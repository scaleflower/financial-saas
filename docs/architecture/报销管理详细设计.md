# æŠ¥é”€ç®¡ç†æ¨¡å—è¯¦ç»†è®¾è®¡

## ğŸ“‹ æ–‡æ¡£è¯´æ˜

**æ¨¡å—åç§°**: æŠ¥é”€ç®¡ç† (Reimbursement Management)  
**æ¨¡å—ä»£ç **: TRANS  
**ä¼˜å…ˆçº§**: P0 (æ ¸å¿ƒåŠŸèƒ½)  
**ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-01-24  

---

## ğŸ“ è®¾è®¡åŸåˆ™

### 1. åŠ¨æ€ç±»å‹ä¼˜å…ˆ
- æŠ¥é”€ç±»å‹å¿…é¡»å¯é…ç½®,æ— éœ€ä»£ç ä¿®æ”¹å³å¯æ–°å¢ã€ä¿®æ”¹ã€å¯ç”¨/ç¦ç”¨
- æ¯ç§ç±»å‹æœ‰ç‹¬ç«‹çš„æ•°æ®schemaå®šä¹‰
- ç±»å‹æ”¯æŒå­—æ®µçº§åˆ«çš„éªŒè¯è§„åˆ™é…ç½®

### 2. è¡¨å•è‡ªåŠ¨æ¸²æŸ“
- åŸºäºç±»å‹é…ç½®è‡ªåŠ¨ç”Ÿæˆå‰ç«¯è¡¨å•
- æ”¯æŒå¤šç§å­—æ®µç±»å‹: æ–‡æœ¬ã€æ•°å­—ã€æ—¥æœŸã€åŸå¸‚é€‰æ‹©ã€æ˜ç»†è¡¨ã€é™„ä»¶ç­‰
- æ”¯æŒå­—æ®µçº§åˆ«çš„æ˜¾ç¤º/éšè—æ§åˆ¶
- æ”¯æŒå­—æ®µçº§åˆ«çš„è”åŠ¨é€»è¾‘

### 3. æ•°æ®ä¸€è‡´æ€§
- åŸå¸é‡‘é¢ + æ±‡ç‡ = æœ¬å¸é‡‘é¢ (è‡ªåŠ¨è®¡ç®—)
- æ˜ç»†é‡‘é¢æ±‡æ€» = æŠ¥é”€å•æ€»é‡‘é¢ (è‡ªåŠ¨éªŒè¯)
- æ”¯æŒå€Ÿæ¬¾æŠµæ‰£,è‡ªåŠ¨è®¡ç®—å‰©ä½™å¾…æ”¯ä»˜é‡‘é¢

### 4. å¤šç§Ÿæˆ·éš”ç¦»
- æ‰€æœ‰æŸ¥è¯¢å¿…é¡»åŒ…å« `tenant_id`
- æŠ¥é”€ç±»å‹é…ç½®æ”¯æŒç§Ÿæˆ·çº§åˆ«çš„è‡ªå®šä¹‰
- å·¥ä½œæµé…ç½®æ”¯æŒç§Ÿæˆ·çº§åˆ«çš„è‡ªå®šä¹‰

### 5. æ’ä»¶åŒ–æ‰©å±•
- æŠ¥é”€æ¨¡å—æœ¬èº«ä½œä¸ºä¸€ä¸ªæ’ä»¶å®ç°
- æ”¯æŒç±»å‹çº§åˆ«çš„æ’ä»¶æ‰©å±•
- æ”¯æŒå­—æ®µçº§åˆ«çš„æ’ä»¶æ‰©å±•(è‡ªå®šä¹‰éªŒè¯ã€è‡ªå®šä¹‰è®¡ç®—ç­‰)

---

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

### æ ¸å¿ƒåŠŸèƒ½
1. **æ–°å»ºæŠ¥é”€å•** - åˆ›å»ºæ–°çš„æŠ¥é”€ç”³è¯·,æ”¯æŒ6ç§æŠ¥é”€ç±»å‹
2. **å¾…æˆ‘å®¡æ‰¹** - æŸ¥çœ‹å¹¶å®¡æ‰¹åˆ†é…ç»™æˆ‘çš„æŠ¥é”€å•
3. **æˆ‘çš„æŠ¥é”€** - æŸ¥çœ‹æˆ‘æäº¤çš„æ‰€æœ‰æŠ¥é”€å•
4. **å·²å¤„ç†æŠ¥é”€** - æŸ¥çœ‹å·²å®¡æ‰¹å®Œæˆçš„æŠ¥é”€å•å†å²
5. **æŠ¥é”€è‰ç¨¿** - ç®¡ç†ä¿å­˜çš„è‰ç¨¿,æ”¯æŒç»§ç»­ç¼–è¾‘

### 6ç§æŠ¥é”€ç±»å‹

| ç±»å‹ID | ç±»å‹åç§° | ç±»å‹ä»£ç  | è¯´æ˜ |
|--------|----------|----------|------|
| 1 | ä¸€èˆ¬è´¹ç”¨ | GENERAL | é€šç”¨æŠ¥é”€ç±»å‹,åŒ…å«åŸºæœ¬å­—æ®µ |
| 2 | å·®æ—…æŠ¥é”€ | TRAVEL | å‡ºå·®æŠ¥é”€,åŒ…å«è¡Œç¨‹ä¿¡æ¯+6ç±»å­è´¹ç”¨ |
| 3 | å›¢å»ºè´¹ç”¨ | TEAM_BUILDING | å›¢é˜Ÿå»ºè®¾,åŒ…å«å»ºè®¾æœˆä»½ |
| 4 | å¸‚å†…äº¤é€š | DOMESTIC_TRANSPORT | å¸‚å†…äº¤é€šè´¹,ç±»ä¼¼ä¸€èˆ¬è´¹ç”¨ |
| 5 | ä¸ªäººé€šè®¯ | PERSONAL_COMM | ä¸ªäººé€šè®¯è´¹,åŒ…å«æ‰‹æœºå·ç  |
| 6 | ä¸šåŠ¡æ´»åŠ¨ | BUSINESS_ACTIVITY | ä¸šåŠ¡æ´»åŠ¨è´¹,ç±»ä¼¼ä¸€èˆ¬è´¹ç”¨ |

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### 1. æŠ¥é”€ç±»å‹é…ç½®è¡¨ (trans_type_config)

```sql
COMMENT ON TABLE trans_type_config IS 'æŠ¥é”€ç±»å‹é…ç½®è¡¨ - æ”¯æŒåŠ¨æ€ç±»å‹å®šä¹‰';

-- å­—æ®µç±»å‹æšä¸¾
CREATE TYPE field_type AS ENUM (
    'TEXT',            -- æ–‡æœ¬
    'NUMBER',          -- æ•°å­—
    'DECIMAL',         -- é‡‘é¢
    'DATE',            -- æ—¥æœŸ
    'DATETIME',        -- æ—¥æœŸæ—¶é—´
    'SELECT',          -- ä¸‹æ‹‰é€‰æ‹©
    'MULTI_SELECT',    -- å¤šé€‰
    'CITY_SELECTOR',   -- åŸå¸‚é€‰æ‹©å™¨
    'ORG_SELECTOR',    -- ç»„ç»‡é€‰æ‹©å™¨
    'PROJECT_SELECTOR',-- é¡¹ç›®é€‰æ‹©å™¨
    'USER_SELECTOR',   -- ç”¨æˆ·é€‰æ‹©å™¨
    'CURRENCY_SELECTOR',-- å¸ç§é€‰æ‹©å™¨
    'SUB_EXPENSE',     -- å­è´¹ç”¨æ˜ç»†è¡¨
    'ATTACHMENT',      -- é™„ä»¶ä¸Šä¼ 
    'TEXTAREA',        -- å¤šè¡Œæ–‡æœ¬
    'RADIO',           -- å•é€‰
    'CHECKBOX'         -- å¤é€‰æ¡†
);

-- æŠ¥é”€ç±»å‹çŠ¶æ€
CREATE TYPE trans_type_status AS ENUM (
    'ACTIVE',          -- å¯ç”¨
    'DISABLED',        -- ç¦ç”¨
    'ARCHIVED'         -- å½’æ¡£
);

CREATE TABLE trans_type_config (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    type_config_id BIGSERIAL NOT NULL,
    
    -- åŸºæœ¬ä¿¡æ¯
    type_code VARCHAR(50) NOT NULL,             -- ç±»å‹ä»£ç (GENERAL/TRAVELç­‰)
    type_name VARCHAR(100) NOT NULL,            -- ç±»å‹åç§°
    type_desc VARCHAR(500),                     -- ç±»å‹æè¿°
    type_icon VARCHAR(100),                     -- ç±»å‹å›¾æ ‡
    type_order INTEGER DEFAULT 0,               -- æ’åº
    
    -- ç±»å‹çŠ¶æ€
    status trans_type_status NOT NULL DEFAULT 'ACTIVE',
    
    -- æ‰©å±•é…ç½®
    config JSONB,                               -- æ‰©å±•é…ç½®(å­˜å‚¨ç±»å‹çº§åˆ«çš„è‡ªå®šä¹‰é…ç½®)
    
    -- å®¡è®¡å­—æ®µ
    created_by BIGINT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by BIGINT,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, type_config_id),
    
    -- å”¯ä¸€çº¦æŸ
    CONSTRAINT uk_trans_type_tenant_code UNIQUE (tenant_id, type_code),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_trans_type_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id)
);

-- ç´¢å¼•
CREATE INDEX idx_trans_type_code ON trans_type_config(type_code);
CREATE INDEX idx_trans_type_status ON trans_type_config(status);

-- æ³¨é‡Š
COMMENT ON COLUMN trans_type_config.tenant_id IS 'ç§Ÿæˆ·ID';
COMMENT ON COLUMN trans_type_config.type_config_id IS 'ç±»å‹é…ç½®ID';
COMMENT ON COLUMN trans_type_config.type_code IS 'ç±»å‹ä»£ç ';
COMMENT ON COLUMN trans_type_config.type_name IS 'ç±»å‹åç§°';
COMMENT ON COLUMN trans_type_config.config IS 'æ‰©å±•é…ç½®(JSONæ ¼å¼)';
```

### 2. æŠ¥é”€ç±»å‹å­—æ®µé…ç½®è¡¨ (trans_type_field)

```sql
COMMENT ON TABLE trans_type_field IS 'æŠ¥é”€ç±»å‹å­—æ®µé…ç½®è¡¨ - å®šä¹‰æ¯ç§ç±»å‹çš„å­—æ®µ';

-- å­—æ®µéªŒè¯è§„åˆ™ç±»å‹
CREATE TYPE validation_rule AS ENUM (
    'REQUIRED',        -- å¿…å¡«
    'MIN_LENGTH',      -- æœ€å°é•¿åº¦
    'MAX_LENGTH',      -- æœ€å¤§é•¿åº¦
    'MIN_VALUE',       -- æœ€å°å€¼
    'MAX_VALUE',       -- æœ€å¤§å€¼
    'REGEX',           -- æ­£åˆ™è¡¨è¾¾å¼
    'CUSTOM',          -- è‡ªå®šä¹‰éªŒè¯
    'DATE_RANGE',      -- æ—¥æœŸèŒƒå›´
    'EMAIL',           -- é‚®ç®±æ ¼å¼
    'PHONE'            -- æ‰‹æœºå·æ ¼å¼
);

CREATE TABLE trans_type_field (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    field_config_id BIGSERIAL NOT NULL,
    
    -- å…³è”ç±»å‹
    type_config_id BIGINT NOT NULL,             -- å…³è”çš„ç±»å‹é…ç½®ID
    
    -- å­—æ®µåŸºæœ¬ä¿¡æ¯
    field_code VARCHAR(50) NOT NULL,           -- å­—æ®µä»£ç (å¯¹åº”æ•°æ®åº“åˆ—å)
    field_name VARCHAR(100) NOT NULL,           -- å­—æ®µæ˜¾ç¤ºåç§°
    field_type field_type NOT NULL,            -- å­—æ®µç±»å‹
    field_desc VARCHAR(500),                   -- å­—æ®µæè¿°
    
    -- å­—æ®µå±æ€§
    is_required SMALLINT NOT NULL DEFAULT 0,    -- æ˜¯å¦å¿…å¡«
    is_readonly SMALLINT NOT NULL DEFAULT 0,    -- æ˜¯å¦åªè¯»
    is_visible SMALLINT NOT NULL DEFAULT 1,     -- æ˜¯å¦å¯è§
    is_editable SMALLINT NOT NULL DEFAULT 1,    -- æ˜¯å¦å¯ç¼–è¾‘(æäº¤å)
    default_value VARCHAR(200),                 -- é»˜è®¤å€¼
    placeholder VARCHAR(200),                  -- å ä½ç¬¦
    
    -- å­—æ®µå¸ƒå±€
    grid_col INTEGER DEFAULT 24,               -- æ …æ ¼åˆ—æ•°(24æ …æ ¼ç³»ç»Ÿ)
    form_group VARCHAR(100),                   -- è¡¨å•åˆ†ç»„
    form_order INTEGER DEFAULT 0,               -- è¡¨å•æ’åº
    
    -- æ•°æ®æºé…ç½®(ç”¨äºSELECTã€CITY_SELECTORç­‰)
    data_source JSONB,                          -- æ•°æ®æºé…ç½®
    
    -- éªŒè¯è§„åˆ™
    validation_rules JSONB,                    -- éªŒè¯è§„åˆ™(JSONæ•°ç»„)
    error_message VARCHAR(500),                 -- é”™è¯¯æç¤º
    
    -- è”åŠ¨é…ç½®
    linkage_rules JSONB,                       -- è”åŠ¨è§„åˆ™(JSONé…ç½®)
    
    -- å­è¡¨é…ç½®(ä»…ç”¨äºSUB_EXPENSEç±»å‹)
    sub_table_config JSONB,                     -- å­è¡¨é…ç½®(å­å­—æ®µå®šä¹‰)
    
    -- å®¡è®¡å­—æ®µ
    created_by BIGINT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by BIGINT,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, field_config_id),
    
    -- å”¯ä¸€çº¦æŸ
    CONSTRAINT uk_trans_type_field UNIQUE (tenant_id, type_config_id, field_code),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_trans_type_field_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    CONSTRAINT fk_trans_type_field_type FOREIGN KEY (tenant_id, type_config_id) 
        REFERENCES trans_type_config(tenant_id, type_config_id)
);

-- ç´¢å¼•
CREATE INDEX idx_trans_type_field_type ON trans_type_field(tenant_id, type_config_id);
CREATE INDEX idx_trans_type_field_code ON trans_type_field(field_code);

-- æ³¨é‡Š
COMMENT ON COLUMN trans_type_field.tenant_id IS 'ç§Ÿæˆ·ID';
COMMENT ON COLUMN trans_type_field.field_config_id IS 'å­—æ®µé…ç½®ID';
COMMENT ON COLUMN trans_type_field.type_config_id IS 'ç±»å‹é…ç½®ID';
COMMENT ON COLUMN trans_type_field.field_code IS 'å­—æ®µä»£ç ';
COMMENT ON COLUMN trans_type_field.field_name IS 'å­—æ®µæ˜¾ç¤ºåç§°';
COMMENT ON COLUMN trans_type_field.field_type IS 'å­—æ®µç±»å‹';
COMMENT ON COLUMN trans_type_field.is_required IS 'æ˜¯å¦å¿…å¡«';
COMMENT ON COLUMN trans_type_field.is_readonly IS 'æ˜¯å¦åªè¯»';
COMMENT ON COLUMN trans_type_field.is_visible IS 'æ˜¯å¦å¯è§';
COMMENT ON COLUMN trans_type_field.is_editable IS 'æ˜¯å¦å¯ç¼–è¾‘';
COMMENT ON COLUMN trans_type_field.data_source IS 'æ•°æ®æºé…ç½®(JSONæ ¼å¼)';
COMMENT ON COLUMN trans_type_field.validation_rules IS 'éªŒè¯è§„åˆ™(JSONæ•°ç»„)';
COMMENT ON COLUMN trans_type_field.linkage_rules IS 'è”åŠ¨è§„åˆ™';
COMMENT ON COLUMN trans_type_field.sub_table_config IS 'å­è¡¨é…ç½®(ä»…ç”¨äºSUB_EXPENSEç±»å‹)';
```

### 3. æŠ¥é”€å•ä¸»è¡¨ (trans) - æ‰©å±•åŸæœ‰è®¾è®¡

```sql
COMMENT ON TABLE trans IS 'æŠ¥é”€å•ä¸»è¡¨';

-- æŠ¥é”€å•çŠ¶æ€
CREATE TYPE trans_state AS ENUM (
    'DRAFT',           -- è‰ç¨¿
    'SUBMITTED',       -- å·²æäº¤
    'APPROVING',       -- å®¡æ‰¹ä¸­
    'APPROVED',        -- å·²æ‰¹å‡†
    'REJECTED',        -- å·²é©³å›
    'SETTLING',        -- ç»“ç®—ä¸­
    'SETTLED',         -- å·²ç»“ç®—
    'CANCELLED'        -- å·²æ’¤é”€
);

CREATE TABLE trans (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    trans_id BIGSERIAL NOT NULL,
    
    -- æŠ¥é”€å•å·
    trans_no VARCHAR(50) NOT NULL,             -- æŠ¥é”€å•å·(è‡ªåŠ¨ç”Ÿæˆ)
    
    -- æŠ¥é”€ç±»å‹
    type_config_id BIGINT NOT NULL,            -- æŠ¥é”€ç±»å‹é…ç½®ID
    type_code VARCHAR(50) NOT NULL,            -- ç±»å‹ä»£ç (å†—ä½™,ä¾¿äºæŸ¥è¯¢)
    
    -- ç”³è¯·äººä¿¡æ¯
    applicant_id BIGINT NOT NULL,               -- ç”³è¯·äººID
    applicant_name VARCHAR(60) NOT NULL,        -- ç”³è¯·äººå§“å
    dept_id BIGINT NOT NULL,                   -- æ‰€å±éƒ¨é—¨ID
    dept_name VARCHAR(200) NOT NULL,           -- æ‰€å±éƒ¨é—¨åç§°
    
    -- é¡¹ç›®ä¿¡æ¯
    project_id BIGINT,                          -- é¡¹ç›®ID
    project_name VARCHAR(200),                 -- é¡¹ç›®åç§°
    
    -- æŠ¥é”€åŸºæœ¬ä¿¡æ¯
    trans_reason TEXT NOT NULL,                -- æŠ¥é”€åŸå› 
    contact_phone VARCHAR(20),                 -- è”ç³»ç”µè¯
    invoice_page_count INTEGER,                -- å‘ç¥¨é¡µæ•°
    invoice_count INTEGER,                     -- å‘ç¥¨å¼ æ•°
    
    -- é‡‘é¢ä¿¡æ¯
    charge NUMERIC(12,2) NOT NULL,             -- åŸå¸é‡‘é¢
    currency VARCHAR(10) NOT NULL,             -- å¸ç§ä»£ç 
    exchange_rate NUMERIC(12,6) NOT NULL,      -- æ±‡ç‡
    lc_charge NUMERIC(12,2) NOT NULL,          -- æœ¬å¸é‡‘é¢
    
    -- ç»“ç®—ä¿¡æ¯
    sett_charge NUMERIC(12,2),                  -- ç»“ç®—é‡‘é¢(å¯èƒ½ä¸åŒ)
    sett_date DATE,                             -- ç»“ç®—æ—¥æœŸ
    sett_user_id BIGINT,                        -- ç»“ç®—äººID
    sett_user_name VARCHAR(60),                 -- ç»“ç®—äººå§“å
    sett_remarks TEXT,                          -- ç»“ç®—å¤‡æ³¨
    
    -- å€Ÿæ¬¾æŠµæ‰£
    loan_offset_amount NUMERIC(12,2) DEFAULT 0,-- å€Ÿæ¬¾æŠµæ‰£é‡‘é¢
    loan_offset_ids TEXT,                       -- æŠµæ‰£çš„å€Ÿæ¬¾IDåˆ—è¡¨(JSONæ•°ç»„)
    
    -- å®ä»˜é‡‘é¢(æœ¬å¸)
    payable_amount NUMERIC(12,2),               -- å®ä»˜é‡‘é¢(lc_charge - loan_offset_amount)
    
    -- å·¥ä½œæµ
    workflow_instance_id VARCHAR(100),          -- å·¥ä½œæµå®ä¾‹ID
    current_node VARCHAR(100),                 -- å½“å‰å®¡æ‰¹èŠ‚ç‚¹
    
    -- æŠ¥é”€å•çŠ¶æ€
    state trans_state NOT NULL DEFAULT 'DRAFT',
    
    -- å®¡è®¡å­—æ®µ
    created_by BIGINT NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by BIGINT,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- è½¯åˆ é™¤
    deleted_at TIMESTAMP,
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, trans_id),
    
    -- å”¯ä¸€çº¦æŸ
    CONSTRAINT uk_trans_tenant_no UNIQUE (tenant_id, trans_no),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_trans_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    CONSTRAINT fk_trans_type_config FOREIGN KEY (tenant_id, type_config_id) 
        REFERENCES trans_type_config(tenant_id, type_config_id),
    CONSTRAINT fk_trans_applicant FOREIGN KEY (tenant_id, applicant_id) 
        REFERENCES "user"(tenant_id, user_id),
    CONSTRAINT fk_trans_dept FOREIGN KEY (tenant_id, dept_id) 
        REFERENCES org(tenant_id, org_id),
    CONSTRAINT fk_trans_project FOREIGN KEY (tenant_id, project_id) 
        REFERENCES project(tenant_id, project_id),
    CONSTRAINT fk_trans_sett_user FOREIGN KEY (tenant_id, sett_user_id) 
        REFERENCES "user"(tenant_id, user_id)
);

-- ç´¢å¼•
CREATE INDEX idx_trans_tenant_no ON trans(trans_no);
CREATE INDEX idx_trans_tenant_type ON trans(tenant_id, type_code);
CREATE INDEX idx_trans_tenant_applicant ON trans(tenant_id, applicant_id);
CREATE INDEX idx_trans_tenant_dept ON trans(tenant_id, dept_id);
CREATE INDEX idx_trans_tenant_state ON trans(tenant_id, state);
CREATE INDEX idx_trans_tenant_date ON trans(tenant_id, created_at);
CREATE INDEX idx_trans_workflow ON trans(workflow_instance_id);

-- æ³¨é‡Š
COMMENT ON COLUMN trans.tenant_id IS 'ç§Ÿæˆ·ID';
COMMENT ON COLUMN trans.trans_id IS 'æŠ¥é”€å•ID';
COMMENT ON COLUMN trans.trans_no IS 'æŠ¥é”€å•å·(è‡ªåŠ¨ç”Ÿæˆ)';
COMMENT ON COLUMN trans.type_config_id IS 'æŠ¥é”€ç±»å‹é…ç½®ID';
COMMENT ON COLUMN trans.type_code IS 'ç±»å‹ä»£ç (å†—ä½™)';
COMMENT ON COLUMN trans.applicant_id IS 'ç”³è¯·äººID';
COMMENT ON COLUMN trans.dept_id IS 'æ‰€å±éƒ¨é—¨ID';
COMMENT ON COLUMN trans.project_id IS 'é¡¹ç›®ID';
COMMENT ON COLUMN trans.charge IS 'åŸå¸é‡‘é¢';
COMMENT ON COLUMN trans.lc_charge IS 'æœ¬å¸é‡‘é¢';
COMMENT ON COLUMN trans.sett_charge IS 'ç»“ç®—é‡‘é¢(å¯èƒ½ä¸åŒ)';
COMMENT ON COLUMN trans.loan_offset_amount IS 'å€Ÿæ¬¾æŠµæ‰£é‡‘é¢';
COMMENT ON COLUMN trans.payable_amount IS 'å®ä»˜é‡‘é¢';
COMMENT ON COLUMN trans.workflow_instance_id IS 'å·¥ä½œæµå®ä¾‹ID';
COMMENT ON COLUMN trans.state IS 'æŠ¥é”€å•çŠ¶æ€';
```

### 4. æŠ¥é”€å•æ˜ç»†è¡¨ (trans_item)

```sql
COMMENT ON TABLE trans_item IS 'æŠ¥é”€å•æ˜ç»†è¡¨';

CREATE TABLE trans_item (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    item_id BIGSERIAL NOT NULL,
    
    -- å…³è”æŠ¥é”€å•
    trans_id BIGINT NOT NULL,                  -- æŠ¥é”€å•ID
    
    -- æ˜ç»†åºå·
    item_no INTEGER NOT NULL,                  -- æ˜ç»†åºå·(1,2,3...)
    
    -- è´¹ç”¨åŸºæœ¬ä¿¡æ¯
    expense_date DATE NOT NULL,                -- è´¹ç”¨å‘ç”Ÿæ—¥æœŸ
    city_id BIGINT,                             -- åŸå¸‚ID
    city_name VARCHAR(100),                    -- åŸå¸‚åç§°
    
    -- é‡‘é¢ä¿¡æ¯
    charge NUMERIC(12,2) NOT NULL,             -- åŸå¸é‡‘é¢
    currency VARCHAR(10) NOT NULL,             -- å¸ç§ä»£ç 
    exchange_rate NUMERIC(12,6) NOT NULL,      -- æ±‡ç‡
    lc_charge NUMERIC(12,2) NOT NULL,          -- æœ¬å¸é‡‘é¢
    
    -- è´¹ç”¨è¯´æ˜
    item_desc TEXT NOT NULL,                   -- è´¹ç”¨è¯´æ˜
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, item_id),
    
    -- å”¯ä¸€çº¦æŸ
    CONSTRAINT uk_trans_item UNIQUE (tenant_id, trans_id, item_no),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_trans_item_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    CONSTRAINT fk_trans_item_trans FOREIGN KEY (tenant_id, trans_id) 
        REFERENCES trans(tenant_id, trans_id)
);

-- ç´¢å¼•
CREATE INDEX idx_trans_item_trans ON trans_item(tenant_id, trans_id);
CREATE INDEX idx_trans_item_date ON trans_item(expense_date);

-- æ³¨é‡Š
COMMENT ON COLUMN trans_item.tenant_id IS 'ç§Ÿæˆ·ID';
COMMENT ON COLUMN trans_item.item_id IS 'æ˜ç»†ID';
COMMENT ON COLUMN trans_item.trans_id IS 'æŠ¥é”€å•ID';
COMMENT ON COLUMN trans_item.item_no IS 'æ˜ç»†åºå·';
COMMENT ON COLUMN trans_item.expense_date IS 'è´¹ç”¨å‘ç”Ÿæ—¥æœŸ';
COMMENT ON COLUMN trans_item.city_id IS 'åŸå¸‚ID';
COMMENT ON COLUMN trans_item.charge IS 'åŸå¸é‡‘é¢';
COMMENT ON COLUMN trans_item.lc_charge IS 'æœ¬å¸é‡‘é¢';
```

### 5. å·®æ—…æŠ¥é”€å­è´¹ç”¨è¡¨ (travel_sub_expense)

```sql
COMMENT ON TABLE travel_sub_expense IS 'å·®æ—…æŠ¥é”€å­è´¹ç”¨è¡¨(ä»…ç”¨äºç±»å‹2)';

-- å­è´¹ç”¨ç±»å‹
CREATE TYPE sub_expense_type AS ENUM (
    'COMMUNICATION',    -- é€šè®¯è´¹
    'TRAFFIC',          -- äº¤é€šè´¹
    'HOTEL',            -- ä½å®¿è´¹
    'AIRPORT',          -- æœºåœºè´¹
    'VISA',             -- ç­¾è¯è´¹
    'OTHER'             -- å…¶ä»–è´¹ç”¨
);

CREATE TABLE travel_sub_expense (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    sub_expense_id BIGSERIAL NOT NULL,
    
    -- å…³è”æŠ¥é”€å•æ˜ç»†
    item_id BIGINT NOT NULL,                    -- å…³è”çš„æ˜ç»†ID
    
    -- å­è´¹ç”¨ç±»å‹
    sub_expense_type sub_expense_type NOT NULL, -- å­è´¹ç”¨ç±»å‹
    
    -- é‡‘é¢ä¿¡æ¯
    charge NUMERIC(12,2) NOT NULL,             -- åŸå¸é‡‘é¢
    currency VARCHAR(10) NOT NULL,             -- å¸ç§ä»£ç 
    exchange_rate NUMERIC(12,6) NOT NULL,      -- æ±‡ç‡
    lc_charge NUMERIC(12,2) NOT NULL,          -- æœ¬å¸é‡‘é¢
    
    -- è´¹ç”¨è¯´æ˜
    item_desc TEXT NOT NULL,                   -- è´¹ç”¨è¯´æ˜
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, sub_expense_id),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_travel_sub_expense_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    CONSTRAINT fk_travel_sub_expense_item FOREIGN KEY (tenant_id, item_id) 
        REFERENCES trans_item(tenant_id, item_id)
);

-- ç´¢å¼•
CREATE INDEX idx_travel_sub_expense_item ON travel_sub_expense(tenant_id, item_id);
CREATE INDEX idx_travel_sub_expense_type ON travel_sub_expense(sub_expense_type);

-- æ³¨é‡Š
COMMENT ON COLUMN travel_sub_expense.tenant_id IS 'ç§Ÿæˆ·ID';
COMMENT ON COLUMN travel_sub_expense.sub_expense_id IS 'å­è´¹ç”¨ID';
COMMENT ON COLUMN travel_sub_expense.item_id IS 'å…³è”çš„æ˜ç»†ID';
COMMENT ON COLUMN travel_sub_expense.sub_expense_type IS 'å­è´¹ç”¨ç±»å‹';
```

### 6. æŠ¥é”€å•é™„ä»¶è¡¨ (trans_attach)

```sql
COMMENT ON TABLE trans_attach IS 'æŠ¥é”€å•é™„ä»¶è¡¨';

CREATE TABLE trans_attach (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    attach_id BIGSERIAL NOT NULL,
    
    -- å…³è”æŠ¥é”€å•
    trans_id BIGINT NOT NULL,                  -- æŠ¥é”€å•ID
    
    -- é™„ä»¶ä¿¡æ¯
    attach_name VARCHAR(255) NOT NULL,         -- é™„ä»¶åç§°
    attach_type VARCHAR(50) NOT NULL,          -- é™„ä»¶ç±»å‹(PDF/IMAGE/OFFICE)
    file_size BIGINT NOT NULL,                 -- æ–‡ä»¶å¤§å°(å­—èŠ‚)
    file_path VARCHAR(500) NOT NULL,           -- æ–‡ä»¶å­˜å‚¨è·¯å¾„(MinIO)
    file_url VARCHAR(500),                     -- æ–‡ä»¶è®¿é—®URL
    
    -- ä¸Šä¼ ä¿¡æ¯
    uploaded_by BIGINT NOT NULL,                -- ä¸Šä¼ äººID
    uploaded_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, attach_id),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_trans_attach_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    CONSTRAINT fk_trans_attach_trans FOREIGN KEY (tenant_id, trans_id) 
        REFERENCES trans(tenant_id, trans_id),
    CONSTRAINT fk_trans_attach_user FOREIGN KEY (tenant_id, uploaded_by) 
        REFERENCES "user"(tenant_id, user_id)
);

-- ç´¢å¼•
CREATE INDEX idx_trans_attach_trans ON trans_attach(tenant_id, trans_id);

-- æ³¨é‡Š
COMMENT ON COLUMN trans_attach.tenant_id IS 'ç§Ÿæˆ·ID';
COMMENT ON COLUMN trans_attach.attach_id IS 'é™„ä»¶ID';
COMMENT ON COLUMN trans_attach.trans_id IS 'æŠ¥é”€å•ID';
COMMENT ON COLUMN trans_attach.file_path IS 'æ–‡ä»¶å­˜å‚¨è·¯å¾„';
```

### 7. æŠ¥é”€å•æ‰©å±•å­—æ®µè¡¨ (trans_ext_field)

```sql
COMMENT ON TABLE trans_ext_field IS 'æŠ¥é”€å•æ‰©å±•å­—æ®µè¡¨ - å­˜å‚¨ç±»å‹ç‰¹å®šå­—æ®µ';

CREATE TABLE trans_ext_field (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    ext_field_id BIGSERIAL NOT NULL,
    
    -- å…³è”æŠ¥é”€å•
    trans_id BIGINT NOT NULL,                  -- æŠ¥é”€å•ID
    
    -- å­—æ®µä¿¡æ¯
    field_code VARCHAR(50) NOT NULL,           -- å­—æ®µä»£ç 
    field_value TEXT,                           -- å­—æ®µå€¼(ç»Ÿä¸€ä½¿ç”¨TEXTå­˜å‚¨)
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, ext_field_id),
    
    -- å”¯ä¸€çº¦æŸ
    CONSTRAINT uk_trans_ext_field UNIQUE (tenant_id, trans_id, field_code),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_trans_ext_field_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    CONSTRAINT fk_trans_ext_field_trans FOREIGN KEY (tenant_id, trans_id) 
        REFERENCES trans(tenant_id, trans_id)
);

-- ç´¢å¼•
CREATE INDEX idx_trans_ext_field_trans ON trans_ext_field(tenant_id, trans_id);
CREATE INDEX idx_trans_ext_field_code ON trans_ext_field(field_code);

-- æ³¨é‡Š
COMMENT ON COLUMN trans_ext_field.tenant_id IS 'ç§Ÿæˆ·ID';
COMMENT ON COLUMN trans_ext_field.ext_field_id IS 'æ‰©å±•å­—æ®µID';
COMMENT ON COLUMN trans_ext_field.trans_id IS 'æŠ¥é”€å•ID';
COMMENT ON COLUMN trans_ext_field.field_code IS 'å­—æ®µä»£ç ';
COMMENT ON COLUMN trans_ext_field.field_value IS 'å­—æ®µå€¼';
```

---

## ğŸ¨ 6ç§æŠ¥é”€ç±»å‹è¯¦ç»†è®¾è®¡

### ç±»å‹1: ä¸€èˆ¬è´¹ç”¨ (GENERAL)

#### ç±»å‹åŸºæœ¬ä¿¡æ¯
```json
{
  "type_code": "GENERAL",
  "type_name": "ä¸€èˆ¬è´¹ç”¨",
  "type_desc": "é€šç”¨æŠ¥é”€ç±»å‹,é€‚ç”¨äºæ—¥å¸¸è´¹ç”¨æŠ¥é”€",
  "type_icon": "money-circle",
  "type_order": 1
}
```

#### å­—æ®µé…ç½®
| åºå· | å­—æ®µä»£ç  | å­—æ®µåç§° | å­—æ®µç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜ |
|------|----------|----------|----------|------|--------|------|
| 1 | trans_no | ç”³è¯·å•å· | TEXT | æ˜¯ | è‡ªåŠ¨ç”Ÿæˆ | ä¸å¯ç¼–è¾‘ |
| 2 | dept_id | æ‰€å±éƒ¨é—¨ | ORG_SELECTOR | æ˜¯ | - | ä»…é€‰æ‹©å¶å­èŠ‚ç‚¹ |
| 3 | project_id | é¡¹ç›® | PROJECT_SELECTOR | æ˜¯ | - | ä»é¡¹ç›®åˆ—è¡¨é€‰æ‹© |
| 4 | trans_reason | æŠ¥é”€åŸå›  | TEXTAREA | æ˜¯ | - | è‡³å°‘10ä¸ªå­— |
| 5 | contact_phone | è”ç³»ç”µè¯ | TEXT | å¦ | å½“å‰ç”¨æˆ·ç”µè¯ | æ‰‹æœºå·æ ¼å¼ |
| 6 | invoice_page_count | å‘ç¥¨é¡µæ•° | NUMBER | æ˜¯ | 0 | æ•´æ•° |
| 7 | invoice_count | å‘ç¥¨å¼ æ•° | NUMBER | æ˜¯ | 0 | æ•´æ•° |
| 8 | item_block | è´¹ç”¨æ˜ç»† | SUB_EXPENSE | æ˜¯ | - | è‡³å°‘1æ¡ |
| 9 | loan_offset | å€Ÿæ¬¾æŠµæ‰£ | LOAN_OFFSET_SELECTOR | å¦ | - | ä»å¯ç”¨å€Ÿæ¬¾é€‰æ‹© |
| 10 | attachments | é™„ä»¶ | ATTACHMENT | æ˜¯ | - | è‡³å°‘1ä¸ªé™„ä»¶ |

#### è´¹ç”¨æ˜ç»†å­—æ®µ(item_blockå­è¡¨)
| å­—æ®µä»£ç  | å­—æ®µåç§° | å­—æ®µç±»å‹ | å¿…å¡« | è¯´æ˜ |
|----------|----------|----------|------|------|
| expense_date | è´¹ç”¨æ—¥æœŸ | DATE | æ˜¯ | ä¸èƒ½æ™šäºå½“å‰æ—¥æœŸ |
| city_id | åŸå¸‚ | CITY_SELECTOR | å¦ | ä»åŸå¸‚åˆ—è¡¨é€‰æ‹© |
| charge | é‡‘é¢ | DECIMAL | æ˜¯ | å¤§äº0 |
| currency | å¸ç§ | CURRENCY_SELECTOR | æ˜¯ | é»˜è®¤CNY |
| exchange_rate | æ±‡ç‡ | DECIMAL(12,6) | æ˜¯ | è‡ªåŠ¨è·å– |
| lc_charge | æœ¬å¸é‡‘é¢ | DECIMAL(12,2) | å¦ | è‡ªåŠ¨è®¡ç®—:charge * exchange_rate |
| item_desc | è´¹ç”¨è¯´æ˜ | TEXTAREA | æ˜¯ | è‡³å°‘5ä¸ªå­— |

#### æ•°æ®éªŒè¯è§„åˆ™
```json
{
  "trans_no": [
    {"type": "REQUIRED", "message": "ç”³è¯·å•å·ä¸èƒ½ä¸ºç©º"}
  ],
  "trans_reason": [
    {"type": "REQUIRED", "message": "æŠ¥é”€åŸå› ä¸èƒ½ä¸ºç©º"},
    {"type": "MIN_LENGTH", "value": 10, "message": "æŠ¥é”€åŸå› è‡³å°‘10ä¸ªå­—"}
  ],
  "contact_phone": [
    {"type": "PHONE", "message": "æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®"}
  ],
  "item_block": [
    {"type": "REQUIRED", "message": "è‡³å°‘æ·»åŠ 1æ¡è´¹ç”¨æ˜ç»†"}
  ],
  "attachments": [
    {"type": "REQUIRED", "message": "è‡³å°‘ä¸Šä¼ 1ä¸ªé™„ä»¶"}
  ]
}
```

#### è‡ªåŠ¨è®¡ç®—è§„åˆ™
```
1. æ±‡ç‡è‡ªåŠ¨è·å–: æ ¹æ®é€‰æ‹©çš„å¸ç§å’Œå½“å‰æ—¥æœŸ,ä»exchange_rateè¡¨è·å–æœ€æ–°æ±‡ç‡
2. æœ¬å¸é‡‘é¢è‡ªåŠ¨è®¡ç®—: lc_charge = charge * exchange_rate
3. æ€»é‡‘é¢è‡ªåŠ¨æ±‡æ€»: trans.charge = SUM(trans_item.charge)
4. æ€»æœ¬å¸é‡‘é¢: trans.lc_charge = SUM(trans_item.lc_charge)
5. å®ä»˜é‡‘é¢: payable_amount = lc_charge - loan_offset_amount
```

---

### ç±»å‹2: å·®æ—…æŠ¥é”€ (TRAVEL)

#### ç±»å‹åŸºæœ¬ä¿¡æ¯
```json
{
  "type_code": "TRAVEL",
  "type_name": "å·®æ—…æŠ¥é”€",
  "type_desc": "å‡ºå·®è´¹ç”¨æŠ¥é”€,åŒ…å«è¡Œç¨‹ä¿¡æ¯å’Œ6ç±»å­è´¹ç”¨",
  "type_icon": "plane",
  "type_order": 2
}
```

#### é€šç”¨å­—æ®µé…ç½®
| åºå· | å­—æ®µä»£ç  | å­—æ®µåç§° | å­—æ®µç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜ |
|------|----------|----------|----------|------|--------|------|
| 1 | trans_no | ç”³è¯·å•å· | TEXT | æ˜¯ | è‡ªåŠ¨ç”Ÿæˆ | ä¸å¯ç¼–è¾‘ |
| 2 | dept_id | æ‰€å±éƒ¨é—¨ | ORG_SELECTOR | æ˜¯ | - | ä»…é€‰æ‹©å¶å­èŠ‚ç‚¹ |
| 3 | project_id | é¡¹ç›® | PROJECT_SELECTOR | æ˜¯ | - | ä»é¡¹ç›®åˆ—è¡¨é€‰æ‹© |
| 4 | trans_reason | æŠ¥é”€åŸå›  | TEXTAREA | æ˜¯ | - | è‡³å°‘10ä¸ªå­— |
| 5 | contact_phone | è”ç³»ç”µè¯ | TEXT | å¦ | å½“å‰ç”¨æˆ·ç”µè¯ | æ‰‹æœºå·æ ¼å¼ |
| 6 | invoice_page_count | å‘ç¥¨é¡µæ•° | NUMBER | æ˜¯ | 0 | æ•´æ•° |
| 7 | invoice_count | å‘ç¥¨å¼ æ•° | NUMBER | æ˜¯ | 0 | æ•´æ•° |

#### å·®æ—…ç‰¹æœ‰å­—æ®µ
| åºå· | å­—æ®µä»£ç  | å­—æ®µåç§° | å­—æ®µç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|----------|----------|----------|------|------|
| 8 | start_date | å‡ºå·®å¼€å§‹æ—¥æœŸ | DATE | æ˜¯ | ä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ |
| 9 | end_date | å‡ºå·®ç»“æŸæ—¥æœŸ | DATE | æ˜¯ | ä¸èƒ½æ—©äºå¼€å§‹æ—¥æœŸ |
| 10 | departure_city | å‡ºå‘åŸå¸‚ | CITY_SELECTOR | æ˜¯ | ä»åŸå¸‚åˆ—è¡¨é€‰æ‹© |
| 11 | destination_city | ç›®çš„åœ°åŸå¸‚ | CITY_SELECTOR | æ˜¯ | ä»åŸå¸‚åˆ—è¡¨é€‰æ‹© |

#### è´¹ç”¨æ˜ç»†å­—æ®µ(item_blockå­è¡¨ - å·®æ—…ç±»å‹)
æ¯ä¸ªæ˜ç»†å¯ä»¥åŒ…å«6ç±»å­è´¹ç”¨:

| å­—æ®µä»£ç  | å­—æ®µåç§° | å­—æ®µç±»å‹ | å¿…å¡« | è¯´æ˜ |
|----------|----------|----------|------|------|
| expense_date | è´¹ç”¨æ—¥æœŸ | DATE | æ˜¯ | åœ¨start_dateå’Œend_dateä¹‹é—´ |
| city_id | åŸå¸‚ | CITY_SELECTOR | å¦ | ä»åŸå¸‚åˆ—è¡¨é€‰æ‹© |
| communication_fee | é€šè®¯è´¹ | DECIMAL(12,2) | å¦ | å¯ä»¥ä¸º0 |
| traffic_fee | äº¤é€šè´¹ | DECIMAL(12,2) | å¦ | å¯ä»¥ä¸º0 |
| hotel_fee | ä½å®¿è´¹ | DECIMAL(12,2) | å¦ | å¯ä»¥ä¸º0 |
| airport_fee | æœºåœºè´¹ | DECIMAL(12,2) | å¦ | å¯ä»¥ä¸º0 |
| visa_fee | ç­¾è¯è´¹ | DECIMAL(12,2) | å¦ | å¯ä»¥ä¸º0 |
| other_fee | å…¶ä»–è´¹ç”¨ | DECIMAL(12,2) | å¦ | å¯ä»¥ä¸º0 |
| currency | å¸ç§ | CURRENCY_SELECTOR | æ˜¯ | é»˜è®¤CNY |
| exchange_rate | æ±‡ç‡ | DECIMAL(12,6) | æ˜¯ | è‡ªåŠ¨è·å– |
| total_charge | æ˜ç»†å°è®¡ | DECIMAL(12,2) | å¦ | è‡ªåŠ¨è®¡ç®— |
| lc_total_charge | æœ¬å¸å°è®¡ | DECIMAL(12,2) | å¦ | è‡ªåŠ¨è®¡ç®— |
| item_desc | è´¹ç”¨è¯´æ˜ | TEXTAREA | æ˜¯ | è‡³å°‘5ä¸ªå­— |

#### å­è´¹ç”¨æ˜ç»†è¡¨(travel_sub_expense)
å‰ç«¯è¡¨å•ä¸­,æ¯æ¡æ˜ç»†è®°å½•ä¿å­˜æ—¶ä¼šæ‹†åˆ†æˆå¤šæ¡å­è´¹ç”¨è®°å½•:

```sql
-- ç¤ºä¾‹: 1æ¡æ˜ç»†åŒ…å«3ç±»è´¹ç”¨,ä¿å­˜ä¸º3æ¡è®°å½•
INSERT INTO trans_item (tenant_id, trans_id, item_no, expense_date, charge, lc_charge, item_desc)
VALUES (1, 1001, 1, '2025-01-20', 1500.00, 1500.00, 'åŒ—äº¬å‡ºå·®è´¹ç”¨');

INSERT INTO travel_sub_expense (tenant_id, item_id, sub_expense_type, charge, lc_charge, item_desc)
VALUES 
  (1, 10001, 'HOTEL', 800.00, 800.00, 'ä½å®¿è´¹'),
  (1, 10001, 'TRAFFIC', 500.00, 500.00, 'é«˜é“è´¹'),
  (1, 10001, 'COMMUNICATION', 200.00, 200.00, 'é€šè®¯è´¹');
```

#### æ•°æ®éªŒè¯è§„åˆ™
```json
{
  "start_date": [
    {"type": "REQUIRED", "message": "å‡ºå·®å¼€å§‹æ—¥æœŸä¸èƒ½ä¸ºç©º"},
    {"type": "DATE_RANGE", "max": "end_date", "message": "å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ"}
  ],
  "end_date": [
    {"type": "REQUIRED", "message": "å‡ºå·®ç»“æŸæ—¥æœŸä¸èƒ½ä¸ºç©º"},
    {"type": "DATE_RANGE", "min": "start_date", "message": "ç»“æŸæ—¥æœŸä¸èƒ½æ—©äºå¼€å§‹æ—¥æœŸ"}
  ],
  "expense_date": [
    {"type": "DATE_RANGE", "min": "start_date", "max": "end_date", "message": "è´¹ç”¨æ—¥æœŸå¿…é¡»åœ¨å‡ºå·®æ—¥æœŸèŒƒå›´å†…"}
  ],
  "item_block": [
    {"type": "REQUIRED", "message": "è‡³å°‘æ·»åŠ 1æ¡è´¹ç”¨æ˜ç»†"},
    {"type": "CUSTOM", "validator": "at_least_one_sub_expense", "message": "æ¯æ¡æ˜ç»†è‡³å°‘å¡«å†™1ç±»è´¹ç”¨"}
  ]
}
```

#### è‡ªåŠ¨è®¡ç®—è§„åˆ™
```
1. æ±‡ç‡è‡ªåŠ¨è·å–: æ ¹æ®é€‰æ‹©çš„å¸ç§å’Œå½“å‰æ—¥æœŸ,ä»exchange_rateè¡¨è·å–æœ€æ–°æ±‡ç‡
2. æ˜ç»†å°è®¡: total_charge = SUM(communication_fee + traffic_fee + hotel_fee + airport_fee + visa_fee + other_fee)
3. æ˜ç»†æœ¬å¸å°è®¡: lc_total_charge = total_charge * exchange_rate
4. trans_item.charge = total_charge
5. trans_item.lc_charge = lc_total_charge
6. æ€»é‡‘é¢è‡ªåŠ¨æ±‡æ€»: trans.charge = SUM(trans_item.charge)
7. æ€»æœ¬å¸é‡‘é¢: trans.lc_charge = SUM(trans_item.lc_charge)
8. å®ä»˜é‡‘é¢: payable_amount = lc_charge - loan_offset_amount
```

---

### ç±»å‹3: å›¢å»ºè´¹ç”¨ (TEAM_BUILDING)

#### ç±»å‹åŸºæœ¬ä¿¡æ¯
```json
{
  "type_code": "TEAM_BUILDING",
  "type_name": "å›¢å»ºè´¹ç”¨",
  "type_desc": "å›¢é˜Ÿå»ºè®¾æ´»åŠ¨è´¹ç”¨æŠ¥é”€",
  "type_icon": "team",
  "type_order": 3
}
```

#### å­—æ®µé…ç½®
| åºå· | å­—æ®µä»£ç  | å­—æ®µåç§° | å­—æ®µç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜ |
|------|----------|----------|----------|------|--------|------|
| 1 | trans_no | ç”³è¯·å•å· | TEXT | æ˜¯ | è‡ªåŠ¨ç”Ÿæˆ | ä¸å¯ç¼–è¾‘ |
| 2 | dept_id | æ‰€å±éƒ¨é—¨ | ORG_SELECTOR | æ˜¯ | - | ä»…é€‰æ‹©å¶å­èŠ‚ç‚¹ |
| 3 | project_id | é¡¹ç›® | PROJECT_SELECTOR | æ˜¯ | - | ä»é¡¹ç›®åˆ—è¡¨é€‰æ‹© |
| 4 | trans_reason | æŠ¥é”€åŸå›  | TEXTAREA | æ˜¯ | - | è‡³å°‘10ä¸ªå­— |
| 5 | contact_phone | è”ç³»ç”µè¯ | TEXT | å¦ | å½“å‰ç”¨æˆ·ç”µè¯ | æ‰‹æœºå·æ ¼å¼ |
| 6 | invoice_page_count | å‘ç¥¨é¡µæ•° | NUMBER | æ˜¯ | 0 | æ•´æ•° |
| 7 | invoice_count | å‘ç¥¨å¼ æ•° | NUMBER | æ˜¯ | 0 | æ•´æ•° |

#### å›¢å»ºç‰¹æœ‰å­—æ®µ
| åºå· | å­—æ®µä»£ç  | å­—æ®µåç§° | å­—æ®µç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|----------|----------|----------|------|------|
| 8 | build_month | å»ºè®¾æœˆä»½ | DATE | æ˜¯ | åªé€‰æ‹©æœˆä»½,YYYY-MMæ ¼å¼ |

#### è´¹ç”¨æ˜ç»†å­—æ®µ(item_blockå­è¡¨)
ä¸ç±»å‹1ç›¸åŒ,ä½¿ç”¨é€šç”¨çš„è´¹ç”¨æ˜ç»†ç»“æ„

---

### ç±»å‹4: å¸‚å†…äº¤é€š (DOMESTIC_TRANSPORT)

#### ç±»å‹åŸºæœ¬ä¿¡æ¯
```json
{
  "type_code": "DOMESTIC_TRANSPORT",
  "type_name": "å¸‚å†…äº¤é€š",
  "type_desc": "å¸‚å†…äº¤é€šè´¹ç”¨æŠ¥é”€",
  "type_icon": "car",
  "type_order": 4
}
```

#### å­—æ®µé…ç½®
ä¸ç±»å‹1(ä¸€èˆ¬è´¹ç”¨)å®Œå…¨ç›¸åŒ,å­—æ®µé…ç½®å¯ä»¥å¤ç”¨

---

### ç±»å‹5: ä¸ªäººé€šè®¯ (PERSONAL_COMM)

#### ç±»å‹åŸºæœ¬ä¿¡æ¯
```json
{
  "type_code": "PERSONAL_COMM",
  "type_name": "ä¸ªäººé€šè®¯",
  "type_desc": "ä¸ªäººé€šè®¯è´¹ç”¨æŠ¥é”€",
  "type_icon": "phone",
  "type_order": 5
}
```

#### å­—æ®µé…ç½®
| åºå· | å­—æ®µä»£ç  | å­—æ®µåç§° | å­—æ®µç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜ |
|------|----------|----------|----------|------|--------|------|
| 1 | trans_no | ç”³è¯·å•å· | TEXT | æ˜¯ | è‡ªåŠ¨ç”Ÿæˆ | ä¸å¯ç¼–è¾‘ |
| 2 | dept_id | æ‰€å±éƒ¨é—¨ | ORG_SELECTOR | æ˜¯ | - | ä»…é€‰æ‹©å¶å­èŠ‚ç‚¹ |
| 3 | project_id | é¡¹ç›® | PROJECT_SELECTOR | æ˜¯ | - | ä»é¡¹ç›®åˆ—è¡¨é€‰æ‹© |
| 4 | trans_reason | æŠ¥é”€åŸå›  | TEXTAREA | æ˜¯ | - | è‡³å°‘10ä¸ªå­— |
| 5 | **phone_number** | **æ‰‹æœºå·ç ** | **TEXT** | **æ˜¯** | **å½“å‰ç”¨æˆ·æ‰‹æœºå·** | **æ‰‹æœºå·æ ¼å¼** |
| 6 | invoice_page_count | å‘ç¥¨é¡µæ•° | NUMBER | æ˜¯ | 0 | æ•´æ•° |
| 7 | invoice_count | å‘ç¥¨å¼ æ•° | NUMBER | æ˜¯ | 0 | æ•´æ•° |

#### ä¸ªäººé€šè®¯ç‰¹æœ‰å­—æ®µ
**phone_number**: å¿…å¡«å­—æ®µ,éªŒè¯æ‰‹æœºå·æ ¼å¼,å¯ä»ç”¨æˆ·ç®¡ç†è‡ªåŠ¨è·å–

#### è´¹ç”¨æ˜ç»†å­—æ®µ(item_blockå­è¡¨)
ä¸ç±»å‹1ç›¸åŒ,ä½¿ç”¨é€šç”¨çš„è´¹ç”¨æ˜ç»†ç»“æ„

---

### ç±»å‹6: ä¸šåŠ¡æ´»åŠ¨ (BUSINESS_ACTIVITY)

#### ç±»å‹åŸºæœ¬ä¿¡æ¯
```json
{
  "type_code": "BUSINESS_ACTIVITY",
  "type_name": "ä¸šåŠ¡æ´»åŠ¨",
  "type_desc": "ä¸šåŠ¡æ´»åŠ¨è´¹ç”¨æŠ¥é”€",
  "type_icon": "gift",
  "type_order": 6
}
```

#### å­—æ®µé…ç½®
ä¸ç±»å‹1(ä¸€èˆ¬è´¹ç”¨)å®Œå…¨ç›¸åŒ,å­—æ®µé…ç½®å¯ä»¥å¤ç”¨

---

## ğŸ–¥ï¸ 5ä¸ªä¸»è¦åŠŸèƒ½è¯¦ç»†è®¾è®¡

### åŠŸèƒ½1: æ–°å»ºæŠ¥é”€å• (NEW_REIMBURSEMENT)

#### åŠŸèƒ½æ¦‚è¿°
åˆ›å»ºæ–°çš„æŠ¥é”€ç”³è¯·,æ”¯æŒ6ç§æŠ¥é”€ç±»å‹,åŠ¨æ€è¡¨å•æ¸²æŸ“

#### å‰ç«¯é¡µé¢è®¾è®¡

**é¡µé¢è·¯ç”±**: `/reimbursement/new`  
**é¡µé¢æ ‡é¢˜**: æ–°å»ºæŠ¥é”€

**é¡µé¢å¸ƒå±€**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ–°å»ºæŠ¥é”€                              [è¿”å›]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚  æ­¥éª¤:                                          â”‚
â”‚  â‘  é€‰æ‹©ç±»å‹ â†’ â‘¡ å¡«å†™ä¿¡æ¯ â†’ â‘¢ ä¸Šä¼ é™„ä»¶ â†’ â‘£ æäº¤  â”‚
â”‚                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚  å½“å‰æ­¥éª¤: â‘  é€‰æ‹©æŠ¥é”€ç±»å‹                       â”‚
â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚         â”‚ â”‚         â”‚ â”‚         â”‚          â”‚
â”‚  â”‚ ğŸ’°      â”‚ â”‚ âœˆï¸      â”‚ â”‚ ğŸ‘¥      â”‚          â”‚
â”‚  â”‚ä¸€èˆ¬è´¹ç”¨  â”‚ â”‚å·®æ—…æŠ¥é”€  â”‚ â”‚å›¢å»ºè´¹ç”¨  â”‚          â”‚
â”‚  â”‚         â”‚ â”‚         â”‚ â”‚         â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚         â”‚ â”‚         â”‚ â”‚         â”‚          â”‚
â”‚  â”‚ ğŸš—      â”‚ â”‚ ğŸ“±      â”‚ â”‚ ğŸ      â”‚          â”‚
â”‚  â”‚å¸‚å†…äº¤é€š  â”‚ â”‚ä¸ªäººé€šè®¯  â”‚ â”‚ä¸šåŠ¡æ´»åŠ¨  â”‚          â”‚
â”‚  â”‚         â”‚ â”‚         â”‚ â”‚         â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                 â”‚
â”‚  [ä¸‹ä¸€æ­¥]                                       â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ­¥éª¤1: é€‰æ‹©æŠ¥é”€ç±»å‹
- å±•ç¤º6ç§æŠ¥é”€ç±»å‹å¡ç‰‡
- æ¯ä¸ªå¡ç‰‡åŒ…å«: ç±»å‹å›¾æ ‡ã€ç±»å‹åç§°ã€ç±»å‹æè¿°
- ç‚¹å‡»å¡ç‰‡è¿›å…¥ä¸‹ä¸€æ­¥
- æ”¯æŒç±»å‹ç­›é€‰: å…¨éƒ¨/å¸¸ç”¨/å…¨éƒ¨ç±»å‹

#### æ­¥éª¤2: å¡«å†™ä¿¡æ¯
**è¡¨å•æ¸²æŸ“å¼•æ“å·¥ä½œæµç¨‹**:

1. **å‰ç«¯APIè°ƒç”¨**:
   ```
   GET /api/reimbursement/types/{typeCode}/form-config
   ```
   
2. **åç«¯è¿”å›è¡¨å•é…ç½®**:
   ```json
   {
     "type_code": "TRAVEL",
     "type_name": "å·®æ—…æŠ¥é”€",
     "form_groups": [
       {
         "group_name": "åŸºæœ¬ä¿¡æ¯",
         "group_order": 1,
         "fields": [
           {
             "field_code": "trans_no",
             "field_name": "ç”³è¯·å•å·",
             "field_type": "TEXT",
             "is_readonly": true,
             "default_value": "BX202501240001",
             "grid_col": 12,
             "form_order": 1
           },
           {
             "field_code": "dept_id",
             "field_name": "æ‰€å±éƒ¨é—¨",
             "field_type": "ORG_SELECTOR",
             "is_required": true,
             "data_source": {
               "api": "/api/org/tree",
               "selectable": "leaf_only"
             },
             "grid_col": 12,
             "form_order": 2
           }
         ]
       },
       {
         "group_name": "å·®æ—…ä¿¡æ¯",
         "group_order": 2,
         "fields": [
           {
             "field_code": "start_date",
             "field_name": "å‡ºå·®å¼€å§‹æ—¥æœŸ",
             "field_type": "DATE",
             "is_required": true,
             "linkage_rules": {
               "affects": ["end_date"],
               "rule": "min_date"
             },
             "grid_col": 12,
             "form_order": 1
           }
         ]
       }
     ]
   }
   ```

3. **å‰ç«¯åŠ¨æ€æ¸²æŸ“è¡¨å•**:
   - æ ¹æ® `form_groups` å’Œ `fields` é…ç½®é€’å½’æ¸²æŸ“è¡¨å•
   - æ ¹æ® `field_type` é€‰æ‹©å¯¹åº”çš„ç»„ä»¶
   - æ ¹æ® `data_source` é…ç½®åŠ è½½ä¸‹æ‹‰é€‰é¡¹
   - æ ¹æ® `linkage_rules` é…ç½®å®ç°å­—æ®µè”åŠ¨

#### æ­¥éª¤3: ä¸Šä¼ é™„ä»¶
- æ”¯æŒå¤šæ–‡ä»¶ä¸Šä¼ 
- æ–‡ä»¶ç±»å‹é™åˆ¶: PDF, JPG, PNG, DOC, DOCX, XLS, XLSX
- å•æ–‡ä»¶å¤§å°é™åˆ¶: 50MB
- æ€»å¤§å°é™åˆ¶: 100MB
- æ”¯æŒæ‹–æ‹½ä¸Šä¼ 
- ä¸Šä¼ åˆ°MinIO
- å®æ—¶æ˜¾ç¤ºä¸Šä¼ è¿›åº¦

#### æ­¥éª¤4: æäº¤å®¡æ‰¹
- æäº¤å‰æ•°æ®éªŒè¯:
  - è¡¨å•å­—æ®µéªŒè¯
  - æ˜ç»†é‡‘é¢éªŒè¯
  - é™„ä»¶å®Œæ•´æ€§éªŒè¯
  - å€Ÿæ¬¾æŠµæ‰£éªŒè¯
  
- æäº¤ç¡®è®¤å¯¹è¯æ¡†:
  ```
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  ç¡®è®¤æäº¤æŠ¥é”€å•                       â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  
  æŠ¥é”€å•å·: BX202501240001
  æŠ¥é”€ç±»å‹: å·®æ—…æŠ¥é”€
  æŠ¥é”€é‡‘é¢: Â¥5,000.00
  å€Ÿæ¬¾æŠµæ‰£: Â¥2,000.00
  å®ä»˜é‡‘é¢: Â¥3,000.00
  
  æäº¤åå°†å¯åŠ¨å®¡æ‰¹æµç¨‹,ç¡®è®¤æäº¤?
  
  [å–æ¶ˆ] [ç¡®è®¤æäº¤]
  ```

#### å‰ç«¯APIè®¾è®¡

```typescript
// APIæ¥å£å®šä¹‰
interface ReimbursementAPI {
  // è·å–æ‰€æœ‰å¯ç”¨çš„æŠ¥é”€ç±»å‹
  getTypes(): Promise<ReimbursementType[]>
  
  // è·å–æŒ‡å®šç±»å‹çš„è¡¨å•é…ç½®
  getTypeFormConfig(typeCode: string): Promise<FormConfig>
  
  // ç”ŸæˆæŠ¥é”€å•å·(é¢„è§ˆ)
  generateTransNo(): Promise<string>
  
  // ä¿å­˜è‰ç¨¿
  saveDraft(data: CreateReimbursementDTO): Promise<number>
  
  // æäº¤å®¡æ‰¹
  submitReimbursement(data: CreateReimbursementDTO): Promise<number>
  
  // ä¸Šä¼ é™„ä»¶
  uploadAttachment(file: File, transId: number): Promise<Attachment>
  
  // åˆ é™¤é™„ä»¶
  deleteAttachment(attachId: number): Promise<void>
  
  // è·å–å¯æŠµæ‰£å€Ÿæ¬¾åˆ—è¡¨
  getOffsetLoans(applicantId: number): Promise<Loan[]>
}

// æ•°æ®ä¼ è¾“å¯¹è±¡
interface CreateReimbursementDTO {
  type_code: string
  dept_id: number
  project_id: number
  trans_reason: string
  contact_phone?: string
  invoice_page_count: number
  invoice_count: number
  // ç±»å‹ç‰¹å®šå­—æ®µ(åŠ¨æ€)
  ext_fields: Record<string, any>
  // è´¹ç”¨æ˜ç»†
  items: CreateTransItemDTO[]
  // å€Ÿæ¬¾æŠµæ‰£
  loan_offset_ids?: number[]
  // é™„ä»¶
  attachment_ids: number[]
}

interface CreateTransItemDTO {
  item_no: number
  expense_date: string
  city_id?: number
  charge: number
  currency: string
  exchange_rate: number
  lc_charge: number
  item_desc: string
  // å·®æ—…ç±»å‹å­è´¹ç”¨(ä»…ç±»å‹2)
  sub_expenses?: CreateSubExpenseDTO[]
}

interface CreateSubExpenseDTO {
  sub_expense_type: string
  charge: number
  lc_charge: number
  item_desc: string
}
```

#### åç«¯APIè®¾è®¡

```java
// Controller
@RestController
@RequestMapping("/api/reimbursement")
@RequiredArgsConstructor
public class ReimbursementController {
    
    private final ReimbursementService reimbursementService;
    
    /**
     * è·å–æ‰€æœ‰å¯ç”¨çš„æŠ¥é”€ç±»å‹
     */
    @GetMapping("/types")
    public Result<List<ReimbursementTypeVO>> getTypes() {
        List<ReimbursementTypeVO> types = reimbursementService.getActiveTypes();
        return Result.success(types);
    }
    
    /**
     * è·å–æŒ‡å®šç±»å‹çš„è¡¨å•é…ç½®
     */
    @GetMapping("/types/{typeCode}/form-config")
    public Result<FormConfigVO> getTypeFormConfig(
            @PathVariable String typeCode) {
        FormConfigVO config = reimbursementService.getTypeFormConfig(typeCode);
        return Result.success(config);
    }
    
    /**
     * ç”ŸæˆæŠ¥é”€å•å·
     */
    @GetMapping("/trans-no")
    public Result<String> generateTransNo() {
        String transNo = reimbursementService.generateTransNo();
        return Result.success(transNo);
    }
    
    /**
     * ä¿å­˜è‰ç¨¿
     */
    @PostMapping("/draft")
    public Result<Long> saveDraft(
            @Valid @RequestBody CreateReimbursementDTO dto) {
        Long transId = reimbursementService.saveDraft(dto);
        return Result.success(transId);
    }
    
    /**
     * æäº¤å®¡æ‰¹
     */
    @PostMapping("/submit")
    public Result<Long> submitReimbursement(
            @Valid @RequestBody CreateReimbursementDTO dto) {
        Long transId = reimbursementService.submitReimbursement(dto);
        return Result.success(transId);
    }
    
    /**
     * ä¸Šä¼ é™„ä»¶
     */
    @PostMapping("/upload")
    public Result<AttachmentVO> uploadAttachment(
            @RequestParam("file") MultipartFile file,
            @RequestParam("transId") Long transId) {
        AttachmentVO attachment = reimbursementService.uploadAttachment(file, transId);
        return Result.success(attachment);
    }
    
    /**
     * è·å–å¯æŠµæ‰£å€Ÿæ¬¾åˆ—è¡¨
     */
    @GetMapping("/offset-loans")
    public Result<List<LoanVO>> getOffsetLoans(
            @RequestParam Long applicantId) {
        List<LoanVO> loans = reimbursementService.getOffsetLoans(applicantId);
        return Result.success(loans);
    }
}

// Serviceæ¥å£
public interface ReimbursementService {
    
    /**
     * è·å–æ‰€æœ‰å¯ç”¨çš„æŠ¥é”€ç±»å‹
     */
    List<ReimbursementTypeVO> getActiveTypes();
    
    /**
     * è·å–æŒ‡å®šç±»å‹çš„è¡¨å•é…ç½®
     */
    FormConfigVO getTypeFormConfig(String typeCode);
    
    /**
     * ç”ŸæˆæŠ¥é”€å•å·
     */
    String generateTransNo();
    
    /**
     * ä¿å­˜è‰ç¨¿
     */
    Long saveDraft(CreateReimbursementDTO dto);
    
    /**
     * æäº¤å®¡æ‰¹
     */
    Long submitReimbursement(CreateReimbursementDTO dto);
    
    /**
     * ä¸Šä¼ é™„ä»¶
     */
    AttachmentVO uploadAttachment(MultipartFile file, Long transId);
    
    /**
     * è·å–å¯æŠµæ‰£å€Ÿæ¬¾åˆ—è¡¨
     */
    List<LoanVO> getOffsetLoans(Long applicantId);
}
```

#### ä¸šåŠ¡é€»è¾‘æµç¨‹

```mermaid
sequenceDiagram
    participant User
    participant Frontend
    participant Backend
    participant Flowable
    participant Database
    
    User->>Frontend: ç‚¹å‡»"æ–°å»ºæŠ¥é”€"
    Frontend->>Backend: GET /api/reimbursement/types
    Backend->>Database: æŸ¥è¯¢å¯ç”¨çš„æŠ¥é”€ç±»å‹
    Database-->>Backend: è¿”å›ç±»å‹åˆ—è¡¨
    Backend-->>Frontend: è¿”å›ç±»å‹åˆ—è¡¨
    Frontend-->>User: å±•ç¤ºç±»å‹é€‰æ‹©é¡µé¢
    
    User->>Frontend: é€‰æ‹©"å·®æ—…æŠ¥é”€"
    Frontend->>Backend: GET /api/reimbursement/types/TRAVEL/form-config
    Backend->>Database: æŸ¥è¯¢ç±»å‹å­—æ®µé…ç½®
    Database-->>Backend: è¿”å›å­—æ®µé…ç½®
    Backend-->>Frontend: è¿”å›è¡¨å•é…ç½®
    Frontend-->>User: åŠ¨æ€æ¸²æŸ“è¡¨å•
    
    User->>Frontend: å¡«å†™è¡¨å•
    User->>Frontend: ä¸Šä¼ é™„ä»¶
    Frontend->>Backend: POST /api/reimbursement/upload
    Backend->>Database: ä¿å­˜é™„ä»¶ä¿¡æ¯
    Database-->>Backend: è¿”å›é™„ä»¶ID
    Backend-->>Frontend: è¿”å›ä¸Šä¼ ç»“æœ
    
    User->>Frontend: ç‚¹å‡»"æäº¤å®¡æ‰¹"
    Frontend->>Frontend: è¡¨å•éªŒè¯
    Frontend->>Backend: POST /api/reimbursement/submit
    Backend->>Backend: æ•°æ®éªŒè¯
    Backend->>Database: å¼€å¯äº‹åŠ¡
    Backend->>Database: ä¿å­˜æŠ¥é”€å•ä¸»è¡¨
    Backend->>Database: ä¿å­˜æŠ¥é”€å•æ˜ç»†
    Backend->>Database: ä¿å­˜å­è´¹ç”¨(å¦‚æœç±»å‹2)
    Backend->>Database: ä¿å­˜æ‰©å±•å­—æ®µ
    Backend->>Database: ä¿å­˜å€Ÿæ¬¾æŠµæ‰£
    Backend->>Flowable: å¯åŠ¨å·¥ä½œæµ
    Flowable-->>Backend: è¿”å›æµç¨‹å®ä¾‹ID
    Backend->>Database: æ›´æ–°æŠ¥é”€å•çŠ¶æ€
    Backend->>Database: æäº¤äº‹åŠ¡
    Backend-->>Frontend: è¿”å›æŠ¥é”€å•ID
    Frontend-->>User: æäº¤æˆåŠŸæç¤º
```

---

### åŠŸèƒ½2: å¾…æˆ‘å®¡æ‰¹ (PENDING_APPROVAL)

#### åŠŸèƒ½æ¦‚è¿°
æŸ¥çœ‹å¹¶å®¡æ‰¹åˆ†é…ç»™æˆ‘çš„æŠ¥é”€å•

#### å‰ç«¯é¡µé¢è®¾è®¡

**é¡µé¢è·¯ç”±**: `/reimbursement/pending`  
**é¡µé¢æ ‡é¢˜**: å¾…æˆ‘å®¡æ‰¹

**é¡µé¢å¸ƒå±€**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¾…æˆ‘å®¡æ‰¹                          åˆ·æ–° | å¯¼å‡º        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  æœç´¢:  [å•å·/ç”³è¯·äºº/åŸå›  _____________] [æœç´¢]    â”‚
â”‚  ç­›é€‰:  [ç±»å‹â–¼] [éƒ¨é—¨â–¼] [æ—¥æœŸèŒƒå›´ â–¼]               â”‚
â”‚                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  BX202501240001  å·®æ—…æŠ¥é”€      Â¥5,000.00       â”‚â”‚
â”‚  â”‚  ç”³è¯·äºº: å¼ ä¸‰  éƒ¨é—¨: ç ”å‘éƒ¨                     â”‚â”‚
â”‚  â”‚  æŠ¥é”€åŸå› : åŒ—äº¬å‡ºå·®è´¹ç”¨                          â”‚â”‚
â”‚  â”‚  æäº¤æ—¶é—´: 2025-01-24 10:30                    â”‚â”‚
â”‚  â”‚  å½“å‰èŠ‚ç‚¹: éƒ¨é—¨ç»ç†å®¡æ‰¹                         â”‚â”‚
â”‚  â”‚                                [æŸ¥çœ‹] [å®¡æ‰¹]    â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  BX202501230002  ä¸€èˆ¬è´¹ç”¨      Â¥2,500.00       â”‚â”‚
â”‚  â”‚  ç”³è¯·äºº: æå››  éƒ¨é—¨: å¸‚åœºéƒ¨                     â”‚â”‚
â”‚  â”‚  æŠ¥é”€åŸå› : å®¢æˆ·æ‹›å¾…è´¹ç”¨                          â”‚â”‚
â”‚  â”‚  æäº¤æ—¶é—´: 2025-01-23 15:20                    â”‚â”‚
â”‚  â”‚  å½“å‰èŠ‚ç‚¹: è´¢åŠ¡å®¡æ‰¹                             â”‚â”‚
â”‚  â”‚                                [æŸ¥çœ‹] [å®¡æ‰¹]    â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                     â”‚
â”‚  å…± 2 æ¡å¾…å®¡æ‰¹è®°å½•  < 1 2 3 >                      â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å®¡æ‰¹å¯¹è¯æ¡†
ç‚¹å‡»"å®¡æ‰¹"æŒ‰é’®å¼¹å‡ºå®¡æ‰¹å¯¹è¯æ¡†:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¡æ‰¹æŠ¥é”€å•                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  æŠ¥é”€å•å·: BX202501240001                â”‚
â”‚  æŠ¥é”€ç±»å‹: å·®æ—…æŠ¥é”€                       â”‚
â”‚  ç”³è¯·äºº: å¼ ä¸‰                             â”‚
â”‚  æŠ¥é”€é‡‘é¢: Â¥5,000.00                     â”‚
â”‚  æŠ¥é”€åŸå› : åŒ—äº¬å‡ºå·®è´¹ç”¨                    â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æŠ¥é”€æ˜ç»†:                          â”‚ â”‚
â”‚  â”‚ 2025-01-20  åŒ—äº¬  ä½å®¿è´¹ Â¥800.00   â”‚ â”‚
â”‚  â”‚ 2025-01-20  åŒ—äº¬  äº¤é€šè´¹ Â¥500.00   â”‚ â”‚
â”‚  â”‚ 2025-01-20  åŒ—äº¬  é€šè®¯è´¹ Â¥200.00   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚  å®¡æ‰¹æ„è§:                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                   â”‚ â”‚
â”‚  â”‚                                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚  [é©³å›] [é€šè¿‡] [è½¬åŠ] [åŠ ç­¾]            â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å‰ç«¯APIè®¾è®¡

```typescript
interface PendingApprovalAPI {
  // è·å–å¾…å®¡æ‰¹åˆ—è¡¨
  getPendingList(params: QueryParams): Promise<PageResult<TransVO>>
  
  // è·å–æŠ¥é”€å•è¯¦æƒ…(å«æµç¨‹ä¿¡æ¯)
  getDetailForApproval(transId: number): Promise<TransDetailVO>
  
  // å®¡æ‰¹é€šè¿‡
  approve(transId: number, comment: string): Promise<void>
  
  // å®¡æ‰¹é©³å›
  reject(transId: number, reason: string): Promise<void>
  
  // å®¡æ‰¹è½¬åŠ
  transfer(transId: number, targetUserId: number, comment: string): Promise<void>
  
  // å®¡æ‰¹åŠ ç­¾
  addSign(transId: number, userIds: number[], comment: string): Promise<void>
  
  // è·å–å®¡æ‰¹å†å²
  getApprovalHistory(transId: number): Promise<ApprovalHistoryVO[]>
}

// æŸ¥è¯¢å‚æ•°
interface QueryParams {
  trans_no?: string
  type_code?: string
  dept_id?: number
  applicant_id?: number
  date_start?: string
  date_end?: string
  page: number
  size: number
}
```

#### åç«¯APIè®¾è®¡

```java
@RestController
@RequestMapping("/api/reimbursement/approval")
@RequiredArgsConstructor
public class ApprovalController {
    
    private final ApprovalService approvalService;
    
    /**
     * è·å–å¾…å®¡æ‰¹åˆ—è¡¨
     */
    @GetMapping("/pending")
    public Result<PageResult<TransVO>> getPendingList(
            @Valid QueryParamsDTO params) {
        PageResult<TransVO> result = approvalService.getPendingList(params);
        return Result.success(result);
    }
    
    /**
     * è·å–æŠ¥é”€å•è¯¦æƒ…(å«æµç¨‹ä¿¡æ¯)
     */
    @GetMapping("/detail/{transId}")
    public Result<TransDetailVO> getDetail(
            @PathVariable Long transId) {
        TransDetailVO detail = approvalService.getDetail(transId);
        return Result.success(detail);
    }
    
    /**
     * å®¡æ‰¹é€šè¿‡
     */
    @PostMapping("/approve")
    public Result<Void> approve(
            @RequestBody ApprovalDTO dto) {
        approvalService.approve(dto);
        return Result.success();
    }
    
    /**
     * å®¡æ‰¹é©³å›
     */
    @PostMapping("/reject")
    public Result<Void> reject(
            @RequestBody RejectDTO dto) {
        approvalService.reject(dto);
        return Result.success();
    }
    
    /**
     * å®¡æ‰¹è½¬åŠ
     */
    @PostMapping("/transfer")
    public Result<Void> transfer(
            @RequestBody TransferDTO dto) {
        approvalService.transfer(dto);
        return Result.success();
    }
    
    /**
     * å®¡æ‰¹åŠ ç­¾
     */
    @PostMapping("/add-sign")
    public Result<Void> addSign(
            @RequestBody AddSignDTO dto) {
        approvalService.addSign(dto);
        return Result.success();
    }
    
    /**
     * è·å–å®¡æ‰¹å†å²
     */
    @GetMapping("/history/{transId}")
    public Result<List<ApprovalHistoryVO>> getHistory(
            @PathVariable Long transId) {
        List<ApprovalHistoryVO> history = approvalService.getHistory(transId);
        return Result.success(history);
    }
}

// æ•°æ®ä¼ è¾“å¯¹è±¡
@RequiredArgsConstructor
public class ApprovalDTO {
    private Long transId;
    private String comment;
}

@RequiredArgsConstructor
public class RejectDTO {
    private Long transId;
    private String reason;
}

@RequiredArgsConstructor
public class TransferDTO {
    private Long transId;
    private Long targetUserId;
    private String comment;
}

@RequiredArgsConstructor
public class AddSignDTO {
    private Long transId;
    private List<Long> userIds;
    private String comment;
}
```

#### ä¸šåŠ¡é€»è¾‘æµç¨‹

```mermaid
sequenceDiagram
    participant User
    participant Frontend
    participant Backend
    participant Flowable
    participant Database
    
    User->>Frontend: è¿›å…¥"å¾…æˆ‘å®¡æ‰¹"é¡µé¢
    Frontend->>Backend: GET /api/reimbursement/approval/pending
    Backend->>Flowable: æŸ¥è¯¢å½“å‰ç”¨æˆ·çš„å¾…åŠä»»åŠ¡
    Flowable-->>Backend: è¿”å›ä»»åŠ¡åˆ—è¡¨
    Backend->>Database: å…³è”æŸ¥è¯¢æŠ¥é”€å•è¯¦æƒ…
    Database-->>Backend: è¿”å›æŠ¥é”€å•æ•°æ®
    Backend-->>Frontend: è¿”å›å¾…å®¡æ‰¹åˆ—è¡¨
    Frontend-->>User: å±•ç¤ºå¾…å®¡æ‰¹åˆ—è¡¨
    
    User->>Frontend: ç‚¹å‡»"å®¡æ‰¹"
    Frontend->>Backend: GET /api/reimbursement/approval/detail/{transId}
    Backend->>Database: æŸ¥è¯¢æŠ¥é”€å•è¯¦æƒ…
    Backend->>Flowable: æŸ¥è¯¢æµç¨‹å†å²
    Database-->>Backend: è¿”å›è¯¦æƒ…æ•°æ®
    Flowable-->>Backend: è¿”å›æµç¨‹å†å²
    Backend-->>Frontend: è¿”å›å®Œæ•´è¯¦æƒ…
    Frontend-->>User: å±•ç¤ºå®¡æ‰¹å¯¹è¯æ¡†
    
    User->>Frontend: å¡«å†™å®¡æ‰¹æ„è§,ç‚¹å‡»"é€šè¿‡"
    Frontend->>Backend: POST /api/reimbursement/approval/approve
    Backend->>Backend: æ•°æ®éªŒè¯
    Backend->>Flowable: å®Œæˆä»»åŠ¡
    Flowable->>Flowable: æ¨è¿›æµç¨‹
    Backend->>Database: æ›´æ–°æŠ¥é”€å•çŠ¶æ€
    Backend->>Database: è®°å½•å®¡æ‰¹å†å²
    Backend-->>Frontend: å®¡æ‰¹æˆåŠŸ
    Frontend-->>User: æç¤ºå®¡æ‰¹æˆåŠŸ
    Frontend->>Frontend: åˆ·æ–°å¾…å®¡æ‰¹åˆ—è¡¨
```

---

### åŠŸèƒ½3: æˆ‘çš„æŠ¥é”€ (MY_REIMBURSEMENT)

#### åŠŸèƒ½æ¦‚è¿°
æŸ¥çœ‹æˆ‘æäº¤çš„æ‰€æœ‰æŠ¥é”€å•

#### å‰ç«¯é¡µé¢è®¾è®¡

**é¡µé¢è·¯ç”±**: `/reimbursement/my`  
**é¡µé¢æ ‡é¢˜**: æˆ‘çš„æŠ¥é”€

**é¡µé¢å¸ƒå±€**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æˆ‘çš„æŠ¥é”€                          åˆ·æ–° | å¯¼å‡º        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  çŠ¶æ€ç­›é€‰:                                          â”‚
â”‚  [å…¨éƒ¨(12)] [è‰ç¨¿(2)] [å®¡æ‰¹ä¸­(5)] [å·²é€šè¿‡(3)] [å·²é©³å›(2)] â”‚
â”‚                                                     â”‚
â”‚  æœç´¢:  [å•å·/åŸå›  _____________] [æœç´¢]            â”‚
â”‚  ç­›é€‰:  [ç±»å‹â–¼] [éƒ¨é—¨â–¼] [æ—¥æœŸèŒƒå›´ â–¼]               â”‚
â”‚                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  BX202501240001  å·®æ—…æŠ¥é”€      Â¥5,000.00       â”‚â”‚
â”‚  â”‚  2025-01-24 10:30  å®¡æ‰¹ä¸­                      â”‚â”‚
â”‚  â”‚  æŠ¥é”€åŸå› : åŒ—äº¬å‡ºå·®è´¹ç”¨                          â”‚â”‚
â”‚  â”‚  å½“å‰èŠ‚ç‚¹: éƒ¨é—¨ç»ç†å®¡æ‰¹                         â”‚â”‚
â”‚  â”‚              [æŸ¥çœ‹] [æ’¤å›]                     â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  BX202501230002  ä¸€èˆ¬è´¹ç”¨      Â¥2,500.00       â”‚â”‚
â”‚  â”‚  2025-01-23 15:20  å·²é€šè¿‡                      â”‚â”‚
â”‚  â”‚  æŠ¥é”€åŸå› : å®¢æˆ·æ‹›å¾…è´¹ç”¨                          â”‚â”‚
â”‚  â”‚  å®¡æ‰¹äºº: å¼ ç»ç†                                â”‚â”‚
â”‚  â”‚              [æŸ¥çœ‹]                           â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  BX202501220003  å›¢å»ºè´¹ç”¨      Â¥3,000.00       â”‚â”‚
â”‚  â”‚  2025-01-22 09:15  å·²é©³å›                      â”‚â”‚
â”‚  â”‚  æŠ¥é”€åŸå› : å›¢é˜Ÿå»ºè®¾è´¹ç”¨                          â”‚â”‚
â”‚  â”‚  é©³å›åŸå› : é™„ä»¶ä¸å®Œæ•´                            â”‚â”‚
â”‚  â”‚              [æŸ¥çœ‹] [é‡æ–°æäº¤]                 â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                     â”‚
â”‚  å…± 12 æ¡è®°å½•  < 1 2 3 >                           â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å‰ç«¯APIè®¾è®¡

```typescript
interface MyReimbursementAPI {
  // è·å–æˆ‘çš„æŠ¥é”€åˆ—è¡¨
  getMyList(params: QueryParams): Promise<PageResult<TransVO>>
  
  // è·å–æŠ¥é”€å•è¯¦æƒ…
  getDetail(transId: number): Promise<TransDetailVO>
  
  // æ’¤å›æŠ¥é”€å•
  withdraw(transId: number, reason: string): Promise<void>
  
  // é‡æ–°æäº¤(ä»é©³å›çŠ¶æ€)
  resubmit(transId: number, data: UpdateReimbursementDTO): Promise<void>
  
  // åˆ é™¤è‰ç¨¿
  deleteDraft(transId: number): Promise<void>
}
```

#### åç«¯APIè®¾è®¡

```java
@RestController
@RequestMapping("/api/reimbursement/my")
@RequiredArgsConstructor
public class MyReimbursementController {
    
    private final MyReimbursementService myReimbursementService;
    
    /**
     * è·å–æˆ‘çš„æŠ¥é”€åˆ—è¡¨
     */
    @GetMapping("/list")
    public Result<PageResult<TransVO>> getMyList(
            @Valid QueryParamsDTO params) {
        PageResult<TransVO> result = myReimbursementService.getMyList(params);
        return Result.success(result);
    }
    
    /**
     * è·å–æŠ¥é”€å•è¯¦æƒ…
     */
    @GetMapping("/detail/{transId}")
    public Result<TransDetailVO> getDetail(
            @PathVariable Long transId) {
        TransDetailVO detail = myReimbursementService.getDetail(transId);
        return Result.success(detail);
    }
    
    /**
     * æ’¤å›æŠ¥é”€å•
     */
    @PostMapping("/withdraw")
    public Result<Void> withdraw(
            @RequestBody WithdrawDTO dto) {
        myReimbursementService.withdraw(dto);
        return Result.success();
    }
    
    /**
     * é‡æ–°æäº¤
     */
    @PostMapping("/resubmit")
    public Result<Void> resubmit(
            @RequestBody UpdateReimbursementDTO dto) {
        myReimbursementService.resubmit(dto);
        return Result.success();
    }
    
    /**
     * åˆ é™¤è‰ç¨¿
     */
    @DeleteMapping("/draft/{transId}")
    public Result<Void> deleteDraft(
            @PathVariable Long transId) {
        myReimbursementService.deleteDraft(transId);
        return Result.success();
    }
}
```

---

### åŠŸèƒ½4: å·²å¤„ç†æŠ¥é”€ (PROCESSED_REIMBURSEMENT)

#### åŠŸèƒ½æ¦‚è¿°
æŸ¥çœ‹å·²å®¡æ‰¹å®Œæˆçš„æŠ¥é”€å•å†å²

#### å‰ç«¯é¡µé¢è®¾è®¡

**é¡µé¢è·¯ç”±**: `/reimbursement/processed`  
**é¡µé¢æ ‡é¢˜**: å·²å¤„ç†æŠ¥é”€

**é¡µé¢å¸ƒå±€**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å·²å¤„ç†æŠ¥é”€                       åˆ·æ–° | å¯¼å‡º | æ‰“å° â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  æœç´¢:  [å•å·/ç”³è¯·äºº/åŸå›  _____________] [æœç´¢]    â”‚
â”‚  ç­›é€‰:  [ç±»å‹â–¼] [éƒ¨é—¨â–¼] [çŠ¶æ€â–¼] [æ—¥æœŸèŒƒå›´ â–¼]      â”‚
â”‚                                                     â”‚
â”‚  ç»Ÿè®¡:                                             â”‚
â”‚  æœ¬æœˆå·²å¤„ç†: 45ç¬”  é‡‘é¢: Â¥125,000.00              â”‚
â”‚                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  BX202501240001  å·®æ—…æŠ¥é”€      Â¥5,000.00       â”‚â”‚
â”‚  â”‚  ç”³è¯·äºº: å¼ ä¸‰  éƒ¨é—¨: ç ”å‘éƒ¨                     â”‚â”‚
â”‚  â”‚  çŠ¶æ€: å·²ç»“ç®—  ç»“ç®—æ—¥æœŸ: 2025-01-25            â”‚â”‚
â”‚  â”‚  æŠ¥é”€åŸå› : åŒ—äº¬å‡ºå·®è´¹ç”¨                          â”‚â”‚
â”‚  â”‚              [æŸ¥çœ‹] [æ‰“å°]                      â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  BX202501230002  ä¸€èˆ¬è´¹ç”¨      Â¥2,500.00       â”‚â”‚
â”‚  â”‚  ç”³è¯·äºº: æå››  éƒ¨é—¨: å¸‚åœºéƒ¨                     â”‚â”‚
â”‚  â”‚  çŠ¶æ€: å·²ç»“ç®—  ç»“ç®—æ—¥æœŸ: 2025-01-24            â”‚â”‚
â”‚  â”‚  æŠ¥é”€åŸå› : å®¢æˆ·æ‹›å¾…è´¹ç”¨                          â”‚â”‚
â”‚  â”‚              [æŸ¥çœ‹] [æ‰“å°]                      â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                     â”‚
â”‚  å…± 45 æ¡è®°å½•  < 1 2 3 4 5 >                      â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å‰ç«¯APIè®¾è®¡

```typescript
interface ProcessedReimbursementAPI {
  // è·å–å·²å¤„ç†åˆ—è¡¨
  getProcessedList(params: QueryParams): Promise<PageResult<TransVO>>
  
  // è·å–ç»Ÿè®¡ä¿¡æ¯
  getStatistics(params: StatisticsParams): Promise<StatisticsVO>
  
  // è·å–æŠ¥é”€å•è¯¦æƒ…
  getDetail(transId: number): Promise<TransDetailVO>
  
  // æ‰“å°æŠ¥é”€å•
  print(transId: number): Promise<Blob>
  
  // å¯¼å‡ºExcel
  exportExcel(params: QueryParams): Promise<Blob>
}
```

#### åç«¯APIè®¾è®¡

```java
@RestController
@RequestMapping("/api/reimbursement/processed")
@RequiredArgsConstructor
public class ProcessedReimbursementController {
    
    private final ProcessedReimbursementService processedReimbursementService;
    
    /**
     * è·å–å·²å¤„ç†åˆ—è¡¨
     */
    @GetMapping("/list")
    public Result<PageResult<TransVO>> getProcessedList(
            @Valid QueryParamsDTO params) {
        PageResult<TransVO> result = processedReimbursementService.getProcessedList(params);
        return Result.success(result);
    }
    
    /**
     * è·å–ç»Ÿè®¡ä¿¡æ¯
     */
    @GetMapping("/statistics")
    public Result<StatisticsVO> getStatistics(
            @Valid StatisticsParamsDTO params) {
        StatisticsVO statistics = processedReimbursementService.getStatistics(params);
        return Result.success(statistics);
    }
    
    /**
     * è·å–æŠ¥é”€å•è¯¦æƒ…
     */
    @GetMapping("/detail/{transId}")
    public Result<TransDetailVO> getDetail(
            @PathVariable Long transId) {
        TransDetailVO detail = processedReimbursementService.getDetail(transId);
        return Result.success(detail);
    }
    
    /**
     * æ‰“å°æŠ¥é”€å•
     */
    @GetMapping("/print/{transId}")
    public void print(
            @PathVariable Long transId,
            HttpServletResponse response) {
        processedReimbursementService.print(transId, response);
    }
    
    /**
     * å¯¼å‡ºExcel
     */
    @PostMapping("/export")
    public void exportExcel(
            @RequestBody QueryParamsDTO params,
            HttpServletResponse response) {
        processedReimbursementService.exportExcel(params, response);
    }
}
```

---

### åŠŸèƒ½5: æŠ¥é”€è‰ç¨¿ (DRAFT_REIMBURSEMENT)

#### åŠŸèƒ½æ¦‚è¿°
ç®¡ç†ä¿å­˜çš„è‰ç¨¿,æ”¯æŒç»§ç»­ç¼–è¾‘

#### å‰ç«¯é¡µé¢è®¾è®¡

**é¡µé¢è·¯ç”±**: `/reimbursement/draft`  
**é¡µé¢æ ‡é¢˜**: æŠ¥é”€è‰ç¨¿

**é¡µé¢å¸ƒå±€**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æŠ¥é”€è‰ç¨¿                          æ¸…ç†è¿‡æœŸè‰ç¨¿      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  å…± 3 æ¡è‰ç¨¿  (è‰ç¨¿ä¿ç•™30å¤©)                        â”‚
â”‚                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  BX202501240001  å·®æ—…æŠ¥é”€      Â¥5,000.00       â”‚â”‚
â”‚  â”‚  ä¿å­˜æ—¶é—´: 2025-01-24 10:30                     â”‚â”‚
â”‚  â”‚  æœ€åç¼–è¾‘: 2025-01-24 14:20                     â”‚â”‚
â”‚  â”‚  æŠ¥é”€åŸå› : åŒ—äº¬å‡ºå·®è´¹ç”¨                          â”‚â”‚
â”‚  â”‚  è¿›åº¦: å·²å¡«å†™åŸºæœ¬ä¿¡æ¯,æœªä¸Šä¼ é™„ä»¶                â”‚â”‚
â”‚  â”‚              [ç»§ç»­ç¼–è¾‘] [åˆ é™¤]                 â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  BX202501230002  ä¸€èˆ¬è´¹ç”¨      Â¥2,500.00       â”‚â”‚
â”‚  â”‚  ä¿å­˜æ—¶é—´: 2025-01-23 15:20                     â”‚â”‚
â”‚  â”‚  æœ€åç¼–è¾‘: 2025-01-23 15:20                     â”‚â”‚
â”‚  â”‚  æŠ¥é”€åŸå› : å®¢æˆ·æ‹›å¾…è´¹ç”¨                          â”‚â”‚
â”‚  â”‚  è¿›åº¦: å·²å¡«å†™åŸºæœ¬ä¿¡æ¯,å·²ä¸Šä¼ é™„ä»¶                â”‚â”‚
â”‚  â”‚              [ç»§ç»­ç¼–è¾‘] [åˆ é™¤]                 â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å‰ç«¯APIè®¾è®¡

```typescript
interface DraftReimbursementAPI {
  // è·å–è‰ç¨¿åˆ—è¡¨
  getDraftList(): Promise<TransVO[]>
  
  // åŠ è½½è‰ç¨¿
  loadDraft(transId: number): Promise<TransDetailVO>
  
  // ç»§ç»­ç¼–è¾‘(åŠ è½½è‰ç¨¿å¹¶è·³è½¬åˆ°ç¼–è¾‘é¡µé¢)
  continueEdit(transId: number): Promise<TransDetailVO>
  
  // åˆ é™¤è‰ç¨¿
  deleteDraft(transId: number): Promise<void>
  
  // æ¸…ç†è¿‡æœŸè‰ç¨¿
  cleanExpiredDrafts(): Promise<number>
}
```

#### åç«¯APIè®¾è®¡

```java
@RestController
@RequestMapping("/api/reimbursement/draft")
@RequiredArgsConstructor
public class DraftReimbursementController {
    
    private final DraftReimbursementService draftReimbursementService;
    
    /**
     * è·å–è‰ç¨¿åˆ—è¡¨
     */
    @GetMapping("/list")
    public Result<List<TransVO>> getDraftList() {
        List<TransVO> drafts = draftReimbursementService.getDraftList();
        return Result.success(drafts);
    }
    
    /**
     * åŠ è½½è‰ç¨¿
     */
    @GetMapping("/load/{transId}")
    public Result<TransDetailVO> loadDraft(
            @PathVariable Long transId) {
        TransDetailVO detail = draftReimbursementService.loadDraft(transId);
        return Result.success(detail);
    }
    
    /**
     * åˆ é™¤è‰ç¨¿
     */
    @DeleteMapping("/{transId}")
    public Result<Void> deleteDraft(
            @PathVariable Long transId) {
        draftReimbursementService.deleteDraft(transId);
        return Result.success();
    }
    
    /**
     * æ¸…ç†è¿‡æœŸè‰ç¨¿
     */
    @PostMapping("/clean")
    public Result<Integer> cleanExpiredDrafts() {
        int count = draftReimbursementService.cleanExpiredDrafts();
        return Result.success(count);
    }
}
```

---

## ğŸ¨ åŠ¨æ€è¡¨å•æ¸²æŸ“å¼•æ“è®¾è®¡

### æ¶æ„è®¾è®¡

```typescript
// è¡¨å•é…ç½®æ¥å£
interface FormConfig {
  type_code: string
  type_name: string
  form_groups: FormGroup[]
}

interface FormGroup {
  group_name: string
  group_order: number
  fields: Field[]
}

interface Field {
  field_code: string
  field_name: string
  field_type: FieldType
  is_required: boolean
  is_readonly: boolean
  is_visible: boolean
  is_editable: boolean
  default_value?: any
  placeholder?: string
  grid_col: number
  form_group: string
  form_order: number
  data_source?: DataSource
  validation_rules?: ValidationRule[]
  linkage_rules?: LinkageRule
  sub_table_config?: SubTableConfig  // ä»…ç”¨äºSUB_EXPENSEç±»å‹
}

// å­—æ®µç±»å‹æšä¸¾
type FieldType = 
  | 'TEXT' 
  | 'NUMBER' 
  | 'DECIMAL' 
  | 'DATE' 
  | 'DATETIME' 
  | 'SELECT' 
  | 'MULTI_SELECT' 
  | 'CITY_SELECTOR' 
  | 'ORG_SELECTOR' 
  | 'PROJECT_SELECTOR' 
  | 'USER_SELECTOR' 
  | 'CURRENCY_SELECTOR' 
  | 'SUB_EXPENSE' 
  | 'ATTACHMENT' 
  | 'TEXTAREA' 
  | 'RADIO' 
  | 'CHECKBOX'

// æ•°æ®æºé…ç½®
interface DataSource {
  api: string
  select_type?: 'leaf_only' | 'all'  // ç”¨äºORG_SELECTOR
  params?: Record<string, any>
}

// éªŒè¯è§„åˆ™
interface ValidationRule {
  type: ValidationRuleType
  value?: any
  message: string
}

type ValidationRuleType = 
  | 'REQUIRED' 
  | 'MIN_LENGTH' 
  | 'MAX_LENGTH' 
  | 'MIN_VALUE' 
  | 'MAX_VALUE' 
  | 'REGEX' 
  | 'CUSTOM' 
  | 'DATE_RANGE' 
  | 'EMAIL' 
  | 'PHONE'

// è”åŠ¨è§„åˆ™
interface LinkageRule {
  affects: string[]  // å½±å“çš„å­—æ®µä»£ç åˆ—è¡¨
  rule: string      // è”åŠ¨è§„åˆ™ç±»å‹
  config?: any      // è”åŠ¨é…ç½®
}

// å­è¡¨é…ç½®(ç”¨äºSUB_EXPENSEç±»å‹)
interface SubTableConfig {
  columns: SubTableColumn[]
  min_rows?: number
  max_rows?: number
  can_add?: boolean
  can_delete?: boolean
  sub_expenses?: SubExpenseType[]  // ä»…ç”¨äºç±»å‹2(å·®æ—…)
}

interface SubTableColumn {
  field_code: string
  field_name: string
  field_type: FieldType
  is_required: boolean
  width?: number
}

// å­è´¹ç”¨ç±»å‹(ä»…ç”¨äºç±»å‹2)
interface SubExpenseType {
  type_code: string
  type_name: string
  is_required: boolean
}
```

### Vue 3 ç»„ä»¶å®ç°

```vue
<!-- DynamicForm.vue -->
<template>
  <el-form
    ref="formRef"
    :model="formData"
    :rules="formRules"
    label-width="120px"
  >
    <div
      v-for="group in formConfig.form_groups"
      :key="group.group_name"
      class="form-group"
    >
      <el-divider content-position="left">
        {{ group.group_name }}
      </el-divider>
      
      <el-row :gutter="20">
        <el-col
          v-for="field in group.fields"
          :key="field.field_code"
          :span="field.grid_col"
          v-show="field.is_visible"
        >
          <!-- åŠ¨æ€æ¸²æŸ“å­—æ®µ -->
          <component
            :is="getFieldComponent(field.field_type)"
            :field="field"
            :value="formData[field.field_code]"
            @update:value="updateFieldValue(field.field_code, $event)"
            @change="handleFieldChange(field.field_code, $event)"
          />
        </el-col>
      </el-row>
    </div>
  </el-form>
</template>

<script setup lang="ts">
import { ref, computed, watch } from 'vue'
import { FormInstance, FormRules } from 'element-plus'

interface Props {
  formConfig: FormConfig
  modelValue: Record<string, any>
}

const props = defineProps<Props>()
const emit = defineEmits<{
  (e: 'update:modelValue', value: Record<string, any>): void
}>()

const formRef = ref<FormInstance>()
const formData = ref<Record<string, any>>(props.modelValue)
const formRules = computed<FormRules>(() => {
  // æ ¹æ®validation_rulesç”Ÿæˆè¡¨å•éªŒè¯è§„åˆ™
  return generateFormRules(props.formConfig)
})

// æ ¹æ®å­—æ®µç±»å‹è·å–å¯¹åº”çš„ç»„ä»¶
function getFieldComponent(fieldType: FieldType) {
  const componentMap = {
    TEXT: 'TextField',
    NUMBER: 'NumberField',
    DECIMAL: 'DecimalField',
    DATE: 'DateField',
    DATETIME: 'DateTimeField',
    SELECT: 'SelectField',
    MULTI_SELECT: 'MultiSelectField',
    CITY_SELECTOR: 'CitySelectorField',
    ORG_SELECTOR: 'OrgSelectorField',
    PROJECT_SELECTOR: 'ProjectSelectorField',
    USER_SELECTOR: 'UserSelectorField',
    CURRENCY_SELECTOR: 'CurrencySelectorField',
    SUB_EXPENSE: 'SubExpenseTable',
    ATTACHMENT: 'AttachmentUploader',
    TEXTAREA: 'TextareaField',
    RADIO: 'RadioField',
    CHECKBOX: 'CheckboxField'
  }
  return componentMap[fieldType] || 'TextField'
}

// æ›´æ–°å­—æ®µå€¼
function updateFieldValue(fieldCode: string, value: any) {
  formData.value[fieldCode] = value
  emit('update:modelValue', formData.value)
}

// å­—æ®µå€¼å˜åŒ–å¤„ç†(ç”¨äºè”åŠ¨)
function handleFieldChange(fieldCode: string, value: any) {
  // æ ¹æ®linkage_rulesæ‰§è¡Œè”åŠ¨é€»è¾‘
  executeLinkageRules(fieldCode, value)
}

// æ‰§è¡Œè”åŠ¨è§„åˆ™
function executeLinkageRules(fieldCode: string, value: any) {
  const field = findField(fieldCode)
  if (!field?.linkage_rules) return
  
  const { affects, rule, config } = field.linkage_rules
  
  affects.forEach(targetFieldCode => {
    const targetField = findField(targetFieldCode)
    if (!targetField) return
    
    switch (rule) {
      case 'min_date':
        // è®¾ç½®ç›®æ ‡å­—æ®µçš„æœ€å°æ—¥æœŸ
        setMinDate(targetFieldCode, value)
        break
      case 'max_date':
        // è®¾ç½®ç›®æ ‡å­—æ®µçš„æœ€å¤§æ—¥æœŸ
        setMaxDate(targetFieldCode, value)
        break
      case 'show':
        // æ˜¾ç¤º/éšè—å­—æ®µ
        setFieldVisible(targetFieldCode, true)
        break
      case 'hide':
        setFieldVisible(targetFieldCode, false)
        break
      case 'set_value':
        // è®¾ç½®ç›®æ ‡å­—æ®µçš„å€¼
        updateFieldValue(targetFieldCode, config?.value)
        break
      case 'clear_value':
        // æ¸…ç©ºç›®æ ‡å­—æ®µçš„å€¼
        updateFieldValue(targetFieldCode, null)
        break
      case 'load_options':
        // åŠ è½½ä¸‹æ‹‰é€‰é¡¹
        loadSelectOptions(targetFieldCode, config?.api)
        break
    }
  })
}

// æŸ¥æ‰¾å­—æ®µé…ç½®
function findField(fieldCode: string): Field | undefined {
  for (const group of props.formConfig.form_groups) {
    const field = group.fields.find(f => f.field_code === fieldCode)
    if (field) return field
  }
  return undefined
}

// ç”Ÿæˆè¡¨å•éªŒè¯è§„åˆ™
function generateFormRules(formConfig: FormConfig): FormRules {
  const rules: FormRules = {}
  
  formConfig.form_groups.forEach(group => {
    group.fields.forEach(field => {
      if (field.validation_rules && field.validation_rules.length > 0) {
        rules[field.field_code] = field.validation_rules.map(rule => ({
          required: rule.type === 'REQUIRED',
          message: rule.message,
          validator: (rule: any, value: any, callback: Function) => {
            if (!validateField(rule.type, value, rule.value)) {
              callback(new Error(rule.message))
            } else {
              callback()
            }
          },
          trigger: 'blur'
        }))
      }
    })
  })
  
  return rules
}

// å­—æ®µéªŒè¯
function validateField(ruleType: ValidationRuleType, value: any, ruleValue?: any): boolean {
  switch (ruleType) {
    case 'REQUIRED':
      return value !== null && value !== undefined && value !== ''
    case 'MIN_LENGTH':
      return value && value.length >= ruleValue
    case 'MAX_LENGTH':
      return value && value.length <= ruleValue
    case 'MIN_VALUE':
      return value && value >= ruleValue
    case 'MAX_VALUE':
      return value && value <= ruleValue
    case 'REGEX':
      return new RegExp(ruleValue).test(value)
    case 'DATE_RANGE':
      // æ—¥æœŸèŒƒå›´éªŒè¯
      return true
    case 'EMAIL':
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)
    case 'PHONE':
      return /^1[3-9]\d{9}$/.test(value)
    default:
      return true
  }
}

// æš´éœ²æ–¹æ³•ç»™çˆ¶ç»„ä»¶
defineExpose({
  validate: () => formRef.value?.validate(),
  resetFields: () => formRef.value?.resetFields()
})
</script>

<style scoped>
.form-group {
  margin-bottom: 24px;
}
</style>
```

---

## ğŸ”§ æ’ä»¶åŒ–æ¶æ„è®¾è®¡

### æŠ¥é”€æ¨¡å—æ’ä»¶æ¥å£

```java
/**
 * æŠ¥é”€æ¨¡å—æ’ä»¶æ¥å£
 */
public interface ReimbursementPlugin {
    
    /**
     * æ’ä»¶åç§°
     */
    String getPluginName();
    
    /**
     * æ’ä»¶ç‰ˆæœ¬
     */
    String getVersion();
    
    /**
     * æ’ä»¶æ”¯æŒçš„æŠ¥é”€ç±»å‹ä»£ç 
     */
    List<String> getSupportedTypeCodes();
    
    /**
     * æäº¤å‰å¤„ç†
     */
    void beforeSubmit(TransDTO trans);
    
    /**
     * æäº¤åå¤„ç†
     */
    void afterSubmit(TransDTO trans);
    
    /**
     * å®¡æ‰¹é€šè¿‡åå¤„ç†
     */
    void afterApproved(TransDTO trans);
    
    /**
     * ç»“ç®—åå¤„ç†
     */
    void afterSettled(TransDTO trans);
    
    /**
     * è‡ªå®šä¹‰å­—æ®µéªŒè¯
     */
    ValidationResult validateCustomField(Field field, Object value);
    
    /**
     * è‡ªå®šä¹‰å­—æ®µè®¡ç®—
     */
    Object calculateCustomField(Field field, TransDTO trans);
}
```

### æ’ä»¶æ³¨å†Œå™¨

```java
@Component
public class ReimbursementPluginRegistry {
    
    private final Map<String, ReimbursementPlugin> plugins = new ConcurrentHashMap<>();
    
    @Autowired
    public void registerPlugins(List<ReimbursementPlugin> pluginList) {
        pluginList.forEach(plugin -> {
            plugin.getSupportedTypeCodes().forEach(typeCode -> {
                plugins.put(typeCode, plugin);
            });
        });
    }
    
    public ReimbursementPlugin getPlugin(String typeCode) {
        return plugins.get(typeCode);
    }
    
    public List<ReimbursementPlugin> getAllPlugins() {
        return new ArrayList<>(plugins.values());
    }
}
```

---

## ğŸ“Š æ•°æ®åˆå§‹åŒ–SQL

### åˆå§‹åŒ–6ç§æŠ¥é”€ç±»å‹

```sql
-- æ’å…¥æŠ¥é”€ç±»å‹é…ç½®
INSERT INTO trans_type_config (tenant_id, type_code, type_name, type_desc, type_icon, type_order, status)
VALUES 
  (1, 'GENERAL', 'ä¸€èˆ¬è´¹ç”¨', 'é€šç”¨æŠ¥é”€ç±»å‹,é€‚ç”¨äºæ—¥å¸¸è´¹ç”¨æŠ¥é”€', 'money-circle', 1, 'ACTIVE'),
  (1, 'TRAVEL', 'å·®æ—…æŠ¥é”€', 'å‡ºå·®è´¹ç”¨æŠ¥é”€,åŒ…å«è¡Œç¨‹ä¿¡æ¯å’Œ6ç±»å­è´¹ç”¨', 'plane', 2, 'ACTIVE'),
  (1, 'TEAM_BUILDING', 'å›¢å»ºè´¹ç”¨', 'å›¢é˜Ÿå»ºè®¾æ´»åŠ¨è´¹ç”¨æŠ¥é”€', 'team', 3, 'ACTIVE'),
  (1, 'DOMESTIC_TRANSPORT', 'å¸‚å†…äº¤é€š', 'å¸‚å†…äº¤é€šè´¹ç”¨æŠ¥é”€', 'car', 4, 'ACTIVE'),
  (1, 'PERSONAL_COMM', 'ä¸ªäººé€šè®¯', 'ä¸ªäººé€šè®¯è´¹ç”¨æŠ¥é”€', 'phone', 5, 'ACTIVE'),
  (1, 'BUSINESS_ACTIVITY', 'ä¸šåŠ¡æ´»åŠ¨', 'ä¸šåŠ¡æ´»åŠ¨è´¹ç”¨æŠ¥é”€', 'gift', 6, 'ACTIVE');
```

### åˆå§‹åŒ–ç±»å‹1(ä¸€èˆ¬è´¹ç”¨)å­—æ®µé…ç½®

```sql
-- æ’å…¥ç±»å‹1å­—æ®µé…ç½®
INSERT INTO trans_type_field (tenant_id, type_config_id, field_code, field_name, field_type, is_required, is_readonly, is_visible, grid_col, form_group, form_order)
SELECT 
  1 AS tenant_id,
  type_config_id,
  field_code,
  field_name,
  field_type::field_type,
  is_required,
  is_readonly,
  is_visible,
  grid_col,
  form_group,
  form_order
FROM (
  VALUES
    -- åŸºæœ¬ä¿¡æ¯
    ('trans_no', 'ç”³è¯·å•å·', 'TEXT', 1, 1, 1, 12, 'åŸºæœ¬ä¿¡æ¯', 1),
    ('dept_id', 'æ‰€å±éƒ¨é—¨', 'ORG_SELECTOR', 1, 0, 1, 12, 'åŸºæœ¬ä¿¡æ¯', 2),
    ('project_id', 'é¡¹ç›®', 'PROJECT_SELECTOR', 1, 0, 1, 12, 'åŸºæœ¬ä¿¡æ¯', 3),
    ('trans_reason', 'æŠ¥é”€åŸå› ', 'TEXTAREA', 1, 0, 1, 24, 'åŸºæœ¬ä¿¡æ¯', 4),
    ('contact_phone', 'è”ç³»ç”µè¯', 'TEXT', 0, 0, 1, 12, 'åŸºæœ¬ä¿¡æ¯', 5),
    ('invoice_page_count', 'å‘ç¥¨é¡µæ•°', 'NUMBER', 1, 0, 1, 12, 'åŸºæœ¬ä¿¡æ¯', 6),
    ('invoice_count', 'å‘ç¥¨å¼ æ•°', 'NUMBER', 1, 0, 1, 12, 'åŸºæœ¬ä¿¡æ¯', 7)
) AS v(field_code, field_name, field_type, is_required, is_readonly, is_visible, grid_col, form_group, form_order)
JOIN trans_type_config ON type_code = 'GENERAL' AND tenant_id = 1;
```

---

## ğŸ“ æ€»ç»“

æœ¬æ–‡æ¡£è¯¦ç»†è®¾è®¡äº†æŠ¥é”€ç®¡ç†æ¨¡å—,åŒ…æ‹¬:

### âœ… å·²å®Œæˆçš„è®¾è®¡
1. **æ•°æ®åº“è®¾è®¡** - 7å¼ æ ¸å¿ƒè¡¨,æ”¯æŒå¤šç§Ÿæˆ·ã€è½¯åˆ é™¤ã€å®¡è®¡è¿½è¸ª
2. **6ç§æŠ¥é”€ç±»å‹** - æ¯ç§ç±»å‹çš„å®Œæ•´å­—æ®µé…ç½®å’ŒéªŒè¯è§„åˆ™
3. **5ä¸ªä¸»è¦åŠŸèƒ½** - æ–°å»ºã€å¾…å®¡æ‰¹ã€æˆ‘çš„ã€å·²å¤„ç†ã€è‰ç¨¿
4. **åŠ¨æ€è¡¨å•å¼•æ“** - Vue 3ç»„ä»¶å®ç°,æ”¯æŒå­—æ®µè”åŠ¨
5. **æ’ä»¶åŒ–æ¶æ„** - æ’ä»¶æ¥å£å®šä¹‰,æ”¯æŒç±»å‹çº§åˆ«æ‰©å±•
6. **å‰ç«¯API** - TypeScriptæ¥å£å®šä¹‰
7. **åç«¯API** - Spring Boot Controllerå’ŒServiceè®¾è®¡
8. **ä¸šåŠ¡æµç¨‹** - å®Œæ•´çš„æ—¶åºå›¾å’Œæµç¨‹è¯´æ˜

### ğŸ¯ è®¾è®¡äº®ç‚¹
1. **é›¶ä»£ç æ–°å¢ç±»å‹** - é€šè¿‡é…ç½®è¡¨å³å¯æ–°å¢æŠ¥é”€ç±»å‹,æ— éœ€ä¿®æ”¹ä»£ç 
2. **è‡ªåŠ¨è¡¨å•æ¸²æŸ“** - åŸºäºé…ç½®è‡ªåŠ¨ç”Ÿæˆå‰ç«¯è¡¨å•,å‡å°‘é‡å¤å¼€å‘
3. **å­—æ®µè”åŠ¨æ”¯æŒ** - æ”¯æŒå­—æ®µçº§åˆ«çš„è”åŠ¨é€»è¾‘
4. **å¤šå¸ç§æ”¯æŒ** - åŸå¸+æ±‡ç‡+æœ¬å¸è‡ªåŠ¨è®¡ç®—
5. **å€Ÿæ¬¾æŠµæ‰£** - è‡ªåŠ¨è®¡ç®—å®ä»˜é‡‘é¢
6. **å·®æ—…å­è´¹ç”¨** - ç±»å‹2æ”¯æŒ6ç±»å­è´¹ç”¨,çµæ´»æ‹†åˆ†
7. **æ’ä»¶åŒ–æ‰©å±•** - æ”¯æŒç±»å‹çº§åˆ«çš„è‡ªå®šä¹‰éªŒè¯å’Œè®¡ç®—

### ğŸ“Œ ä¸‹ä¸€æ­¥å·¥ä½œ
1. æ ¹æ®æ­¤è®¾è®¡å®ç°åç«¯ä»£ç 
2. æ ¹æ®æ­¤è®¾è®¡å®ç°å‰ç«¯ä»£ç 
3. ç¼–å†™å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
4. è®¾è®¡å·¥ä½œæµæµç¨‹å®šä¹‰(BPMN)
5. å‡†å¤‡æµ‹è¯•æ•°æ®å’Œç”¨ä¾‹

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-01-24  
**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ
