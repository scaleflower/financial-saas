# æµç¨‹å¼•æ“ä¸å®é™…æ•°æ®æµé›†æˆæ–¹æ¡ˆ

## ğŸ¯ æ ¸å¿ƒé—®é¢˜

**æ‚¨çš„é—®é¢˜**ï¼šæµç¨‹å¼•æ“æ€ä¹ˆå’Œå®é™…æ•°æ®æµç»“åˆï¼Ÿæ¯”å¦‚æŠ¥é”€å•æäº¤åï¼Œæµç¨‹å¼•æ“æ€ä¹ˆçŸ¥é“åº”è¯¥è½¬åˆ°è°å»å®¡æ‰¹ï¼Ÿ

**ç­”æ¡ˆ**ï¼šé€šè¿‡**æµç¨‹å˜é‡+ä»»åŠ¡ç›‘å¬å™¨ï¼ˆTask Listenerï¼‰**å®ç°ï¼æµç¨‹å¼•æ“ä¸ç›´æ¥çŸ¥é“å®¡æ‰¹äººæ˜¯è°ï¼Œè€Œæ˜¯é€šè¿‡ï¼š
1. **æµç¨‹å˜é‡ä¼ é€’**ï¼šåœ¨å¯åŠ¨æµç¨‹æ—¶ï¼Œå°†ç”³è¯·äººIDã€é¡¹ç›®IDã€éƒ¨é—¨IDç­‰ä¼ é€’ç»™æµç¨‹å¼•æ“
2. **ä»»åŠ¡ç›‘å¬å™¨æŸ¥è¯¢**ï¼šåœ¨ä»»åŠ¡åˆ›å»ºæ—¶ï¼Œé€šè¿‡ç›‘å¬å™¨ä»æ•°æ®åº“æŸ¥è¯¢å®é™…çš„å®¡æ‰¹äºº
3. **åŠ¨æ€è®¾ç½®å®¡æ‰¹äºº**ï¼šå°†æŸ¥è¯¢åˆ°çš„å®¡æ‰¹äººIDè®¾ç½®ç»™ä»»åŠ¡

---

## ğŸ“Š æ ¸å¿ƒæ¦‚å¿µ

### 1. æµç¨‹å˜é‡ï¼ˆProcess Variablesï¼‰
æµç¨‹å˜é‡æ˜¯åœ¨æµç¨‹å¯åŠ¨æ—¶è®¾ç½®çš„é”®å€¼å¯¹ï¼Œå¯ä»¥åœ¨æ•´ä¸ªæµç¨‹ä¸­ä½¿ç”¨ã€‚

**ç¤ºä¾‹**ï¼š
```java
Map<String, Object> variables = new HashMap<>();
variables.put("transId", 1001L);              // æŠ¥é”€å•ID
variables.put("projectId", 2001L);               // é¡¹ç›®ID
variables.put("deptId", 3001L);                  // éƒ¨é—¨ID
variables.put("applicantId", 5001L);              // ç”³è¯·äººID
variables.put("charge", new BigDecimal("5000.00")); // æŠ¥é”€é‡‘é¢
variables.put("transType", "GENERAL");              // æŠ¥é”€ç±»å‹

runtimeService.startProcessInstanceByKey(
    "reimbursementApprovalProcess",
    variables
);
```

### 2. ä»»åŠ¡å®¡æ‰¹äººè®¾ç½®æ–¹å¼

Camundaæ”¯æŒ3ç§å®¡æ‰¹äººè®¾ç½®æ–¹å¼ï¼š

| æ–¹å¼ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| **assignee** | ç›´æ¥æŒ‡å®šå•ä¸ªå®¡æ‰¹äºº | æ˜ç¡®æŒ‡å®šå•ä¸ªå®¡æ‰¹äºº |
| **candidateUsers** | å€™é€‰äººåˆ—è¡¨ï¼ˆä¼šæŒ‰é¡ºåºåˆ†é…ï¼‰ | éœ€è¦é¡ºåºå®¡æ‰¹æ—¶ |
| **candidateGroups** | å€™é€‰å€™é€‰äººç»„ï¼ˆç»„å†…æ‰€æœ‰äººéƒ½ä¼šæ”¶åˆ°ä»»åŠ¡ï¼‰ | å¹¶è¡Œå®¡æ‰¹æ—¶ |

**æˆ‘ä»¬ä¸»è¦ä½¿ç”¨assignee**æ–¹å¼ï¼Œä½†é€šè¿‡åŠ¨æ€è®¡ç®—å¾—å‡ºã€‚

### 3. ä»»åŠ¡ç›‘å¬å™¨ï¼ˆTask Listenerï¼‰
ä»»åŠ¡ç›‘å¬å™¨æ˜¯åœ¨ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸäº‹ä»¶è§¦å‘æ—¶çš„é’©å­å‡½æ•°ï¼Œä¸»è¦çš„äº‹ä»¶ç±»å‹ï¼š

| äº‹ä»¶ | è§¦å‘æ—¶æœº | ç”¨é€” |
|------|----------|------|
| **create** | ä»»åŠ¡åˆ›å»ºæ—¶ | æŸ¥è¯¢å’Œè®¾ç½®å®¡æ‰¹äººã€å‘é€é€šçŸ¥ |
| **complete** | ä»»åŠ¡å®Œæˆæ—¶ | è®°å½•å®¡æ‰¹ç»“æœã€è§¦å‘ä¸‹ä¸€èŠ‚ç‚¹ |

**æˆ‘ä»¬ä¸»è¦ä½¿ç”¨createäº‹ä»¶**æ¥å®ç°åŠ¨æ€å®¡æ‰¹äººæŸ¥è¯¢ã€‚

---

## ğŸ” æµç¨‹å˜é‡è®¾è®¡

### æŠ¥é”€å®¡æ‰¹æµç¨‹çš„æµç¨‹å˜é‡

| å˜é‡å | ç±»å‹ | è¯´æ˜ | è®¾ç½®æ—¶æœº | ä½¿ç”¨èŠ‚ç‚¹ |
|--------|------|------|----------|----------|
| transId | Long | æŠ¥é”€å•ID | æµç¨‹å¯åŠ¨æ—¶ | å…¨å±€ |
| transNo | String | æŠ¥é”€å•å· | æµç¨‹å¯åŠ¨æ—¶ | å…¨å±€ |
| tenantId | Long | ç§Ÿæˆ·ID | æµç¨‹å¯åŠ¨æ—¶ | å…¨å±€ |
| applicantId | Long | ç”³è¯·äººID | æµç¨‹å¯åŠ¨æ—¶ | å…¨å±€ |
| projectId | Long | é¡¹ç›®ID | æµç¨‹å¯åŠ¨æ—¶ | å…¨å±€ |
| deptId | Long | éƒ¨é—¨ID | æµç¨‹å¯åŠ¨æ—¶ | å…¨å±€ |
| charge | BigDecimal | æŠ¥é”€é‡‘é¢ | æµç¨‹å¯åŠ¨æ—¶ | å…¨å±€ |
| lcCharge | BigDecimal | æœ¬å¸é‡‘é¢ | æµç¨‹å¯åŠ¨æ—¶ | å…¨å±€ |
| currency | String | å¸ç§ | æµç¨‹å¯åŠ¨æ—¶ | å…¨å±€ |
| exchangeRate | BigDecimal | æ±‡ç‡ | æµç¨‹å¯åŠ¨æ—¶ | å…¨å±€ |
| transType | String | æŠ¥é”€ç±»å‹ | æµç¨‹å¯åŠ¨æ—¶ | å…¨å±€ |
| transReason | String | æŠ¥é”€åŸå›  | æµç¨‹å¯åŠ¨æ—¶ | å…¨å±€ |
| loanOffsetAmount | BigDecimal | å€Ÿæ¬¾æŠµæ‰£é‡‘é¢ | æµç¨‹å¯åŠ¨æ—¶ | å…¨å±€ |
| payableAmount | BigDecimal | å®ä»˜é‡‘é¢ | æµå¯åŠ¨æ—¶ | å…¨å±€ |
| approvalThreshold | BigDecimal | å®¡æ‰¹é˜ˆå€¼ | æµç¨‹å¯åŠ¨æ—¶ | å…¨å±€ |
| projectManagerId | **Long** | é¡¹ç›®ç»ç†ID | æµç¨‹å¯åŠ¨æ—¶ï¼ˆç›‘å¬å™¨è®¡ç®—ï¼‰ | é¡¹ç›®ç»ç†å®¡æ‰¹èŠ‚ç‚¹ |
| deptManagerId | **Long** | éƒ¨é—¨ç»ç†ID | æµç¨‹å¯åŠ¨æ—¶ï¼ˆç›‘å¬å™¨è®¡ç®—ï¼‰ | éƒ¨é—¨ç»ç†å®¡æ‰¹èŠ‚ç‚¹ |
| isSameManager | **Boolean** | é¡¹ç›®ç»ç†=éƒ¨é—¨ç»ç† | æµç¨‹å¯åŠ¨æ—¶ï¼ˆç›‘å¬å™¨è®¡ç®—ï¼‰ | æ™ºèƒ½åˆ¤æ–­ç½‘å…³ |
| generalManagerId | **Long** | æ€»ç»ç†ID | æµç¨‹å¯åŠ¨æ—¶ï¼ˆç›‘å¬å™¨è®¡ç®—ï¼‰ | æ€»ç»ç†å®¡æ‰¹èŠ‚ç‚¹ |
| financeManagerId | **Long** | è´¢åŠ¡ç»ç†ID | æµç¨‹å¯åŠ¨æ—¶ï¼ˆç›‘å¬å™¨è®¡ç®—ï¼‰ | è´¢åŠ¡å®¡æ ¸èŠ‚ç‚¹ |
| cashierId | **Long** | å‡ºçº³ID | æµç¨‹å¯åŠ¨æ—¶ï¼ˆç›‘å¬å™¨è®¡ç®—ï¼‰ | å‡ºçº³ä»˜æ¬¾èŠ‚ç‚¹ |

**åŠ ç²—çš„å˜é‡**æ˜¯åŠ¨æ€è®¡ç®—çš„ï¼Œä¸æ˜¯åœ¨å¯åŠ¨æ—¶ç›´æ¥ä¼ å…¥ã€‚

---

## ğŸ”§ ä»»åŠ¡ç›‘å¬å™¨å®ç°

### 1. é¡¹ç›®ç»ç†å®¡æ‰¹ä»»åŠ¡ç›‘å¬å™¨

**ä½œç”¨**ï¼šæŸ¥è¯¢é¡¹ç›®è´Ÿè´£äººIDï¼Œå¹¶è®¾ç½®ç»™é¡¹ç›®ç»ç†å®¡æ‰¹ä»»åŠ¡

```java
@Component
@Slf4j
public class ProjectManagerTaskListener implements TaskListener {
    
    @Autowired
    private ProjectService projectService;
    
    @Autowired
    private NotificationService notificationService;
    
    @Override
    public void notify(DelegateTask delegateTask) {
        String eventName = delegateTask.getEventName();
        
        if ("create".equals(eventName)) {
            // ä»æµç¨‹å˜é‡ä¸­è·å–é¡¹ç›®ID
            Long projectId = (Long) delegateTask.getVariable("projectId");
            Long tenantId = (Long) delegateTask.getVariable("tenantId");
            
            // æŸ¥è¯¢é¡¹ç›®ä¿¡æ¯
            Project project = projectService.getById(tenantId, projectId);
            
            // è·å–é¡¹ç›®ç»ç†ID
            Long projectManagerId = project.getLeaderId();
            
            if (projectManagerId == null) {
                log.error("é¡¹ç›®è´Ÿè´£äººä¸ºç©ºï¼ŒprojectId: {}", projectId);
                throw new BusinessException("é¡¹ç›®è´Ÿè´£äººä¸èƒ½ä¸ºç©º");
            }
            
            // è®¾ç½®å®¡æ‰¹äºº
            delegateTask.setAssignee(projectManagerId.toString());
            
            // è®¾ç½®æµç¨‹å˜é‡ï¼ˆä¾›åç»­ä½¿ç”¨ï¼‰
            delegateTask.setVariable("projectManagerId", projectManagerId);
            
            // å‘é€å®¡æ‰¹é€šçŸ¥
            String transNo = (String) delegateTask.getVariable("transNo");
            BigDecimal charge = (BigDecimal) delegateTask.getVariable("charge");
            notificationService.sendApprovalNotification(
                tenantId,
                projectManagerId,
                "å¾…å®¡æ‰¹æŠ¥é”€å•",
                String.format("æŠ¥é”€å•å·ï¼š%sï¼Œé‡‘é¢ï¼š%.2f", transNo, charge)
            );
            
            log.info("é¡¹ç›®ç»ç†å®¡æ‰¹ä»»åŠ¡åˆ›å»ºæˆåŠŸã€‚é¡¹ç›®ç»ç†ID: {}, æŠ¥é”€å•å·: {}", 
                projectManagerId, transNo);
        }
    }
}
```

### 2. éƒ¨é—¨ç»ç†å®¡æ‰¹ä»»åŠ¡ç›‘å¬å™¨

**ä½œç”¨**ï¼šæŸ¥è¯¢éƒ¨é—¨è´Ÿè´£äººIDï¼Œå¹¶è®¾ç½®ç»™éƒ¨é—¨ç»ç†å®¡æ‰¹ä»»åŠ¡

```java
@Component
@Slf4j
public class DeptManagerTaskListener implements TaskListener {
    
    @Autowired
    private OrgService orgService;
    
    @Autowired
    private NotificationService notificationService;
    
    @Override
    public void notify(DelegateTask delegateTask) {
        String eventName = delegateTask.getEventName();
        
        if ("create".equals(eventName)) {
            // ä»æµç¨‹å˜é‡ä¸­è·å–éƒ¨é—¨ID
            Long deptId = (Long) delegateTask.getVariable("deptId");
            Long tenantId = ( delegateTask.getVariable("tenantId");
            
            // æŸ¥è¯¢éƒ¨é—¨ä¿¡æ¯
            Org dept = orgService.getById(tenantId, deptId);
            
            // è·å–éƒ¨é—¨è´Ÿè´£äººID
            Long deptManagerId = dept.getLeaderId();
            
            if (deptManagerId == null) {
                log.error("éƒ¨é—¨è´Ÿè´£äººä¸ºç©ºï¼ŒdeptId: {}", deptId);
                throw new BusinessException("éƒ¨é—¨è´Ÿè´£äººä¸èƒ½ä¸ºç©º");
            }
            
            // è®¾ç½®å®¡æ‰¹äºº
            delegateTask.setAssignee(deptManagerId.toString());
            
            // è®¾ç½®æµç¨‹å˜é‡ï¼ˆä¾›åç»­ä½¿ç”¨ï¼‰
            delegateTask.setVariable("deptManagerId", deptManagerId);
            
            // å‘é€å®¡æ‰¹é€šçŸ¥
            String transNo = (String) delegateTask.getVariable("transNo");
            BigDecimal charge = (BigDecimal) delegateTask.getVariable("charge");
            notificationService.sendApprovalNotification(
                tenantId,
                deptManagerId,
                "å¾…å®¡æ‰¹æŠ¥é”€å•",
                String.format("æŠ¥é”€å•å·ï¼š%sï¼Œé‡‘é¢ï¼š%.2f", transNo, charge)
            );
            
            log.info("éƒ¨é—¨ç»ç†å®¡æ‰¹ä»»åŠ¡åˆ›å»ºæˆåŠŸã€‚éƒ¨é—¨ç»ç†ID: {}, æŠ¥é”€å•å·: {}", 
                deptManagerId, transNo);
        }
    }
}
```

### 3. æ€»ç»ç†å®¡æ‰¹ä»»åŠ¡ç›‘å¬å™¨

**ä½œç”¨**ï¼šæŸ¥è¯¢æ€»ç»ç†IDï¼ˆä»ç§Ÿæˆ·é…ç½®ä¸­æŸ¥è¯¢ï¼‰ï¼Œå¹¶è®¾ç½®ç»™æ€»ç»ç†å®¡æ‰¹ä»»åŠ¡

```java
@Component
@Slf4j
public class GeneralManagerTaskListener implements TaskListener {
    
    @Autowired
    private TenantConfigService tenantConfigService;
    
    @Autowired
    private NotificationService notificationService;
    
    @Override
    public void notify(DelegateTask delegateTask) {
        String eventName = delegateTask.getEventName();
        
        if ("create".equals(eventName)) {
            // ä»æµç¨‹å˜é‡ä¸­è·å–ç§Ÿæˆ·ID
            Long tenantId = (Long) delegateTask.getVariable("tenantId");
            
            // æŸ¥è¯¢ç§Ÿæˆ·é…ç½®ï¼Œè·å–æ€»ç»ç†ID
            TenantConfig config = tenantConfigService.getByTenantId(tenantId);
            Long generalManagerId = config.getGeneralManagerId();
            
            if (generalManagerId == null) {
                log.error("æ€»ç»ç†ä¸ºç©ºï¼ŒtenantId: {}", tenantId);
                throw new BusinessException("æ€»ç»ç†ä¸èƒ½ä¸ºç©º");
            }
            
            // è®¾ç½®å®¡æ‰¹äºº
            delegateTask.setAssignee(generalManagerId.toString());
            
            // è®¾ç½®æµç¨‹å˜é‡ï¼ˆä¾›åç»­ä½¿ç”¨ï¼‰
            delegateTask.setVariable("generalManagerId", generalManagerId);
            
            // å‘é€å®¡æ‰¹é€šçŸ¥
            String transNo = (String) delegateTask.getVariable("transNo");
            BigDecimal charge = (BigDecimal) delegateTask.getVariable("charge");
            notificationService.sendApprovalNotification(
                tenantId,
                generalManagerId,
                "å¾…å®¡æ‰¹æŠ¥é”€å•",
                String.format("æŠ¥é”€å•å·ï¼š%sï¼Œé‡‘é¢ï¼š%.2f", transNo, charge)
            );
            
            log.info("æ€»ç»ç†å®¡æ‰¹ä»»åŠ¡åˆ›å»ºæˆåŠŸã€‚æ€»ç»ç†ID: {}, æŠ¥é”€å•å·: {}", 
                generalManagerId, transNo);
        }
    }
}
```

### 4. è´¢åŠ¡å®¡æ ¸ä»»åŠ¡ç›‘å¬å™¨

**ä½œç”¨**ï¼šæŸ¥è¯¢è´¢åŠ¡äººå‘˜ï¼ˆè§’è‰²ï¼‰ï¼Œé€šè¿‡candidateGroupsè®¾ç½®å€™é€‰äººç»„

```java
@Component
@Slf4j
public class FinanceAuditTaskListener implements TaskListener {
    
    @Autowired
    private NotificationService notificationService;
    
    @Override
    public void notify(DelegateTask delegateTask) {
        String eventName = delegateTask.getEventName();
        
        if ("create".equals(eventName)) {
            // è·å–ç§Ÿæˆ·IDï¼ˆä»æµç¨‹å˜é‡ï¼‰
            Long tenantId = (Long) delegateTask.getVariable("tenantId");
            
            // è·å–æŠ¥é”€å•å·ï¼ˆç”¨äºé€šçŸ¥ï¼‰
            String transNo = (String) delegateTask.getVariable("transNo");
            
            // è®¾ç½®å€™é€‰äººç»„ï¼ˆæ‰€æœ‰è´¢åŠ¡äººå‘˜éƒ½å¯ä»¥å®¡æ‰¹ï¼‰
            delegateTask.addCandidateGroup("FINANCE");
            
            // å‘é€å®¡æ‰¹é€šçŸ¥ç»™æ‰€æœ‰è´¢åŠ¡äººå‘˜
            notificationService.sendApprovalNotification(
                tenantId,
                "FINANCE",
                "å¾…å®¡æ‰¹æŠ¥é”€å•",
                String.format("æŠ¥é”€å•å·ï¼š%sï¼Œè¯·è´¢åŠ¡äººå‘˜å®¡æ‰¹", transNo)
            );
            
            log.info("è´¢åŠ¡å®¡æ ¸ä»»åŠ¡åˆ›å»ºæˆåŠŸã€‚å€™é€‰äººç»„: FINANCE, æŠ¥é”€å•å·: {}", transNo);
        }
    }
}
```

### 5. å‡ºçº³ä»˜æ¬¾ä»»åŠ¡ç›‘å¬å™¨

**ä½œç”¨**ï¼šæŸ¥è¯¢å‡ºçº³äººå‘˜ï¼ˆè§’è‰²ï¼‰ï¼Œé€šè¿‡candidateGroupsè®¾ç½®å€™é€‰äººç»„

```java
@Component
@Slf4j
public class CashierPaymentTaskListener implements TaskListener {
    
    @Autowired
    private NotificationService notificationService;
    
    @Override
    public void notify(DelegateTask delegateTask) {
        String eventName = delegateTask.getEventName();
        
        if ("create".equals(eventName)) {
            // è·å–ç§Ÿæˆ·IDï¼ˆä»æµç¨‹å˜é‡ï¼‰
            Long tenantId = (Long) delegateTask.getVariable("tenantId");
            
            // è·å–æŠ¥é”€å•å·ï¼ˆç”¨äºé€šçŸ¥ï¼‰
            String transNo = (String) delegateTaskVariable("transNo");
            BigDecimal payableAmount = (BigDecimal) delegateTask.getVariable("payableAmount");
            
            // è®¾ç½®å€™é€‰äººç»„ï¼ˆæ‰€æœ‰å‡ºçº³äººå‘˜éƒ½å¯ä»¥ä»˜æ¬¾ï¼‰
            delegateTask.addCandidateGroup("CASHIER");
            
            // å‘é€ä»˜æ¬¾é€šçŸ¥ç»™æ‰€æœ‰å‡ºçº³äººå‘˜
            notificationService.sendApprovalNotification(
                tenantId,
                "CASHIER",
                "å¾…ä»˜æ¬¾æŠ¥é”€å•",
                String.format("æŠ¥é”€å•å·ï¼š%sï¼Œå¾…ä»˜é‡‘é¢ï¼š%.2f", transNo, payableAmount)
            );
            
            log.info("å‡ºçº³ä»˜æ¬¾ä»»åŠ¡åˆ›å»ºæˆåŠŸã€‚å€™é€‰äººç»„: CASHIER, æŠ¥é”€å•å·: {}, å¾…ä»˜é‡‘é¢: {}", 
                transNo, payableAmount);
        }
    }
}
```

### 6. å‘˜å·¥ä¿®æ”¹ä»»åŠ¡ç›‘å¬å™¨

**ä½œç”¨**ï¼šè®¾ç½®ç”³è¯·äººä¸ºå®¡æ‰¹äººï¼ˆå‘˜å·¥å¯ä»¥ä¿®æ”¹è‡ªå·±çš„è‰ç¨¿ï¼‰

```java
@Component
@Slf4j
public class EmployeeUpdateTaskListener implements TaskListener {
    
    @Override
    public void notify(DelegateTask delegateTask) {
        String eventName = delegateTask.getEventName();
        
        if ("create".equals(eventName)) {
            // ä»æµç¨‹å˜é‡ä¸­è·å–ç”³è¯·äººID
            Long applicantId = (Long) delegateTask.getVariable("applicantId");
            
            // è®¾ç½®å®¡æ‰¹äººä¸ºç”³è¯·äººï¼ˆå‘˜å·¥åªèƒ½ä¿®æ”¹è‡ªå·±çš„è‰ç¨¿ï¼‰
            delegateTask.setAssignee(applicantId.toString());
            
            log.info("å‘˜å·¥ä¿®æ”¹ä»»åŠ¡åˆ›å»ºæˆåŠŸã€‚ç”³è¯·äººID: {}", applicantId);
        }
    }
}
```

---

## ğŸš€ æµç¨‹å¯åŠ¨ç¤ºä¾‹

### 1. æŠ¥é”€å•æäº¤æ—¶å¯åŠ¨æµç¨‹

```java
@Service
@Slf4j
@RequiredArgsConstructor
public class ReimbursementService {
    
    private final RuntimeService runtimeService;
    private final ProjectService projectService;
    private final OrgService orgService;
    private final TenantConfigService tenantConfigService;
    
    /**
     * æäº¤æŠ¥é”€å®¡æ‰¹æµç¨‹
     */
    public void submitApprovalProcess(Trans trans) {
        log.info("å¼€å§‹æäº¤æŠ¥é”€å®¡æ‰¹æµç¨‹ï¼ŒæŠ¥é”€å•å·: {}", trans.getTransNo());
        
        // 1. å‡†å¤‡æµç¨‹å˜é‡
        Map<String, Object> variables = new HashMap<>();
        
        // 2. åŸºç¡€ä¿¡æ¯
        variables.put("transId", trans.getTransId());
        variables.put("transNo", trans.getTransNo());
        variables.put("tenantId", trans.getTenantId());
        variables.put("applicantId", trans.getApplicantId());
        variables.put("projectId", trans.getProjectId());
        variables.put("deptId", trans.getDeptId());
        variables.put("transReason", trans.getTransReason());
        
        // 3. é‡‘é¢ä¿¡æ¯
        variables.put("charge", trans.getCharge());
        variables.put("lcCharge", trans.getLcCharge());
        variables.put("currency", trans.getCurrency());
        variables.put("exchangeRate", trans.getExchangeRate());
        variables.put("loanOffsetAmount", 
            trans.getLoanOffsetAmount() != null ? trans.getLoanOffsetAmount() : BigDecimal.ZERO);
        variables.put("payableAmount", trans.getPayableAmount());
        
        // 4. ç±»å‹ä¿¡æ¯
        variables.put("transType", trans.getTypeCode());
        
        // 5. æŸ¥è¯¢å®¡æ‰¹é˜ˆå€¼ï¼ˆä»ç§Ÿæˆ·é…ç½®ï¼‰
        String transType = trans.getTypeCode();
        BigDecimal threshold = tenantConfigService.getApprovalThreshold(
            trans.getTenantId(), 
            transType
        );
        variables.put("approvalThreshold", threshold);
        
        log.info("æµç¨‹å˜é‡å‡†å¤‡å®Œæˆ: transId={}, projectId={}, deptId={}, transType={}, charge={}, threshold={}", 
            trans.getTransId(), trans.getProjectId(), trans.getDeptId(), 
            transType, trans.getCharge(), threshold);
        
        // 6. å¯åŠ¨æµç¨‹å®ä¾‹
        ProcessInstance processInstance = runtimeService
            .startProcessInstanceByKey(
                "reimbursementApprovalProcess",  // æµç¨‹å®šä¹‰çš„key
                trans.getTransNo(),               // ä¸šåŠ¡ä¸»é”®ï¼ˆæŠ¥é”€å•å·ï¼‰
                variables
            );
        
        // 7. æ›´æ–°æŠ¥é”€å•çŠ¶æ€å’Œæµç¨‹å®ä¾‹ID
        trans.setState(TransState.SUBMITTED);
        trans.setWorkflowInstanceId(processInstance.getId());
        transRepository.save(trans);
        
        log.info("æµç¨‹å¯åŠ¨æˆåŠŸï¼Œæµç¨‹å®ä¾‹ID: {}, æŠ¥é”€å•å·: {}", 
            processInstance.getId(), trans.getTransNo());
    }
}
```

---

## ğŸ“Š å®Œæ•´çš„æµç¨‹-æ•°æ®æµäº¤äº’æ—¶åºå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æŠ¥é”€å•æäº¤                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚         å‰ç«¯: æäº¤æŠ¥é”€å•              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  ReimbursementService.submitApproval()   â”‚
         â”‚                                       â”‚
         â”‚  1. å‡†å¤‡æµç¨‹å˜é‡                  â”‚
         â”‚     transId = 1001                    â”‚
         â”‚     projectId = 2001                   â”‚
         â”‚     deptId = 3001                     â”‚
         â”‚     applicantId = 5001               â”‚
         â”‚     charge = 5000.00                   â”‚
         â”‚     transType = "GENERAL"                â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  ProjectService.getById(2001)           â”‚
         â”‚  project: {leaderId: 6001}        â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  RuntimeService.startProcessInstanceByKey()â”‚
         â”‚                                       â”‚
         â”‚  variables: {                        â”‚
         â”‚   transId: 1001,                    â”‚
         â”‚   transNo: "BX202501240001",         â”‚
         â”‚   applicantId: 5001,               â”‚
         â”‚   projectId: 2001,                   â”‚
         â”‚   charge: 5000.00,                   â”‚
         â”‚   transType: "GENERAL"                â”‚
         â”‚   ...                             â”‚
         â”‚ }                                     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Camundaæµç¨‹å¼•æ“                        â”‚
         â”‚                                       â”‚
         â”‚  æµç¨‹å®ä¾‹åˆ›å»º                          â”‚
         â”‚  BPMNæ–‡ä»¶éƒ¨ç½²:                         â”‚
         â”‚   - å‘˜å·¥æäº¤äº‹ä»¶                      â”‚
         â”‚   - é¡¹ç›®ç»ç†å®¡æ‰¹ä»»åŠ¡                   â”‚
         â”‚   - éƒ¨é—¨ç»ç†å®¡æ‰¹ä»»åŠ¡                 â”‚
         â”‚   - é‡‘é¢åˆ¤æ–­ç½‘å…³                       â”‚
         â”‚   - æ€»ç»ç†å®¡æ‰¹ä»»åŠ¡                   â”‚
         â”‚   - è´¢åŠ¡å®¡æ ¸ä»»åŠ¡                     â”‚
         â”‚   - å‡ºçº³ä»˜æ¬¾ä»»åŠ¡                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  é¡¹ç›®ç»ç†å®¡æ‰¹ä»»åŠ¡åˆ›å»º                    â”‚
         â”‚  Event: create                      â”‚
         â”‚  TaskListener: ProjectManagerTaskListener â”‚
         â”‚                                       â”‚
         â”‚  1. è·å–projectIdå˜é‡                 â”‚
         â”‚     projectId = 2001                     â”‚
         â”‚                                       â”‚
         â”‚  2. è°ƒç”¨ProjectService.getById()    â”‚
         â”‚     project = {leaderId: 6001}        â”‚
         â”‚                                       â”‚
          3. è®¾ç½®å®¡æ‰¹äºº                          â”‚
         â”‚     task.setAssignee("6001")         â”‚
         â”‚                                       â”‚
         â”‚  4. è®¾ç½®æµç¨‹å˜é‡                        â”‚
         â”‚     task.setVariable("projectManagerId", 6001L)â”‚
         â”‚                                       â”‚
         â”‚  5. å‘é€é€šçŸ¥                          â”‚
         â”‚     notificationService.send()            â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Camundaæµç¨‹å¼•æ“                        â”‚
         â”‚                                       â”‚
         â”‚  æŸ¥è¯¢å¾…åŠä»»åŠ¡åˆ—è¡¨                       â”‚
         â”‚  taskService.createTaskQuery()        â”‚
         â”‚                                       â”‚
         â”‚  è¿”å›ä»»åŠ¡åˆ—è¡¨ç»™å‰ç«¯                     â”‚
         â”‚  Task:                               â”‚
         â”‚   - id: "task-001"                   â”‚
         â”‚   - name: "é¡¹ç›®ç»ç†å®¡æ‰¹"              â”‚
         â”‚   - assignee: "6001"                  â”‚
         â”‚   - createTime: "2025-01-24 10:30"    â”‚
         â”‚   - processInstanceId: "proc-001"    â”‚
         â”‚   - variables: {transId: 1001, ...} â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  å‰ç«¯æ˜¾ç¤ºä»»åŠ¡åˆ—è¡¨                        â”‚
         â”‚                                       â”‚
         â”‚  å¾…åŠä»»åŠ¡åˆ—è¡¨:                          â”‚
         â”‚  1. æŠ¥é”€å•: BX202501240001                â”‚
         â”‚     ç”³è¯·äºº: å¼ ä¸‰                      â”‚
         â”‚     å®¡æ‰¹ç±»å‹: é¡¹ç›®ç»ç†å®¡æ‰¹              â”‚
         â”‚     ç”³è¯·æ—¶é—´: 2025-01-24 10:30         â”‚
         â”‚  æŠ¥é”€é‡‘é¢: Â¥5,000.00                   â”‚
         â”‚                                       â”‚
         â”‚  [æŸ¥çœ‹] [å®¡æ‰¹] [è½¬åŠ]              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  ç”¨æˆ·ç‚¹å‡»"å®¡æ‰¹"æŒ‰é’®                   â”‚
         â”‚                                       â”‚
         â”‚  å‰ç«¯è°ƒç”¨å®¡æ‰¹API                        â”‚
         â”‚  POST /api/workflow/task/{taskId}/complete  â”‚
         â”‚  RequestBody:                           â”‚
         â”‚  {                                     â”‚
         â”‚    "approvalResult": "APPROVE",            â”‚
         â”‚    "approvalComment": "åŒæ„ç”³è¯·"            â”‚
         â”‚  }                                     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Camundaæµç¨‹å¼•æ“                        â”‚
         â”‚                                       â”‚
         â”‚  1. è®¾ç½®å®¡æ‰¹ç»“æœå˜é‡                   â”‚
         â”‚     task.setVariable("approvalResult",  â”‚
         â”‚                              "APPROVE")          â”‚
         â”‚     task.setVariable("approvalComment", â”‚
         â”‚                              "åŒæ„ç”³è¯·")         â”‚
         â”‚                                       â”‚
         â”‚  2. å®Œæˆä»»åŠ¡                            â”‚
         â”‚     taskService.complete(taskId)           â”‚
         â”‚                                       â”‚
         â”‚  3. è§¦å‘completeäº‹ä»¶                  â”‚
         â”‚     -> TaskListener:                    â”‚
         â”‚         ProjectManagerCompleteListener  â”‚
         â”‚     -> æµç¨‹ç»§ç»­æµè½¬                    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  ProjectManagerCompleteListener    â”‚
         â”‚  (completeäº‹ä»¶ï¼‰                       â”‚
         â”‚                                       â”‚
         â”‚  1. è·å–å®¡æ‰¹ç»“æœ                     â”‚
         â”‚     approvalResult = "APPROVE"           â”‚
         â”‚                                       â”‚
           2. åˆ¤æ–­é¡¹ç›®ç»ç†å’Œéƒ¨é—¨ç»ç†æ˜¯å¦ä¸ºåŒä¸€äºº  â”‚
         â”‚     Long projectManagerId = projectService  â”‚
         â”‚         .getById(projectId).getLeaderId();  â”‚
         â”‚     Long deptManagerId = orgService      â”‚
         â”‚         .getById(deptId).getLeaderId();     â”‚
         â”‚                                       â”‚
         â”‚ 3. è®¾ç½®æµç¨‹å˜é‡                       â”‚
         â”‚     task.setVariable("projectManagerId",  â”‚
         â”‚                              projectManagerId); â”‚
         â”‚     task.setVariable("deptManagerId",     â”‚
         â”‚                              deptManagerId); â”‚
         â”‚     task.setVariable("isSameManager",  â”‚
         â”‚                              projectManagerId      â”‚
         â”‚                                 â”‚
         â”‚                                     â”‚
         â”‚ 4. å¦‚æœæ˜¯åŒä¸€äººï¼Œè‡ªåŠ¨å®Œæˆéƒ¨é—¨ç»ç†å®¡æ‰¹    â”‚
         â”‚     if (projectManagerId.equals      â”‚
         â”‚         deptManagerId)) {                   â”‚
         â”‚           // è‡ªåŠ¨å®Œæˆéƒ¨é—¨ç»ç†å®¡æ‰¹ä»»åŠ¡      â”‚
         â”‚           autoCompleteDeptManagerTask(   â”‚
         â”‚               task.getProcessInstanceId(),  â”‚
         â”‚               "APPROVE",             â”‚
         â”‚               "åŒæ„ç”³è¯·"             â”‚
         â”‚           );                               â”‚
         â”‚     }                                      â”‚
         â”‚                                       â”‚
         â”‚  5. æµç¨‹ç»§ç»­åˆ°ä¸‹ä¸€èŠ‚ç‚¹                  â”‚
         â”‚     æµç¨‹å¼•æ“è‡ªåŠ¨åˆ¤æ–­ä¸‹ä¸€ä¸ªèŠ‚ç‚¹      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Camundaæµç¨‹å¼•æ“                        â”‚
         â”‚                                       â”‚
         â”‚  åˆ¤æ–­ä¸‹ä¸€æ­¥èŠ‚ç‚¹                        â”‚
         â”‚  æ™ºèƒ½åˆ¤æ–­ç½‘å…³: isSameManager?       â”‚
         â”‚                                       â”‚
         â”‚  å¦‚æœisSameManager = true:              â”‚
         â”‚     -> è·³åˆ°é‡‘é¢åˆ¤æ–­ç½‘å…³               â”‚
         â”‚                                        â”‚
         â”‚  å¦‚æœisSameManager = false:             â”‚
         â”‚     -> åˆ›å»ºéƒ¨é—¨ç»ç†å®¡æ‰¹ä»»åŠ¡            â”‚
         â”‚                                        â”‚
         â”‚ é‡‘é¢åˆ¤æ–­ç½‘å…³: charge >= threshold?    â”‚
         â”‚                                       â”‚
         â”‚  å¦‚æœcharge >= threshold:                â”‚
â”‚     -> åˆ›å»ºæ€»ç»ç†å®¡æ‰¹ä»»åŠ¡                      â”‚
â”‚                                        â”‚
â”‚  å¦‚æœcharge < threshold:                 â”‚
â”‚     -> åˆ›å»ºè´¢åŠ¡å®¡æ ¸ä»»åŠ¡                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  è´¢åŠ¡å®¡æ ¸ä»»åŠ¡åˆ›å»º                        â”‚
         â”‚  Event: create                      â”‚
         â”‚  TaskListener: FinanceAuditTaskListener  â”‚
         â”‚                                       â”‚
         â”‚  1. è®¾ç½®å€™é€‰äººç»„                          â”‚
         â”‚     task.addCandidateGroup("FINANCE")   â”‚
         â”‚                                       â”‚
         â”‚ 2. å‘é€é€šçŸ¥ç»™æ‰€æœ‰è´¢åŠ¡äººå‘˜               â”‚
         â”‚     notificationService.sendApproval   â”‚
         â”‚       (tenantId, "FINANCE", ...) â”‚
         â”‚                                       â”‚
          ä»»åŠ¡åˆ†é…ç»™å€™é€‰äººç»„å†…çš„ç¬¬ä¸€ä¸ªäºº     â”‚
         â”‚  â†’ task.setAssignee(...) (å¯é€‰ï¼‰ â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ å…³é”®ä»£ç å®ç°

### 1. æŠ¥é”€æœåŠ¡å¯åŠ¨æµç¨‹

```java
@Service
@Slf4j
@RequiredArgsConstructor
@Transactional
public class ReimbursementService {
    
    private final RuntimeService runtimeService;
    private final RepositoryService repositoryService;
    private final ProjectService projectService;
    private final OrgService orgService;
    private final TransRepository transRepository;
    private final TenantConfigService tenantConfigService;
    
    /**
     * æäº¤æŠ¥é”€å®¡æ‰¹æµç¨‹
     */
    public void submitApprovalProcess(String transNo) {
        log.info("å¼€å§‹æäº¤æŠ¥é”€å®¡æ‰¹æµç¨‹ï¼ŒæŠ¥é”€å•å·: {}", transNo);
        
        // 1. æŸ¥è¯¢æŠ¥é”€å•
        Trans trans = transRepository.findByTransNo(transNo)
            .orElseThrow(() -> new BusinessException("æŠ¥é”€å•ä¸å­˜åœ¨"));
        
        // 2. éªŒè¯æŠ¥é”€å•çŠ¶æ€
        if (trans.getState() != TransState.DRAFT) {
            throw new BusinessException("åªæœ‰è‰ç¨¿çŠ¶æ€çš„æŠ¥é”€å•æ‰èƒ½æäº¤");
        }
        
        // 3. å‡†å¤‡æµç¨‹å˜é‡
        Map<String, Object> variables = prepareProcessVariables(trans);
        
        // 4. å¯åŠ¨æµç¨‹å®ä¾‹
        ProcessInstance processInstance = runtimeService
            .startProcessInstanceByKey(
                "reimbursementApprovalProcess",
                transNo,
                variables
            );
        
        // 5. æ›´æ–°æŠ¥é”€å•çŠ¶æ€
        trans.setState(TransState.SUBMITTED);
        trans.setWorkflowInstanceId(processInstance.getId());
        transRepository.save(trans);
        
        log.info("æµç¨‹å¯åŠ¨æˆåŠŸï¼Œæµç¨‹å®ä¾‹ID: {}, æŠ¥é”€å•å·: {}", 
            processInstance.getId(), transNo);
    }
    
    /**
     * å‡†å¤‡æµç¨‹å˜é‡
     */
    private Map<String, Object> prepareProcessVariables(Trans trans) {
        Map<String, Object> variables = new HashMap<>();
        
        // åŸºç¡€ä¿¡æ¯
        variables.put("transId", trans.getTransId());
        variables.put("transNo", trans.getTransNo());
        variables.put("tenantId", trans.getTenantId());
        variables.put("applicantId", trans.getApplicantId());
        variables.put("projectId", trans.getProjectId());
        variables.put("deptId", trans.getDeptId());
        variables.put("transReason", trans.getTransReason());
        
        // é‡‘é¢ä¿¡æ¯
        variables.put("charge", trans.getCharge());
        variables.put("lcCharge", trans.getLcCharge());
        variables.put("currency", trans.getCurrency());
        variables.put("exchangeRate", trans.getExchangeRate());
        variables.put("loanOffsetAmount", 
            trans.getLoanOffsetAmount() != null ? trans.getLoanOffsetAmount() : BigDecimal.ZERO);
        variables.put("payableAmount", trans.getPayableAmount());
        
        // ç±»å‹ä¿¡æ¯
        variables.put("transType", trans.getTypeCode());
        
        // æŸ¥è¯¢å®¡æ‰¹é˜ˆå€¼ï¼ˆä»ç§Ÿæˆ·é…ç½®ï¼‰
        BigDecimal threshold = tenantConfigService.getApprovalThreshold(
            trans.getTenantId(), 
            trans.getTypeCode()
        );
        variables.put("approvalThreshold", threshold);
        
        return variables;
    }
}
```

### 2. é¡¹ç›®æœåŠ¡ï¼ˆæŸ¥è¯¢é¡¹ç›®ç»ç†ï¼‰

```java
@Service
@RequiredArgsConstructor
public class ProjectService {
    
    private final ProjectRepository projectRepository;
    
    /**
     * æ ¹æ®ç§Ÿæˆ·IDå’Œé¡¹ç›®IDæŸ¥è¯¢é¡¹ç›®
     */
    public Project getById(Long tenantId, Long projectId) {
        return projectRepository.findByTenantIdAndProjectId(tenantId, projectId)
                .orElseThrow(() -> new BusinessException("é¡¹ç›®ä¸å­˜åœ¨"));
    }
}
```

### 3. ç»„ç»‡æœåŠ¡ï¼ˆæŸ¥è¯¢éƒ¨é—¨ç»ç†ï¼‰

```java
@Service
@RequiredArgsConstructor
public class OrgService {
    
    private final OrgRepository orgRepository;
    
    /**
     * æ ¹æ®ç§Ÿæˆ·IDå’Œç»„ç»‡IDæŸ¥è¯¢ç»„ç»‡
     */
    public Org getById(Long tenantId, Long orgId) {
        return orgRepository.findByTenantIdAndOrgId(tenantId, orgId)
                .orElseThrow(() -> new BusinessException("ç»„ç»‡ä¸å­˜åœ¨"));
    }
}
```

### 4. ç§Ÿæˆ·é…ç½®æœåŠ¡ï¼ˆæŸ¥è¯¢å®¡æ‰¹é˜ˆå€¼å’Œæ€»ç»ç†ï¼‰

```java
@Service
@RequiredArgsConstructor
public class TenantConfigService {
    
    private final TenantRepository tenantRepository;
    
    /**
     * è·å–æŠ¥é”€å®¡æ‰¹é˜ˆå€¼
     */
    public BigDecimal getApprovalThreshold(Long tenantId, String transType) {
        Tenant tenant = tenantRepository.findById(tenantId)
                .orElseThrow(() -> new BusinessException("ç§Ÿæˆ·ä¸å­˜åœ¨"));
        
        String config = tenant.getConfig();
        if (config == null || config.isEmpty()) {
            // è¿”å›é»˜è®¤é˜ˆå€¼
            return getDefaultThreshold(transType);
        }
        
        try {
            JSONObject configJson = new JSONObject(config);
            String key = transType.toLowerCase() + "_threshold";
            
            if (configJson.has(key)) {
                return configJson.getBigDecimal(key);
            }
            
            // å¦‚æœæ²¡æœ‰ç±»å‹ç‰¹å®šçš„é˜ˆå€¼ï¼Œä½¿ç”¨é€šç”¨é˜ˆå€¼
            if (configJson.has("general_threshold")) {
                return configJson.getBigDecimal("general_threshold");
            }
            
            return BigDecimal.ZERO;
            
        } catch (Exception e) {
            log.error("è§£æç§Ÿæˆ·é…ç½®å¤±è´¥ï¼Œç§Ÿæˆ·ID: {}", tenantId, e);
            return getDefaultThreshold(transType);
        }
    }
    
    /**
     * è·å–æ€»ç»ç†ID
     */
    public Long getGeneralManagerId(Long tenantId) {
        Tenant tenant = tenantRepository.findById(tenantId)
                .orElseThrow(() -> new BusinessException("ç§Ÿæˆ·ä¸å­˜åœ¨"));
        
        String config = tenant.getConfig();
        if (config == null || config.isEmpty()) {
            throw new BusinessException("æœªé…ç½®æ€»ç»ç†");
        }
        
        try {
            JSONObject configJson = new JSONObject(config);
            Long generalManagerId = configJson.getLong("general_manager_id");
            
            if (generalManagerId == null) {
                throw new BusinessException("æœªé…ç½®æ€»ç»ç†ID");
            }
            
            return generalManagerId;
            
        } catch (Exception e) {
            log.error("è§£æç§Ÿæˆ·é…ç½®å¤±è´¥ï¼Œç§Ÿæˆ·ID: {}", tenantId, e);
            throw new BusinessException("è·å–æ€»ç»ç†IDå¤±è´¥");
        }
    }
    
    private BigDecimal getDefaultThreshold(String transType) {
        Map<String, BigDecimal> thresholds = Map.of(
            "general", new BigDecimal("5000"),
            "travel", new BigDecimal("10000"),
            "team_building", new BigDecimal("8000"),
            "domestic_transport", new BigDecimal("3000"),
            "personal_comm", new BigDecimal("2000"),
            "business_activity", new BigDecimal("5000")
        );
        
        return thresholds.getOrDefault(transType.toLowerCase(), new BigDecimal("5000"));
    }
}
```

### 5. é€šçŸ¥æœåŠ¡

```java
@Service
@RequiredArgsConstructor
public class NotificationService {
    
    private final NotificationRepository notificationRepository;
    private final UserService userService;
    
    /**
     * å‘é€å®¡æ‰¹é€šçŸ¥
     */
    public void sendApprovalNotification(
            Long tenantId,
            Object receiver,           // å¯ä»¥æ˜¯Long(ç”¨æˆ·ID)æˆ–String(è§’è‰²ä»£ç ï¼‰
            String title,
            String content) {
        
        List<Long> userIds = new ArrayList<>();
        
        // å¦‚æœæ˜¯å•ä¸ªç”¨æˆ·ID
        if (receiver instanceof Long) {
            userIds.add((Long) receiver);
        } 
        // å¦‚æœæ˜¯è§’è‰²ä»£ç 
        else if (receiver instanceof String) {
            String roleCode = (String) receiver;
            userIds = userService.getUserIdsByRole(tenantId, roleCode);
        }
        
        // åˆ›å»ºé€šçŸ¥è®°å½•
        for (Long userId : userIds) {
            Notification notification = new Notification();
            notification.setTenantId(tenantId);
            notification.setReceiverId(userId);
            notification.setTitle(title);
            notification.setContent(content);
            notification.setType(NotificationType.APPROVAL);
            notification.setStatus(NotificationStatus.UNREAD);
            notification.setBusinessKey("reimbursement");
            notification.setBusinessId(transNo);
            
            notificationRepository.save(notification);
        }
        
        log.info("å‘é€å®¡æ‰¹é€šçŸ¥æˆåŠŸ. ç§Ÿæˆ·ID: {}, æ¥æ”¶äººæ•°: {}, æ ‡é¢˜: {}", 
            tenantId, userIds.size(), title);
    }
}
```

### 6. å¾…åŠä»»åŠ¡æŸ¥è¯¢æœåŠ¡

```java
@Service
@RequiredArgsConstructor
public class WorkflowTaskService {
    
    private final TaskService taskService;
    
    /**
     * è·å–å½“å‰ç”¨æˆ·çš„å¾…åŠä»»åŠ¡åˆ—è¡¨
     */
    public List<TaskVO> getMyTasks(Long userId) {
        return taskService.createTaskQuery()
            .taskAssignee(userId.toString())
            .active()
            .orderByTaskCreateTime()
            .desc()
            .list()
            .stream()
            .map(this::convertToVO)
            .collect(Collectors.toList());
    }
    
    /**
     * å®Œæˆå®¡æ‰¹ä»»åŠ¡
     */
    public void completeTask(String taskId, ApproveDTO approveDTO) {
        Map<String, Object> variables = new HashMap<>();
        variables.put("approvalResult", approveDTO.getApprovalResult());
        variables.put("approvalComment", approveDTO.getApprovalComment());
        
        taskService.complete(taskId, variables);
    }
    
    private TaskVO convertToVO(Task task) {
        TaskVO vo = new TaskVO();
        vo.setTaskId(task.getId());
        vo.setTaskName(task.getName());
        vo.setAssignee(task.getAssignee());
        vo.setCreateTime(task.getCreateTime());
        vo.setDueDate(task.getDueDate());
        vo.setProcessInstanceId(task.getProcessInstanceId());
        vo.setTaskDefinitionKey(task.getTaskDefinitionKey());
        
        // è·å–æµç¨‹å˜é‡
        Map<String, Object> variables = task.getProcessVariables();
        vo.setVariables(variables);
        
        return vo;
    }
}
```

---

## ğŸ“Š å¾…åŠä»»åŠ¡è¿”å›ç»™å‰ç«¯çš„æ•°æ®ç»“æ„

### TaskVOï¼ˆå¾…åŠä»»åŠ¡è§†å›¾å¯¹è±¡ï¼‰

```java
@Data
public class TaskVO {
    private String taskId;
    private String taskName;
    private String assignee;
    private LocalDateTime createTime;
    private LocalDateTime dueDate;
    private String processInstanceId;
    private String taskDefinitionKey;
    
    // æµç¨‹å˜é‡ï¼ˆç”¨äºå‰ç«¯å±•ç¤ºï¼‰
    private Map<String, Object> variables;
    
    // æµç¨‹å˜é‡è®¿é—®å™¨æ–¹æ³•
    public Long getTransId() {
        return (Long) variables.get("transId");
    }
    
    public String getTransNo() {
        return (String) variables.get("transNo");
    }
    
    public BigDecimal getCharge() {
        return (BigDecimal) variables.get("charge");
    }
    
    public String getTransType() {
        return (String) variables.get("transType");
    }
    
    // ... å…¶ä»–getteræ–¹æ³•
}
```

### å‰ç«¯å¾…åŠä»»åŠ¡åˆ—è¡¨å±•ç¤º

```vue
<template>
  <div class="pending-tasks">
    <h2>å¾…æˆ‘å®¡æ‰¹çš„ä»»åŠ¡</h2>
    
    <el-table :data="tasks" style="width: 100%">
      <el-table-column prop="taskName" label="ä»»åŠ¡åç§°" width="150"/>
      <el-table-column prop="assignee" label="å®¡æ‰¹äºº" width="120"/>
      <el-table-column prop="createTime" label="åˆ›å»ºæ—¶é—´" width="180"/>
      <el-table-column prop="dueDate" label="æˆªæ­¢æ—¶é—´" width="180"/>
      <el-table-column prop="charge" label="æŠ¥é”€é‡‘é¢" width="120">
        <template #default="scope">
          <span>{{ scope.row.charge }}</span>
        </template>
      </el-table-column>
      <el-table-column prop="transType" label="æŠ¥é”€ç±»å‹" width="120">
        <template #default="scope">
          <el-tag>{{ transTypeMap(scope.row.transType) }}</el-tag>
        </template>
      </el-table-column>
      <el-table-column label="æ“ä½œ" width="200">
        <template #default="scope">
          <el-button 
            size="small" 
            @click="viewDetail(scope.row)"
            type="primary">
            æŸ¥çœ‹
          </el-button>
          <el-button 
            size="small" 
            @click="approve(scope.row)"
            type="success">
            å®¡æ‰¹
          </el-button>
          <el-button 
            size="small" 
            @click="transfer(scope.row)"
            type="warning">
            è½¬åŠ
          </el-button>
        </template>
      </el-table-column>
    </el-table>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { ref as ref, reactive } from 'vue'
import { ElMessage } from 'element-plus'
import { workflowTaskService } from '@/api/workflow'
import type { TaskVO } from '@/types/workflow'

const tasks = ref<TaskVO[]>([])

onMounted(async () => {
  // è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„IDï¼ˆä»JWT Tokenä¸­è·å–ï¼‰
  const userId = getUserId() // éœ€è¦å®ç°è¿™ä¸ªå‡½æ•°
  tasks.value = await workflowTaskService.getMyTasks(userId)
})

const getUserId = () => {
  // ä»JWT Tokenè§£æç”¨æˆ·ID
  const token = localStorage.getItem('token')
  const payload = JSON.parse(atob(token.split('.')[1]))
  return payload.userId
}

const viewDetail = (task: TaskVO) => {
  // è·³è½¬åˆ°æŠ¥é”€å•è¯¦æƒ…é¡µ
  console.log('æŸ¥çœ‹è¯¦æƒ…:', task)
}

const approve = (task: TaskVO) => {
  ElMessageBox.confirm(`ç¡®è®¤é€šè¿‡è¯¥å®¡æ‰¹ä»»åŠ¡ï¼Ÿ\\nä»»åŠ¡ï¼š${task.taskName}\\næŠ¥é”€å•å·ï¼š${task.transNo}`)
    .then(async () => {
      await workflowTaskService.completeTask(task.taskId, {
        approvalResult: 'APPROVE',
        approvalComment: 'åŒæ„ç”³è¯·'
      })
      ElMessage.success('å®¡æ‰¹æˆåŠŸ')
      // åˆ·æ–°å¾…åŠåˆ—è¡¨
      await refreshTasks()
    })
}

const transfer = (task: TaskVO) => {
  // æ‰“å¼€è½¬åŠå¯¹è¯æ¡†
  console.log('è½¬åŠ:', task)
}

const refreshTasks = async () => {
  const userId = getUserId()
  tasks.value = await workflowTaskService.getMyTasks(userId)
}
</script>
```

---

## ğŸ”‘ å…³é”®æŠ€æœ¯è¦ç‚¹

### 1. å®¡æ‰¹äººè®¾ç½®çš„æ—¶æœº

**å…³é”®æ—¶æœº**ï¼šTaskListenerçš„createäº‹ä»¶

**ä¸ºä»€ä¹ˆç”¨createäº‹ä»¶**ï¼š
- âœ… ä»»åŠ¡åˆšåˆ›å»ºæ—¶ï¼Œå®¡æ‰¹äººè¿˜æœªåˆ†é…
- âœ… å¯ä»¥æŸ¥è¯¢æ•°æ®åº“åŠ¨æ€è®¡ç®—å®¡æ‰¹äºº
- âœ… å¯ä»¥å‘é€å®¡æ‰¹é€šçŸ¥
- âœ… å¯ä»¥è®¾ç½®ä»»åŠ¡è¶…æ—¶æ—¶é—´

**ä¸ºä»€ä¹ˆä¸ä½¿ç”¨assigneeå­—æ®µ**ï¼š
- âŒ assigneeå¿…é¡»åœ¨éƒ¨ç½²BPMNæ–‡ä»¶æ—¶ç¡®å®š
- âŒ æ— æ³•æ ¹æ®æµç¨‹å˜é‡åŠ¨æ€è®¾ç½®
- âŒ æ— æ³•å‘é€å®¡æ‰¹é€šçŸ¥

### 2. æµç¨‹å˜é‡çš„ä½œç”¨åŸŸ

| å˜é‡ç±»å‹ | ä½œç”¨åŸŸ | è¯´æ˜ | ç¤ºä¾‹ |
|----------|--------|------|------|
| å…¨å±€å˜é‡ | æ•´ä¸ªæµç¨‹ | æ‰€æœ‰èŠ‚ç‚¹éƒ½å¯ä»¥è®¿é—® | transId, transNo, tenantId |
| èŠ‚ç‚¹å±€éƒ¨å˜é‡ | å½“å‰èŠ‚ç‚¹ | åªæœ‰å½“å‰èŠ‚ç‚¹å¯ä»¥è®¿é—® | projectManagerId, deptManagerId |
| æµç¨‹å®ä¾‹å˜é‡ | æµç¨‹å®ä¾‹ | æ•´ä¸ªæµç¨‹å®ä¾‹ | processInstanceId |

### 3. å®¡æ‰¹äººçš„3ç§è®¾ç½®æ–¹å¼

#### æ–¹å¼1ï¼šassigneeï¼ˆæ¨èï¼‰

**ç”¨é€”**ï¼šç›´æ¥æŒ‡å®šå•ä¸ªå®¡æ‰¹äºº

**BPMNå®šä¹‰**ï¼š
```xml
<userTask id="projectManagerApproval" name="é¡¹ç›®ç»ç†å®¡æ‰¹">
    <extensionElements>
        <flowable:taskListener 
            event="create" 
            class="com.fs.workflow.listener.ProjectManagerTaskListener"/>
    </extensionElements>
    <!-- ä¸è®¾ç½® assignee -->
</userTask>
```

**TaskListenerå®ç°**ï¼š
```java
@Override
public void notify(DelegateTask delegateTask) {
    // æŸ¥è¯¢é¡¹ç›®ç»ç†ID
    Long projectManagerId = projectService.getById(
        tenantId, 
        (Long) delegateTask.getVariable("projectId")
    ).getLeaderId();
    
    // è®¾ç½®å®¡æ‰¹äºº
    delegateTask.setAssignee(projectManagerId.toString());
}
```

#### æ–¹å¼2ï¼šcandidateUsersï¼ˆå€™é€‰äººåˆ—è¡¨ï¼‰

**ç”¨é€”**ï¼šé¡ºåºå®¡æ‰¹ï¼ˆç¬¬ä¸€ä¸ªäººå®Œæˆä»»åŠ¡åï¼Œè‡ªåŠ¨æµè½¬åˆ°ç¬¬äºŒä¸ªäººï¼‰

**BPMNå®šä¹‰**ï¼š
```xml
<userTask id="financeAudit" name="è´¢åŠ¡å®¡æ ¸">
    <extensionElements>
        <flowable:taskListener 
            event="create" 
            class="com.fs.workflow.listener.FinanceAuditTaskListener"/>
    </extensionElements>
    <candidateUsers>${financeManager1},${financeManager2},${financeManager3}</candidateUsers>
</userTask>
```

**é€‚ç”¨åœºæ™¯**ï¼š
- éœ€è¦å¤šä¸ªè´¢åŠ¡äººå‘˜ä¸­ä»»æ„ä¸€äººå®Œæˆå®¡æ‰¹
- å®¡æ‰¹äººæŒ‰ä¼˜å…ˆçº§æ’åºå®¡æ‰¹

#### æ–¹å¼3ï¼šcandidateGroupsï¼ˆå€™é€‰äººç»„ï¼‰

**ç”¨é€”**ï¼šå¹¶è¡Œå®¡æ‰¹ï¼ˆå€™é€‰äººç»„å†…æ‰€æœ‰äººéƒ½å¯ä»¥å®¡æ‰¹ï¼Œä»»æ„ä¸€äººå®Œæˆå³ç»“æŸï¼‰

**BPMNå®šä¹‰**ï¼š
```xml
<userTask id="financeAudit" name="è´¢åŠ¡å®¡æ ¸">
    <extensionElements>
        <flowable:taskListener 
            event="create" 
            class="com.fs.workflow.listener.FinanceAuditTaskListener"/>
    </extensionElements>
    <candidateGroups>FINANCE</candidateGroups>
</userTask>
```

**é€‚ç”¨åœºæ™¯**ï¼š
- è´¢åŠ¡éƒ¨é—¨å¤šä¸ªäººæœ‰å®¡æ‰¹æƒé™
- ä»»æ„ä¸€äººå®Œæˆå³å¯

---

## ğŸ“Š å®Œæ•´æ•°æ®æµç¤ºä¾‹

### åœºæ™¯1ï¼šå‘˜å·¥æäº¤æŠ¥é”€å•

**ç”¨æˆ·æ“ä½œ**ï¼š
```
å‰ç«¯ï¼šç”¨æˆ·ç‚¹å‡»"æäº¤å®¡æ‰¹"æŒ‰é’®
```

**å‰ç«¯è°ƒç”¨**ï¼š
```javascript
POST /api/reimbursement/submit
{
  "transNo": "BX202501240001"
}
```

**åç«¯å¤„ç†**ï¼š
```java
@PostMapping("/reimbursement/submit")
public Result<Void> submitReimbursement(@RequestBody SubmitDTO dto) {
    // 1. æŸ¥è¯¢æŠ¥é”€å•
    Trans trans = transRepository.findByTransNo(dto.getTransNo());
    
    // 2. éªŒè¯çŠ¶æ€
    if (trans.getState() != TransState.DRAFT) {
        return Result.error("åªæœ‰è‰ç¨¿çŠ¶æ€æ‰èƒ½æäº¤");
    }
    
    // 3. å¯åŠ¨æµç¨‹
    reimbursementService.submitApprovalProcess(trans.getTransNo());
    
    return Result.success("æäº¤æµç¨‹æˆåŠŸ");
}
```

**æµç¨‹å¯åŠ¨**ï¼š
```java
// reimbursementService.submitApprovalProcess()
Map<String, Object> variables = new HashMap<>();
variables.put("transId", 1001L);
variables.put("transNo", "BX202501240001");
variables.put("tenantId", 1L);
variables.put("applicantId", 5001L);
variables.put("projectId", 2001L);
variables.put("deptId", 3001L);
variables.put("charge", new BigDecimal("5000.00"));
variables.put("lcCharge", new BigDecimal("5000.00"));
variables.put("currency", "CNY");
variables.put("exchangeRate", new BigDecimal("1.0"));
variables.put("loanOffsetAmount", BigDecimal.ZERO);
variables.put("payableAmount", new BigDecimal("5000.00"));
variables.put("transType", "GENERAL");

runtimeService.startProcessInstanceByKey(
    "reimbursementApprovalProcess",
    "BX202501240001",
    variables
);
```

**æµç¨‹å¼•æ“å†…éƒ¨å¤„ç†**ï¼š
```
1. Camundaæµç¨‹å¼•æ“æ¥æ”¶åˆ°æµç¨‹å¯åŠ¨è¯·æ±‚
2. æ ¹æ®BPMNæ–‡ä»¶åˆ›å»ºæµç¨‹å®ä¾‹
3. åˆ›å»º"é¡¹ç›®ç»ç†å®¡æ‰¹"ä»»åŠ¡
4. è§¦å‘ProjectManagerTaskListenerçš„createäº‹ä»¶
5. TaskListeneræŸ¥è¯¢ProjectServiceè·å–leaderId = 6001
6. TaskListenerè®¾ç½®task.setAssignee("6001")
7. Camundaå¼•æ“å°†ä»»åŠ¡åˆ†é…ç»™ç”¨æˆ·6001
8. å‰ç«¯é€šè¿‡GET /api/workflow/tasks/myè·å–å¾…åŠä»»åŠ¡åˆ—è¡¨
9. å‰ç«¯å±•ç¤ºç»™ç”¨æˆ·6001çš„å¾…åŠä»»åŠ¡
```

### åœºæ™¯2ï¼šç”¨æˆ·å®¡æ‰¹é€šè¿‡

**ç”¨æˆ·æ“ä½œ**ï¼š
```
å‰ç«¯ï¼šå®¡æ‰¹äºº6001ç‚¹å‡»"å®¡æ‰¹é€šè¿‡"æŒ‰é’®
```

**å‰ç«¯è°ƒç”¨**ï¼š
```javascript
POST /api/workflow/task/task-001/complete
{
  "approvalResult": "APPROVE",
  "approvalComment": "åŒæ„ç”³è¯·"
}
```

**åç«¯å¤„ç†**ï¼š
```java
@PostMapping("/workflow/task/{taskId}/complete")
public Result<Void> completeTask(
        @PathVariable String taskId,
        @RequestBody ApproveDTO dto) {
    
    // 1. å®Œæˆä»»åŠ¡
    workflowTaskService.completeTask(taskId, dto);
    
    // 2. Camundaæµç¨‹å¼•æ“è‡ªåŠ¨å¤„ç†ï¼š
    //    - è®¾ç½®å®¡æ‰¹ç»“æœå˜é‡
    //    - è§¦å‘completeäº‹ä»¶
    //    - ProjectManagerCompleteListeneræ‰§è¡Œ
    //    - åˆ¤æ–­é¡¹ç›®ç»ç†å’Œéƒ¨é—¨ç»ç†æ˜¯å¦ä¸ºåŒä¸€äºº
    //    - å¦‚æœä¸æ˜¯åŒä¸€äººï¼Œåˆ›å»ºéƒ¨é—¨ç»ç†å®¡æ‰¹ä»»åŠ¡
    //    - å¦‚æœæ˜¯åŒä¸€äººï¼Œè‡ªåŠ¨å®Œæˆéƒ¨é—¨ç»ç†å®¡æ‰¹
    //    - æµè½¬åˆ°ä¸‹ä¸€èŠ‚ç‚¹
    
    return Result.success("å®¡æ‰¹æˆåŠŸ");
}
```

**Camundaå¼•æ“å†…éƒ¨å¤„ç†**ï¼š
```
1. Camundaå¼•æ“æ¥æ”¶å®Œæˆä»»åŠ¡è¯·æ±‚
2. è®¾ç½®æµç¨‹å˜é‡ï¼š
   approvalResult: "APPROVE"
   approvalComment: "åŒæ„ç”³è¯·"
3. è§¦å‘completeäº‹ä»¶
4. ProjectManagerCompleteListeneræ‰§è¡Œï¼š
   - è·å–å®¡æ‰¹ç»“æœï¼š"APPROVE"
   - è·å–å®¡æ‰¹æ„è§ï¼š"åŒæ„ç”³è¯·"
   - æŸ¥è¯¢é¡¹ç›®ç»ç†IDå’Œéƒ¨é—¨ç»ç†ID
   - åˆ¤æ–­isSameManager
   - å¦‚æœisSameManager=false:
     â†’ è§¦å‘éƒ¨é—¨ç»ç†å®¡æ‰¹ä»»åŠ¡çš„createäº‹ä»¶
   - å¦‚æœisSameManager=true:
     â†’ è·³è¿‡éƒ¨é—¨ç»ç†å®¡æ‰¹
     â†’ ç›´æ¥åˆ°é‡‘é¢åˆ¤æ–­ç½‘å…³
```

### åœºæ™¯3ï¼šæŸ¥è¯¢å¾…åŠä»»åŠ¡

**ç”¨æˆ·æ“ä½œ**ï¼š
```
å‰ç«¯ï¼šç”¨æˆ·ç™»å½•åï¼Œè‡ªåŠ¨æŸ¥è¯¢å¾…åŠä»»åŠ¡
```

**å‰ç«¯è°ƒç”¨**ï¼š
```javascript
// ç™»å½•åè‡ªåŠ¨æŸ¥è¯¢
GET /api/workflow/tasks/my
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInV4c3IjoiLCJhbGciOiJIzI2NiJ9.eyJ...`

// æŸ¥è¯¢å½“å‰ç”¨æˆ·çš„æ‰€æœ‰å¾…åŠä»»åŠ¡
GET /api/workflow/tasks/my
```

**åç«¯å¤„ç†**ï¼š
```java
@GetMapping("/workflow/tasks/my")
public Result<List<TaskVO>> getMyTasks() {
    // 1. ä»JWT Tokenä¸­è·å–ç”¨æˆ·ID
    Long userId = getCurrentUserId();
    
    // 2. æŸ¥è¯¢è¯¥ç”¨æˆ·çš„å¾…åŠä»»åŠ¡
    List<Task> tasks = taskService.createTaskQuery()
        .taskAssignee(userId.toString())
        .active()
        .orderByTaskCreateTime()
        .desc()
        .list();
    
    // 3. è½¬æ¢ä¸ºVOå¹¶è¿”å›
    List<TaskVO> taskVOs = tasks.stream()
        .map(this::convertToVO)
        .collect(Collectors.toList());
    
    return Result.success(taskVOs);
}

private TaskVO convertToVO(Task task) {
    TaskVO vo = new TaskVO();
    vo.setTaskId(task.getId());
    vo.setTaskName(task.getName());
    vo.setAssignee(task.getAssignee());
    vo.setCreateTime(task.getCreateTime());
    vo.setDueDate(task.getDueDate());
    vo.setProcessInstanceId(task.getProcessInstanceId());
    vo.setTaskDefinitionKey(task.getTaskDefinitionKey());
    
    // è·å–æµç¨‹å˜é‡
    vo.setVariables(task.getProcessVariables());
    
    return vo;
}
```

**å‰ç«¯å±•ç¤º**ï¼š
```vue
<template>
  <div class="pending-tasks">
    <el-table :data="tasks" style="width: 100%">
      <el-table-column prop="taskName" label="ä»»åŠ¡åç§°"/>
      <el-table-column prop="createTime" label="åˆ›å»ºæ—¶é—´"/>
      <el-table-column prop="charge" label="é‡‘é¢">
        <template #default="scope">
          <span>{{ scope.row.charge }}</span>
        </template>
      </el-table-column>
      <el-table-column label="æ“ä½œ">
        <template #default="scope">
          <el-button @click="approve(scope.row)" type="success">
            å®¡æ‰¹
          </el-button>
        </template>
      </el-table-column>
    </el-table>
  </div>
</template>
```

---

## ğŸ¯ æ€»ç»“

### æµç¨‹å¼•æ“ä¸å®é™…æ•°æ®æµç»“åˆçš„æ ¸å¿ƒæœºåˆ¶

| æœºåˆ¶ | ä½œç”¨ | ç¤ºä¾‹ |
|------|------|------|
| **æµç¨‹å˜é‡** | ä¼ é€’ä¸šåŠ¡æ•°æ®åˆ°æµç¨‹ | transId, projectId, deptId, charge |
| **TaskListenerï¼ˆcreateäº‹ä»¶ï¼‰** | ä»æ•°æ®åº“æŸ¥è¯¢å®é™…å®¡æ‰¹äºº | æŸ¥è¯¢project.leader_id, org.leader_id |
| **assigneeå­—æ®µ** | è®¾ç½®å®¡æ‰¹äºº | task.setAssignee(approverId) |
| **å€™é€‰äººç±»åˆ«** | æ”¯æŒé¡ºåº/å¹¶è¡Œå®¡æ‰¹ | candidateUsers, candidateGroups |
| **æµç¨‹å˜é‡æŸ¥è¯¢** | åœ¨ä»»åŠ¡ä¸­è·å–ä¸šåŠ¡æ•°æ® | variables.get("transId") |

### æ•°æ®æµå‘

```
1. ä¸šåŠ¡å±‚è®¾ç½®æµç¨‹å˜é‡ï¼ˆä»æ•°æ®åº“è·å–ï¼‰ï¼š
   - projectId â†’ æŸ¥è¯¢project.leader_id â†’ projectManagerId
   - deptId â†’ æŸ¥è¯¢org.leader_id â†’ deptManagerId
   - tenantId â†’ æŸ¥è¯¢tenant.config â†’ generalManagerId
   - charge â†’ è®¡ç®—é˜ˆå€¼ â†’ approvalThreshold

2. å¯åŠ¨æµç¨‹å®ä¾‹ï¼Œè®¾ç½®æµç¨‹å˜é‡ï¼š
   runtimeService.startProcessInstanceByKey(processKey, businessKey, variables)

3. æµç¨‹å¼•æ“åˆ›å»ºä»»åŠ¡ï¼Œè§¦å‘TaskListenerï¼š
   TaskListener.createäº‹ä»¶ â†’ æŸ¥è¯¢æ•°æ®åº“ â†’ è®¾ç½®assignee

4. å‰ç«¯æŸ¥è¯¢å¾…åŠä»»åŠ¡ï¼š
   taskService.createTaskQuery().taskAssignee(userId).list()

5. ç”¨æˆ·å®¡æ‰¹ï¼š
   taskService.complete(taskId, approvalResult)

6. æµç¨‹å¼•æ“æ ¹æ®BPMNæµç¨‹å®šä¹‰è‡ªåŠ¨æµè½¬åˆ°ä¸‹ä¸€èŠ‚ç‚¹
```

---

## ğŸš€ å…³é”®è¦ç‚¹

1. **æµç¨‹å˜é‡æ˜¯æ¡¥æ¢**ï¼šæµç¨‹å˜é‡è¿æ¥ä¸šåŠ¡æ•°æ®å’Œæµç¨‹å¼•æ“
2. **TaskListeneræ˜¯æŸ¥è¯¢è€…**ï¼šåœ¨createäº‹ä»¶ä¸­æŸ¥è¯¢æ•°æ®åº“
3. **assigneeæ˜¯è®¾ç½®è€…**ï¼šå°†æŸ¥è¯¢ç»“æœè®¾ç½®ç»™ä»»åŠ¡
4. **å®Œå…¨ç¦»çº¿**ï¼šæ‰€æœ‰å®¡æ‰¹äººæŸ¥è¯¢éƒ½å‘ç”Ÿåœ¨ä¼ä¸šå†…éƒ¨æ•°æ®åº“
5. **æ— äº’è”ç½‘ä¾èµ–**ï¼šæµç¨‹å¼•æ“ä¸ç›´æ¥æŸ¥è¯¢å¤–éƒ¨ç³»ç»Ÿ
6. **å®‰å…¨å¯æ§**ï¼šæ‰€æœ‰æŸ¥è¯¢éƒ½ç»è¿‡Serviceå±‚ï¼Œæœ‰æƒé™éªŒè¯
7. **å®æ—¶æ€§**ï¼šæµç¨‹å¯åŠ¨å’Œä»»åŠ¡åˆ›å»ºéƒ½æ˜¯å®æ—¶çš„

---

## ğŸ“Œ å®ç°æ­¥éª¤å»ºè®®

### ç¬¬1æ­¥ï¼šå®ç°åŸºç¡€æ•°æ®åº“æœåŠ¡
1. âœ… ProjectService.getById() - æŸ¥è¯¢é¡¹ç›®å’Œè´Ÿè´£äºº
2. âœ… OrgService.getById() - æŸ¥è¯¢ç»„ç»‡å’Œè´Ÿè´£äºº
3. âœ… TenantConfigService.getApprovalThreshold() - æŸ¥è¯¢å®¡æ‰¹é˜ˆå€¼
4. âœ… TenantConfigService.getGeneralManagerId() - æŸ¥è¯¢æ€»ç»ç†

### ç¬¬2æ­¥ï¼šå®ç°ä»»åŠ¡ç›‘å¬å™¨
1. âœ… ProjectManagerTaskListener
2. âœ… DeptManagerTaskListener
3. âœ… GeneralManagerTaskListener
4. âœ… FinanceAuditTaskListener
5. âœ… CashierPaymentTaskListener
6. âœ… EmployeeUpdateTaskListener

### ç¬¬3æ­¥ï¼šå®ç°æµç¨‹æœåŠ¡
1. âœ… WorkflowTaskService.getMyTasks()
2. âœ… WorkflowTaskService.completeTask()
3. âœ… WorkflowTaskService.transferTask()

### ç¬¬4æ­¥ï¼šé›†æˆåˆ°æŠ¥é”€ä¸šåŠ¡
1. âœ… ReimbursementService.submitApprovalProcess()
2. âœ… æäº¤æ—¶è‡ªåŠ¨å¯åŠ¨æµç¨‹
3. âœ… æ›´æ–°æŠ¥é”€å•çŠ¶æ€å’Œæµç¨‹å®ä¾‹ID

### ç¬¬5æ­¥ï¼šå®ç°å‰ç«¯é›†æˆ
1. âœ… å¾…åŠä»»åŠ¡åˆ—è¡¨é¡µé¢
2. âœ… å®¡æ‰¹å¯¹è¯æ¡†
3. âœ… æŠ¥é”€å•è¯¦æƒ…é¡µï¼ˆå«æµç¨‹å†å²ï¼‰

---

## ğŸ“Œ æ‚¨çš„é—®é¢˜å›ç­”

### æ‚¨çš„é—®é¢˜ï¼šæµç¨‹å¼•æ“æ€ä¹ˆçŸ¥é“åº”è¯¥è½¬åˆ°è°å»å®¡æ‰¹ï¼Ÿ

### ç­”æ¡ˆï¼š

**æµç¨‹å¼•æ“æœ¬èº«ä¸çŸ¥é“**å®¡æ‰¹äººæ˜¯è°ï¼

**ä½†é€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°**ï¼š

1. **æ­¥éª¤1**ï¼šå¯åŠ¨æµç¨‹æ—¶ï¼Œè®¾ç½®æµç¨‹å˜é‡
   ```java
   variables.put("projectId", trans.getProjectId());
   variables.put("deptId", trans.getDeptId());
   ```

2. **æ­¥éª¤2**ï¼šé¡¹ç›®ç»ç†å®¡æ‰¹ä»»åŠ¡åˆ›å»ºæ—¶ï¼Œè§¦å‘TaskListener
   ```java
   public class ProjectManagerTaskListener implements TaskListener {
       @Override
       public void notify(DelegateTask delegateTask) {
           // ä»æµç¨‹å˜é‡è·å–projectId
           Long projectId = delegateTask.getVariable("projectId");
           
           // æŸ¥è¯¢æ•°æ®åº“
           Project project = projectService.getById(projectId);
           Long projectManagerId = project.getLeaderId();
           
           // è®¾ç½®å®¡æ‰¹äºº
           delegateTask.setAssignee(projectManagerId.toString());
       }
   }
   ```

3. **æ­¥éª¤3**ï¼šå‰ç«¯æŸ¥è¯¢å¾…åŠä»»åŠ¡æ—¶ï¼Œå®¡æ‰¹äººå·²ç»è®¾ç½®å¥½
   ```java
   taskService.createTaskQuery()
       .taskAssignee(userId.toString())  // åªè¿”å›å½“å‰ç”¨æˆ·çš„ä»»åŠ¡
       .list()
   ```

4. **æ­¥éª¤4**ï¼šç”¨æˆ·å®¡æ‰¹åï¼Œæµç¨‹å¼•æ“è‡ªåŠ¨æµè½¬åˆ°ä¸‹ä¸€èŠ‚ç‚¹
   ```java
   taskService.complete(taskId, variables);
   // Camundaæ ¹æ®BPMNè‡ªåŠ¨æµè½¬
   ```

---

## ğŸ“Œ å…³é”®æ•°æ®æµå‘å›¾

```
ä¸šåŠ¡æ•°æ®åº“                Camundaæµç¨‹å¼•æ“                å‰ç«¯
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      â”‚                         â”‚                      â”‚
â”‚ transè¡¨                 â”‚                         â”‚  taskè¡¨          â”‚
â”‚ trans_id: 1001         â”‚                         â”‚  id: "task-001"     â”‚
â”‚ project_id: 2001          â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬  â”‚ assignee: "6001"  â”‚
â”‚ dept_id: 3001            â”‚                         â”‚  name: "é¡¹ç›®ç»ç†å®¡æ‰¹"  â”‚
â”‚ applicant_id: 5001        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ process_id: "proc-001" â”‚
â”‚ state: DRAFT â†’ SUBMITTED â”‚                         â”‚  create_time: "2025-01-24"  â”‚
â”‚ workflow_inst_id: NULL    â”‚                         â”‚  due_date: "2025-01-25"  â”‚
â”‚                      â”‚                         â”‚  variables: {          â”‚
â”‚                      â”‚                         â”‚    transId: 1001,     â”‚
â”‚                      â”‚                         â”‚    projectId: 2001,   â”‚
â”‚                      â”‚                         â”‚    applicantId: 5001, â”‚
â”‚                      â”‚                         â”‚    charge: 5000.00, â”‚
â”‚                      â”‚ â”‚    ...                      â”‚
â”‚                      â”‚ â”‚ }                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  ProjectService.getById(2001)        â”‚
         â”‚                                        â”‚
         â”‚  é¡¹ç›®ä¿¡æ¯:                             â”‚
         â”‚  project_id: 2001                     â”‚
         â”‚  leader_id: 6001                      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Camundaæµç¨‹å¼•æ“                        â”‚
         â”‚  ProjectManagerTaskListener            â”‚
         â”‚  (createäº‹ä»¶ï¼‰                      â”‚
         â”‚                                        â”‚
         â”‚  æ‰§è¡Œ:                                â”‚
         â”‚    1. è·å–projectIdæµç¨‹å˜é‡   â”‚
         â”‚    projectId = 2001                    â”‚
         â”‚                                        â”‚
         â”‚    2. è°ƒç”¨ProjectService  â”‚
         â”‚       project.getById(1, 2001)     â”‚
         â”‚       project = {               â”‚
         â”‚         project_id: 2001,     â”‚
         â”‚         leader_id: 6001      â”‚
         â”‚       }                         â”‚
         â”‚                                        â”‚
         â”‚    3. è®¾ç½®å®¡æ‰¹äºº: assignee="6001" â”‚
         â”‚                                        â”‚
         â”‚    4. å¯é€‰: è®¾ç½®æµç¨‹å˜é‡:      â”‚
         â”‚       task.setVariable(         â”‚
         â”‚         "projectManagerId",   6001 â”‚
         â”‚       )                        â”‚
         â”‚                                        â”‚
         â”‚    5. å¯é€‰: å‘é€é€šçŸ¥:          â”‚
         â”‚       notificationService.send()     â”‚
         â”‚                                  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Camundaæµç¨‹å¼•æ“                        â”‚
         â”‚  taskè¡¨                                â”‚
         â”‚                                        â”‚
         â”‚  id: "task-001"                       â”‚
         â”‚  assignee: "6001"                     â”‚
â”‚  name: "é¡¹ç›®ç»ç†å®¡æ‰¹"                   â”‚
â”‚  process_instance_id: "proc-001"            â”‚
â”‚  create_time: "2025-01-24 10:30"  â”‚
â”‚  due_date: "2025-01-25 10:30"   â”‚
â”‚  variables: {                            â”‚
â”‚    "transId": 1001,                     â”‚
â”‚    "projectId": 2001,                   â”‚
â”‚    "applicantId": 5001,               â”‚
â”‚    "charge": 5000.00,                   â”‚
â”‚    ...                                 â”‚
â”‚  }                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  GET /api/workflow/tasks/my          â”‚
         â”‚  Authorization: Bearer <JWT>    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  è¿”å›ä»»åŠ¡åˆ—è¡¨ç»™å‰ç«¯                    â”‚
         â”‚  TaskVO:                             â”‚
         â”‚    taskId: "task-001"                    â”‚
         â”‚    taskName: "é¡¹ç›®ç»ç†å®¡æ‰¹"              â”‚
         â”‚    assignee: "6001"                    â”‚
â”‚    createTime: "2025-01-24 10:30"   â”‚
â”‚    dueDate: "2025-01-25 10:30"    â”‚
â”‚    processInstanceId: "proc-001"          â”‚
â”‚    variables: {                             â”‚
â”‚       "transId": 1001,                       â”‚
â”‚       "transNo": "BX202501240001",             â”‚
â”‚       "charge": 5000.00,                       â”‚
â”‚       "projectId": 2001,                     â”‚
â”‚       "applicantId": "5001,                     â”‚
â”‚       ...                                 â”‚
â”‚    }                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  å‰ç«¯å±•ç¤ºå¾…åŠä»»åŠ¡åˆ—è¡¨              â”‚
         â”‚                                        â”‚
â”‚  å¾…å®¡æ‰¹ä»»åŠ¡åˆ—è¡¨:                          â”‚
â”‚    1. æŠ¥é”€å•: BX202501240001              â”‚
â”‚       ç”³è¯·äºº: å¼ ä¸‰                        â”‚
â”‚       ä»»åŠ¡: é¡¹ç›®ç»ç†å®¡æ‰¹                  â”‚
â”‚       æ—¶é—´: 2025-01-24 10:30          â”‚
â”‚       é‡‘é¢: Â¥5,000.00                   â”‚
â”‚       [æŸ¥çœ‹] [å®¡æ‰¹] [è½¬åŠ]                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Œ æ€»ç»“

### æ ¸å¿ƒæœºåˆ¶

**æµç¨‹å¼•æ“ä¸å®é™…æ•°æ®æµçš„ç»“åˆæ–¹å¼**ï¼š

1. **å¯åŠ¨æµç¨‹æ—¶**ï¼šè®¾ç½®æµç¨‹å˜é‡ï¼ˆä¸šåŠ¡æ•°æ®ï¼‰
2. **åˆ›å»ºä»»åŠ¡æ—¶**ï¼šè§¦å‘TaskListener
3. **TaskListenerä¸­**ï¼šæŸ¥è¯¢æ•°æ®åº“ï¼ˆè·å–å®é™…å®¡æ‰¹äººï¼‰
4. **è®¾ç½®assignee**ï¼šå°†å®¡æ‰¹äººIDè®¾ç½®ç»™ä»»åŠ¡
5. **æŸ¥è¯¢å¾…åŠä»»åŠ¡**ï¼šå‰ç«¯è·å–åˆ†é…ç»™å½“å‰ç”¨æˆ·çš„ä»»åŠ¡
6. **å®Œæˆä»»åŠ¡æ—¶**ï¼šæµç¨‹å¼•æ“æ ¹æ®BPMNè‡ªåŠ¨æµè½¬

### å…³é”®ä»£ç æ–‡ä»¶

| æ–‡ä»¶ | ä½œç”¨ |
|------|------|
| `ProjectManagerTaskListener.java` | é¡¹ç›®ç»ç†å®¡æ‰¹ç›‘å¬å™¨ |
| `DeptManagerTaskListener.java` | éƒ¨é—¨ç»ç†å®¡æ‰¹ç›‘å¬å™¨ |
| `GeneralManagerTaskListener.java` | æ€»ç»ç†å®¡æ‰¹ç›‘å¬å™¨ |
| `FinanceAuditTaskListener.java` | è´¢åŠ¡å®¡æ ¸ç›‘å¬å™¨ |
| `CashierPaymentTaskListener.java` | å‡ºçº³ä»˜æ¬¾ç›‘å¬å™¨ |
| `EmployeeUpdateTaskListener.java` | å‘˜å·¥ä¿®æ”¹ç›‘å¬å™¨ |
| `ReimbursementService.java` | æŠ¥é”€æœåŠ¡ï¼ˆå¯åŠ¨æµç¨‹ï¼‰ |
| `WorkflowTaskService.java` | å·¥ä½œæµä»»åŠ¡æœåŠ¡ï¼ˆæŸ¥è¯¢ã€å®Œæˆï¼‰ |
| `ProjectService.java` | é¡¹ç›®æœåŠ¡ï¼ˆæŸ¥è¯¢é¡¹ç›®è´Ÿè´£äººï¼‰ |
| `OrgService.java` | ç»„ç»‡æœåŠ¡ï¼ˆæŸ¥è¯¢éƒ¨é—¨è´Ÿè´£äººï¼‰|
| `TenantConfigService.java` | ç§Ÿæˆ·é…ç½®æœåŠ¡ï¼ˆæŸ¥è¯¢é˜ˆå€¼ã€æ€»ç»ç†ï¼‰|
| `NotificationService.java` | é€šçŸ¥æœåŠ¡ï¼ˆå‘é€é€šçŸ¥ï¼‰|

---

**æ‚¨è¿˜æœ‰å…¶ä»–ç–‘é—®å—ï¼Ÿæ¯”å¦‚ï¼š**
1. å€Ÿæ¬¾æŠµæ‰£å¦‚ä½•å®ç°ï¼Ÿ
2. æ™ºèƒ½å®¡æ‰¹é€»è¾‘å¦‚ä½•å®ç°ï¼Ÿ
3. å®¡æ‰¹è¶…æ—¶å¦‚ä½•å¤„ç†ï¼Ÿ
4. å®¡æ‰¹å†å²å¦‚ä½•è®°å½•ï¼Ÿ

**è¯·å‘Šè¯‰æˆ‘æ‚¨çš„æƒ³æ³•ï¼** ğŸš€
