# 企业内网环境下的流程调整方案

## 🎯 约束条件

**核心约束**：企业内部无法访问互联网

**影响**：
- ❌ 无法使用Camunda Web Modeler（在线版）
- ❌ 无法使用云端服务
- ❌ 无法访问外部资源

---

## 📊 重新评估方案

### 方案1：Camunda Desktop Modeler（离线版）⭐⭐⭐⭐⭐

#### 简介
Camunda官方提供的免费桌面应用，完全离线使用。

#### 优点
1. ✅ **完全离线** - 无需网络连接
2. ✅ **功能强大** - 支持所有BPMN 2.0特性
3. ✅ **完全免费** - 无功能限制
4. ✅ **跨平台** - 支持Windows/Mac/Linux
5. ✅ **无需安装服务器** - 桌面应用，直接使用

#### 缺点
1. ⚠️ **文件管理** - BPMN文件需要手动管理
2. ⚠️ **团队协作** - 无法实时同步，需要手动传输文件
3. ⚠️ **版本管理** - 需要依赖Git或其他版本管理工具

#### 解决方案

##### 文件管理方案

**目录结构**：
```
financial-reimbursement/
├── srcnew/
│   ├── backend/
│   │   └── main/
│   │       └── resources/
│   │           └── processes/
│   │               ├── reimbursement-approval.bpmn
│   │               ├── loan-approval.bpmn
│   │               └── repayment-approval.bpmn
│   └── docs/
│       └── bpmn/
│           ├── reimbursement-approval.png
│           ├── reimbursement-approval.pdf
│           └── flow-changes/
│               ├── v1.0/
│               │   └── reimbursement-approval.bpmn
│               ├── v1.1/
│               │   └── reimbursement-approval.bpmn
│               └── v2.0/
│                   └── reimbursement-approval.bpmn
```

##### 版本管理方案

**使用Git管理BPMN文件**：

```bash
# 1. 初始化Git仓库（如果还没有）
cd srcnew/backend/main/resources/processes
git init
git add .
git commit -m "Initial commit: v1.0 流程定义"

# 2. 创建流程变更记录
git tag v1.0

# 3. 调整流程后
# 修改 reimbursement-approval.bpmn
git add reimbursement-approval.bpmn
git commit -m "feat: 增加副总经理审批节点"
git tag v1.1

# 4. 查看流程变更历史
git log --oneline --graph

# 5. 版本对比
git diff v1.0 v1.1

# 6. 版本回退
git checkout v1.0
```

##### 团队协作方案

**方案A：共享文件服务器**
```
内网文件服务器
└── 流程定义/
    ├── 最新版本/
    │   └── reimbursement-approval.bpmn
    ├── 历史版本/
    │   ├── v1.0/
    │   ├── v1.1/
    │   └── v2.0/
    └── 流程图/
        └── reimbursement-approval.png
```

**方案B：Git协作（推荐）**
```bash
# 1. 创建流程定义Git仓库
git init processes-repo
cd processes-repo

# 2. 创建目录结构
mkdir -p processes/{active,history,docs}
mkdir -p docs/images

# 3. 提交初始流程
git add processes/active/reimbursement-approval.bpmn
git add docs/images/reimbursement-approval.png
git commit -m "Initial: v1.0 报销审批流程"

# 4. 标记版本
git tag -a v1.0 -m "v1.0: 初始版本"

# 5. 团队成员克隆仓库
git clone git@internal-git-server:financial-reimbursement/processes-repo.git

# 6. 调整流程
git checkout -b feature/add-vice-general-manager
# 修改 reimbursement-approval.bpmn
git add processes/active/reimbursement-approval.bpmn
git commit -m "feat: 增加副总经理审批节点"

# 7. 提交代码审查
git push origin feature/add-vice-general-manager

# 8. 合并到主分支
git checkout main
git merge feature/add-vice-general-manager

# 9. 打标签
git tag -a v2.0 -m "v2.0: 增加副总经理审批节点"
git push origin main --tags
```

#### 操作流程

**场景：需要增加"副总经理审批"节点**

**步骤1：打开Camunda Desktop Modeler**
```
双击 Camunda Modeler 图标启动应用
```

**步骤2：打开现有流程**
```
File -> Open -> 选择 reimbursement-approval.bpmn
```

**步骤3：调整流程**
```
1. 从左侧面板拖拽 User Task 节点到画布
2. 配置节点属性
3. 重新连线
4. 保存文件
```

**步骤4：提交到Git**
```bash
git add srcnew/backend/main/resources/processes/reimbursement-approval.bpmn
git commit -m "feat: 增加副总经理审批节点"
git tag v2.0
```

**步骤5：导出流程图**
```
File -> Export As PNG -> 保存到 docs/images/reimbursement-approval-v2.0.png
```

**步骤6：部署到测试环境**
```bash
# 1. 复制BPMN文件到测试服务器
scp srcnew/backend/main/resources/processes/reimbursement-approval.bpmn test-server:/opt/financial-reimbursement/processes/

# 2. 通过后端API部署流程
curl -X POST http://test-server:8080/api/workflow/deploy \
  -H "Content-Type: multipart/form-data" \
  -F "file=@reimbursement-approval.bpmn"
```

**步骤7：测试验证**
```
1. 登录测试环境
2. 创建测试报销单
3. 验证流程是否正确
4. 确认审批节点是否正确
```

**步骤8：部署到生产环境**
```bash
# 1. 复制BPMN文件到生产服务器
scp srcnew/backend/main/resources/processes/reimbursement-approval.bpmn prod-server:/opt/financial-reimbursement/processes/

# 2. 通过后端API部署流程
curl -X POST http://prod-server:8080/api/workflow/deploy \
  -H "Content-Type: multipart/form-data" \
  -F "file=@reimbursement-approval.bpmn"
```

**步骤9：通知业务人员**
```
发送邮件/钉钉通知：
主题：流程调整通知 - 报销审批流程 v2.0

内容：
尊敬的业务人员：

报销审批流程已调整，主要变更如下：
1. 新增"副总经理审批"节点
2. 调整审批顺序
3. 其他...

流程版本：v2.0
调整时间：2025-01-24 15:30
调整人：张三（技术部）

如有问题，请联系技术部。

谢谢！
```

**时间成本**：
- 调整流程：5分钟
- Git提交：2分钟
- 部署测试：3分钟
- 测试验证：10分钟
- 部署生产：3分钟
- 通知业务：2分钟
- **总计：25分钟**

---

### 方案2：自建Camunda Web Modeler（企业内部）⭐⭐⭐⭐

#### 简介
在企业内部搭建Camunda Web Modeler服务器。

#### 优点
1. ✅ **完全离线** - 部署在企业内部网络
2. ✅ **团队协作** - 支持多人同时编辑
3. ✅ **实时同步** - 修改实时同步给团队成员
4. ✅ **权限控制** - 支持细粒度的编辑权限
5. ✅ **版本管理** - 自动保存历史版本

#### 缺点
1. ⚠️ **需要部署** - 需要部署和维护服务器
2. ⚠️ **开发成本** - 需要一定开发和配置成本
3. ⚠️ **服务器资源** - 需要服务器资源

#### 实施方案

##### 技术架构

```
┌─────────────────────────────────────────────────┐
│         企业内网环境                               │
│                                                  │
│  ┌────────────────────────────────────────┐  │
│  │   Nginx (反向代理）                       │  │
│  │   Port: 80/443                           │  │
│  └─────────────┬──────────────────────────┘  │
│                  │                              │
│         ┌────────┴────────┐                   │
│         │   Docker       │                   │
│         │   Camunda     │                   │
│         │   Web Modeler  │                   │
│         │   Port: 8080   │                   │
│         └────────┬────────┘                   │
│                  │                              │
│         ┌────────┴────────┐                   │
│         │   PostgreSQL  │                   │
│         │   Port: 5432   │                   │
│         └─────────────────┘                   │
│                                                  │
│  访问地址：http://workflow-modeler.internal/   │
│                                                  │
└─────────────────────────────────────────────────┘
```

##### Docker部署方式

**1. 准备Docker Compose文件**

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:15
    container_name: camunda-modeler-postgres
    environment:
      POSTGRES_DB: camunda_modeler
      POSTGRES_USER: camunda
      POSTGRES_PASSWORD: camunda123
    ports:
      - "5432:5432"
    volumes:
      - camunda-modeler-data:/var/lib/postgresql/data
    networks:
      - camunda-network
    restart: unless-stopped

  camunda-modeler:
    image: camunda/camunda-modeler:latest
    container_name: camunda-modeler
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/camunda_modeler
      SPRING_DATASOURCE_USERNAME: camunda
      SPRING_DATASOURCE_PASSWORD: camunda123
      CAMUNDA_WEB_MODELER_URL: http://camunda-modeler.internal:8080
    ports:
      - "8080:8080"
    depends_on:
      - postgres
    volumes:
      - ./logs:/app/logs
      - ./uploads:/app/uploads
    networks:
      - camunda-network
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    container_name: camunda-modeler-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - camunda-modeler
    networks:
      - camunda-network
    restart: unless-stopped

volumes:
  camunda-modeler-data:
  camunda-modeler-logs:
  camunda-modeler-uploads:
  camunda-modeler-ssl:

networks:
  camunda-network:
    driver: bridge
```

**2. 准备Nginx配置**

```nginx
server {
    listen 80;
    server_name workflow-modeler.internal;

    location / {
        proxy_pass http://camunda-modeler:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

**3. 启动服务**

```bash
# 1. 创建目录
mkdir -p {logs,uploads,ssl}

# 2. 启动服务
docker-compose up -d

# 3. 查看日志
docker-compose logs -f

# 4. 访问Web Modeler
# 浏览器访问：http://workflow-modeler.internal/
```

**4. 配置用户和权限**

```bash
# 登录Camunda Web Modeler
# 默认管理员账号：demo / demo

# 创建用户
1. 登录后，点击右上角头像
2. 点击 "Users"
3. 点击 "Create User"
4. 创建用户：
   - Username: zhangsan
   - Email: zhangsan@company.com
   - Password: zhangsan123
   - Role: Designer

5. 分配权限：
   - 流程设计权限
   - 流程部署权限
   - 流程查看权限
```

**5. 创建项目和流程**

```bash
1. 登录Camunda Web Modeler
2. 点击 "New Project"
3. 输入项目名称：Financial Reimbursement
4. 创建流程：
   - 点击 "New Diagram"
   - 选择 "BPMN 2.0 Diagram"
   - 输入流程名称：reimbursement-approval
```

**6. 团队协作**

```bash
1. 点击项目右上角 "Share"
2. 复制分享链接
3. 发送给团队成员
4. 团队成员点击链接即可协作编辑
```

**7. 部署到Camunda服务器**

```bash
# 方式1：通过API部署
curl -X POST http://camunda-server.internal:8080/api/workflow/deploy \
  -H "Content-Type: application/json" \
  -d '{
    "processName": "reimbursementApprovalProcess",
    "processKey": "reimbursementApprovalProcess",
    "bpmnXml": "...",
    "deploymentName": "Financial Reimbursement Process"
  }'

# 方式2：通过Web界面部署
1. 点击流程右上角 "Deploy"
2. 选择Camunda服务器
3. 点击 "Deploy"
```

#### 操作流程

**场景：需要增加"副总经理审批"节点**

**步骤1：打开Camunda Web Modeler**
```
浏览器访问：http://workflow-modeler.internal/
```

**步骤2：登录账号**
```
输入用户名和密码登录
```

**步骤3：打开项目**
```
点击 "Financial Reimbursement" 项目
```

**步骤4：打开流程**
```
点击 "reimbursement-approval" 流程
```

**步骤5：调整流程**
```
1. 拖拽 User Task 节点到画布
2. 配置节点属性
3. 重新连线
4. 流程自动保存
```

**步骤6：验证流程**
```
1. 点击 "Validate" 按钮
2. 检查验证结果
3. 修正错误（如果有）
```

**步骤7：预览流程**
```
1. 点击 "Preview" 按钮
2. 查看流程图
3. 确认流程正确
```

**步骤8：部署到测试环境**
```
1. 点击 "Deploy" 按钮
2. 选择测试环境
3. 点击 "Deploy"
```

**步骤9：测试验证**
```
1. 登录测试环境
2. 创建测试报销单
3. 验证流程是否正确
```

**步骤10：部署到生产环境**
```
1. 点击 "Deploy" 按钮
2. 选择生产环境
3. 点击 "Deploy"
```

**步骤11：通知业务人员**
```
系统自动发送钉钉通知：
主题：流程调整通知 - 报销审批流程 v2.0
内容：流程已部署到生产环境
```

**时间成本**：
- 调整流程：3分钟
- 验证流程：2分钟
- 部署测试：1分钟
- 测试验证：10分钟
- 部署生产：1分钟
- 通知业务：系统自动
- **总计：17分钟**

---

### 方案3：自研Web版流程设计器（集成到报销系统）⭐⭐⭐⭐⭐

#### 简介
基于Vue 3 + BPMN.js自研的Web版流程设计器，集成到报销系统内部。

#### 优点
1. ✅ **完全离线** - 部署在企业内部
2. ✅ **完全自定义** - 可根据需求定制所有功能
3. ✅ **集成度高** - 直接集成到报销系统
4. ✅ **用户体验** - 可以完全按照业务需求设计UI
5. ✅ **权限控制** - 与系统权限完全打通
6. ✅ **业务友好** - 可以隐藏BPMN技术细节

#### 缺点
1. ⚠️ **开发成本高** - 需要开发2-3周
2. ⚠️ **维护成本高** - Bug修复、功能迭代都需要自己来
3. ⚠️ **功能受限** - 无法支持所有BPMN特性

#### 技术实现方案

**技术栈**：
- 前端：Vue 3 + bpmn-js + Element Plus
- 后端：Spring Boot + Camunda API
- 存储：PostgreSQL（与报销系统共用）

**核心功能**：
1. 流程可视化编辑（拖拽节点、连线）
2. 节点属性配置（审批人、超时时间等）
3. 流程验证（完整性检查）
4. 流程版本管理（Git集成）
5. 流程部署（一键部署到Camunda）
6. 流程预览（BPMN可视化）
7. 流程历史（查看历史版本、对比差异）
8. 权限控制（只有管理员和流程管理员可编辑）
9. 流程模板（提供常用流程模板）

#### 界面设计

```
┌─────────────────────────────────────────────────────┐
│  系统管理 > 流程设计器                              [返回]    │
├─────────────────────────────────────────────────────┤
│                                                             │
│  流程列表                                              │
│  ┌──────────────────────────────────────────────┐    │
│  │ 报销审批流程  [编辑][部署][删除]         │    │
│  │ 借款审批流程  [编辑][部署][删除]         │    │
│  │ 还款审批流程  [编辑][部署][删除]         │    │
│  └──────────────────────────────────────────────┘    │
│                                      [+ 新建流程]  │
│                                                             │
│  流程版本历史                                          │
│  ┌──────────────────────────────────────────────┐    │
│  │ v1.0 (2025-01-24) [查看][对比]             │    │
│  │ v1.1 (2025-01-25) [查看][对比]             │    │
│  │ v2.0 (2025-01-26) [查看][对比][回退]    │    │
│  └──────────────────────────────────────────────┘    │
│                                                             │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│  流程设计器 - 报销审批流程               [保存][部署] │
├─────────────────────────────────────────────────────┤
│                                                             │
│  节点面板              流程画布              属性面板          │
│  ┌─────────┐         ┌──────────────────────────┐  ┌─────────┐  │
│  │ 节点    │         │                          │  │ 节点    │  │
│  │        │         │      员工提交              │  │ 基本信息 │  │
│  │ ┌────┐ │         │         [START]          │  │ 名称:   │  │
│  │ │开始│ │         │            │             │  │ 节点ID  │  │
│  │ └────┘ │         │            ▼             │  └─────────┘  │
│  │        │         │    ┌─────────────────┐    │  ┌─────────┐  │
│  │ ┌────┐ │         │    │ 项目经理审批    │    │  │ 审批人  │  │
│  │ │用户│ │         │    │  (User Task)    │    │  │ 类型:   │  │
│  │ │任务│ │         │    └────────┬────────┘    │  │ 变量:   │  │
│  │ └────┘ │         │             │             │  │         │  │
│  │        │         │        ┌────┴────┐        │  │ 超时时间│  │
│  │ ┌────┐ │         │        │         │        │  │         │  │
│  │ │网关│ │         │   通过   │ 驳回   │        │  └─────────┘  │
│  │ └────┘ │         │        │         │        │  ┌─────────┐  │
│  │        │         │        ▼         ▼        │  │ 流程变量│  │
│  │        │         │  ┌─────────┐  ┌─────────┐ │  │ transId│  │
│  │        │         │  │部门经理 │  │员工修改  │ │  │ projectId│ │
│  │        │         │  └────┬────┘  └─────────┘ │  │ charge  │  │
│  │        │         │       │                   │  └─────────┘  │
│  │        │         │       ▼                   │              │
│  │        │         │  ┌─────────────────┐      │              │
│  │        │         │  │ 智能判断网关    │      │              │
│  │        │         │  └────────┬────────┘      │              │
│  │        │         │           │                │              │
│  │        │         │     ┌─────┴─────┐          │              │
│  │        │         │     │           │          │              │
│  │        │         │   同一人     不同人       │              │
│  │        │         │     │           │          │              │
│  │        │         │     ▼           ▼          │              │
│  │        │         │  金额判断   部门经理      │              │
│  │        │         │     └─────┬─────┘          │              │
│  │        │         │           │                │              │
│  │        │         │           ▼                │              │
│  │        │         │     ┌───────────────┐      │              │
│  │        │         │     │ 结束          │      │              │
│  │        │         │     │  [END]        │      │              │
│  │        │         │     └───────────────┘      │              │
│  │        │         └──────────────────────────┘              │
│  └─────────┘                                              │
│                                                             │
│  [撤销][重做][缩放][预览][验证][导出BPMN][导出图片]               │
│                                                             │
└─────────────────────────────────────────────────────┘
```

#### 操作流程

**场景：需要增加"副总经理审批"节点**

**步骤1：登录报销系统**
```
浏览器访问：http://financial-reimbursement.internal/
```

**步骤2：进入流程设计器**
```
菜单：系统管理 > 流程设计器
```

**步骤3：打开报销审批流程**
```
流程列表中点击"报销审批流程"的"编辑"按钮
```

**步骤4：拖拽节点**
```
从左侧节点面板拖拽"审批节点"到画布
```

**步骤5：配置节点属性**
```
点击节点，在右侧属性面板配置：
- 节点名称：副总经理审批
- 审批人：${viceGeneralManagerId}
- 超时时间：2天
```

**步骤6：重新连线**
```
拖拽连接线，连接各个节点
```

**步骤7：验证流程**
```
点击"验证"按钮，检查流程完整性
```

**步骤8：预览流程**
```
点击"预览"按钮，查看流程图
```

**步骤9：保存流程**
```
点击"保存"按钮，保存流程
```

**步骤10：部署流程**
```
点击"部署"按钮，部署到Camunda
```

**时间成本**：
- 调整流程：5分钟
- 验证流程：2分钟
- 保存流程：1分钟
- 部署流程：1分钟
- **总计：9分钟**

---

## 🏆 推荐方案

### 推荐：自研Web版流程设计器 ⭐⭐⭐⭐⭐

#### 推荐理由

**针对企业内网环境**：
1. ✅ **完全离线** - 部署在企业内部，无需互联网
2. ✅ **集成度高** - 直接集成到报销系统，无需切换
3. ✅ **用户体验** - 完全自定义，业务友好
4. ✅ **权限控制** - 与系统权限完全打通
5. ✅ **长期成本** - 一次开发，长期使用
6. ✅ **维护可控** - 自己掌控，不依赖第三方

**相比其他方案的优势**：

| 对比项 | Camunda Desktop | 自建Web Modeler | 自研Web版设计器 |
|--------|-----------------|------------------|-----------------|
| 离线使用 | ✅ 是 | ✅ 是 | ✅ 是 |
| 团队协作 | ❌ 需要Git | ✅ 实时同步 | ✅ 实时同步 |
| 集成度 | ❌ 需要切换 | ⚠️ 独立系统 | ✅ 集成到系统 |
| 用户体验 | ⚠️ 需要学习 | ⚠️ 有一定学习成本 | ✅ 完全自定义 |
| 权限控制 | ❌ 无 | ✅ 粗粒度 | ✅ 细粒度 |
| 开发成本 | 0 | 中等（部署+配置） | 高（2-3周） |
| 维护成本 | 低 | 中等（服务器维护） | 高（自己维护） |
| 长期成本 | 低 | 中 | 低 |
| **推荐指数** | ⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |

---

## 📊 实施建议

### 方案A：快速上线（推荐）

**第一阶段（第1-3个月）：使用Camunda Desktop Modeler + Git**

**理由**：
1. ✅ 零开发成本，立即使用
2. ✅ Git管理版本，方便协作
3. ✅ 快速上线，适应需求变化

**操作流程**：
```
业务需求 → 技术人员用Camunda Desktop调整 → Git提交 → 部署测试 → 测试验证 → 部署生产 → 通知业务
```

**时间成本**：
- 简单调整：15分钟
- 复杂调整：1小时

**第二阶段（第3个月后）：自研Web版流程设计器**

**理由**：
1. ✅ 提升用户体验
2. ✅ 降低长期成本
3. ✅ 业务友好

---

## 📌 最终推荐

### 推荐：自研Web版流程设计器 ⭐⭐⭐⭐⭐

#### 理由
1. ✅ **完全离线** - 满足企业内网环境要求
2. ✅ **集成度高** - 直接集成到报销系统
3. ✅ **用户体验** - 完全自定义，业务友好
4. ✅ **权限控制** - 与系统权限完全打通
5. ✅ **长期成本** - 一次开发，长期使用
6. ✅ **维护可控** - 自己掌控，不依赖第三方

#### 备选方案：Camunda Desktop Modeler + Git

#### 理由
1. ✅ **零开发成本** - 立即使用
2. ✅ **完全免费** - 无功能限制
3. ✅ **版本管理** - Git管理，方便协作
4. ✅ **适合快速上线** - 前3个月使用

#### 实施策略
```
第1-3个月：Camunda Desktop Modeler + Git（快速上线）
↓
第3个月后：自研Web版流程设计器（提升体验）
```

---

**您觉得这个方案如何？是否同意使用自研Web版流程设计器？**
