# è´¢åŠ¡æŠ¥é”€SaaSç³»ç»Ÿ - å¾®æœåŠ¡æ¶æ„è¯¦ç»†è®¾è®¡

## ğŸ“‹ æ–‡æ¡£è¯´æ˜

**ç‰ˆæœ¬**: 1.0.0  
**æ—¥æœŸ**: 2026-01-25  
**ä½œè€…**: System Architecture Team

---

## ç›®å½•

1. [æ•´ä½“æ¶æ„æ¦‚è§ˆ](#æ•´ä½“æ¶æ„æ¦‚è§ˆ)
2. [å¾®æœåŠ¡æ¸…å•](#å¾®æœåŠ¡æ¸…å•)
3. [æœåŠ¡1: Tenant Service - ç§Ÿæˆ·ç®¡ç†æœåŠ¡](#æœåŠ¡1-tenant-service---ç§Ÿæˆ·ç®¡ç†æœåŠ¡)
4. [æœåŠ¡2: User Service - ç”¨æˆ·ç®¡ç†æœåŠ¡](#æœåŠ¡2-user-service---ç”¨æˆ·ç®¡ç†æœåŠ¡)
5. [æœåŠ¡3: Org Service - ç»„ç»‡ç®¡ç†æœåŠ¡](#æœåŠ¡3-org-service---ç»„ç»‡ç®¡ç†æœåŠ¡)
6. [æœåŠ¡4: Trans Service - æŠ¥é”€æœåŠ¡](#æœåŠ¡4-trans-service---æŠ¥é”€æœåŠ¡)
7. [æœåŠ¡5: Loan Service - å€Ÿæ¬¾æœåŠ¡](#æœåŠ¡5-loan-service---å€Ÿæ¬¾æœåŠ¡)
8. [æœåŠ¡6: Repayment Service - è¿˜æ¬¾æœåŠ¡](#æœåŠ¡6-repayment-service---è¿˜æ¬¾æœåŠ¡)
9. [æœåŠ¡7: Approval Service - å®¡æ‰¹æœåŠ¡](#æœåŠ¡7-approval-service---å®¡æ‰¹æœåŠ¡)
10. [æœåŠ¡8: Notification Service - é€šçŸ¥æœåŠ¡](#æœåŠ¡8-notification-service---é€šçŸ¥æœåŠ¡)
11. [æœåŠ¡9: Report Service - æŠ¥è¡¨æœåŠ¡](#æœåŠ¡9-report-service---æŠ¥è¡¨æœåŠ¡)
12. [æœåŠ¡10: File Service - æ–‡ä»¶æœåŠ¡](#æœåŠ¡10-file-service---æ–‡ä»¶æœåŠ¡)
13. [æœåŠ¡é—´é€šä¿¡è®¾è®¡](#æœåŠ¡é—´é€šä¿¡è®¾è®¡)
14. [éƒ¨ç½²æ¶æ„](#éƒ¨ç½²æ¶æ„)
15. [ç›‘æ§å’Œè¿ç»´](#ç›‘æ§å’Œè¿ç»´)

---

## æ•´ä½“æ¶æ„æ¦‚è§ˆ

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Client Layer                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ Web Client   â”‚  â”‚ Mobile App   â”‚  â”‚ Third-party  â”‚          â”‚
â”‚  â”‚ (Vue 3)      â”‚  â”‚ (å°ç¨‹åº/APP) â”‚  â”‚ Integrations â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      API Gateway Layer                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚            Spring Cloud Gateway                           â”‚  â”‚
â”‚  â”‚  - Tenant Identification (å­åŸŸå/Token)                   â”‚  â”‚
â”‚  â”‚  - Authentication & Authorization                         â”‚  â”‚
â”‚  â”‚  - Rate Limiting & Circuit Breaker                       â”‚  â”‚
â”‚  â”‚  - Request Routing                                        â”‚  â”‚
â”‚  â”‚  - Logging & Tracing                                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Microservices Layer                         â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚Tenant Serviceâ”‚  â”‚User Service  â”‚  â”‚Org Service   â”‚          â”‚
â”‚  â”‚(8761)        â”‚  â”‚(8762)        â”‚  â”‚(8763)        â”‚          â”‚
â”‚  â”‚ç§Ÿæˆ·ç®¡ç†      â”‚  â”‚ç”¨æˆ·ç®¡ç†      â”‚  â”‚ç»„ç»‡ç®¡ç†      â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚Trans Service â”‚  â”‚Loan Service  â”‚  â”‚Repayment Svc  â”‚          â”‚
â”‚  â”‚(8764)        â”‚  â”‚(8765)        â”‚  â”‚(8766)        â”‚          â”‚
â”‚  â”‚æŠ¥é”€ç®¡ç†      â”‚  â”‚å€Ÿæ¬¾ç®¡ç†      â”‚  â”‚è¿˜æ¬¾ç®¡ç†      â”‚          â”‚
â”‚  â”‚(æ ¸å¿ƒä¸šåŠ¡)    â”‚  â”‚(æ ¸å¿ƒä¸šåŠ¡)    â”‚  â”‚(æ ¸å¿ƒä¸šåŠ¡)    â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚Approval Svc  â”‚  â”‚Notify Svc    â”‚  â”‚Report Serviceâ”‚          â”‚
â”‚  â”‚(8767)        â”‚  â”‚(8768)        â”‚  â”‚(8769)        â”‚          â”‚
â”‚  â”‚å®¡æ‰¹æµç¨‹      â”‚  â”‚é€šçŸ¥æ¶ˆæ¯      â”‚  â”‚æŠ¥è¡¨ç»Ÿè®¡      â”‚          â”‚
â”‚  â”‚(Camunda)     â”‚  â”‚(RabbitMQ)    â”‚  â”‚(Elasticsearch)â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚
â”‚  â”‚File Service  â”‚                                                â”‚
â”‚  â”‚(8770)        â”‚                                                â”‚
â”‚  â”‚æ–‡ä»¶å­˜å‚¨      â”‚                                                â”‚
â”‚  â”‚(MinIO)       â”‚                                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Infrastructure Layer                          â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚Nacos         â”‚  â”‚RabbitMQ      â”‚  â”‚Redis         â”‚          â”‚
â”‚  â”‚æ³¨å†Œ+é…ç½®      â”‚  â”‚æ¶ˆæ¯é˜Ÿåˆ—      â”‚  â”‚ç¼“å­˜          â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚PostgreSQL    â”‚  â”‚MinIO         â”‚  â”‚Camunda       â”‚          â”‚
â”‚  â”‚ä¸»æ•°æ®åº“      â”‚  â”‚å¯¹è±¡å­˜å‚¨      â”‚  â”‚å·¥ä½œæµå¼•æ“    â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚Prometheus    â”‚  â”‚Grafana       â”‚  â”‚SkyWalking    â”‚          â”‚
â”‚  â”‚ç›‘æ§æŒ‡æ ‡      â”‚  â”‚å¯è§†åŒ–        â”‚  â”‚é“¾è·¯è¿½è¸ª      â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Deployment Layer                              â”‚
â”‚                      Kubernetes (K8s)                           â”‚
â”‚  - Container Orchestration                                      â”‚
â”‚  - Auto Scaling                                                  â”‚
â”‚  - Service Discovery                                            â”‚
â”‚  - Config Management                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å¾®æœåŠ¡æ¸…å•

| æœåŠ¡ID | æœåŠ¡åç§° | ç«¯å£ | ä¼˜å…ˆçº§ | æŠ€æœ¯æ ˆ | ç‹¬ç«‹æ‰©å±• |
|--------|---------|------|--------|--------|---------|
| 1 | Tenant Service | 8761 | P0 | Spring Boot 3.2 + MyBatis Plus | âŒ |
| 2 | User Service | 8762 | P0 | Spring Boot 3.2 + MyBatis Plus + Spring Security | âŒ |
| 3 | Org Service | 8763 | P0 | Spring Boot 3.2 + MyBatis Plus | âŒ |
| 4 | Trans Service | 8764 | P0 | Spring Boot 3.2 + MyBatis Plus + Camunda Client | âœ… |
| 5 | Loan Service | 8765 | P0 | Spring Boot 3.2 + MyBatis Plus + Camunda Client | âœ… |
| 6 | Repayment Service | 8766 | P0 | Spring Boot 3.2 + MyBatis Plus + Camunda Client | âœ… |
| 7 | Approval Service | 8767 | P0 | Spring Boot 3.2 + Camunda 8 Embedded | âœ… |
| 8 | Notification Service | 8768 | P1 | Spring Boot 3.2 + RabbitMQ | âœ… |
| 9 | Report Service | 8769 | P1 | Spring Boot 3.2 + Elasticsearch | âœ… |
| 10 | File Service | 8770 | P1 | Spring Boot 3.2 + MinIO SDK | âœ… |

---

## æœåŠ¡1: Tenant Service - ç§Ÿæˆ·ç®¡ç†æœåŠ¡

### ğŸ“‹ æœåŠ¡æ¦‚è§ˆ

**æœåŠ¡åç§°**: tenant-service  
**æœåŠ¡ç«¯å£**: 8761  
**ä¼˜å…ˆçº§**: P0ï¼ˆæ ¸å¿ƒåŸºç¡€æœåŠ¡ï¼‰  
**æŠ€æœ¯æ ˆ**: Spring Boot 3.2 + MyBatis Plus + PostgreSQL  
**èŒè´£èŒƒå›´**: ç§Ÿæˆ·æ³¨å†Œã€ç§Ÿæˆ·ä¿¡æ¯ç®¡ç†ã€ç§Ÿæˆ·é…ç½®ç®¡ç†ã€ç§Ÿæˆ·çŠ¶æ€ç®¡ç†

### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½ID | åŠŸèƒ½åç§° | æè¿° | ä¼˜å…ˆçº§ |
|--------|---------|------|--------|
| T-001 | ç§Ÿæˆ·æ³¨å†Œ | åˆ›å»ºæ–°ç§Ÿæˆ·ï¼Œåˆå§‹åŒ–ç§Ÿæˆ·æ•°æ® | P0 |
| T-002 | ç§Ÿæˆ·æŸ¥è¯¢ | æŸ¥è¯¢ç§Ÿæˆ·ä¿¡æ¯ | P0 |
| T-003 | ç§Ÿæˆ·æ›´æ–° | æ›´æ–°ç§Ÿæˆ·åŸºæœ¬ä¿¡æ¯ | P0 |
| T-004 | ç§Ÿæˆ·çŠ¶æ€ç®¡ç† | å¯ç”¨/åœç”¨/è¿‡æœŸç§Ÿæˆ· | P0 |
| T-005 | ç§Ÿæˆ·é…ç½®ç®¡ç† | ç®¡ç†ç§Ÿæˆ·ä¸ªæ€§åŒ–é…ç½® | P1 |
| T-006 | ç§Ÿæˆ·é…é¢ç®¡ç† | ç®¡ç†ç”¨æˆ·æ•°ã€å­˜å‚¨ç©ºé—´é…é¢ | P1 |
| T-007 | å­åŸŸåç®¡ç† | ç®¡ç†ç§Ÿæˆ·å­åŸŸå | P1 |

### ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

**è¡¨**: tenant

```sql
-- ç§Ÿæˆ·è¡¨
CREATE TABLE tenant (
    -- ä¸»é”®
    tenant_id BIGSERIAL PRIMARY KEY,
    
    -- åŸºæœ¬ä¿¡æ¯
    tenant_code VARCHAR(50) NOT NULL UNIQUE,
    tenant_name VARCHAR(200) NOT NULL,
    tenant_type VARCHAR(50) NOT NULL,              -- COMPANY/DEPARTMENT
    subdomain VARCHAR(50) UNIQUE,                  -- å­åŸŸåï¼ˆç”¨äºSaaSè®¿é—®ï¼‰
    
    -- è”ç³»ä¿¡æ¯
    contact_name VARCHAR(60),
    contact_phone VARCHAR(20),
    contact_email VARCHAR(100),
    
    -- ç§Ÿæˆ·çŠ¶æ€
    status VARCHAR(20) NOT NULL DEFAULT 'PENDING', -- ACTIVE/SUSPENDED/EXPIRED/PENDING
    
    -- è®¡è´¹ä¿¡æ¯
    max_users INTEGER DEFAULT 10,
    max_storage_mb INTEGER DEFAULT 1024,
    current_users INTEGER DEFAULT 0,
    current_storage_mb INTEGER DEFAULT 0,
    expire_date DATE,
    
    -- ç§Ÿæˆ·é…ç½®ï¼ˆJSONï¼‰
    config JSONB,                                 -- ä¸ªæ€§åŒ–é…ç½®
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP,
    remarks TEXT
);

-- ç´¢å¼•
CREATE INDEX idx_tenant_status ON tenant(status);
CREATE INDEX idx_tenant_subdomain ON tenant(subdomain);
CREATE INDEX idx_tenant_type ON tenant(tenant_type);
```

### ğŸ”Œ APIæ¥å£è®¾è®¡

#### 1. ç§Ÿæˆ·æ³¨å†Œ

**POST** `/api/tenant/register`

```json
// Request
{
  "tenantCode": "COMPANY_A",
  "tenantName": "Aå…¬å¸",
  "tenantType": "COMPANY",
  "subdomain": "company-a",
  "contactName": "å¼ ä¸‰",
  "contactPhone": "13800138000",
  "contactEmail": "zhangsan@company-a.com",
  "maxUsers": 100,
  "maxStorageMb": 10240
}

// Response
{
  "code": 200,
  "message": "ç§Ÿæˆ·æ³¨å†ŒæˆåŠŸ",
  "data": {
    "tenantId": 1,
    "tenantCode": "COMPANY_A",
    "tenantName": "Aå…¬å¸",
    "subdomain": "company-a",
    "status": "PENDING"
  }
}
```

#### 2. ç§Ÿæˆ·æŸ¥è¯¢

**GET** `/api/tenant/{tenantId}`

**Response**
```json
{
  "code": 200,
  "data": {
    "tenantId": 1,
    "tenantCode": "COMPANY_A",
    "tenantName": "Aå…¬å¸",
    "tenantType": "COMPANY",
    "subdomain": "company-a",
    "contactName": "å¼ ä¸‰",
    "contactPhone": "13800138000",
    "contactEmail": "zhangsan@company-a.com",
    "status": "ACTIVE",
    "maxUsers": 100,
    "currentUsers": 45,
    "maxStorageMb": 10240,
    "currentStorageMb": 5120,
    "config": {
      "customLogo": "https://...",
      "customTheme": "dark"
    }
  }
}
```

#### 3. ç§Ÿæˆ·çŠ¶æ€æ›´æ–°

**PUT** `/api/tenant/{tenantId}/status`

```json
// Request
{
  "status": "ACTIVE"
}

// Response
{
  "code": 200,
  "message": "ç§Ÿæˆ·çŠ¶æ€æ›´æ–°æˆåŠŸ"
}
```

#### 4. ç§Ÿæˆ·é…ç½®æ›´æ–°

**PUT** `/api/tenant/{tenantId}/config`

```json
// Request
{
  "config": {
    "customLogo": "https://...",
    "customTheme": "dark",
    "approvalSettings": {
      "autoApproveThreshold": 5000
    }
  }
}
```

### ğŸ’» æ ¸å¿ƒä»£ç å®ç°

#### TenantController.java

```java
package com.fs.tenant.controller;

import com.fs.common.core.result.Result;
import com.fs.tenant.dto.TenantDTO;
import com.fs.tenant.dto.TenantRegisterDTO;
import com.fs.tenant.dto.TenantUpdateDTO;
import com.fs.tenant.service.TenantService;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;

import jakarta.validation.Valid;

@RestController
@RequestMapping("/api/tenant")
@RequiredArgsConstructor
public class TenantController {
    
    private final TenantService tenantService;
    
    /**
     * ç§Ÿæˆ·æ³¨å†Œ
     */
    @PostMapping("/register")
    public Result<TenantDTO> register(@Valid @RequestBody TenantRegisterDTO dto) {
        return Result.success(tenantService.register(dto));
    }
    
    /**
     * æŸ¥è¯¢ç§Ÿæˆ·
     */
    @GetMapping("/{tenantId}")
    public Result<TenantDTO> getTenant(@PathVariable Long tenantId) {
        return Result.success(tenantService.getTenantById(tenantId));
    }
    
    /**
     * æ ¹æ®å­åŸŸåè·å–ç§Ÿæˆ·ID
     */
    @GetMapping("/subdomain/{subdomain}")
    public Result<Long> getTenantIdBySubdomain(@PathVariable String subdomain) {
        return Result.success(tenantService.getTenantIdBySubdomain(subdomain));
    }
    
    /**
     * æ›´æ–°ç§Ÿæˆ·çŠ¶æ€
     */
    @PutMapping("/{tenantId}/status")
    public Result<Void> updateStatus(
            @PathVariable Long tenantId,
            @RequestParam String status) {
        tenantService.updateStatus(tenantId, status);
        return Result.success();
    }
    
    /**
     * æ›´æ–°ç§Ÿæˆ·é…ç½®
     */
    @PutMapping("/{tenantId}/config")
    public Result<Void> updateConfig(
            @PathVariable Long tenantId,
            @RequestBody String configJson) {
        tenantService.updateConfig(tenantId, configJson);
        return Result.success();
    }
}
```

#### TenantService.java

```java
package com.fs.tenant.service;

import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fs.common.tenant.exception.TenantNotFoundException;
import com.fs.tenant.dto.TenantDTO;
import com.fs.tenant.dto.TenantRegisterDTO;
import com.fs.tenant.entity.Tenant;
import com.fs.tenant.mapper.TenantMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDate;

@Slf4j
@Service
@RequiredArgsConstructor
public class TenantService extends ServiceImpl<TenantMapper, Tenant> {
    
    private final ObjectMapper objectMapper;
    
    /**
     * ç§Ÿæˆ·æ³¨å†Œ
     */
    @Transactional(rollbackFor = Exception.class)
    public TenantDTO register(TenantRegisterDTO dto) {
        log.info("æ³¨å†Œç§Ÿæˆ·: {}", dto.getTenantName());
        
        // 1. æ£€æŸ¥ç§Ÿæˆ·ä»£ç æ˜¯å¦å·²å­˜åœ¨
        boolean exists = baseMapper.exists(
            new LambdaQueryWrapper<Tenant>()
                .eq(Tenant::getTenantCode, dto.getTenantCode())
        );
        
        if (exists) {
            throw new RuntimeException("ç§Ÿæˆ·ä»£ç å·²å­˜åœ¨");
        }
        
        // 2. æ£€æŸ¥å­åŸŸåæ˜¯å¦å·²å­˜åœ¨
        if (dto.getSubdomain() != null) {
            exists = baseMapper.exists(
                new LambdaQueryWrapper<Tenant>()
                    .eq(Tenant::getSubdomain, dto.getSubdomain())
            );
            
            if (exists) {
                throw new RuntimeException("å­åŸŸåå·²è¢«ä½¿ç”¨");
            }
        }
        
        // 3. åˆ›å»ºç§Ÿæˆ·
        Tenant tenant = new Tenant();
        tenant.setTenantCode(dto.getTenantCode());
        tenant.setTenantName(dto.getTenantName());
        tenant.setTenantType(dto.getTenantType());
        tenant.setSubdomain(dto.getSubdomain());
        tenant.setContactName(dto.getContactName());
        tenant.setContactPhone(dto.getContactPhone());
        tenant.setContactEmail(dto.getContactEmail());
        tenant.setStatus("PENDING");
        tenant.setMaxUsers(dto.getMaxUsers() != null ? dto.getMaxUsers() : 10);
        tenant.setMaxStorageMb(dto.getMaxStorageMb() != null ? dto.getMaxStorageMb() : 1024);
        tenant.setCurrentUsers(0);
        tenant.setCurrentStorageMb(0);
        
        save(tenant);
        
        // 4. åˆå§‹åŒ–ç§Ÿæˆ·æ•°æ®ï¼ˆç®¡ç†å‘˜è´¦å·ã€é»˜è®¤è§’è‰²ã€é»˜è®¤ç»„ç»‡ç­‰ï¼‰
        initializeTenantData(tenant.getTenantId(), dto);
        
        log.info("ç§Ÿæˆ·æ³¨å†ŒæˆåŠŸ: tenantId={}", tenant.getTenantId());
        return convertToDTO(tenant);
    }
    
    /**
     * æŸ¥è¯¢ç§Ÿæˆ·
     */
    public TenantDTO getTenantById(Long tenantId) {
        Tenant tenant = getById(tenantId);
        if (tenant == null) {
            throw new TenantNotFoundException("ç§Ÿæˆ·ä¸å­˜åœ¨: " + tenantId);
        }
        return convertToDTO(tenant);
    }
    
    /**
     * æ ¹æ®å­åŸŸåè·å–ç§Ÿæˆ·ID
     */
    public Long getTenantIdBySubdomain(String subdomain) {
        Tenant tenant = getOne(
            new LambdaQueryWrapper<Tenant>()
                .eq(Tenant::getSubdomain, subdomain)
        );
        
        if (tenant == null) {
            throw new TenantNotFoundException("ç§Ÿæˆ·ä¸å­˜åœ¨: " + subdomain);
        }
        
        return tenant.getTenantId();
    }
    
    /**
     * æ›´æ–°ç§Ÿæˆ·çŠ¶æ€
     */
    @Transactional(rollbackFor = Exception.class)
    public void updateStatus(Long tenantId, String status) {
        Tenant tenant = getById(tenantId);
        if (tenant == null) {
            throw new TenantNotFoundException("ç§Ÿæˆ·ä¸å­˜åœ¨: " + tenantId);
        }
        
        tenant.setStatus(status);
        updateById(tenant);
        
        log.info("ç§Ÿæˆ·çŠ¶æ€æ›´æ–°: tenantId={}, status={}", tenantId, status);
    }
    
    /**
     * æ›´æ–°ç§Ÿæˆ·é…ç½®
     */
    @Transactional(rollbackFor = Exception.class)
    public void updateConfig(Long tenantId, String configJson) {
        Tenant tenant = getById(tenantId);
        if (tenant == null) {
            throw new TenantNotFoundException("ç§Ÿæˆ·ä¸å­˜åœ¨: " + tenantId);
        }
        
        try {
            // éªŒè¯JSONæ ¼å¼
            objectMapper.readTree(configJson);
            
            tenant.setConfig(objectMapper.readTree(configJson).toString());
            updateById(tenant);
            
            log.info("ç§Ÿæˆ·é…ç½®æ›´æ–°: tenantId={}", tenantId);
        } catch (Exception e) {
            log.error("é…ç½®JSONæ ¼å¼é”™è¯¯", e);
            throw new RuntimeException("é…ç½®JSONæ ¼å¼é”™è¯¯");
        }
    }
    
    /**
     * åˆå§‹åŒ–ç§Ÿæˆ·æ•°æ®
     */
    private void initializeTenantData(Long tenantId, TenantRegisterDTO dto) {
        // TODO: 
        // 1. åˆ›å»ºç®¡ç†å‘˜è´¦å·
        // 2. åˆ›å»ºé»˜è®¤è§’è‰²
        // 3. åˆ›å»ºé»˜è®¤ç»„ç»‡
        // 4. åˆå§‹åŒ–åŸºç¡€æ•°æ®ï¼ˆå¸ç§ã€åŸå¸‚ã€è´¹ç”¨ç±»å‹ç­‰ï¼‰
        // 5. åˆ›å»ºMinIOå­˜å‚¨æ¡¶ï¼šbucket/tenant_{tenantId}/
        
        log.info("åˆå§‹åŒ–ç§Ÿæˆ·æ•°æ®: tenantId={}", tenantId);
    }
    
    private TenantDTO convertToDTO(Tenant tenant) {
        TenantDTO dto = new TenantDTO();
        dto.setTenantId(tenant.getTenantId());
        dto.setTenantCode(tenant.getTenantCode());
        dto.setTenantName(tenant.getTenantName());
        dto.setTenantType(tenant.getTenantType());
        dto.setSubdomain(tenant.getSubdomain());
        dto.setContactName(tenant.getContactName());
        dto.setContactPhone(tenant.getContactPhone());
        dto.setContactEmail(tenant.getContactEmail());
        dto.setStatus(tenant.getStatus());
        dto.setMaxUsers(tenant.getMaxUsers());
        dto.setCurrentUsers(tenant.getCurrentUsers());
        dto.setMaxStorageMb(tenant.getMaxStorageMb());
        dto.setCurrentStorageMb(tenant.getCurrentStorageMb());
        dto.setExpireDate(tenant.getExpireDate());
        
        if (tenant.getConfig() != null) {
            try {
                dto.setConfig(objectMapper.readTree(tenant.getConfig()));
            } catch (Exception e) {
                log.error("è§£æé…ç½®JSONå¤±è´¥", e);
            }
        }
        
        return dto;
    }
}
```

### ğŸ“Š ç›‘æ§æŒ‡æ ‡

| æŒ‡æ ‡åç§° | ç±»å‹ | æè¿° |
|---------|------|------|
| tenant_total_count | Gauge | ç§Ÿæˆ·æ€»æ•° |
| tenant_active_count | Gauge | æ´»è·ƒç§Ÿæˆ·æ•° |
| tenant_register_total | Counter | ç§Ÿæˆ·æ³¨å†Œæ€»æ•° |
| tenant_register_duration_seconds | Histogram | ç§Ÿæˆ·æ³¨å†Œè€—æ—¶ |

---


---

## æœåŠ¡2: User Service - ç”¨æˆ·ç®¡ç†æœåŠ¡

### ğŸ“‹ æœåŠ¡æ¦‚è§ˆ

**æœåŠ¡åç§°**: user-service  
**æœåŠ¡ç«¯å£**: 8762  
**ä¼˜å…ˆçº§**: P0ï¼ˆæ ¸å¿ƒåŸºç¡€æœåŠ¡ï¼‰  
**æŠ€æœ¯æ ˆ**: Spring Boot 3.2 + MyBatis Plus + Spring Security + Redis  
**èŒè´£èŒƒå›´**: ç”¨æˆ·æ³¨å†Œã€ç”¨æˆ·ç™»å½•ã€æƒé™ç®¡ç†ã€ç”¨æˆ·ä¿¡æ¯ç®¡ç†

### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½ID | åŠŸèƒ½åç§° | æè¿° | ä¼˜å…ˆçº§ |
|--------|---------|------|--------|
| U-001 | ç”¨æˆ·æ³¨å†Œ | åˆ›å»ºæ–°ç”¨æˆ· | P0 |
| U-002 | ç”¨æˆ·ç™»å½• | ç”¨æˆ·åå¯†ç ç™»å½•ã€é’‰é’‰æ‰«ç ç™»å½• | P0 |
| U-003 | ç”¨æˆ·æŸ¥è¯¢ | æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ | P0 |
| U-004 | ç”¨æˆ·æ›´æ–° | æ›´æ–°ç”¨æˆ·ä¿¡æ¯ | P0 |
| U-005 | ç”¨æˆ·çŠ¶æ€ç®¡ç† | å¯ç”¨/é”å®š/åœç”¨ç”¨æˆ· | P0 |
| U-006 | å¯†ç ç®¡ç† | å¯†ç ä¿®æ”¹ã€å¯†ç é‡ç½® | P0 |
| U-007 | è§’è‰²ç®¡ç† | ç”¨æˆ·è§’è‰²å…³è”ç®¡ç† | P0 |
| U-008 | é’‰é’‰é›†æˆ | é’‰é’‰ç”¨æˆ·åŒæ­¥ã€é’‰é’‰ç™»å½• | P1 |

### ğŸ” è®¤è¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1. Login Request
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Authentication Filter                      â”‚
â”‚  - Extract credentials                              â”‚
â”‚  - Validate format                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 2. Validate User
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              UserDetailsService                     â”‚
â”‚  - Load user from DB                                â”‚
â”‚  - Check account status                             â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 3. Verify Password
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            PasswordEncoder                          â”‚
â”‚  - BCrypt encryption                               â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 4. Generate Token
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              JWT Provider                            â”‚
â”‚  - Generate JWT token                               â”‚
â”‚  - Include tenant_id, user_id, roles                â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 5. Cache Token
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Redis                                  â”‚
â”‚  - token:{user_id}:{tenant_id}                     â”‚
â”‚  - TTL: 24 hours                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 6. Return Token
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

**è¡¨**: user, user_role

```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE "user" (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    user_id BIGSERIAL NOT NULL,
    
    -- åŸºæœ¬ä¿¡æ¯
    username VARCHAR(100) NOT NULL,
    password VARCHAR(100),                       -- BCryptåŠ å¯†
    realname VARCHAR(60) NOT NULL,
    nickname VARCHAR(60),
    avatar VARCHAR(255),
    email VARCHAR(100),
    phone VARCHAR(20),
    job_number VARCHAR(30),
    
    -- èº«ä»½è®¤è¯
    dingtalk_id VARCHAR(100),
    dingtalk_unionid VARCHAR(100),
    auth_type VARCHAR(20) DEFAULT 'PASSWORD',    -- PASSWORD/DINGTALK/SMS
    
    -- ç»„ç»‡å…³è”
    org_id BIGINT NOT NULL,
    
    -- ç”¨æˆ·çŠ¶æ€
    status VARCHAR(20) NOT NULL DEFAULT 'PENDING',
    deleted SMALLINT NOT NULL DEFAULT 0,
    
    -- å¯†ç ç®¡ç†
    password_change_date DATE,
    login_fail_count INTEGER DEFAULT 0,
    locked_until TIMESTAMP,
    
    -- æœ€åç™»å½•ä¿¡æ¯
    last_login_ip VARCHAR(50),
    last_login_time TIMESTAMP,
    last_login_device VARCHAR(100),
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    remarks TEXT,
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, user_id),
    
    -- å”¯ä¸€çº¦æŸ
    CONSTRAINT uk_user_tenant_username UNIQUE (tenant_id, username),
    CONSTRAINT uk_user_tenant_email UNIQUE (tenant_id, email),
    CONSTRAINT uk_user_tenant_phone UNIQUE (tenant_id, phone),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_user_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    CONSTRAINT fk_user_org FOREIGN KEY (tenant_id, org_id) REFERENCES org(tenant_id, org_id)
);

-- ç´¢å¼•
CREATE INDEX idx_user_username ON "user"(tenant_id, username);
CREATE INDEX idx_user_email ON "user"(tenant_id, email);
CREATE INDEX idx_user_phone ON "user"(tenant_id, phone);
CREATE INDEX idx_user_org ON "user"(tenant_id, org_id);
CREATE INDEX idx_user_status ON "user"(tenant_id, status);
CREATE INDEX idx_user_dingtalk_id ON "user"(dingtalk_id);

-- ç”¨æˆ·è§’è‰²å…³è”è¡¨
CREATE TABLE user_role (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    user_role_id BIGSERIAL NOT NULL,
    
    -- å…³è”å…³ç³»
    user_id BIGINT NOT NULL,
    role_id BIGINT NOT NULL,
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    expired_at TIMESTAMP,
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, user_role_id),
    
    -- å”¯ä¸€çº¦æŸ
    CONSTRAINT uk_user_role UNIQUE (tenant_id, user_id, role_id),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_user_role_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    CONSTRAINT fk_user_role_user FOREIGN KEY (tenant_id, user_id) REFERENCES "user"(tenant_id, user_id),
    CONSTRAINT fk_user_role_role FOREIGN KEY (tenant_id, role_id) REFERENCES role(tenant_id, role_id)
);
```

### ğŸ”Œ APIæ¥å£è®¾è®¡

#### 1. ç”¨æˆ·ç™»å½•

**POST** `/api/auth/login`

```json
// Request
{
  "username": "zhangsan",
  "password": "123456",
  "tenantCode": "COMPANY_A"
}

// Response
{
  "code": 200,
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "tokenType": "Bearer",
    "expiresIn": 86400,
    "user": {
      "userId": 1,
      "username": "zhangsan",
      "realname": "å¼ ä¸‰",
      "nickname": "è€å¼ ",
      "avatar": "https://...",
      "email": "zhangsan@company-a.com",
      "phone": "13800138000",
      "jobNumber": "E001",
      "orgId": 1,
      "orgName": "æŠ€æœ¯éƒ¨",
      "roles": ["USER", "EMPLOYEE"]
    }
  }
}
```

#### 2. ç”¨æˆ·æ³¨å†Œ

**POST** `/api/user/register`

```json
// Request
{
  "username": "lisi",
  "password": "123456",
  "realname": "æå››",
  "email": "lisi@company-a.com",
  "phone": "13900139000",
  "jobNumber": "E002",
  "orgId": 1
}

// Response
{
  "code": 200,
  "message": "æ³¨å†ŒæˆåŠŸ",
  "data": {
    "userId": 2,
    "username": "lisi",
    "realname": "æå››"
  }
}
```

#### 3. è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯

**GET** `/api/user/current`

**Header**: `Authorization: Bearer {token}`

```json
// Response
{
  "code": 200,
  "data": {
    "userId": 1,
    "username": "zhangsan",
    "realname": "å¼ ä¸‰",
    "nickname": "è€å¼ ",
    "avatar": "https://...",
    "email": "zhangsan@company-a.com",
    "phone": "13800138000",
    "jobNumber": "E001",
    "orgId": 1,
    "orgName": "æŠ€æœ¯éƒ¨",
    "roles": ["USER", "EMPLOYEE"],
    "permissions": ["trans:create", "trans:view", "loan:create", "loan:view"]
  }
}
```

#### 4. æ›´æ–°ç”¨æˆ·ä¿¡æ¯

**PUT** `/api/user/{userId}`

```json
// Request
{
  "realname": "å¼ ä¸‰ä¸°",
  "nickname": "ä¸‰ä¸°",
  "email": "zhangsanfeng@company-a.com",
  "phone": "13800138001"
}

// Response
{
  "code": 200,
  "message": "æ›´æ–°æˆåŠŸ"
}
```

### ğŸ’» æ ¸å¿ƒä»£ç å®ç°

#### AuthenticationController.java

```java
package com.fs.user.controller;

import com.fs.common.core.result.Result;
import com.fs.user.dto.LoginRequest;
import com.fs.user.dto.LoginResponse;
import com.fs.user.dto.UserDTO;
import com.fs.user.service.AuthService;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;

import jakarta.validation.Valid;

@RestController
@RequestMapping("/api/auth")
@RequiredArgsConstructor
public class AuthenticationController {
    
    private final AuthService authService;
    
    /**
     * ç”¨æˆ·ç™»å½•
     */
    @PostMapping("/login")
    public Result<LoginResponse> login(@Valid @RequestBody LoginRequest request) {
        return Result.success(authService.login(request));
    }
    
    /**
     * ç™»å‡º
     */
    @PostMapping("/logout")
    public Result<Void> logout(@RequestHeader("Authorization") String token) {
        authService.logout(token);
        return Result.success();
    }
    
    /**
     * åˆ·æ–°Token
     */
    @PostMapping("/refresh")
    public Result<LoginResponse> refreshToken(@RequestHeader("Authorization") String token) {
        return Result.success(authService.refreshToken(token));
    }
}
```

#### AuthService.java

```java
package com.fs.user.service;

import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.fs.common.core.exception.BusinessException;
import com.fs.common.security.util.JwtUtil;
import com.fs.user.dto.LoginRequest;
import com.fs.user.dto.LoginResponse;
import com.fs.user.entity.User;
import com.fs.user.mapper.UserMapper;
import com.fs.user.service.impl.UserServiceImpl;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;

import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.TimeUnit;

@Slf4j
@Service
@RequiredArgsConstructor
public class AuthService {
    
    private final AuthenticationManager authenticationManager;
    private final JwtUtil jwtUtil;
    private final PasswordEncoder passwordEncoder;
    private final RedisTemplate<String, Object> redisTemplate;
    private final UserServiceImpl userService;
    
    /**
     * ç”¨æˆ·ç™»å½•
     */
    public LoginResponse login(LoginRequest request) {
        log.info("ç”¨æˆ·ç™»å½•: username={}, tenantCode={}", request.getUsername(), request.getTenantCode());
        
        // 1. éªŒè¯ç”¨æˆ·åå’Œå¯†ç 
        Authentication authentication = authenticationManager.authenticate(
            new UsernamePasswordAuthenticationToken(
                request.getUsername(),
                request.getPassword()
            )
        );
        
        // 2. è·å–ç”¨æˆ·ä¿¡æ¯
        User user = (User) authentication.getPrincipal();
        
        // 3. éªŒè¯ç§Ÿæˆ·
        if (!user.getTenantId().equals(request.getTenantId())) {
            throw new BusinessException("ç”¨æˆ·ä¸å±äºè¯¥ç§Ÿæˆ·");
        }
        
        // 4. éªŒè¯ç”¨æˆ·çŠ¶æ€
        if (!"ACTIVE".equals(user.getStatus())) {
            throw new BusinessException("ç”¨æˆ·è´¦å·å·²è¢«ç¦ç”¨");
        }
        
        // 5. æ£€æŸ¥è´¦å·æ˜¯å¦è¢«é”å®š
        if (user.getLockedUntil() != null && user.getLockedUntil().isAfter(java.time.LocalDateTime.now())) {
            throw new BusinessException("è´¦å·å·²è¢«é”å®šï¼Œè¯·ç¨åå†è¯•");
        }
        
        // 6. ç”ŸæˆJWT Token
        Map<String, Object> claims = new HashMap<>();
        claims.put("tenantId", user.getTenantId());
        claims.put("userId", user.getUserId());
        claims.put("username", user.getUsername());
        claims.put("roles", user.getRoles());
        
        String token = jwtUtil.generateToken(claims);
        
        // 7. ç¼“å­˜Tokenåˆ°Redis
        String cacheKey = String.format("token:%d:%d", user.getTenantId(), user.getUserId());
        redisTemplate.opsForValue().set(cacheKey, token, 24, TimeUnit.HOURS);
        
        // 8. æ›´æ–°æœ€åç™»å½•ä¿¡æ¯
        user.setLastLoginTime(java.time.LocalDateTime.now());
        user.setLastLoginIp(request.getClientIp());
        userService.updateById(user);
        
        log.info("ç”¨æˆ·ç™»å½•æˆåŠŸ: username={}, userId={}", user.getUsername(), user.getUserId());
        
        return LoginResponse.builder()
                .token(token)
                .tokenType("Bearer")
                .expiresIn(86400)
                .user(userService.convertToDTO(user))
                .build();
    }
    
    /**
     * ç™»å‡º
     */
    public void logout(String token) {
        // 1. ä»Tokenä¸­è·å–ç”¨æˆ·ä¿¡æ¯
        String username = jwtUtil.extractUsername(token);
        Long tenantId = jwtUtil.extractClaim(token, "tenantId", Long.class);
        Long userId = jwtUtil.extractClaim(token, "userId", Long.class);
        
        // 2. ä»Redisä¸­åˆ é™¤Token
        String cacheKey = String.format("token:%d:%d", tenantId, userId);
        redisTemplate.delete(cacheKey);
        
        log.info("ç”¨æˆ·ç™»å‡º: username={}, userId={}", username, userId);
    }
    
    /**
     * åˆ·æ–°Token
     */
    public LoginResponse refreshToken(String token) {
        // 1. éªŒè¯Tokenæ˜¯å¦è¿‡æœŸ
        if (!jwtUtil.validateToken(token)) {
            throw new BusinessException("Tokenæ— æ•ˆæˆ–å·²è¿‡æœŸ");
        }
        
        // 2. ä»Tokenä¸­æå–ç”¨æˆ·ä¿¡æ¯
        String username = jwtUtil.extractUsername(token);
        Long tenantId = jwtUtil.extractClaim(token, "tenantId", Long.class);
        Long userId = jwtUtil.extractClaim(token, "userId", Long.class);
        
        // 3. æŸ¥è¯¢ç”¨æˆ·
        User user = userService.getById(userId);
        if (user == null) {
            throw new BusinessException("ç”¨æˆ·ä¸å­˜åœ¨");
        }
        
        // 4. ç”Ÿæˆæ–°Token
        Map<String, Object> claims = new HashMap<>();
        claims.put("tenantId", user.getTenantId());
        claims.put("userId", user.getUserId());
        claims.put("username", user.getUsername());
        claims.put("roles", user.getRoles());
        
        String newToken = jwtUtil.generateToken(claims);
        
        // 5. æ›´æ–°Redisç¼“å­˜
        String cacheKey = String.format("token:%d:%d", tenantId, userId);
        redisTemplate.opsForValue().set(cacheKey, newToken, 24, TimeUnit.HOURS);
        
        log.info("Tokenåˆ·æ–°æˆåŠŸ: username={}", username);
        
        return LoginResponse.builder()
                .token(newToken)
                .tokenType("Bearer")
                .expiresIn(86400)
                .user(userService.convertToDTO(user))
                .build();
    }
}
```

### ğŸ“Š ç›‘æ§æŒ‡æ ‡

| æŒ‡æ ‡åç§° | ç±»å‹ | æè¿° |
|---------|------|------|
| user_login_total | Counter | ç™»å½•æ€»æ•° |
| user_login_failed_total | Counter | ç™»å½•å¤±è´¥æ€»æ•° |
| user_register_total | Counter | æ³¨å†Œæ€»æ•° |
| user_active_count | Gauge | æ´»è·ƒç”¨æˆ·æ•° |

---

## æœåŠ¡3: Org Service - ç»„ç»‡ç®¡ç†æœåŠ¡

### ğŸ“‹ æœåŠ¡æ¦‚è§ˆ

**æœåŠ¡åç§°**: org-service  
**æœåŠ¡ç«¯å£**: 8763  
**ä¼˜å…ˆçº§**: P0ï¼ˆæ ¸å¿ƒåŸºç¡€æœåŠ¡ï¼‰  
**æŠ€æœ¯æ ˆ**: Spring Boot 3.2 + MyBatis Plus  
**èŒè´£èŒƒå›´**: ç»„ç»‡æ¶æ„ç®¡ç†ã€ç»„ç»‡æ ‘ç®¡ç†ã€ç»„ç»‡è´Ÿè´£äººç®¡ç†

### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½ID | åŠŸèƒ½åç§° | æè¿° | ä¼˜å…ˆçº§ |
|--------|---------|------|--------|
| O-001 | ç»„ç»‡åˆ›å»º | åˆ›å»ºç»„ç»‡ | P0 |
| O-002 | ç»„ç»‡æŸ¥è¯¢ | æŸ¥è¯¢ç»„ç»‡ä¿¡æ¯ | P0 |
| O-003 | ç»„ç»‡æ ‘æŸ¥è¯¢ | æŸ¥è¯¢ç»„ç»‡æ ‘ | P0 |
| O-004 | ç»„ç»‡æ›´æ–° | æ›´æ–°ç»„ç»‡ä¿¡æ¯ | P0 |
| O-005 | ç»„ç»‡åˆ é™¤ | åˆ é™¤ç»„ç»‡ | P0 |
| O-006 | ç»„ç»‡è´Ÿè´£äººè®¾ç½® | è®¾ç½®ç»„ç»‡è´Ÿè´£äºº | P0 |

### ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

**è¡¨**: org

```sql
-- ç»„ç»‡è¡¨
CREATE TABLE org (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    org_id BIGSERIAL NOT NULL,
    
    -- åŸºæœ¬ä¿¡æ¯
    org VARCHAR(50) NOT NULL,
    org_name VARCHAR(200) NOT NULL,
    org_type VARCHAR(50) NOT NULL,               -- COMPANY/DEPARTMENT/TEAM
    org_level INTEGER NOT NULL DEFAULT 1,
    
    -- ç»„ç»‡æ ‘ç»“æ„
    parent_org_id BIGINT,
    parent_path VARCHAR(500),
    sort_order INTEGER DEFAULT 0,
    
    -- ç»„ç»‡è´Ÿè´£äºº
    leader_id BIGINT,
    leader_name VARCHAR(60),
    
    -- ç»„ç»‡çŠ¶æ€
    status VARCHAR(20) NOT NULL DEFAULT 'ACTIVE',
    
    -- è”ç³»ä¿¡æ¯
    contact_name VARCHAR(60),
    contact_phone VARCHAR(20),
    contact_email VARCHAR(100),
    address VARCHAR(500),
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP,
    remarks TEXT,
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, org_id),
    
    -- å”¯ä¸€çº¦æŸ
    CONSTRAINT uk_org_tenant_code UNIQUE (tenant_id, org),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_org_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    CONSTRAINT fk_org_parent FOREIGN KEY (tenant_id, parent_org_id) REFERENCES org(tenant_id, org_id),
    CONSTRAINT fk_org_leader FOREIGN KEY (tenant_id, leader_id) REFERENCES "user"(tenant_id, user_id)
);

-- ç´¢å¼•
CREATE INDEX idx_org_parent ON org(tenant_id, parent_org_id);
CREATE INDEX idx_org_level ON org(tenant_id, org_level);
CREATE INDEX idx_org_status ON org(tenant_id, status);
CREATE INDEX idx_org_type ON org(tenant_id, org_type);
```

### ğŸ”Œ APIæ¥å£è®¾è®¡

#### 1. åˆ›å»ºç»„ç»‡

**POST** `/api/org/create`

```json
// Request
{
  "orgCode": "TECH_DEPT",
  "orgName": "æŠ€æœ¯éƒ¨",
  "orgType": "DEPARTMENT",
  "parentOrgId": 1,
  "leaderId": 10,
  "contactPhone": "010-12345678",
  "address": "åŒ—äº¬å¸‚æœé˜³åŒº..."
}

// Response
{
  "code": 200,
  "message": "ç»„ç»‡åˆ›å»ºæˆåŠŸ",
  "data": {
    "orgId": 2,
    "orgCode": "TECH_DEPT",
    "orgName": "æŠ€æœ¯éƒ¨",
    "orgType": "DEPARTMENT",
    "orgLevel": 2,
    "parentOrgId": 1,
    "parentPath": "/1",
    "leaderId": 10,
    "leaderName": "å¼ ä¸‰",
    "status": "ACTIVE"
  }
}
```

#### 2. æŸ¥è¯¢ç»„ç»‡æ ‘

**GET** `/api/org/tree`

**Response**
```json
{
  "code": 200,
  "data": [
    {
      "orgId": 1,
      "orgCode": "COMPANY_A",
      "orgName": "Aå…¬å¸",
      "orgType": "COMPANY",
      "orgLevel": 1,
      "parentOrgId": null,
      "children": [
        {
          "orgId": 2,
          "orgCode": "TECH_DEPT",
          "orgName": "æŠ€æœ¯éƒ¨",
          "orgType": "DEPARTMENT",
          "orgLevel": 2,
          "parentOrgId": 1,
          "children": [
            {
              "orgId": 3,
              "orgCode": "DEV_TEAM",
              "orgName": "å¼€å‘å›¢é˜Ÿ",
              "orgType": "TEAM",
              "orgLevel": 3,
              "parentOrgId": 2,
              "children": []
            }
          ]
        }
      ]
    }
  ]
}
```

#### 3. æŸ¥è¯¢ç»„ç»‡è¯¦æƒ…

**GET** `/api/org/{orgId}`

**Response**
```json
{
  "code": 200,
  "data": {
    "orgId": 2,
    "orgCode": "TECH_DEPT",
    "orgName": "æŠ€æœ¯éƒ¨",
    "orgType": "DEPARTMENT",
    "orgLevel": 2,
    "parentOrgId": 1,
    "parentPath": "/1",
    "leaderId": 10,
    "leaderName": "å¼ ä¸‰",
    "contactName": "æå››",
    "contactPhone": "010-12345678",
    "contactEmail": "lisi@company-a.com",
    "address": "åŒ—äº¬å¸‚æœé˜³åŒº...",
    "status": "ACTIVE"
  }
}
```

### ğŸ’» æ ¸å¿ƒä»£ç å®ç°

#### OrgController.java

```java
package com.fs.org.controller;

import com.fs.common.core.result.Result;
import com.fs.org.dto.OrgDTO;
import com.fs.org.dto.OrgCreateDTO;
import com.fs.org.dto.OrgTreeDTO;
import com.fs.org.service.OrgService;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;

import jakarta.validation.Valid;
import java.util.List;

@RestController
@RequestMapping("/api/org")
@RequiredArgsConstructor
public class OrgController {
    
    private final OrgService orgService;
    
    /**
     * åˆ›å»ºç»„ç»‡
     */
    @PostMapping("/create")
    public Result<OrgDTO> create(@Valid @RequestBody OrgCreateDTO dto) {
        return Result.success(orgService.createOrg(dto));
    }
    
    /**
     * æŸ¥è¯¢ç»„ç»‡æ ‘
     */
    @GetMapping("/tree")
    public Result<List<OrgTreeDTO>> getTree() {
        return Result.success(orgService.getOrgTree());
    }
    
    /**
     * æŸ¥è¯¢ç»„ç»‡è¯¦æƒ…
     */
    @GetMapping("/{orgId}")
    public Result<OrgDTO> getOrg(@PathVariable Long orgId) {
        return Result.success(orgService.getOrgById(orgId));
    }
    
    /**
     * æ›´æ–°ç»„ç»‡
     */
    @PutMapping("/{orgId}")
    public Result<OrgDTO> update(
            @PathVariable Long orgId,
            @Valid @RequestBody OrgCreateDTO dto) {
        return Result.success(orgService.updateOrg(orgId, dto));
    }
    
    /**
     * åˆ é™¤ç»„ç»‡
     */
    @DeleteMapping("/{orgId}")
    public Result<Void> delete(@PathVariable Long orgId) {
        orgService.deleteOrg(orgId);
        return Result.success();
    }
}
```

#### OrgService.java

```java
package com.fs.org.service;

import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.fs.common.core.exception.BusinessException;
import com.fs.org.dto.OrgDTO;
import com.fs.org.dto.OrgCreateDTO;
import com.fs.org.dto.OrgTreeDTO;
import com.fs.org.entity.Org;
import com.fs.org.mapper.OrgMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class OrgService {
    
    private final OrgMapper orgMapper;
    
    /**
     * åˆ›å»ºç»„ç»‡
     */
    @Transactional(rollbackFor = Exception.class)
    public OrgDTO createOrg(OrgCreateDTO dto) {
        log.info("åˆ›å»ºç»„ç»‡: {}", dto.getOrgName());
        
        // 1. æ£€æŸ¥ç»„ç»‡ä»£ç æ˜¯å¦å·²å­˜åœ¨
        boolean exists = orgMapper.exists(
            new LambdaQueryWrapper<Org>()
                .eq(Org::getOrg, dto.getOrgCode())
        );
        
        if (exists) {
            throw new BusinessException("ç»„ç»‡ä»£ç å·²å­˜åœ¨");
        }
        
        // 2. ç¡®å®šç»„ç»‡å±‚çº§å’Œçˆ¶è·¯å¾„
        Integer orgLevel = 1;
        String parentPath = "";
        
        if (dto.getParentOrgId() != null) {
            Org parentOrg = orgMapper.selectById(dto.getParentOrgId());
            if (parentOrg == null) {
                throw new BusinessException("çˆ¶ç»„ç»‡ä¸å­˜åœ¨");
            }
            orgLevel = parentOrg.getOrgLevel() + 1;
            parentPath = parentOrg.getParentPath() + "/" + parentOrg.getOrgId();
        }
        
        // 3. åˆ›å»ºç»„ç»‡
        Org org = new Org();
        org.setOrg(dto.getOrgCode());
        org.setOrgName(dto.getOrgName());
        org.setOrgType(dto.getOrgType());
        org.setOrgLevel(orgLevel);
        org.setParentOrgId(dto.getParentOrgId());
        org.setParentPath(parentPath);
        org.setLeaderId(dto.getLeaderId());
        org.setContactName(dto.getContactName());
        org.setContactPhone(dto.getContactPhone());
        org.setContactEmail(dto.getContactEmail());
        org.setAddress(dto.getAddress());
        org.setStatus("ACTIVE");
        
        orgMapper.insert(org);
        
        // 4. æ›´æ–°è´Ÿè´£äººä¿¡æ¯
        if (dto.getLeaderId() != null) {
            updateLeaderInfo(org);
        }
        
        log.info("ç»„ç»‡åˆ›å»ºæˆåŠŸ: orgId={}", org.getOrgId());
        return convertToDTO(org);
    }
    
    /**
     * æŸ¥è¯¢ç»„ç»‡æ ‘
     */
    public List<OrgTreeDTO> getOrgTree() {
        // 1. æŸ¥è¯¢æ‰€æœ‰ç»„ç»‡
        List<Org> allOrgs = orgMapper.selectList(
            new LambdaQueryWrapper<Org>()
                .orderByAsc(Org::getOrgLevel)
                .orderByAsc(Org::getSortOrder)
        );
        
        // 2. è½¬æ¢ä¸ºDTO
        List<OrgTreeDTO> dtoList = allOrgs.stream()
                .map(this::convertToTreeDTO)
                .collect(Collectors.toList());
        
        // 3. æ„å»ºæ ‘å½¢ç»“æ„
        return buildTree(dtoList, null);
    }
    
    /**
     * æ„å»ºæ ‘å½¢ç»“æ„
     */
    private List<OrgTreeDTO> buildTree(List<OrgTreeDTO> allNodes, Long parentId) {
        List<OrgTreeDTO> result = new ArrayList<>();
        
        for (OrgTreeDTO node : allNodes) {
            if ((parentId == null && node.getParentOrgId() == null) ||
                (parentId != null && parentId.equals(node.getParentOrgId()))) {
                node.setChildren(buildTree(allNodes, node.getOrgId()));
                result.add(node);
            }
        }
        
        return result;
    }
    
    /**
     * æŸ¥è¯¢ç»„ç»‡è¯¦æƒ…
     */
    public OrgDTO getOrgById(Long orgId) {
        Org org = orgMapper.selectById(orgId);
        if (org == null) {
            throw new BusinessException("ç»„ç»‡ä¸å­˜åœ¨");
        }
        return convertToDTO(org);
    }
    
    /**
     * æ›´æ–°ç»„ç»‡
     */
    @Transactional(rollbackFor = Exception.class)
    public OrgDTO updateOrg(Long orgId, OrgCreateDTO dto) {
        Org org = orgMapper.selectById(orgId);
        if (org == null) {
            throw new BusinessException("ç»„ç»‡ä¸å­˜åœ¨");
        }
        
        // æ£€æŸ¥æ˜¯å¦å¾ªç¯å¼•ç”¨
        if (dto.getParentOrgId() != null && dto.getParentOrgId().equals(orgId)) {
            throw new BusinessException("ä¸èƒ½å°†ç»„ç»‡è®¾ç½®ä¸ºè‡ªå·±çš„çˆ¶ç»„ç»‡");
        }
        
        org.setOrgName(dto.getOrgName());
        org.setLeaderId(dto.getLeaderId());
        org.setContactName(dto.getContactName());
        org.setContactPhone(dto.getContactPhone());
        org.setContactEmail(dto.getContactEmail());
        org.setAddress(dto.getAddress());
        
        orgMapper.updateById(org);
        
        // æ›´æ–°è´Ÿè´£äººä¿¡æ¯
        if (dto.getLeaderId() != null) {
            updateLeaderInfo(org);
        }
        
        return convertToDTO(org);
    }
    
    /**
     * åˆ é™¤ç»„ç»‡
     */
    @Transactional(rollbackFor = Exception.class)
    public void deleteOrg(Long orgId) {
        Org org = orgMapper.selectById(orgId);
        if (org == null) {
            throw new BusinessException("ç»„ç»‡ä¸å­˜åœ¨");
        }
        
        // æ£€æŸ¥æ˜¯å¦æœ‰å­ç»„ç»‡
        boolean hasChildren = orgMapper.exists(
            new LambdaQueryWrapper<Org>()
                .eq(Org::getParentOrgId, orgId)
        );
        
        if (hasChildren) {
            throw new BusinessException("ç»„ç»‡ä¸‹æœ‰å­ç»„ç»‡ï¼Œæ— æ³•åˆ é™¤");
        }
        
        // æ£€æŸ¥æ˜¯å¦æœ‰ç”¨æˆ·
        // TODO: è°ƒç”¨User Serviceæ£€æŸ¥æ˜¯å¦æœ‰ç”¨æˆ·å…³è”åˆ°è¯¥ç»„ç»‡
        
        // è½¯åˆ é™¤
        org.setDeletedAt(LocalDateTime.now());
        orgMapper.updateById(org);
        
        log.info("ç»„ç»‡åˆ é™¤æˆåŠŸ: orgId={}", orgId);
    }
    
    /**
     * æ›´æ–°è´Ÿè´£äººä¿¡æ¯
     */
    private void updateLeaderInfo(Org org) {
        // TODO: è°ƒç”¨User Serviceè·å–è´Ÿè´£äººå§“å
        // org.setLeaderName(userName);
    }
    
    private OrgDTO convertToDTO(Org org) {
        OrgDTO dto = new OrgDTO();
        dto.setOrgId(org.getOrgId());
        dto.setOrgCode(org.getOrg());
        dto.setOrgName(org.getOrgName());
        dto.setOrgType(org.getOrgType());
        dto.setOrgLevel(org.getOrgLevel());
        dto.setParentOrgId(org.getParentOrgId());
        dto.setParentPath(org.getParentPath());
        dto.setLeaderId(org.getLeaderId());
        dto.setLeaderName(org.getLeaderName());
        dto.setContactName(org.getContactName());
        dto.setContactPhone(org.getContactPhone());
        dto.setContactEmail(org.getContactEmail());
        dto.setAddress(org.getAddress());
        dto.setStatus(org.getStatus());
        return dto;
    }
    
    private OrgTreeDTO convertToTreeDTO(Org org) {
        OrgTreeDTO dto = new OrgTreeDTO();
        dto.setOrgId(org.getOrgId());
        dto.setOrgCode(org.getOrg());
        dto.setOrgName(org.getOrgName());
        dto.setOrgType(org.getOrgType());
        dto.setOrgLevel(org.getOrgLevel());
        dto.setParentOrgId(org.getParentOrgId());
        dto.setLeaderId(org.getLeaderId());
        dto.setLeaderName(org.getLeaderName());
        dto.setStatus(org.getStatus());
        return dto;
    }
}
```

### ğŸ“Š ç›‘æ§æŒ‡æ ‡

| æŒ‡æ ‡åç§° | ç±»å‹ | æè¿° |
|---------|------|------|
| org_total_count | Gauge | ç»„ç»‡æ€»æ•° |
| org_create_total | Counter | ç»„ç»‡åˆ›å»ºæ€»æ•° |
| org_tree_depth | Gauge | ç»„ç»‡æ ‘æ·±åº¦ |

---


## æœåŠ¡4: Trans Service - æŠ¥é”€æœåŠ¡

### ğŸ“‹ æœåŠ¡æ¦‚è§ˆ

**æœåŠ¡åç§°**: trans-service  
**æœåŠ¡ç«¯å£**: 8764  
**ä¼˜å…ˆçº§**: P0ï¼ˆæ ¸å¿ƒä¸šåŠ¡æœåŠ¡ï¼‰  
**æŠ€æœ¯æ ˆ**: Spring Boot 3.2 + MyBatis Plus + Camunda Client + Redis  
**èŒè´£èŒƒå›´**: æŠ¥é”€å•ç®¡ç†ã€æŠ¥é”€å®¡æ‰¹ã€æŠ¥é”€ç»“ç®—ã€æ’ä»¶åŒ–æ”¯æŒ

### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½ID | åŠŸèƒ½åç§° | æè¿° | ä¼˜å…ˆçº§ |
|--------|---------|------|--------|
| T-001 | æŠ¥é”€å•åˆ›å»º | åˆ›å»ºæŠ¥é”€å•ï¼ˆè‰ç¨¿/æäº¤ï¼‰ | P0 |
| T-002 | æŠ¥é”€å•æŸ¥è¯¢ | æŸ¥è¯¢æŠ¥é”€å•åˆ—è¡¨å’Œè¯¦æƒ… | P0 |
| T-003 | æŠ¥é”€å•æ›´æ–° | æ›´æ–°æŠ¥é”€å•ä¿¡æ¯ | P0 |
| T-004 | æŠ¥é”€å•åˆ é™¤ | åˆ é™¤æŠ¥é”€å•ï¼ˆè½¯åˆ é™¤ï¼‰ | P0 |
| T-005 | æŠ¥é”€å•æäº¤ | æäº¤æŠ¥é”€å•å®¡æ‰¹ | P0 |
| T-006 | æŠ¥é”€å•ç»“ç®— | ç»“ç®—æŠ¥é”€å• | P0 |
| T-007 | æ’ä»¶åŠ è½½ | åŠ è½½æŠ¥é”€ç±»å‹æ’ä»¶é…ç½® | P0 |
| T-008 | åŠ¨æ€è¡¨å•æ¸²æŸ“ | åŠ¨æ€æ¸²æŸ“è¡¨å•ï¼ˆè¿”å›JSONé…ç½®ï¼‰ | P0 |

### ğŸ”Œ æœåŠ¡é—´é€šä¿¡

```
Trans Service
    â†“ (è°ƒç”¨)
â”œâ”€ User Service (æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯)
â”œâ”€ Org Service (æŸ¥è¯¢ç»„ç»‡ä¿¡æ¯)
â”œâ”€ Project Service (æŸ¥è¯¢é¡¹ç›®ä¿¡æ¯)
â”œâ”€ Approval Service (å¯åŠ¨/æŸ¥è¯¢å®¡æ‰¹æµç¨‹)
â”œâ”€ File Service (ä¸Šä¼ /ä¸‹è½½é™„ä»¶)
â””â”€ Notification Service (å‘é€é€šçŸ¥æ¶ˆæ¯)
```

### ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

**è¡¨**: trans, trans_item, charge_item, trans_attach

```sql
-- æŠ¥é”€å•è¡¨
CREATE TABLE trans (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    trans_id BIGSERIAL NOT NULL,
    
    -- åŸºæœ¬ä¿¡æ¯
    trans_code VARCHAR(60) NOT NULL,
    trans_type_id BIGINT NOT NULL,
    trans_type_name VARCHAR(100) NOT NULL,
    trans_type_code VARCHAR(50),
    
    -- é¡¹ç›®å…³è”
    project_id BIGINT NOT NULL,
    project_code VARCHAR(50) NOT NULL,
    project_name VARCHAR(200) NOT NULL,
    
    -- æŠ¥é”€é‡‘é¢
    trans_charge NUMERIC(12,2),
    lc_charge NUMERIC(12,2),
    trans_sett_charge NUMERIC(12,2),
    lc_sett_charge NUMERIC(12,2),
    
    -- è”ç³»ä¿¡æ¯
    link_tel VARCHAR(20),
    link_address VARCHAR(500),
    
    -- é™„ä»¶ä¿¡æ¯
    pages INTEGER,
    sheets INTEGER,
    
    -- æŠ¥é”€è¯´æ˜
    trans_desc TEXT,
    trans_sett_desc TEXT,
    
    -- å®¡æ‰¹æµç¨‹
    processinstance_id VARCHAR(60),
    state VARCHAR(20) NOT NULL DEFAULT 'DRAFT',
    state_date TIMESTAMP,
    
    -- å¸ç§å’Œæ±‡ç‡
    currency_id INTEGER DEFAULT 1,
    exchange_rate NUMERIC(12,6),
    
    -- åˆ›å»ºäººä¿¡æ¯
    created_user_id BIGINT NOT NULL,
    created_user_name VARCHAR(60) NOT NULL,
    created_job_number VARCHAR(30),
    
    -- ç»“ç®—äººä¿¡æ¯
    sett_user_id BIGINT,
    sett_user_name VARCHAR(60),
    sett_job_number VARCHAR(30),
    sett_date TIMESTAMP,
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP,
    remarks TEXT,
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, trans_id),
    
    -- å”¯ä¸€çº¦æŸ
    CONSTRAINT uk_trans_tenant_code UNIQUE (tenant_id, trans_code),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_trans_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    CONSTRAINT fk_trans_project FOREIGN KEY (tenant_id, project_id) REFERENCES project(tenant_id, project_id),
    CONSTRAINT fk_trans_currency FOREIGN KEY (currency_id) REFERENCES currency(currency_id)
);

-- ç´¢å¼•
CREATE INDEX idx_trans_tenant_user ON trans(tenant_id, created_user_id);
CREATE INDEX idx_trans_project ON trans(tenant_id, project_id);
CREATE INDEX idx_trans_type ON trans(tenant_id, trans_type_id);
CREATE INDEX idx_trans_state ON trans(tenant_id, state);
CREATE INDEX idx_trans_date ON trans(tenant_id, created_at);
CREATE INDEX idx_trans_process ON trans(processinstance_id);

-- æŠ¥é”€æ˜ç»†è¡¨
CREATE TABLE trans_item (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    trans_item_id BIGSERIAL NOT NULL,
    
    -- å…³è”æŠ¥é”€å•
    trans_id BIGINT NOT NULL,
    
    -- æŠ¥é”€ç±»å‹
    trans_type_id BIGINT,
    trans_type_name VARCHAR(100),
    trans_type_code VARCHAR(50),
    
    -- é¡¹ç›®å…³è”
    project_id BIGINT,
    project_code VARCHAR(50),
    project_name VARCHAR(200),
    
    -- æ˜ç»†ä¿¡æ¯
    trans_item_name VARCHAR(200) NOT NULL,
    trans_item_desc TEXT,
    
    -- æ˜ç»†çŠ¶æ€
    state VARCHAR(20) DEFAULT 'DRAFT',
    state_date TIMESTAMP,
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, trans_item_id),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_trans_item_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    CONSTRAINT fk_trans_item_trans FOREIGN KEY (tenant_id, trans_id) REFERENCES trans(tenant_id, trans_id)
);

-- ç´¢å¼•
CREATE INDEX idx_trans_item_trans ON trans_item(tenant_id, trans_id);

-- è´¹ç”¨æ˜ç»†è¡¨
CREATE TABLE charge_item (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    charge_id BIGSERIAL NOT NULL,
    
    -- å…³è”æŠ¥é”€æ˜ç»†
    trans_item_id BIGINT NOT NULL,
    
    -- è´¹ç”¨ç±»å‹
    expense_item_type_id BIGINT NOT NULL,
    expense_item_type_name VARCHAR(100) NOT NULL,
    
    -- è´¹ç”¨ä¿¡æ¯
    charge_amount NUMERIC(12,2) NOT NULL,
    lc_charge NUMERIC(12,2),
    charge_desc TEXT,
    charge_date DATE,
    
    -- å¸ç§å’Œæ±‡ç‡
    exchange_rate NUMERIC(12,6),
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, charge_id),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_charge_item_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    CONSTRAINT fk_charge_item_trans_item FOREIGN KEY (tenant_id, trans_item_id) REFERENCES trans_item(tenant_id, trans_item_id)
);

-- ç´¢å¼•
CREATE INDEX idx_charge_item_trans_item ON charge_item(tenant_id, trans_item_id);
CREATE INDEX idx_charge_item_date ON charge_item(tenant_id, charge_date);

-- æŠ¥é”€é™„ä»¶è¡¨
CREATE TABLE trans_attach (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    attach_id BIGSERIAL NOT NULL,
    
    -- å…³è”æŠ¥é”€å•
    trans_id BIGINT NOT NULL,
    
    -- é™„ä»¶ä¿¡æ¯
    attach_name VARCHAR(255) NOT NULL,
    attach_path VARCHAR(500),
    attach_size BIGINT,
    attach_type VARCHAR(100),
    attach_ext VARCHAR(10),
    
    -- MinIOå­˜å‚¨ä¿¡æ¯
    bucket_name VARCHAR(100),
    object_key VARCHAR(500) NOT NULL,
    object_url VARCHAR(500),
    
    -- ä¸Šä¼ äººä¿¡æ¯
    upload_user_id BIGINT NOT NULL,
    upload_user_name VARCHAR(60) NOT NULL,
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, attach_id),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_trans_attach_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    CONSTRAINT fk_trans_attach_trans FOREIGN KEY (tenant_id, trans_id) REFERENCES trans(tenant_id, trans_id)
);

-- ç´¢å¼•
CREATE INDEX idx_trans_attach_trans ON trans_attach(tenant_id, trans_id);
```

### ğŸ”Œ APIæ¥å£è®¾è®¡

#### 1. åˆ›å»ºæŠ¥é”€å•

**POST** `/api/trans/create`

```json
// Request
{
  "transTypeId": 1,
  "transTypeName": "ä¸€èˆ¬è´¹ç”¨",
  "projectId": 1,
  "projectCode": "P001",
  "projectName": "é¡¹ç›®A",
  "transCharge": 5000.00,
  "lcCharge": 5000.00,
  "currencyId": 1,
  "exchangeRate": 1.000000,
  "transDesc": "å·®æ—…è´¹ç”¨æŠ¥é”€",
  "linkTel": "13800138000",
  "chargeItems": [
    {
      "expenseItemTypeId": 1,
      "expenseItemTypeName": "äº¤é€šè´¹",
      "chargeAmount": 2000.00,
      "lcCharge": 2000.00,
      "chargeDate": "2026-01-20",
      "chargeDesc": "åŒ—äº¬åˆ°ä¸Šæµ·é«˜é“"
    },
    {
      "expenseItemTypeId": 2,
      "expenseItemTypeName": "ä½å®¿è´¹",
      "chargeAmount": 3000.00,
      "lcCharge": 3000.00,
      "chargeDate": "2026-01-21",
      "chargeDesc": "ä¸Šæµ·é…’åº—2æ™š"
    }
  ],
  "attachments": [
    {
      "attachName": "invoice.pdf",
      "objectKey": "tenant_1/trans/20260125/invoice.pdf",
      "objectUrl": "https://minio.example.com/tenant_1/trans/20260125/invoice.pdf"
    }
  ]
}

// Response
{
  "code": 200,
  "message": "æŠ¥é”€å•åˆ›å»ºæˆåŠŸ",
  "data": {
    "tenantId": 1,
    "transId": 1,
    "transCode": "BX202601250001",
    "transTypeId": 1,
    "transTypeName": "ä¸€èˆ¬è´¹ç”¨",
    "projectId": 1,
    "projectCode": "P001",
    "projectName": "é¡¹ç›®A",
    "transCharge": 5000.00,
    "lcCharge": 5000.00,
    "state": "DRAFT",
    "createdUserId": 1,
    "createdUserName": "å¼ ä¸‰",
    "createdAt": "2026-01-25T10:00:00"
  }
}
```

#### 2. æŸ¥è¯¢æŠ¥é”€å•åˆ—è¡¨

**GET** `/api/trans/list`

**Query Parameters**:
- `transTypeId`: æŠ¥é”€ç±»å‹IDï¼ˆå¯é€‰ï¼‰
- `projectId`: é¡¹ç›®IDï¼ˆå¯é€‰ï¼‰
- `state`: çŠ¶æ€ï¼ˆå¯é€‰ï¼‰
- `startDate`: å¼€å§‹æ—¥æœŸï¼ˆå¯é€‰ï¼‰
- `endDate`: ç»“æŸæ—¥æœŸï¼ˆå¯é€‰ï¼‰
- `page`: é¡µç ï¼ˆé»˜è®¤1ï¼‰
- `size`: æ¯é¡µå¤§å°ï¼ˆé»˜è®¤10ï¼‰

**Response**
```json
{
  "code": 200,
  "data": {
    "total": 100,
    "page": 1,
    "size": 10,
    "records": [
      {
        "transId": 1,
        "transCode": "BX202601250001",
        "transTypeName": "ä¸€èˆ¬è´¹ç”¨",
        "projectName": "é¡¹ç›®A",
        "transCharge": 5000.00,
        "lcCharge": 5000.00,
        "state": "SUBMITTED",
        "createdUserName": "å¼ ä¸‰",
        "createdAt": "2026-01-25T10:00:00"
      },
      {
        "transId": 2,
        "transCode": "BX202601250002",
        "transTypeName": "å·®æ—…æŠ¥é”€",
        "projectName": "é¡¹ç›®B",
        "transCharge": 8000.00,
        "lcCharge": 8000.00,
        "state": "APPROVED",
        "createdUserName": "æå››",
        "createdAt": "2026-01-24T15:30:00"
      }
    ]
  }
}
```

#### 3. æŸ¥è¯¢æŠ¥é”€å•è¯¦æƒ…

**GET** `/api/trans/{transId}`

**Response**
```json
{
  "code": 200,
  "data": {
    "transId": 1,
    "transCode": "BX202601250001",
    "transTypeId": 1,
    "transTypeName": "ä¸€èˆ¬è´¹ç”¨",
    "transTypeCode": "GENERAL",
    "projectId": 1,
    "projectCode": "P001",
    "projectName": "é¡¹ç›®A",
    "transCharge": 5000.00,
    "lcCharge": 5000.00,
    "transSettCharge": 5000.00,
    "lcSettCharge": 5000.00,
    "linkTel": "13800138000",
    "linkAddress": "åŒ—äº¬å¸‚æœé˜³åŒº...",
    "pages": 5,
    "sheets": 3,
    "transDesc": "å·®æ—…è´¹ç”¨æŠ¥é”€",
    "transSettDesc": "å®¡æ ¸é€šè¿‡ï¼Œå…¨é¢ç»“ç®—",
    "processInstanceId": "process_123456",
    "state": "COMPLETED",
    "stateDate": "2026-01-26T14:30:00",
    "currencyId": 1,
    "exchangeRate": 1.000000,
    "createdUserId": 1,
    "createdUserName": "å¼ ä¸‰",
    "createdJobNumber": "E001",
    "settUserId": 10,
    "settUserName": "ç‹äº”",
    "settJobNumber": "E010",
    "settDate": "2026-01-26T14:30:00",
    "createdAt": "2026-01-25T10:00:00",
    "updatedAt": "2026-01-26T14:30:00",
    "transItems": [
      {
        "transItemId": 1,
        "transTypeName": "ä¸€èˆ¬è´¹ç”¨",
        "projectName": "é¡¹ç›®A",
        "transItemName": "å·®æ—…è´¹ç”¨",
        "transItemDesc": "åŒ—äº¬åˆ°ä¸Šæµ·å‡ºå·®",
        "state": "COMPLETED",
        "chargeItems": [
          {
            "chargeId": 1,
            "expenseItemTypeName": "äº¤é€šè´¹",
            "chargeAmount": 2000.00,
            "lcCharge": 2000.00,
            "chargeDate": "2026-01-20",
            "chargeDesc": "åŒ—äº¬åˆ°ä¸Šæµ·é«˜é“"
          },
          {
            "chargeId": 2,
            "expenseItemTypeName": "ä½å®¿è´¹",
            "chargeAmount": 3000.00,
            "lcCharge": 3000.00,
            "chargeDate": "2026-01-21",
            "chargeDesc": "ä¸Šæµ·é…’åº—2æ™š"
          }
        ]
      }
    ],
    "attachments": [
      {
        "attachId": 1,
        "attachName": "invoice.pdf",
        "attachSize": 1024000,
        "attachType": "application/pdf",
        "attachExt": "pdf",
        "objectUrl": "https://minio.example.com/tenant_1/trans/20260125/invoice.pdf",
        "uploadUserId": 1,
        "uploadUserName": "å¼ ä¸‰",
        "createdAt": "2026-01-25T10:00:00"
      }
    ]
  }
}
```

#### 4. æäº¤æŠ¥é”€å•å®¡æ‰¹

**POST** `/api/trans/{transId}/submit`

**Response**
```json
{
  "code": 200,
  "message": "æŠ¥é”€å•æäº¤æˆåŠŸ",
  "data": {
    "transId": 1,
    "transCode": "BX202601250001",
    "state": "SUBMITTED",
    "processInstanceId": "process_123456",
    "submittedAt": "2026-01-25T10:30:00"
  }
}
```

#### 5. ç»“ç®—æŠ¥é”€å•

**POST** `/api/trans/{transId}/settle`

```json
// Request
{
  "transSettCharge": 4800.00,
  "lcSettCharge": 4800.00,
  "transSettDesc": "éƒ¨åˆ†è´¹ç”¨ä¸äºˆæŠ¥é”€ï¼Œç»“ç®—4800å…ƒ"
}

// Response
{
  "code": 200,
  "message": "æŠ¥é”€å•ç»“ç®—æˆåŠŸ",
  "data": {
    "transId": 1,
    "transCode": "BX202601250001",
    "state": "COMPLETED",
    "transSettCharge": 4800.00,
    "lcSettCharge": 4800.00,
    "settUserId": 10,
    "settUserName": "ç‹äº”",
    "settDate": "2026-01-26T14:30:00"
  }
}
```

#### 6. è·å–æŠ¥é”€ç±»å‹æ’ä»¶é…ç½®

**GET** `/api/trans-type/{transTypeId}/plugin`

**Response**
```json
{
  "code": 200,
  "data": {
    "manifest": {
      "id": "TRAVEL",
      "name": "å·®æ—…æŠ¥é”€",
      "version": "1.0.0",
      "description": "å‡ºå·®å·®æ—…è´¹ç”¨æŠ¥é”€",
      "bpmnFile": "definition/reimbursement.bpmn",
      "formSchema": "form/form-schema.json",
      "config": "config/config.json"
    },
    "formSchema": {
      "formType": "grid",
      "sections": [
        {
          "title": "å‡ºå·®ä¿¡æ¯",
          "fields": [
            {
              "id": "tripType",
              "label": "å‡ºå·®ç±»å‹",
              "type": "radio",
              "required": true,
              "options": [
                {"value": "DOMESTIC", "label": "å›½å†…å‡ºå·®"},
                {"value": "INTERNATIONAL", "label": "å›½é™…å‡ºå·®"}
              ]
            }
          ]
        }
      ]
    },
    "config": {
      "approvalThreshold": 10000,
      "currency": {
        "enabled": true,
        "default": "CNY",
        "supported": ["CNY", "USD", "EUR", "JPY"]
      }
    }
  }
}
```

### ğŸ’» æ ¸å¿ƒä»£ç å®ç°

#### TransController.java

```java
package com.fs.trans.controller;

import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.fs.common.core.result.Result;
import com.fs.trans.dto.*;
import com.fs.trans.service.TransService;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;

import jakarta.validation.Valid;
import java.util.List;

@RestController
@RequestMapping("/api/trans")
@RequiredArgsConstructor
public class TransController {
    
    private final TransService transService;
    
    /**
     * åˆ›å»ºæŠ¥é”€å•
     */
    @PostMapping("/create")
    public Result<TransDTO> create(@Valid @RequestBody TransCreateDTO dto) {
        return Result.success(transService.createTrans(dto));
    }
    
    /**
     * æŸ¥è¯¢æŠ¥é”€å•åˆ—è¡¨
     */
    @GetMapping("/list")
    public Result<Page<TransDTO>> list(
            @RequestParam(required = false) Long transTypeId,
            @RequestParam(required = false) Long projectId,
            @RequestParam(required = false) String state,
            @RequestParam(required = false) String startDate,
            @RequestParam(required = false) String endDate,
            @RequestParam(defaultValue = "1") int page,
            @RequestParam(defaultValue = "10") int size) {
        
        TransQueryDTO queryDTO = new TransQueryDTO();
        queryDTO.setTransTypeId(transTypeId);
        queryDTO.setProjectId(projectId);
        queryDTO.setState(state);
        queryDTO.setStartDate(startDate);
        queryDTO.setEndDate(endDate);
        queryDTO.setPage(page);
        queryDTO.setSize(size);
        
        return Result.success(transService.queryTransList(queryDTO));
    }
    
    /**
     * æŸ¥è¯¢æŠ¥é”€å•è¯¦æƒ…
     */
    @GetMapping("/{transId}")
    public Result<TransDetailDTO> getDetail(@PathVariable Long transId) {
        return Result.success(transService.getTransDetail(transId));
    }
    
    /**
     * æäº¤æŠ¥é”€å•å®¡æ‰¹
     */
    @PostMapping("/{transId}/submit")
    public Result<TransDTO> submit(@PathVariable Long transId) {
        return Result.success(transService.submitTrans(transId));
    }
    
    /**
     * ç»“ç®—æŠ¥é”€å•
     */
    @PostMapping("/{transId}/settle")
    public Result<TransDTO> settle(
            @PathVariable Long transId,
            @Valid @RequestBody TransSettleDTO dto) {
        return Result.success(transService.settleTrans(transId, dto));
    }
    
    /**
     * è·å–æŠ¥é”€ç±»å‹æ’ä»¶é…ç½®
     */
    @GetMapping("/trans-type/{transTypeId}/plugin")
    public Result<TransTypePluginDTO> getPluginConfig(@PathVariable Long transTypeId) {
        return Result.success(transService.getTransTypePluginConfig(transTypeId));
    }
}
```

#### TransService.java

```java
package com.fs.trans.service;

import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.fs.common.core.exception.BusinessException;
import com.fs.common.tenant.context.TenantContextHolder;
import com.fs.trans.dto.*;
import com.fs.trans.entity.*;
import com.fs.trans.mapper.*;
import com.fs.trans.plugin.TransTypePluginManager;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.List;
import java.util.UUID;

@Slf4j
@Service
@RequiredArgsConstructor
public class TransService {
    
    private final TransMapper transMapper;
    private final TransItemMapper transItemMapper;
    private final ChargeItemMapper chargeItemMapper;
    private final TransAttachMapper transAttachMapper;
    private final TransTypePluginManager pluginManager;
    
    /**
     * åˆ›å»ºæŠ¥é”€å•
     */
    @Transactional(rollbackFor = Exception.class)
    public TransDTO createTrans(TransCreateDTO dto) {
        log.info("åˆ›å»ºæŠ¥é”€å•: transTypeId={}, projectId={}, amount={}", 
                 dto.getTransTypeId(), dto.getProjectId(), dto.getTransCharge());
        
        Long tenantId = TenantContextHolder.getTenantId();
        
        // 1. ç”ŸæˆæŠ¥é”€å•å·
        String transCode = generateTransCode();
        
        // 2. åˆ›å»ºæŠ¥é”€å•
        Trans trans = new Trans();
        trans.setTenantId(tenantId);
        trans.setTransCode(transCode);
        trans.setTransTypeId(dto.getTransTypeId());
        trans.setTransTypeName(dto.getTransTypeName());
        trans.setTransTypeCode(dto.getTransTypeCode());
        trans.setProjectId(dto.getProjectId());
        trans.setProjectCode(dto.getProjectCode());
        trans.setProjectName(dto.getProjectName());
        trans.setTransCharge(dto.getTransCharge());
        trans.setLcCharge(dto.getLcCharge());
        trans.setCurrencyId(dto.getCurrencyId());
        trans.setExchangeRate(dto.getExchangeRate());
        trans.setTransDesc(dto.getTransDesc());
        trans.setLinkTel(dto.getLinkTel());
        trans.setLinkAddress(dto.getLinkAddress());
        trans.setPages(dto.getPages());
        trans.setSheets(dto.getSheets());
        trans.setState("DRAFT");
        trans.setCreatedUserId(dto.getCreatedUserId());
        trans.setCreatedUserName(dto.getCreatedUserName());
        trans.setCreatedJobNumber(dto.getCreatedJobNumber());
        
        transMapper.insert(trans);
        
        // 3. åˆ›å»ºæŠ¥é”€æ˜ç»†
        TransItem transItem = new TransItem();
        transItem.setTenantId(tenantId);
        transItem.setTransId(trans.getTransId());
        transItem.setTransTypeId(dto.getTransTypeId());
        transItem.setTransTypeName(dto.getTransTypeName());
        transItem.setTransTypeCode(dto.getTransTypeCode());
        transItem.setProjectId(dto.getProjectId());
        transItem.setProjectCode(dto.getProjectCode());
        transItem.setProjectName(dto.getProjectName());
        transItem.setTransItemName(dto.getTransTypeName());
        transItem.setTransItemDesc(dto.getTransDesc());
        transItem.setState("DRAFT");
        
        transItemMapper.insert(transItem);
        
        // 4. åˆ›å»ºè´¹ç”¨æ˜ç»†
        if (dto.getChargeItems() != null && !dto.getChargeItems().isEmpty()) {
            for (ChargeItemCreateDTO chargeItemDTO : dto.getChargeItems()) {
                ChargeItem chargeItem = new ChargeItem();
                chargeItem.setTenantId(tenantId);
                chargeItem.setTransItemId(transItem.getTransItemId());
                chargeItem.setExpenseItemTypeId(chargeItemDTO.getExpenseItemTypeId());
                chargeItem.setExpenseItemTypeName(chargeItemDTO.getExpenseItemTypeName());
                chargeItem.setChargeAmount(chargeItemDTO.getChargeAmount());
                chargeItem.setLcCharge(chargeItemDTO.getLcCharge());
                chargeItem.setChargeDate(chargeItemDTO.getChargeDate());
                chargeItem.setChargeDesc(chargeItemDTO.getChargeDesc());
                chargeItem.setExchangeRate(dto.getExchangeRate());
                
                chargeItemMapper.insert(chargeItem);
            }
        }
        
        // 5. åˆ›å»ºé™„ä»¶
        if (dto.getAttachments() != null && !dto.getAttachments().isEmpty()) {
            for (TransAttachCreateDTO attachDTO : dto.getAttachments()) {
                TransAttach attach = new TransAttach();
                attach.setTenantId(tenantId);
                attach.setTransId(trans.getTransId());
                attach.setAttachName(attachDTO.getAttachName());
                attach.setObjectKey(attachDTO.getObjectKey());
                attach.setObjectUrl(attachDTO.getObjectUrl());
                attach.setUploadUserId(dto.getCreatedUserId());
                attach.setUploadUserName(dto.getCreatedUserName());
                
                transAttachMapper.insert(attach);
            }
        }
        
        log.info("æŠ¥é”€å•åˆ›å»ºæˆåŠŸ: transId={}, transCode={}", trans.getTransId(), transCode);
        return convertToDTO(trans);
    }
    
    /**
     * æŸ¥è¯¢æŠ¥é”€å•åˆ—è¡¨
     */
    public Page<TransDTO> queryTransList(TransQueryDTO queryDTO) {
        Long tenantId = TenantContextHolder.getTenantId();
        
        Page<Trans> page = new Page<>(queryDTO.getPage(), queryDTO.getSize());
        
        LambdaQueryWrapper<Trans> wrapper = new LambdaQueryWrapper<Trans>()
                .eq(Trans::getTenantId, tenantId)
                .eq(queryDTO.getTransTypeId() != null, Trans::getTransTypeId, queryDTO.getTransTypeId())
                .eq(queryDTO.getProjectId() != null, Trans::getProjectId, queryDTO.getProjectId())
                .eq(queryDTO.getState() != null, Trans::getState, queryDTO.getState())
                .ge(queryDTO.getStartDate() != null, Trans::getCreatedAt, queryDTO.getStartDate())
                .le(queryDTO.getEndDate() != null, Trans::getCreatedAt, queryDTO.getEndDate())
                .orderByDesc(Trans::getCreatedAt);
        
        Page<Trans> transPage = transMapper.selectPage(page, wrapper);
        
        // è½¬æ¢ä¸ºDTO
        Page<TransDTO> dtoPage = new Page<>();
        dtoPage.setRecords(transPage.getRecords().stream()
                .map(this::convertToDTO)
                .collect(java.util.stream.Collectors.toList()));
        dtoPage.setTotal(transPage.getTotal());
        dtoPage.setCurrent(transPage.getCurrent());
        dtoPage.setSize(transPage.getSize());
        
        return dtoPage;
    }
    
    /**
     * æŸ¥è¯¢æŠ¥é”€å•è¯¦æƒ…
     */
    public TransDetailDTO getTransDetail(Long transId) {
        Long tenantId = TenantContextHolder.getTenantId();
        
        // 1. æŸ¥è¯¢æŠ¥é”€å•
        Trans trans = transMapper.selectById(transId);
        if (trans == null) {
            throw new BusinessException("æŠ¥é”€å•ä¸å­˜åœ¨");
        }
        
        // 2. æŸ¥è¯¢æŠ¥é”€æ˜ç»†
        List<TransItem> transItems = transItemMapper.selectList(
            new LambdaQueryWrapper<TransItem>()
                .eq(TransItem::getTenantId, tenantId)
                .eq(TransItem::getTransId, transId)
        );
        
        // 3. æŸ¥è¯¢è´¹ç”¨æ˜ç»†
        List<ChargeItem> chargeItems = chargeItemMapper.selectList(
            new LambdaQueryWrapper<ChargeItem>()
                .eq(ChargeItem::getTenantId, tenantId)
                .in(ChargeItem::getTransItemId, 
                    transItems.stream().map(TransItem::getTransItemId).toList())
        );
        
        // 4. æŸ¥è¯¢é™„ä»¶
        List<TransAttach> attachments = transAttachMapper.selectList(
            new LambdaQueryWrapper<TransAttach>()
                .eq(TransAttach::getTenantId, tenantId)
                .eq(TransAttach::getTransId, transId)
        );
        
        // 5. ç»„è£…DTO
        TransDetailDTO detailDTO = convertToDetailDTO(trans);
        
        // 6. ç»„è£…æŠ¥é”€æ˜ç»†
        for (TransItem transItem : transItems) {
            TransItemDetailDTO itemDetail = convertToTransItemDetailDTO(transItem);
            
            // ç»„è£…è´¹ç”¨æ˜ç»†
            List<ChargeItem> itemChargeItems = chargeItems.stream()
                    .filter(ci -> ci.getTransItemId().equals(transItem.getTransItemId()))
                    .toList();
            itemDetail.setChargeItems(itemChargeItems.stream()
                    .map(this::convertToChargeItemDTO)
                    .collect(java.util.stream.Collectors.toList()));
            
            detailDTO.getTransItems().add(itemDetail);
        }
        
        // 7. ç»„è£…é™„ä»¶
        detailDTO.setAttachments(attachments.stream()
                .map(this::convertToAttachDTO)
                .collect(java.util.stream.Collectors.toList()));
        
        return detailDTO;
    }
    
    /**
     * æäº¤æŠ¥é”€å•å®¡æ‰¹
     */
    @Transactional(rollbackFor = Exception.class)
    public TransDTO submitTrans(Long transId) {
        log.info("æäº¤æŠ¥é”€å•å®¡æ‰¹: transId={}", transId);
        
        Long tenantId = TenantContextHolder.getTenantId();
        
        // 1. æŸ¥è¯¢æŠ¥é”€å•
        Trans trans = transMapper.selectById(transId);
        if (trans == null) {
            throw new BusinessException("æŠ¥é”€å•ä¸å­˜åœ¨");
        }
        
        // 2. éªŒè¯çŠ¶æ€
        if (!"DRAFT".equals(trans.getState())) {
            throw new BusinessException("åªæœ‰è‰ç¨¿çŠ¶æ€çš„æŠ¥é”€å•æ‰èƒ½æäº¤");
        }
        
        // 3. è°ƒç”¨Approval Serviceå¯åŠ¨å®¡æ‰¹æµç¨‹
        String processInstanceId = startApprovalProcess(trans);
        
        // 4. æ›´æ–°æŠ¥é”€å•çŠ¶æ€
        trans.setState("SUBMITTED");
        trans.setStateDate(LocalDateTime.now());
        trans.setProcessInstanceId(processInstanceId);
        transMapper.updateById(trans);
        
        log.info("æŠ¥é”€å•æäº¤æˆåŠŸ: transId={}, processInstanceId={}", transId, processInstanceId);
        return convertToDTO(trans);
    }
    
    /**
     * ç»“ç®—æŠ¥é”€å•
     */
    @Transactional(rollbackFor = Exception.class)
    public TransDTO settleTrans(Long transId, TransSettleDTO dto) {
        log.info("ç»“ç®—æŠ¥é”€å•: transId={}, settCharge={}", transId, dto.getTransSettCharge());
        
        Long tenantId = TenantContextHolder.getTenantId();
        
        // 1. æŸ¥è¯¢æŠ¥é”€å•
        Trans trans = transMapper.selectById(transId);
        if (trans == null) {
            throw new BusinessException("æŠ¥é”€å•ä¸å­˜åœ¨");
        }
        
        // 2. éªŒè¯çŠ¶æ€
        if (!"APPROVED".equals(trans.getState())) {
            throw new BusinessException("åªæœ‰å·²é€šè¿‡çš„æŠ¥é”€å•æ‰èƒ½ç»“ç®—");
        }
        
        // 3. æ›´æ–°ç»“ç®—ä¿¡æ¯
        trans.setTransSettCharge(dto.getTransSettCharge());
        trans.setLcSettCharge(dto.getLcSettCharge());
        trans.setTransSettDesc(dto.getTransSettDesc());
        trans.setSettUserId(dto.getSettUserId());
        trans.setSettUserName(dto.getSettUserName());
        trans.setSettJobNumber(dto.getSettJobNumber());
        trans.setSettDate(LocalDateTime.now());
        trans.setState("COMPLETED");
        trans.setStateDate(LocalDateTime.now());
        
        transMapper.updateById(trans);
        
        log.info("æŠ¥é”€å•ç»“ç®—æˆåŠŸ: transId={}", transId);
        return convertToDTO(trans);
    }
    
    /**
     * è·å–æŠ¥é”€ç±»å‹æ’ä»¶é…ç½®
     */
    public TransTypePluginDTO getTransTypePluginConfig(Long transTypeId) {
        // è°ƒç”¨æ’ä»¶ç®¡ç†å™¨è·å–æ’ä»¶é…ç½®
        return pluginManager.getPluginConfig(transTypeId);
    }
    
    /**
     * ç”ŸæˆæŠ¥é”€å•å·
     */
    private String generateTransCode() {
        // æ ¼å¼: BX + yyyyMMdd + 6ä½åºå·
        String dateStr = java.time.LocalDate.now().format(
            java.time.format.DateTimeFormatter.ofPattern("yyyyMMdd"));
        String uuid = UUID.randomUUID().toString().replace("-", "").substring(0, 6).toUpperCase();
        return "BX" + dateStr + uuid;
    }
    
    /**
     * å¯åŠ¨å®¡æ‰¹æµç¨‹
     */
    private String startApprovalProcess(Trans trans) {
        // TODO: è°ƒç”¨Approval Serviceå¯åŠ¨Camundaæµç¨‹
        log.info("å¯åŠ¨å®¡æ‰¹æµç¨‹: transId={}, transTypeId={}", trans.getTransId(), trans.getTransTypeId());
        return "process_" + UUID.randomUUID().toString();
    }
    
    // è½¬æ¢æ–¹æ³•çœç•¥...
}
```

### ğŸ“Š ç›‘æ§æŒ‡æ ‡

| æŒ‡æ ‡åç§° | ç±»å‹ | æè¿° |
|---------|------|------|
| trans_create_total | Counter | æŠ¥é”€å•åˆ›å»ºæ€»æ•° |
| trans_submit_total | Counter | æŠ¥é”€å•æäº¤æ€»æ•° |
| trans_settle_total | Counter | æŠ¥é”€å•ç»“ç®—æ€»æ•° |
| trans_state_summary | Gauge | æŠ¥é”€å•çŠ¶æ€åˆ†å¸ƒ |
| trans_amount_total | Gauge | æŠ¥é”€å•æ€»é‡‘é¢ |
| trans_processing_duration_seconds | Histogram | æŠ¥é”€å•å¤„ç†è€—æ—¶ |

---


## æœåŠ¡5: Loan Service - å€Ÿæ¬¾æœåŠ¡

### ğŸ“‹ æœåŠ¡æ¦‚è§ˆ

**æœåŠ¡åç§°**: loan-service  
**æœåŠ¡ç«¯å£**: 8765  
**ä¼˜å…ˆçº§**: P0ï¼ˆæ ¸å¿ƒä¸šåŠ¡æœåŠ¡ï¼‰  
**æŠ€æœ¯æ ˆ**: Spring Boot 3.2 + MyBatis Plus + Camunda Client  
**èŒè´£èŒƒå›´**: å€Ÿæ¬¾å•ç®¡ç†ã€å€Ÿæ¬¾å®¡æ‰¹ã€å€Ÿæ¬¾å‘æ”¾ã€å€Ÿæ¬¾è¿˜æ¬¾è·Ÿè¸ª

### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½ID | åŠŸèƒ½åç§° | æè¿° | ä¼˜å…ˆçº§ |
|--------|---------|------|--------|
| L-001 | å€Ÿæ¬¾å•åˆ›å»º | åˆ›å»ºå€Ÿæ¬¾å• | P0 |
| L-002 | å€Ÿæ¬¾å•æŸ¥è¯¢ | æŸ¥è¯¢å€Ÿæ¬¾å•åˆ—è¡¨å’Œè¯¦æƒ… | P0 |
| L-003 | å€Ÿæ¬¾å•æäº¤ | æäº¤å€Ÿæ¬¾å•å®¡æ‰¹ | P0 |
| L-004 | å€Ÿæ¬¾å‘æ”¾ | å‘æ”¾å€Ÿæ¬¾ | P0 |
| L-005 | å€Ÿæ¬¾è¿˜æ¬¾è·Ÿè¸ª | è·Ÿè¸ªå€Ÿæ¬¾è¿˜æ¬¾æƒ…å†µ | P0 |

### ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

**è¡¨**: loan, loan_attach

```sql
-- å€Ÿæ¬¾è¡¨
CREATE TABLE loan (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    loan_id BIGSERIAL NOT NULL,
    
    -- åŸºæœ¬ä¿¡æ¯
    loan_code VARCHAR(60) NOT NULL,
    loan_type VARCHAR(50),
    
    -- å€Ÿæ¬¾äººä¿¡æ¯
    user_id BIGINT NOT NULL,
    user_name VARCHAR(60) NOT NULL,
    user_job_number VARCHAR(30),
    user_org_id BIGINT,
    
    -- å€Ÿæ¬¾é¡¹ç›®
    project_id BIGINT NOT NULL,
    project_code VARCHAR(50) NOT NULL,
    project_name VARCHAR(200) NOT NULL,
    
    -- å€Ÿæ¬¾é‡‘é¢
    loan_amount NUMERIC(12,2) NOT NULL,
    loan_lc_amount NUMERIC(12,2),
    loan_sett_charge NUMERIC(12,2),
    amount_repaid NUMERIC(12,2) DEFAULT 0,
    amount_outstanding NUMERIC(12,2),
    
    -- å€Ÿæ¬¾æ—¥æœŸ
    loan_date DATE NOT NULL,
    due_date DATE,
    sett_date DATE,
    
    -- å€Ÿæ¬¾è¯´æ˜
    description TEXT,
    loan_sett_desc TEXT,
    
    -- è”ç³»ä¿¡æ¯
    link_tel VARCHAR(20),
    
    -- å®¡æ‰¹æµç¨‹
    processinstance_id VARCHAR(60),
    state VARCHAR(20) NOT NULL DEFAULT 'DRAFT',
    state_date TIMESTAMP,
    
    -- å¸ç§å’Œæ±‡ç‡
    currency_id INTEGER DEFAULT 1,
    exchange_rate NUMERIC(12,6),
    
    -- ç»“ç®—äººä¿¡æ¯
    sett_user_id BIGINT,
    sett_user_name VARCHAR(60),
    sett_job_number VARCHAR(30),
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP,
    remarks TEXT,
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, loan_id),
    
    -- å”¯ä¸€çº¦æŸ
    CONSTRAINT uk_loan_tenant_code UNIQUE (tenant_id, loan_code),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_loan_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    CONSTRAINT fk_loan_project FOREIGN KEY (tenant_id, project_id) REFERENCES project(tenant_id, project_id),
    CONSTRAINT fk_loan_currency FOREIGN KEY (currency_id) REFERENCES currency(currency_id)
);

-- ç´¢å¼•
CREATE INDEX idx_loan_user ON loan(tenant_id, user_id);
CREATE INDEX idx_loan_project ON loan(tenant_id, project_id);
CREATE INDEX idx_loan_state ON loan(tenant_id, state);
CREATE INDEX idx_loan_date ON loan(tenant_id, loan_date);
CREATE INDEX idx_loan_process ON loan(processinstance_id);

-- å€Ÿæ¬¾é™„ä»¶è¡¨
CREATE TABLE loan_attach (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    attach_id BIGSERIAL NOT NULL,
    
    -- å…³è”å€Ÿæ¬¾å•
    loan_id BIGINT NOT NULL,
    
    -- é™„ä»¶ä¿¡æ¯
    attach_name VARCHAR(255) NOT NULL,
    attach_path VARCHAR(500),
    attach_size BIGINT,
    attach_type VARCHAR(100),
    attach_ext VARCHAR(10),
    
    -- MinIOå­˜å‚¨ä¿¡æ¯
    bucket_name VARCHAR(100),
    object_key VARCHAR(500) NOT NULL,
    object_url VARCHAR(500),
    
    -- ä¸Šä¼ äººä¿¡æ¯
    upload_user_id BIGINT NOT NULL,
    upload_user_name VARCHAR(60) NOT NULL,
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, attach_id),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_loan_attach_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    CONSTRAINT fk_loan_attach_loan FOREIGN KEY (tenant_id, loan_id) REFERENCES loan(tenant_id, loan_id)
);

-- ç´¢å¼•
CREATE INDEX idx_loan_attach_loan ON loan_attach(tenant_id, loan_id);
```

### ğŸ”Œ APIæ¥å£è®¾è®¡

#### 1. åˆ›å»ºå€Ÿæ¬¾å•

**POST** `/api/loan/create`

```json
// Request
{
  "loanType": "INTERNATIONAL_TRAVEL",
  "userId": 1,
  "userName": "å¼ ä¸‰",
  "userJobNumber": "E001",
  "userOrgId": 1,
  "projectId": 1,
  "projectCode": "P001",
  "projectName": "é¡¹ç›®A",
  "loanAmount": 10000.00,
  "loanLcAmount": 10000.00,
  "loanDate": "2026-01-25",
  "dueDate": "2026-02-25",
  "currencyId": 1,
  "exchangeRate": 1.000000,
  "description": "å›½é™…å·®æ—…å€Ÿæ¬¾",
  "linkTel": "13800138000",
  "attachments": [
    {
      "attachName": "application.pdf",
      "objectKey": "tenant_1/loan/20260125/application.pdf",
      "objectUrl": "https://minio.example.com/tenant_1/loan/20260125/application.pdf"
    }
  ]
}

// Response
{
  "code": 200,
  "message": "å€Ÿæ¬¾å•åˆ›å»ºæˆåŠŸ",
  "data": {
    "tenantId": 1,
    "loanId": 1,
    "loanCode": "JK202601250001",
    "loanType": "INTERNATIONAL_TRAVEL",
    "userId": 1,
    "userName": "å¼ ä¸‰",
    "loanAmount": 10000.00,
    "loanLcAmount": 10000.00,
    "amountOutstanding": 10000.00,
    "state": "DRAFT",
    "createdAt": "2026-01-25T10:00:00"
  }
}
```

#### 2. æŸ¥è¯¢å€Ÿæ¬¾å•åˆ—è¡¨

**GET** `/api/loan/list`

**Query Parameters**:
- `userId`: å€Ÿæ¬¾äººIDï¼ˆå¯é€‰ï¼‰
- `projectId`: é¡¹ç›®IDï¼ˆå¯é€‰ï¼‰
- `state`: çŠ¶æ€ï¼ˆå¯é€‰ï¼‰
- `startDate`: å¼€å§‹æ—¥æœŸï¼ˆå¯é€‰ï¼‰
- `endDate`: ç»“æŸæ—¥æœŸï¼ˆå¯é€‰ï¼‰
- `page`: é¡µç ï¼ˆé»˜è®¤1ï¼‰
- `size`: æ¯é¡µå¤§å°ï¼ˆé»˜è®¤10ï¼‰

**Response**
```json
{
  "code": 200,
  "data": {
    "total": 50,
    "page": 1,
    "size": 10,
    "records": [
      {
        "loanId": 1,
        "loanCode": "JK202601250001",
        "loanType": "INTERNATIONAL_TRAVEL",
        "userName": "å¼ ä¸‰",
        "projectName": "é¡¹ç›®A",
        "loanAmount": 10000.00,
        "loanLcAmount": 10000.00,
        "amountRepaid": 3000.00,
        "amountOutstanding": 7000.00,
        "state": "RELEASED",
        "createdAt": "2026-01-25T10:00:00"
      }
    ]
  }
}
```

#### 3. å‘æ”¾å€Ÿæ¬¾

**POST** `/api/loan/{loanId}/release`

**Response**
```json
{
  "code": 200,
  "message": "å€Ÿæ¬¾å‘æ”¾æˆåŠŸ",
  "data": {
    "loanId": 1,
    "loanCode": "JK202601250001",
    "state": "RELEASED",
    "settDate": "2026-01-26T10:30:00"
  }
}
```

---

## æœåŠ¡6: Repayment Service - è¿˜æ¬¾æœåŠ¡

### ğŸ“‹ æœåŠ¡æ¦‚è§ˆ

**æœåŠ¡åç§°**: repayment-service  
**æœåŠ¡ç«¯å£**: 8766  
**ä¼˜å…ˆçº§**: P0ï¼ˆæ ¸å¿ƒä¸šåŠ¡æœåŠ¡ï¼‰  
**æŠ€æœ¯æ ˆ**: Spring Boot 3.2 + MyBatis Plus + Camunda Client  
**èŒè´£èŒƒå›´**: è¿˜æ¬¾å•ç®¡ç†ã€è¿˜æ¬¾å®¡æ‰¹ã€è¿˜æ¬¾ç»“ç®—ã€è¿˜æ¬¾å†²é”€å€Ÿæ¬¾

### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½ID | åŠŸèƒ½åç§° | æè¿° | ä¼˜å…ˆçº§ |
|--------|---------|------|--------|
| R-001 | è¿˜æ¬¾å•åˆ›å»º | åˆ›å»ºè¿˜æ¬¾å• | P0 |
| R-002 | è¿˜æ¬¾å•æŸ¥è¯¢ | æŸ¥è¯¢è¿˜æ¬¾å•åˆ—è¡¨å’Œè¯¦æƒ… | P0 |
| R-003 | è¿˜æ¬¾å•æäº¤ | æäº¤è¿˜æ¬¾å•å®¡æ‰¹ | P0 |
| R-004 | è¿˜æ¬¾ç»“ç®— | ç»“ç®—è¿˜æ¬¾ | P0 |
| R-005 | è¿˜æ¬¾å†²é”€ | è¿˜æ¬¾å†²é”€å€Ÿæ¬¾ | P0 |

### ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

**è¡¨**: repayment, repayment_sett, repayment_attach

```sql
-- è¿˜æ¬¾è¡¨
CREATE TABLE repayment (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    repayment_id BIGSERIAL NOT NULL,
    
    -- åŸºæœ¬ä¿¡æ¯
    repayment_code VARCHAR(60) NOT NULL,
    
    -- è¿˜æ¬¾äººä¿¡æ¯
    user_id BIGINT NOT NULL,
    user_name VARCHAR(60) NOT NULL,
    user_job_number VARCHAR(30),
    
    -- è¿˜æ¬¾é¡¹ç›®
    project_id BIGINT NOT NULL,
    project_code VARCHAR(50) NOT NULL,
    project_name VARCHAR(200) NOT NULL,
    
    -- è¿˜æ¬¾é‡‘é¢
    repayment_amount NUMERIC(12,2) NOT NULL,
    lc_repayment_amount NUMERIC(12,2),
    
    -- è¿˜æ¬¾æ—¥æœŸ
    repayment_date DATE NOT NULL,
    sett_date DATE,
    
    -- è¿˜æ¬¾è¯´æ˜
    description TEXT,
    
    -- è”ç³»ä¿¡æ¯
    link_tel VARCHAR(20),
    
    -- å®¡æ‰¹æµç¨‹
    processinstance_id VARCHAR(60),
    state VARCHAR(20) NOT NULL DEFAULT 'DRAFT',
    state_date TIMESTAMP,
    
    -- å¸ç§å’Œæ±‡ç‡
    currency_id INTEGER DEFAULT 1,
    exchange_rate NUMERIC(12,6),
    
    -- ç»“ç®—äººä¿¡æ¯
    sett_user_id BIGINT,
    sett_user_name VARCHAR(60),
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP,
    remarks TEXT,
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, repayment_id),
    
    -- å”¯ä¸€çº¦æŸ
    CONSTRAINT uk_repayment_tenant_code UNIQUE (tenant_id, repayment_code),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_repayment_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    CONSTRAINT fk_repayment_project FOREIGN KEY (tenant_id, project_id) REFERENCES project(tenant_id, project_id),
    CONSTRAINT fk_repayment_currency FOREIGN KEY (currency_id) REFERENCES currency(currency_id)
);

-- ç´¢å¼•
CREATE INDEX idx_repayment_user ON repayment(tenant_id, user_id);
CREATE INDEX idx_repayment_project ON repayment(tenant_id, project_id);
CREATE INDEX idx_repayment_state ON repayment(tenant_id, state);
CREATE INDEX idx_repayment_date ON repayment(tenant_id, repayment_date);
CREATE INDEX idx_repayment_process ON repayment(processinstance_id);

-- è¿˜æ¬¾å†²é”€è¡¨
CREATE TABLE repayment_sett (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    sett_id BIGSERIAL NOT NULL,
    
    -- å…³è”å…³ç³»
    repayment_id BIGINT NOT NULL,
    loan_id BIGINT NOT NULL,
    
    -- å†²é”€ä¿¡æ¯
    sett_amount NUMERIC(12,2) NOT NULL,
    sett_date DATE NOT NULL,
    sett_desc TEXT,
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, sett_id),
    
    -- å”¯ä¸€çº¦æŸ
    CONSTRAINT uk_repayment_sett UNIQUE (tenant_id, repayment_id, loan_id),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_repayment_sett_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    CONSTRAINT fk_repayment_sett_repayment FOREIGN KEY (tenant_id, repayment_id) REFERENCES repayment(tenant_id, repayment_id),
    CONSTRAINT fk_repayment_sett_loan FOREIGN KEY (tenant_id, loan_id) REFERENCES loan(tenant_id, loan_id)
);

-- ç´¢å¼•
CREATE INDEX idx_repayment_sett_repayment ON repayment_sett(tenant_id, repayment_id);
CREATE INDEX idx_repayment_sett_loan ON repayment_sett(tenant_id, loan_id);

-- è¿˜æ¬¾é™„ä»¶è¡¨
CREATE TABLE repayment_attach (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    attach_id BIGSERIAL NOT NULL,
    
    -- å…³è”è¿˜æ¬¾å•
    repayment_id BIGINT NOT NULL,
    
    -- é™„ä»¶ä¿¡æ¯
    attach_name VARCHAR(255) NOT NULL,
    attach_path VARCHAR(500),
    attach_size BIGINT,
    attach_type VARCHAR(100),
    attach_ext VARCHAR(10),
    
    -- MinIOå­˜å‚¨ä¿¡æ¯
    bucket_name VARCHAR(100),
    object_key VARCHAR(500) NOT NULL,
    object_url VARCHAR(500),
    
    -- ä¸Šä¼ äººä¿¡æ¯
    upload_user_id BIGINT NOT NULL,
    upload_user_name VARCHAR(60) NOT NULL,
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, attach_id),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_repayment_attach_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    CONSTRAINT fk_repayment_attach_repayment FOREIGN KEY (tenant_id, repayment_id) REFERENCES repayment(tenant_id, repayment_id)
);

-- ç´¢å¼•
CREATE INDEX idx_repayment_attach_repayment ON repayment_attach(tenant_id, repayment_id);
```

---

## æœåŠ¡7: Approval Service - å®¡æ‰¹æœåŠ¡

### ğŸ“‹ æœåŠ¡æ¦‚è§ˆ

**æœåŠ¡åç§°**: approval-service  
**æœåŠ¡ç«¯å£**: 8767  
**ä¼˜å…ˆçº§**: P0ï¼ˆæ ¸å¿ƒåŸºç¡€æœåŠ¡ï¼‰  
**æŠ€æœ¯æ ˆ**: Spring Boot 3.2 + Camunda 8 Embedded + PostgreSQL  
**èŒè´£èŒƒå›´**: å®¡æ‰¹æµç¨‹ç®¡ç†ã€Camundaæµç¨‹å¼•æ“é›†æˆ

### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½ID | åŠŸèƒ½åç§° | æè¿° | ä¼˜å…ˆçº§ |
|--------|---------|------|--------|
| A-001 | æµç¨‹å®šä¹‰ç®¡ç† | éƒ¨ç½²/æŸ¥è¯¢æµç¨‹å®šä¹‰ | P0 |
| A-002 | æµç¨‹å®ä¾‹å¯åŠ¨ | å¯åŠ¨å®¡æ‰¹æµç¨‹ | P0 |
| A-003 | ä»»åŠ¡æŸ¥è¯¢ | æŸ¥è¯¢å¾…åŠ/å·²åŠä»»åŠ¡ | P0 |
| A-004 | ä»»åŠ¡å¤„ç† | å®Œæˆä»»åŠ¡ï¼ˆé€šè¿‡/é©³å›ï¼‰ | P0 |
| A-005 | ä»»åŠ¡è½¬åŠ | è½¬åŠä»»åŠ¡ | P0 |
| A-006 | æµç¨‹å†å²æŸ¥è¯¢ | æŸ¥è¯¢å®¡æ‰¹å†å² | P0 |
| A-007 | æµç¨‹ç›‘æ§ | ç›‘æ§å¼‚å¸¸æµç¨‹ | P1 |

### ğŸ”Œ æœåŠ¡é—´é€šä¿¡

```
Approval Service
    â†“ (è°ƒç”¨)
â”œâ”€ User Service (æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯)
â”œâ”€ Org Service (æŸ¥è¯¢ç»„ç»‡ä¿¡æ¯)
â”œâ”€ Project Service (æŸ¥è¯¢é¡¹ç›®ä¿¡æ¯)
â””â”€ Notification Service (å‘é€å®¡æ‰¹é€šçŸ¥)

    â†‘ (è¢«è°ƒç”¨)
â”œâ”€ Trans Service (å¯åŠ¨æŠ¥é”€å®¡æ‰¹)
â”œâ”€ Loan Service (å¯åŠ¨å€Ÿæ¬¾å®¡æ‰¹)
â””â”€ Repayment Service (å¯åŠ¨è¿˜æ¬¾å®¡æ‰¹)
```

### ğŸ—„ï¸ Camundaæ•°æ®åº“è¡¨

Camunda 8 Embeddedæ¨¡å¼ä¼šè‡ªåŠ¨åˆ›å»ºä»¥ä¸‹è¡¨ï¼š

```
act_* (25å¼ è¡¨)
â”œâ”€â”€ act_hi_*          # å†å²è¡¨
â”œâ”€â”€ act_re_*          # æµç¨‹å®šä¹‰è¡¨
â”œâ”€â”€ act_ru_*          # è¿è¡Œæ—¶è¡¨
â””â”€â”€ act_id_*          # èº«ä»½è®¤è¯è¡¨
```

### ğŸ”Œ APIæ¥å£è®¾è®¡

#### 1. å¯åŠ¨æµç¨‹å®ä¾‹

**POST** `/api/approval/start`

```json
// Request
{
  "processDefinitionKey": "reimbursementApprovalProcess",
  "businessKey": "TRANS_1",
  "variables": {
    "tenantId": 1,
    "transId": 1,
    "projectId": 1,
    "transTypeId": 1,
    "transTypeCode": "GENERAL",
    "totalAmount": 5000.00,
    "createdUserId": 1,
    "createdUserName": "å¼ ä¸‰"
  }
}

// Response
{
  "code": 200,
  "message": "æµç¨‹å¯åŠ¨æˆåŠŸ",
  "data": {
    "processInstanceId": "process_123456",
    "processDefinitionId": "reimbursementApprovalProcess:1:12345",
    "businessKey": "TRANS_1"
  }
}
```

#### 2. æŸ¥è¯¢å¾…åŠä»»åŠ¡

**GET** `/api/approval/tasks/pending`

**Query Parameters**:
- `userId`: ç”¨æˆ·ID
- `tenantId`: ç§Ÿæˆ·ID
- `page`: é¡µç ï¼ˆé»˜è®¤1ï¼‰
- `size`: æ¯é¡µå¤§å°ï¼ˆé»˜è®¤10ï¼‰

**Response**
```json
{
  "code": 200,
  "data": {
    "total": 5,
    "page": 1,
    "size": 10,
    "records": [
      {
        "taskId": "task_123456",
        "taskName": "é¡¹ç›®ç»ç†å®¡æ‰¹",
        "processInstanceId": "process_123456",
        "businessKey": "TRANS_1",
        "assignee": "user_10",
        "createTime": "2026-01-25T10:00:00",
        "variables": {
          "transId": 1,
          "totalAmount": 5000.00
        }
      }
    ]
  }
}
```

#### 3. å®Œæˆä»»åŠ¡ï¼ˆé€šè¿‡ï¼‰

**POST** `/api/approval/tasks/{taskId}/complete`

```json
// Request
{
  "action": "APPROVE",
  "comment": "åŒæ„æŠ¥é”€",
  "variables": {}
}

// Response
{
  "code": 200,
  "message": "ä»»åŠ¡å®ŒæˆæˆåŠŸ"
}
```

#### 4. é©³å›ä»»åŠ¡

**POST** `/api/approval/tasks/{taskId}/reject`

```json
// Request
{
  "action": "REJECT",
  "comment": "è´¹ç”¨æ˜ç»†ä¸æ¸…æ™°ï¼Œè¯·è¡¥å……è¯´æ˜",
  "rejectTo": "userTask_apply"  // é©³å›åˆ°ç”³è¯·äºº
}

// Response
{
  "code": 200,
  "message": "ä»»åŠ¡é©³å›æˆåŠŸ"
}
```

#### 5. æŸ¥è¯¢æµç¨‹å†å²

**GET** `/api/approval/history/{processInstanceId}`

**Response**
```json
{
  "code": 200,
  "data": {
    "processInstanceId": "process_123456",
    "processDefinitionName": "æŠ¥é”€å®¡æ‰¹æµç¨‹",
    "startTime": "2026-01-25T10:00:00",
    "endTime": "2026-01-26T14:30:00",
    "duration": 162000,
    "activities": [
      {
        "activityId": "startEvent",
        "activityName": "å¼€å§‹",
        "activityType": "startEvent",
        "startTime": "2026-01-25T10:00:00",
        "endTime": "2026-01-25T10:00:01"
      },
      {
        "activityId": "userTask_projectManager",
        "activityName": "é¡¹ç›®ç»ç†å®¡æ‰¹",
        "activityType": "userTask",
        "assignee": "user_10",
        "startTime": "2026-01-25T10:00:01",
        "endTime": "2026-01-25T11:00:00",
        "comment": "åŒæ„æŠ¥é”€"
      },
      {
        "activityId": "endEvent_approve",
        "activityName": "é€šè¿‡",
        "activityType": "endEvent",
        "startTime": "2026-01-26T14:30:00",
        "endTime": "2026-01-26T14:30:00"
      }
    ]
  }
}
```

### ğŸ’» æ ¸å¿ƒä»£ç å®ç°

#### ApprovalController.java

```java
package com.fs.approval.controller;

import com.fs.approval.dto.*;
import com.fs.approval.service.ApprovalService;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;

import jakarta.validation.Valid;
import java.util.Map;

@RestController
@RequestMapping("/api/approval")
@RequiredArgsConstructor
public class ApprovalController {
    
    private final ApprovalService approvalService;
    
    /**
     * å¯åŠ¨æµç¨‹å®ä¾‹
     */
    @PostMapping("/start")
    public ApprovalResult<ProcessInstanceDTO> startProcess(@Valid @RequestBody ProcessStartDTO dto) {
        return ApprovalResult.success(approvalService.startProcess(dto));
    }
    
    /**
     * æŸ¥è¯¢å¾…åŠä»»åŠ¡
     */
    @GetMapping("/tasks/pending")
    public ApprovalResult<PageResult<TaskDTO>> getPendingTasks(
            @RequestParam Long userId,
            @RequestParam Long tenantId,
            @RequestParam(defaultValue = "1") int page,
            @RequestParam(defaultValue = "10") int size) {
        return ApprovalResult.success(approvalService.getPendingTasks(userId, tenantId, page, size));
    }
    
    /**
     * å®Œæˆä»»åŠ¡
     */
    @PostMapping("/tasks/{taskId}/complete")
    public ApprovalResult<Void> completeTask(
            @PathVariable String taskId,
            @Valid @RequestBody TaskCompleteDTO dto) {
        approvalService.completeTask(taskId, dto);
        return ApprovalResult.success();
    }
    
    /**
     * é©³å›ä»»åŠ¡
     */
    @PostMapping("/tasks/{taskId}/reject")
    public ApprovalResult<Void> rejectTask(
            @PathVariable String taskId,
            @Valid @RequestBody TaskRejectDTO dto) {
        approvalService.rejectTask(taskId, dto);
        return ApprovalResult.success();
    }
    
    /**
     * æŸ¥è¯¢æµç¨‹å†å²
     */
    @GetMapping("/history/{processInstanceId}")
    public ApprovalResult<ProcessHistoryDTO> getProcessHistory(@PathVariable String processInstanceId) {
        return ApprovalResult.success(approvalService.getProcessHistory(processInstanceId));
    }
}
```

#### ApprovalService.java

```java
package com.fs.approval.service;

import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.fs.approval.dto.*;
import com.fs.approval.mapper.TaskMapper;
import com.fs.common.core.exception.BusinessException;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.camunda.bpm.engine.*;
import org.camunda.bpm.engine.history.HistoricActivityInstance;
import org.camunda.bpm.engine.history.HistoricProcessInstance;
import org.camunda.bpm.engine.runtime.ProcessInstance;
import org.camunda.bpm.engine.task.Task;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@Slf4j
@Service
@RequiredArgsConstructor
public class ApprovalService {
    
    private final RuntimeService runtimeService;
    private final TaskService taskService;
    private final HistoryService historyService;
    private final RepositoryService repositoryService;
    
    /**
     * å¯åŠ¨æµç¨‹å®ä¾‹
     */
    public ProcessInstanceDTO startProcess(ProcessStartDTO dto) {
        log.info("å¯åŠ¨æµç¨‹: processDefinitionKey={}, businessKey={}", 
                 dto.getProcessDefinitionKey(), dto.getBusinessKey());
        
        // 1. å¯åŠ¨æµç¨‹
        ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(
            dto.getProcessDefinitionKey(),
            dto.getBusinessKey(),
            dto.getVariables()
        );
        
        log.info("æµç¨‹å¯åŠ¨æˆåŠŸ: processInstanceId={}", processInstance.getId());
        
        return ProcessInstanceDTO.builder()
                .processInstanceId(processInstance.getId())
                .processDefinitionId(processInstance.getProcessDefinitionId())
                .businessKey(processInstance.getBusinessKey())
                .build();
    }
    
    /**
     * æŸ¥è¯¢å¾…åŠä»»åŠ¡
     */
    public PageResult<TaskDTO> getPendingTasks(Long userId, Long tenantId, int page, int size) {
        // 1. æŸ¥è¯¢ä»»åŠ¡åˆ—è¡¨
        List<Task> tasks = taskService.createTaskQuery()
                .taskAssignee(userId.toString())
                .processVariableValueEquals("tenantId", tenantId)
                .orderByTaskCreateTime()
                .desc()
                .listPage((page - 1) * size, size);
        
        // 2. æŸ¥è¯¢æ€»æ•°
        long total = taskService.createTaskQuery()
                .taskAssignee(userId.toString())
                .processVariableValueEquals("tenantId", tenantId)
                .count();
        
        // 3. è½¬æ¢ä¸ºDTO
        List<TaskDTO> taskDTOs = new ArrayList<>();
        for (Task task : tasks) {
            TaskDTO taskDTO = TaskDTO.builder()
                    .taskId(task.getId())
                    .taskName(task.getName())
                    .processInstanceId(task.getProcessInstanceId())
                    .businessKey(task.getProcessInstanceId())
                    .assignee(task.getAssignee())
                    .createTime(task.getCreateTime())
                    .variables(getProcessVariables(task.getProcessInstanceId()))
                    .build();
            taskDTOs.add(taskDTO);
        }
        
        return PageResult.<TaskDTO>builder()
                .total(total)
                .page(page)
                .size(size)
                .records(taskDTOs)
                .build();
    }
    
    /**
     * å®Œæˆä»»åŠ¡
     */
    public void completeTask(String taskId, TaskCompleteDTO dto) {
        log.info("å®Œæˆä»»åŠ¡: taskId={}, action={}", taskId, dto.getAction());
        
        // 1. æŸ¥è¯¢ä»»åŠ¡
        Task task = taskService.createTaskQuery().taskId(taskId).singleResult();
        if (task == null) {
            throw new BusinessException("ä»»åŠ¡ä¸å­˜åœ¨");
        }
        
        // 2. è®¾ç½®æµç¨‹å˜é‡
        Map<String, Object> variables = new HashMap<>();
        variables.put("action", dto.getAction());
        variables.put("comment", dto.getComment());
        
        if (dto.getVariables() != null) {
            variables.putAll(dto.getVariables());
        }
        
        // 3. å®Œæˆä»»åŠ¡
        taskService.complete(taskId, variables);
        
        log.info("ä»»åŠ¡å®ŒæˆæˆåŠŸ: taskId={}", taskId);
    }
    
    /**
     * é©³å›ä»»åŠ¡
     */
    public void rejectTask(String taskId, TaskRejectDTO dto) {
        log.info("é©³å›ä»»åŠ¡: taskId={}, rejectTo={}", taskId, dto.getRejectTo());
        
        // 1. æŸ¥è¯¢ä»»åŠ¡
        Task task = taskService.createTaskQuery().taskId(taskId).singleResult();
        if (task == null) {
            throw new BusinessException("ä»»åŠ¡ä¸å­˜åœ¨");
        }
        
        // 2. è®¾ç½®æµç¨‹å˜é‡
        Map<String, Object> variables = new HashMap<>();
        variables.put("action", "REJECT");
        variables.put("comment", dto.getComment());
        variables.put("rejectTo", dto.getRejectTo());
        
        // 3. é©³å›åˆ°æŒ‡å®šèŠ‚ç‚¹
        taskService.setVariable(task.getProcessInstanceId(), "rejected", true);
        taskService.complete(taskId, variables);
        
        log.info("ä»»åŠ¡é©³å›æˆåŠŸ: taskId={}", taskId);
    }
    
    /**
     * æŸ¥è¯¢æµç¨‹å†å²
     */
    public ProcessHistoryDTO getProcessHistory(String processInstanceId) {
        log.info("æŸ¥è¯¢æµç¨‹å†å²: processInstanceId={}", processInstanceId);
        
        // 1. æŸ¥è¯¢æµç¨‹å®ä¾‹å†å²
        HistoricProcessInstance processInstance = historyService.createHistoricProcessInstanceQuery()
                .processInstanceId(processInstanceId)
                .singleResult();
        
        // 2. æŸ¥è¯¢æ´»åŠ¨å†å²
        List<HistoricActivityInstance> activities = historyService.createHistoricActivityInstanceQuery()
                .processInstanceId(processInstanceId)
                .orderByHistoricActivityInstanceStartTime()
                .asc()
                .list();
        
        // 3. ç»„è£…DTO
        ProcessHistoryDTO historyDTO = ProcessHistoryDTO.builder()
                .processInstanceId(processInstance.getId())
                .processDefinitionName(processInstance.getProcessDefinitionName())
                .startTime(processInstance.getStartTime())
                .endTime(processInstance.getEndTime())
                .duration(processInstance.getDurationInMillis())
                .activities(new ArrayList<>())
                .build();
        
        for (HistoricActivityInstance activity : activities) {
            ActivityDTO activityDTO = ActivityDTO.builder()
                    .activityId(activity.getActivityId())
                    .activityName(activity.getActivityName())
                    .activityType(activity.getActivityType())
                    .assignee(activity.getAssignee())
                    .startTime(activity.getStartTime())
                    .endTime(activity.getEndTime())
                    .build();
            historyDTO.getActivities().add(activityDTO);
        }
        
        return historyDTO;
    }
    
    /**
     * è·å–æµç¨‹å˜é‡
     */
    private Map<String, Object> getProcessVariables(String processInstanceId) {
        // TODO: å®ç°è·å–æµç¨‹å˜é‡
        return new HashMap<>();
    }
}
```

### ğŸ“Š ç›‘æ§æŒ‡æ ‡

| æŒ‡æ ‡åç§° | ç±»å‹ | æè¿° |
|---------|------|------|
| approval_process_total | Counter | æµç¨‹å¯åŠ¨æ€»æ•° |
| approval_task_pending_count | Gauge | å¾…åŠä»»åŠ¡æ•° |
| approval_task_completed_total | Counter | å·²å®Œæˆä»»åŠ¡æ€»æ•° |
| approval_process_duration_seconds | Histogram | æµç¨‹å¤„ç†è€—æ—¶ |
| approval_task_duration_seconds | Histogram | ä»»åŠ¡å¤„ç†è€—æ—¶ |

---


## æœåŠ¡8: Notification Service - é€šçŸ¥æœåŠ¡

### ğŸ“‹ æœåŠ¡æ¦‚è§ˆ

**æœåŠ¡åç§°**: notification-service  
**æœåŠ¡ç«¯å£**: 8768  
**ä¼˜å…ˆçº§**: P1ï¼ˆè¾…åŠ©æœåŠ¡ï¼‰  
**æŠ€æœ¯æ ˆ**: Spring Boot 3.2 + RabbitMQ + Redis + WebSocket  
**èŒè´£èŒƒå›´**: æ¶ˆæ¯é€šçŸ¥ã€ç«™å†…æ¶ˆæ¯ã€é‚®ä»¶é€šçŸ¥ã€é’‰é’‰é€šçŸ¥

### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½ID | åŠŸèƒ½åç§° | æè¿° | ä¼˜å…ˆçº§ |
|--------|---------|------|--------|
| N-001 | å‘é€ç«™å†…æ¶ˆæ¯ | å‘é€ç«™å†…æ¶ˆæ¯ | P0 |
| N-002 | å‘é€é‚®ä»¶ | å‘é€é‚®ä»¶é€šçŸ¥ | P0 |
| N-003 | å‘é€é’‰é’‰æ¶ˆæ¯ | å‘é€é’‰é’‰é€šçŸ¥ | P1 |
| N-004 | æ¶ˆæ¯æŸ¥è¯¢ | æŸ¥è¯¢ç”¨æˆ·æ¶ˆæ¯ | P0 |
| N-005 | æ¶ˆæ¯æ ‡è®°å·²è¯» | æ ‡è®°æ¶ˆæ¯å·²è¯» | P0 |
| N-006 | å®æ—¶æ¨é€ | WebSocketå®æ—¶æ¨é€ | P1 |

### ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

**è¡¨**: notification

```sql
-- é€šçŸ¥è¡¨
CREATE TABLE notification (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    notification_id BIGSERIAL NOT NULL,
    
    -- æ¥æ”¶äººä¿¡æ¯
    receiver_id BIGINT NOT NULL,
    receiver_name VARCHAR(60) NOT NULL,
    
    -- é€šçŸ¥ç±»å‹
    notification_type VARCHAR(50) NOT NULL,      -- EMAIL/IN_APP/DINGTALK/SMS
    notification_category VARCHAR(50) NOT NULL,  -- APPROVAL/SYSTEM/REMINDER
    
    -- é€šçŸ¥æ ‡é¢˜å’Œå†…å®¹
    title VARCHAR(200) NOT NULL,
    content TEXT NOT NULL,
    
    -- å…³è”ä¿¡æ¯
    business_type VARCHAR(50),                   -- TRANS/LOAN/REPAYMENT
    business_id BIGINT,
    business_data JSONB,
    
    -- é€šçŸ¥çŠ¶æ€
    read_status SMALLINT NOT NULL DEFAULT 0,     -- 0=æœªè¯»ï¼Œ1=å·²è¯»
    read_at TIMESTAMP,
    
    -- å‘é€çŠ¶æ€
    send_status SMALLINT NOT NULL DEFAULT 0,     -- 0=å¾…å‘é€ï¼Œ1=å‘é€æˆåŠŸï¼Œ2=å‘é€å¤±è´¥
    send_at TIMESTAMP,
    send_retry_count INTEGER DEFAULT 0,
    send_error_message TEXT,
    
    -- å‘é€æ¸ é“
    channels JSONB,                               -- å‘é€æ¸ é“åˆ—è¡¨ï¼ˆJSONæ•°ç»„ï¼‰
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, notification_id),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_notification_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id)
);

-- ç´¢å¼•
CREATE INDEX idx_notification_receiver ON notification(tenant_id, receiver_id);
CREATE INDEX idx_notification_type ON notification(tenant_id, notification_type);
CREATE INDEX idx_notification_category ON notification(tenant_id, notification_category);
CREATE INDEX idx_notification_read_status ON notification(tenant_id, read_status);
CREATE INDEX idx_notification_business ON notification(tenant_id, business_type, business_id);
```

### ğŸ”Œ APIæ¥å£è®¾è®¡

#### 1. å‘é€é€šçŸ¥

**POST** `/api/notification/send`

```json
// Request
{
  "receiverId": 1,
  "receiverName": "å¼ ä¸‰",
  "notificationType": "IN_APP",
  "notificationCategory": "APPROVAL",
  "title": "æŠ¥é”€å•å®¡æ‰¹é€šçŸ¥",
  "content": "æ‚¨æäº¤çš„æŠ¥é”€å•BX202601250001å·²è¢«é¡¹ç›®ç»ç†å®¡æ‰¹é€šè¿‡",
  "businessType": "TRANS",
  "businessId": 1,
  "channels": ["IN_APP", "DINGTALK"]
}

// Response
{
  "code": 200,
  "message": "é€šçŸ¥å‘é€æˆåŠŸ",
  "data": {
    "notificationId": 1,
    "sendStatus": "PENDING"
  }
}
```

#### 2. æŸ¥è¯¢ç”¨æˆ·æ¶ˆæ¯

**GET** `/api/notification/list`

**Query Parameters**:
- `readStatus`: å·²è¯»çŠ¶æ€ï¼ˆå¯é€‰ï¼š0=æœªè¯»ï¼Œ1=å·²è¯»ï¼‰
- `category`: æ¶ˆæ¯åˆ†ç±»ï¼ˆå¯é€‰ï¼‰
- `page`: é¡µç ï¼ˆé»˜è®¤1ï¼‰
- `size`: æ¯é¡µå¤§å°ï¼ˆé»˜è®¤10ï¼‰

**Response**
```json
{
  "code": 200,
  "data": {
    "total": 20,
    "page": 1,
    "size": 10,
    "records": [
      {
        "notificationId": 1,
        "notificationType": "IN_APP",
        "notificationCategory": "APPROVAL",
        "title": "æŠ¥é”€å•å®¡æ‰¹é€šçŸ¥",
        "content": "æ‚¨æäº¤çš„æŠ¥é”€å•BX202601250001å·²è¢«é¡¹ç›®ç»ç†å®¡æ‰¹é€šè¿‡",
        "businessType": "TRANS",
        "businessId": 1,
        "readStatus": 0,
        "createdAt": "2026-01-25T14:30:00"
      }
    ]
  }
}
```

#### 3. æ ‡è®°æ¶ˆæ¯å·²è¯»

**PUT** `/api/notification/{notificationId}/read`

**Response**
```json
{
  "code": 200,
  "message": "æ¶ˆæ¯æ ‡è®°å·²è¯»æˆåŠŸ"
}
```

---

## æœåŠ¡9: Report Service - æŠ¥è¡¨æœåŠ¡

### ğŸ“‹ æœåŠ¡æ¦‚è§ˆ

**æœåŠ¡åç§°**: report-service  
**æœåŠ¡ç«¯å£**: 8769  
**ä¼˜å…ˆçº§**: P1ï¼ˆè¾…åŠ©æœåŠ¡ï¼‰  
**æŠ€æœ¯æ ˆ**: Spring Boot 3.2 + Elasticsearch + MySQL  
**èŒè´£èŒƒå›´**: æŠ¥è¡¨ç»Ÿè®¡ã€æ•°æ®åˆ†æã€æŠ¥è¡¨å¯¼å‡º

### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½ID | åŠŸèƒ½åç§° | æè¿° | ä¼˜å…ˆçº§ |
|--------|---------|------|--------|
| RPT-001 | æŠ¥é”€ç»Ÿè®¡æŠ¥è¡¨ | æŠ¥é”€é‡‘é¢ã€æ•°é‡ç»Ÿè®¡ | P0 |
| RPT-002 | å€Ÿæ¬¾ç»Ÿè®¡æŠ¥è¡¨ | å€Ÿæ¬¾é‡‘é¢ã€è¿˜æ¬¾ç»Ÿè®¡ | P0 |
| RPT-003 | è´¹ç”¨åˆ†ææŠ¥è¡¨ | è´¹ç”¨ç±»å‹ã€éƒ¨é—¨åˆ†æ | P1 |
| RPT-004 | æŠ¥è¡¨å¯¼å‡º | å¯¼å‡ºExcel/PDFæŠ¥è¡¨ | P1 |

### ğŸ—„ï¸ Elasticsearchç´¢å¼•è®¾è®¡

**ç´¢å¼•**: trans_stats

```json
{
  "mappings": {
    "properties": {
      "tenantId": {"type": "long"},
      "transId": {"type": "long"},
      "transCode": {"type": "keyword"},
      "transTypeId": {"type": "long"},
      "transTypeName": {"type": "keyword"},
      "projectId": {"type": "long"},
      "projectName": {"type": "keyword"},
      "userId": {"type": "long"},
      "userName": {"type": "keyword"},
      "orgId": {"type": "long"},
      "orgName": {"type": "keyword"},
      "transCharge": {"type": "double"},
      "lcCharge": {"type": "double"},
      "currencyId": {"type": "integer"},
      "state": {"type": "keyword"},
      "createdAt": {"type": "date"},
      "settDate": {"type": "date"}
    }
  }
}
```

### ğŸ”Œ APIæ¥å£è®¾è®¡

#### 1. æŠ¥é”€ç»Ÿè®¡æŠ¥è¡¨

**POST** `/api/report/trans-stats`

```json
// Request
{
  "startDate": "2026-01-01",
  "endDate": "2026-01-31",
  "groupBy": "USER",  // USER/PROJECT/ORG/DATE
  "dimension": "AMOUNT"  // AMOUNT/COUNT/AVG
}

// Response
{
  "code": 200,
  "data": {
    "totalAmount": 500000.00,
    "totalCount": 100,
    "details": [
      {
        "key": "å¼ ä¸‰",
        "amount": 50000.00,
        "count": 10,
        "percentage": 10.0
      },
      {
        "key": "æå››",
        "amount": 30000.00,
        "count": 5,
        "percentage": 6.0
      }
    ]
  }
}
```

#### 2. å€Ÿæ¬¾ç»Ÿè®¡æŠ¥è¡¨

**POST** `/api/report/loan-stats`

```json
// Request
{
  "startDate": "2026-01-01",
  "endDate": "2026-01-31",
  "groupBy": "USER"
}

// Response
{
  "code": 200,
  "data": {
    "totalLoanAmount": 200000.00,
    "totalRepaidAmount": 80000.00,
    "totalOutstandingAmount": 120000.00,
    "details": [
      {
        "key": "å¼ ä¸‰",
        "loanAmount": 50000.00,
        "repaidAmount": 20000.00,
        "outstandingAmount": 30000.00
      }
    ]
  }
}
```

---

## æœåŠ¡10: File Service - æ–‡ä»¶æœåŠ¡

### ğŸ“‹ æœåŠ¡æ¦‚è§ˆ

**æœåŠ¡åç§°**: file-service  
**æœåŠ¡ç«¯å£**: 8770  
**ä¼˜å…ˆçº§**: P1ï¼ˆè¾…åŠ©æœåŠ¡ï¼‰  
**æŠ€æœ¯æ ˆ**: Spring Boot 3.2 + MinIO SDK  
**èŒè´£èŒƒå›´**: æ–‡ä»¶ä¸Šä¼ ã€æ–‡ä»¶ä¸‹è½½ã€æ–‡ä»¶ç®¡ç†

### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½ID | åŠŸèƒ½åç§° | æè¿° | ä¼˜å…ˆçº§ |
|--------|---------|------|--------|
| F-001 | æ–‡ä»¶ä¸Šä¼  | ä¸Šä¼ æ–‡ä»¶åˆ°MinIO | P0 |
| F-002 | æ–‡ä»¶ä¸‹è½½ | ä»MinIOä¸‹è½½æ–‡ä»¶ | P0 |
| F-003 | æ–‡ä»¶åˆ é™¤ | åˆ é™¤MinIOæ–‡ä»¶ | P0 |
| F-004 | æ–‡ä»¶é¢„è§ˆ | æ–‡ä»¶åœ¨çº¿é¢„è§ˆ | P1 |
| F-005 | æ–‡ä»¶æŸ¥è¯¢ | æŸ¥è¯¢æ–‡ä»¶ä¿¡æ¯ | P0 |

### ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

**è¡¨**: file_record

```sql
-- æ–‡ä»¶è®°å½•è¡¨
CREATE TABLE file_record (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    file_id BIGSERIAL NOT NULL,
    
    -- æ–‡ä»¶ä¿¡æ¯
    file_name VARCHAR(255) NOT NULL,
    file_type VARCHAR(100) NOT NULL,
    file_ext VARCHAR(10) NOT NULL,
    file_size BIGINT NOT NULL,
    file_md5 VARCHAR(32),
    
    -- MinIOå­˜å‚¨ä¿¡æ¯
    bucket_name VARCHAR(100) NOT NULL,
    object_key VARCHAR(500) NOT NULL,
    object_url VARCHAR(500) NOT NULL,
    
    -- å…³è”ä¿¡æ¯
    business_type VARCHAR(50),                   -- TRANS/LOAN/REPAYMENT
    business_id BIGINT,
    
    -- ä¸Šä¼ äººä¿¡æ¯
    upload_user_id BIGINT NOT NULL,
    upload_user_name VARCHAR(60) NOT NULL,
    
    -- è®¿é—®æ§åˆ¶
    is_public SMALLINT NOT NULL DEFAULT 0,
    access_url VARCHAR(500),                     -- ä¸´æ—¶è®¿é—®URL
    access_url_expire_at TIMESTAMP,
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, file_id),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_record_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id)
);

-- ç´¢å¼•
CREATE INDEX idx_file_record_business ON file_record(tenant_id, business_type, business_id);
CREATE INDEX idx_file_record_upload_user ON file_record(tenant_id, upload_user_id);
CREATE INDEX idx_file_record_md5 ON file_record(file_md5);
```

### ğŸ”Œ APIæ¥å£è®¾è®¡

#### 1. æ–‡ä»¶ä¸Šä¼ 

**POST** `/api/file/upload`

**Content-Type**: `multipart/form-data`

**Parameters**:
- `file`: æ–‡ä»¶
- `businessType`: ä¸šåŠ¡ç±»å‹ï¼ˆå¯é€‰ï¼‰
- `businessId`: ä¸šåŠ¡IDï¼ˆå¯é€‰ï¼‰

**Response**
```json
{
  "code": 200,
  "message": "æ–‡ä»¶ä¸Šä¼ æˆåŠŸ",
  "data": {
    "fileId": 1,
    "fileName": "invoice.pdf",
    "fileType": "application/pdf",
    "fileExt": "pdf",
    "fileSize": 1024000,
    "objectUrl": "https://minio.example.com/tenant_1/files/20260125/invoice.pdf",
    "createdAt": "2026-01-25T10:00:00"
  }
}
```

#### 2. æ–‡ä»¶ä¸‹è½½

**GET** `/api/file/download/{fileId}`

**Response**: è¿”å›æ–‡ä»¶æµ

#### 3. è·å–ä¸´æ—¶è®¿é—®URL

**GET** `/api/file/{fileId}/access-url`

**Query Parameters**:
- `expireSeconds`: è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼Œé»˜è®¤3600ï¼‰

**Response**
```json
{
  "code": 200,
  "data": {
    "fileId": 1,
    "accessUrl": "https://minio.example.com/tenant_1/files/20260125/invoice.pdf?X-Amz-Expires=3600&...",
    "expireAt": "2026-01-25T11:00:00"
  }
}
```

---

## æœåŠ¡é—´é€šä¿¡è®¾è®¡

### é€šä¿¡æ–¹å¼é€‰æ‹©

| åœºæ™¯ | é€šä¿¡æ–¹å¼ | åè®® | è¯´æ˜ |
|------|---------|------|------|
| åŒæ­¥æŸ¥è¯¢ | HTTP REST | HTTP/1.1 | OpenFeign |
| å¼‚æ­¥é€šçŸ¥ | æ¶ˆæ¯é˜Ÿåˆ— | AMQP | RabbitMQ |
| å®æ—¶æ¨é€ | WebSocket | WS | é€šçŸ¥æ¨é€ |
| æ•°æ®åŒæ­¥ | äº‹ä»¶æ€»çº¿ | RabbitMQ | æ•°æ®æœ€ç»ˆä¸€è‡´æ€§ |

### OpenFeignå®¢æˆ·ç«¯å®šä¹‰

#### User Serviceå®¢æˆ·ç«¯

```java
package com.fs.common.feign;

import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.*;

@FeignClient(name = "user-service", path = "/api/user")
public interface UserClient {
    
    /**
     * æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
     */
    @GetMapping("/{userId}")
    UserDTO getUser(@PathVariable Long userId);
    
    /**
     * æ‰¹é‡æŸ¥è¯¢ç”¨æˆ·
     */
    @GetMapping("/batch")
    List<UserDTO> getUsers(@RequestParam List<Long> userIds);
    
    /**
     * æŸ¥è¯¢ç”¨æˆ·è§’è‰²
     */
    @GetMapping("/{userId}/roles")
    List<String> getUserRoles(@PathVariable Long userId);
}
```

#### Project Serviceå®¢æˆ·ç«¯

```java
package com.fs.common.feign;

import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.*;

@FeignClient(name = "project-service", path = "/api/project")
public interface ProjectClient {
    
    /**
     * æŸ¥è¯¢é¡¹ç›®ä¿¡æ¯
     */
    @GetMapping("/{projectId}")
    ProjectDTO getProject(@PathVariable Long projectId);
    
    /**
     * æ‰¹é‡æŸ¥è¯¢é¡¹ç›®
     */
    @GetMapping("/batch")
    List<ProjectDTO> getProjects(@RequestParam List<Long> projectIds);
}
```

### æ¶ˆæ¯é˜Ÿåˆ—è®¾è®¡

#### RabbitMQ Exchangeå’ŒQueueå®šä¹‰

```java
package com.fs.common.mq.config;

import org.springframework.amqp.core.*;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class RabbitMQConfig {
    
    // Exchangeå®šä¹‰
    public static final String APPROVAL_EXCHANGE = "fs.approval.exchange";
    public static final String NOTIFICATION_EXCHANGE = "fs.notification.exchange";
    
    // Queueå®šä¹‰
    public static final String APPROVAL_CREATED_QUEUE = "fs.approval.created.queue";
    public static final String APPROVAL_COMPLETED_QUEUE = "fs.approval.completed.queue";
    public static final String NOTIFICATION_QUEUE = "fs.notification.queue";
    
    // Routing Keyå®šä¹‰
    public static final String APPROVAL_CREATED_ROUTING_KEY = "approval.created";
    public static final String APPROVAL_COMPLETED_ROUTING_KEY = "approval.completed";
    public static final String NOTIFICATION_ROUTING_KEY = "notification.send";
    
    /**
     * å®¡æ‰¹Exchange
     */
    @Bean
    public TopicExchange approvalExchange() {
        return new TopicExchange(APPROVAL_EXCHANGE, true, false);
    }
    
    /**
     * é€šçŸ¥Exchange
     */
    @Bean
    public TopicExchange notificationExchange() {
        return new TopicExchange(NOTIFICATION_EXCHANGE, true, false);
    }
    
    /**
     * å®¡æ‰¹åˆ›å»ºQueue
     */
    @Bean
    public Queue approvalCreatedQueue() {
        return QueueBuilder.durable(APPROVAL_CREATED_QUEUE).build();
    }
    
    /**
     * å®¡æ‰¹å®ŒæˆQueue
     */
    @Bean
    public Queue approvalCompletedQueue() {
        return QueueBuilder.durable(APPROVAL_COMPLETED_QUEUE).build();
    }
    
    /**
     * é€šçŸ¥Queue
     */
    @Bean
    public Queue notificationQueue() {
        return QueueBuilder.durable(NOTIFICATION_QUEUE).build();
    }
    
    /**
     * ç»‘å®šå®¡æ‰¹åˆ›å»ºQueueåˆ°Exchange
     */
    @Bean
    public Binding approvalCreatedBinding() {
        return BindingBuilder.bind(approvalCreatedQueue())
                .to(approvalExchange())
                .with(APPROVAL_CREATED_ROUTING_KEY);
    }
    
    /**
     * ç»‘å®šå®¡æ‰¹å®ŒæˆQueueåˆ°Exchange
     */
    @Bean
    public Binding approvalCompletedBinding() {
        return BindingBuilder.bind(approvalCompletedQueue())
                .to(approvalExchange())
                .with(APPROVAL_COMPLETED_ROUTING_KEY);
    }
    
    /**
     * ç»‘å®šé€šçŸ¥Queueåˆ°Exchange
     */
    @Bean
    public Binding notificationBinding() {
        return BindingBuilder.bind(notificationQueue())
                .to(notificationExchange())
                .with(NOTIFICATION_ROUTING_KEY);
    }
}
```

#### æ¶ˆæ¯ç”Ÿäº§è€…

```java
package com.fs.common.mq.producer;

import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.amqp.rabbit.core.RabbitTemplate;
import org.springframework.stereotype.Component;

@Slf4j
@Component
@RequiredArgsConstructor
public class NotificationProducer {
    
    private final RabbitTemplate rabbitTemplate;
    private final ObjectMapper objectMapper;
    
    /**
     * å‘é€é€šçŸ¥æ¶ˆæ¯
     */
    public void sendNotification(NotificationMessage message) {
        try {
            String json = objectMapper.writeValueAsString(message);
            rabbitTemplate.convertAndSend(
                RabbitMQConfig.NOTIFICATION_EXCHANGE,
                RabbitMQConfig.NOTIFICATION_ROUTING_KEY,
                json
            );
            log.info("å‘é€é€šçŸ¥æ¶ˆæ¯æˆåŠŸ: {}", json);
        } catch (Exception e) {
            log.error("å‘é€é€šçŸ¥æ¶ˆæ¯å¤±è´¥", e);
        }
    }
}
```

#### æ¶ˆæ¯æ¶ˆè´¹è€…

```java
package com.fs.notification.consumer;

import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.amqp.rabbit.annotation.RabbitListener;
import org.springframework.stereotype.Component;

@Slf4j
@Component
@RequiredArgsConstructor
public class NotificationConsumer {
    
    private final ObjectMapper objectMapper;
    private final NotificationService notificationService;
    
    /**
     * æ¶ˆè´¹é€šçŸ¥æ¶ˆæ¯
     */
    @RabbitListener(queues = RabbitMQConfig.NOTIFICATION_QUEUE)
    public void handleNotification(String message) {
        try {
            log.info("æ¥æ”¶é€šçŸ¥æ¶ˆæ¯: {}", message);
            
            NotificationMessage notificationMessage = objectMapper.readValue(message, NotificationMessage.class);
            
            // å¤„ç†é€šçŸ¥
            notificationService.sendNotification(notificationMessage);
            
        } catch (Exception e) {
            log.error("å¤„ç†é€šçŸ¥æ¶ˆæ¯å¤±è´¥", e);
        }
    }
}
```

---

## éƒ¨ç½²æ¶æ„

### Kuberneteséƒ¨ç½²é…ç½®

#### Gateway Serviceéƒ¨ç½²

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: financial-gateway
  namespace: financial-saas
spec:
  replicas: 2
  selector:
    matchLabels:
      app: financial-gateway
  template:
    metadata:
      labels:
        app: financial-gateway
    spec:
      containers:
      - name: gateway
        image: registry.cn-hangzhou.aliyuncs.com/fs/gateway:1.0.0
        ports:
        - containerPort: 8080
        env:
        - name: NACOS_SERVER_ADDR
          value: "nacos:8848"
        - name: NACOS_NAMESPACE
          value: "financial-saas"
        - name: JAVA_OPTS
          value: "-Xms512m -Xmx512m"
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /actuator/health/liveness
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: financial-gateway
  namespace: financial-saas
spec:
  type: LoadBalancer
  selector:
    app: financial-gateway
  ports:
  - port: 80
    targetPort: 8080
```

#### Trans Serviceéƒ¨ç½²

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: trans-service
  namespace: financial-saas
spec:
  replicas: 3
  selector:
    matchLabels:
      app: trans-service
  template:
    metadata:
      labels:
        app: trans-service
    spec:
      containers:
      - name: trans-service
        image: registry.cn-hangzhou.aliyuncs.com/fs/trans-service:1.0.0
        ports:
        - containerPort: 8764
        env:
        - name: NACOS_SERVER_ADDR
          value: "nacos:8848"
        - name: NACOS_NAMESPACE
          value: "financial-saas"
        - name: SPRING_DATASOURCE_URL
          value: "jdbc:postgresql://postgresql:5432/financial_saas"
        - name: SPRING_REDIS_HOST
          value: "redis"
        - name: JAVA_OPTS
          value: "-Xms1g -Xmx1g"
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
        livenessProbe:
          httpGet:
            path: /actuator/health/liveness
            port: 8764
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8764
          initialDelaySeconds: 10
          periodSeconds: 5
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: trans-service-hpa
  namespace: financial-saas
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: trans-service
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

### Docker Composeéƒ¨ç½²ï¼ˆå¼€å‘ç¯å¢ƒï¼‰

```yaml
version: '3.8'

services:
  # Nacosæ³¨å†Œä¸­å¿ƒ
  nacos:
    image: nacos/nacos-server:v2.3.0
    container_name: financial-nacos
    environment:
      MODE: standalone
      SPRING_DATASOURCE_PLATFORM: postgresql
    ports:
      - "8848:8848"
    volumes:
      - ./data/nacos:/home/nacos/data

  # PostgreSQLæ•°æ®åº“
  postgresql:
    image: postgres:15
    container_name: financial-postgresql
    environment:
      POSTGRES_DB: financial_saas
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - ./data/postgresql:/var/lib/postgresql/data

  # Redisç¼“å­˜
  redis:
    image: redis:7.2
    container_name: financial-redis
    ports:
      - "6379:6379"
    volumes:
      - ./data/redis:/data

  # RabbitMQæ¶ˆæ¯é˜Ÿåˆ—
  rabbitmq:
    image: rabbitmq:3.12-management
    container_name: financial-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - ./data/rabbitmq:/var/lib/rabbitmq

  # MinIOå¯¹è±¡å­˜å‚¨
  minio:
    image: minio/minio:latest
    container_name: financial-minio
    environment:
      MINIO_ROOT_USER: admin
      MINIO_ROOT_PASSWORD: admin123
    ports:
      - "9000:9000"
      - "9001:9001"
    command: server /data --console-address ":9001"
    volumes:
      - ./data/minio:/data

  # API Gateway
  gateway:
    image: registry.cn-hangzhou.aliyuncs.com/fs/gateway:1.0.0
    container_name: financial-gateway
    ports:
      - "8080:8080"
    environment:
      NACOS_SERVER_ADDR: nacos:8848
    depends_on:
      - nacos

  # Trans Service
  trans-service:
    image: registry.cn-hangzhou.aliyuncs.com/fs/trans-service:1.0.0
    container_name: financial-trans-service
    ports:
      - "8764:8764"
    environment:
      NACOS_SERVER_ADDR: nacos:8848
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgresql:5432/financial_saas
      SPRING_REDIS_HOST: redis
    depends_on:
      - nacos
      - postgresql
      - redis
```

---

## ç›‘æ§å’Œè¿ç»´

### Prometheusç›‘æ§é…ç½®

```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  # GatewayæœåŠ¡
  - job_name: 'financial-gateway'
    metrics_path: '/actuator/prometheus'
    static_configs:
      - targets: ['financial-gateway:8080']
        labels:
          service: 'gateway'
          namespace: 'financial-saas'

  # TransæœåŠ¡
  - job_name: 'financial-trans-service'
    metrics_path: '/actuator/prometheus'
    static_configs:
      - targets: ['trans-service:8764']
        labels:
          service: 'trans'
          namespace: 'financial-saas'

  # LoanæœåŠ¡
  - job_name: 'financial-loan-service'
    metrics_path: '/actuator/prometheus'
    static_configs:
      - targets: ['loan-service:8765']
        labels:
          service: 'loan'
          namespace: 'financial-saas'

  # RepaymentæœåŠ¡
  - job_name: 'financial-repayment-service'
    metrics_path: '/actuator/prometheus'
    static_configs:
      - targets: ['repayment-service:8766']
        labels:
          service: 'repayment'
          namespace: 'financial-saas'

  # ApprovalæœåŠ¡
  - job_name: 'financial-approval-service'
    metrics_path: '/actuator/prometheus'
    static_configs:
      - targets: ['approval-service:8767']
        labels:
          service: 'approval'
          namespace: 'financial-saas'

  # NotificationæœåŠ¡
  - job_name: 'financial-notification-service'
    metrics_path: '/actuator/prometheus'
    static_configs:
      - targets: ['notification-service:8768']
        labels:
          service: 'notification'
          namespace: 'financial-saas'
```

### Grafanaä»ªè¡¨ç›˜

**å…³é”®ç›‘æ§æŒ‡æ ‡**:

1. **æœåŠ¡å¥åº·åº¦**
   - æœåŠ¡å®ä¾‹æ•°é‡
   - æœåŠ¡å¯ç”¨æ€§
   - å“åº”æ—¶é—´ï¼ˆP50, P95, P99ï¼‰

2. **ä¸šåŠ¡æŒ‡æ ‡**
   - æŠ¥é”€å•åˆ›å»ºæ•°é‡
   - å€Ÿæ¬¾å•åˆ›å»ºæ•°é‡
   - å®¡æ‰¹ä»»åŠ¡æ•°é‡
   - æµç¨‹å®Œæˆç‡

3. **èµ„æºä½¿ç”¨**
   - CPUä½¿ç”¨ç‡
   - å†…å­˜ä½¿ç”¨ç‡
   - JVMå †å†…å­˜
   - GCæ¬¡æ•°å’Œè€—æ—¶

4. **æ•°æ®åº“æŒ‡æ ‡**
   - è¿æ¥æ± ä½¿ç”¨æƒ…å†µ
   - æŸ¥è¯¢è€—æ—¶
   - æ…¢æŸ¥è¯¢æ•°é‡

5. **æ¶ˆæ¯é˜Ÿåˆ—æŒ‡æ ‡**
   - æ¶ˆæ¯ç§¯å‹æ•°é‡
   - æ¶ˆæ¯æ¶ˆè´¹é€Ÿç‡
   - æ¶ˆæ¯å¤±è´¥ç‡

---

## æ€»ç»“

### è®¾è®¡è¦ç‚¹æ€»ç»“

1. **å¾®æœåŠ¡æ‹†åˆ†**
   - 10ä¸ªå¾®æœåŠ¡ï¼ŒèŒè´£æ¸…æ™°
   - æ ¸å¿ƒæœåŠ¡ï¼šTenantã€Userã€Orgã€Transã€Loanã€Repaymentã€Approval
   - è¾…åŠ©æœåŠ¡ï¼šNotificationã€Reportã€File

2. **å¤šç§Ÿæˆ·éš”ç¦»**
   - æ‰€æœ‰ä¸šåŠ¡è¡¨åŒ…å«tenant_id
   - åº”ç”¨å±‚éªŒè¯ç§Ÿæˆ·éš”ç¦»
   - æ•°æ®åº“å±‚é¢çº¦æŸ

3. **æœåŠ¡é€šä¿¡**
   - åŒæ­¥è°ƒç”¨ï¼šOpenFeign
   - å¼‚æ­¥é€šçŸ¥ï¼šRabbitMQ
   - å®æ—¶æ¨é€ï¼šWebSocket

4. **å¯æ‰©å±•æ€§**
   - ç‹¬ç«‹æ‰©å±•æ ¸å¿ƒä¸šåŠ¡æœåŠ¡
   - K8sè‡ªåŠ¨æ‰©ç¼©å®¹ï¼ˆHPAï¼‰
   - æ’ä»¶åŒ–æ”¯æŒ

5. **é«˜å¯ç”¨æ€§**
   - æœåŠ¡å¤šå‰¯æœ¬éƒ¨ç½²
   - å¥åº·æ£€æŸ¥ï¼ˆLiveness/Readiness Probeï¼‰
   - ç†”æ–­é™çº§ï¼ˆSentinel/Hystrixï¼‰

6. **å¯è§‚æµ‹æ€§**
   - Prometheusç›‘æ§
   - Grafanaå¯è§†åŒ–
   - SkyWalkingé“¾è·¯è¿½è¸ª
   - ELKæ—¥å¿—æ”¶é›†

### ä¸‹ä¸€æ­¥å·¥ä½œ

1. âœ… å®Œæˆè¯¦ç»†è®¾è®¡æ–‡æ¡£
2. â³ å®ç°å„å¾®æœåŠ¡ä»£ç 
3. â³ ç¼–å†™å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
4. â³ éƒ¨ç½²åˆ°K8sé›†ç¾¤
5. â³ æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–
6. â³ ç¼–å†™è¿ç»´æ–‡æ¡£

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0  
**æœ€åæ›´æ–°**: 2026-01-25  
**ä½œè€…**: System Architecture Team
