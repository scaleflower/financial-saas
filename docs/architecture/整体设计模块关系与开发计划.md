# 财务报销SaaS系统 - 整体设计模块关系与开发计划

## 📋 项目概览

**项目名称**: Financial Reimbursement SaaS System  
**技术栈**: Spring Boot 3.2 + Spring Cloud 2023.0 + PostgreSQL 15 + Kubernetes  
**架构模式**: 微服务 + 多租户 + 云原生  
**开发环境**: macOS + Docker + 本地PostgreSQL

---

## 🏗️ 整体设计模块关系图

```
财务报销SaaS系统
├── 🌐 API Gateway Layer (Spring Cloud Gateway)
│   ├── 租户识别 (子域名/Token)
│   ├── 认证授权 (JWT + Spring Security)
│   ├── 限流熔断 (Sentinel)
│   └── 请求路由
│
├── 🏢 Core Business Layer (P0优先级)
│   ├── 🔹 Tenant Service (8761) - 租户管理
│   │   ├── 租户注册/管理
│   │   ├── 租户配置/状态
│   │   └── 多租户隔离基础
│   │
│   ├── 👥 User Service (8762) - 用户管理
│   │   ├── 用户注册/登录
│   │   ├── 权限管理 (RBAC)
│   │   ├── 钉钉集成
│   │   └── JWT认证
│   │
│   ├── 🏢 Org Service (8763) - 组织管理
│   │   ├── 组织树管理
│   │   ├── 组织负责人
│   │   └── 层级关系
│   │
│   ├── 💰 Trans Service (8764) - 报销服务 ⭐核心业务
│   │   ├── 报销单管理
│   │   ├── 插件化支持
│   │   ├── 动态表单
│   │   ├── 审批集成
│   │   └── 附件管理
│   │
│   ├── 💵 Loan Service (8765) - 借款服务 ⭐核心业务
│   │   ├── 借款单管理
│   │   ├── 借款发放
│   │   ├── 还款跟踪
│   │   └── 审批集成
│   │
│   ├── 💸 Repayment Service (8766) - 还款服务 ⭐核心业务
│   │   ├── 还款单管理
│   │   ├── 还款冲销
│   │   ├── 借款关联
│   │   └── 审批集成
│   │
│   └── 🔄 Approval Service (8767) - 审批服务 ⭐核心基础
│       ├── Camunda 8集成
│       ├── 流程定义管理
│       ├── 任务管理
│       ├── 流程监控
│       └── 审批历史
│
├── 🔧 Supporting Services Layer (P1优先级)
│   ├── 📢 Notification Service (8768) - 通知服务
│   │   ├── 站内消息
│   │   ├── 邮件通知
│   │   ├── 钉钉消息
│   │   └── WebSocket推送
│   │
│   ├── 📊 Report Service (8769) - 报表服务
│   │   ├── 数据统计
│   │   ├── 报表导出
│   │   └── Elasticsearch集成
│   │
│   └── 📁 File Service (8770) - 文件服务
│       ├── MinIO集成
│       ├── 文件上传/下载
│       ├── 文件预览
│       └── 存储管理
│
└── 🛠️ Infrastructure Layer
    ├── 📊 PostgreSQL (主数据库)
    ├── 🔥 Redis (缓存/Session)
    ├── 🐰 RabbitMQ (消息队列)
    ├── 📦 MinIO (对象存储)
    ├── 🏷️ Nacos (注册中心/配置中心)
    ├── ⚙️ Camunda (工作流引擎)
    ├── 📈 Prometheus (监控指标)
    └── 📊 Grafana (监控可视化)
```

---

## 🎯 核心模块依赖关系

```
依赖关系图：
┌─────────────────────────────────────────────────────────────────┐
│                    依赖关系说明                                │
│ → : 强依赖 (必须调用)                                         │
│ ⫽ : 弱依赖 (可选调用)                                         │
│ ↔ : 双向依赖                                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                       核心业务依赖                              │
│                                                                 │
│ Trans Service ⭐                                                 │
│   → User Service (查询用户信息)                                   │
│   → Org Service (查询组织信息)                                    │
│   → Project Service (查询项目信息)                               │
│   → Approval Service (启动审批流程)                               │
│   → File Service (附件管理)                                       │
│   → Notification Service (发送通知) ⫽                             │
│                                                                 │
│ Loan Service                                                     │
│   → User Service (查询用户信息)                                   │
│   → Org Service (查询组织信息)                                    │
│   → Project Service (查询项目信息)                               │
│   → Approval Service (启动审批流程)                               │
│   → File Service (附件管理)                                       │
│   → Notification Service (发送通知) ⫽                             │
│                                                                 │
│ Repayment Service                                                │
│   → User Service (查询用户信息)                                   │
│   → Org Service (查询组织信息)                                    │
│   → Project Service (查询项目信息)                               │
│   → Loan Service (查询借款信息)                                   │
│   → Approval Service (启动审批流程)                               │
│   → File Service (附件管理)                                       │
│   → Notification Service (发送通知) ⫽                             │
│                                                                 │
│ Approval Service ⭐                                               │
│   → User Service (查询审批人信息)                                 │
│   → Org Service (查询组织架构)                                    │
│   → Notification Service (发送审批通知) ⫽                         │
│                                                                 │
│ User Service ↔ Tenant Service (租户用户管理)                     │
│ Org Service ↔ Tenant Service (租户组织管理)                      │
│                                                                 │
│ Report Service (分析层)                                          │
│   → Trans Service ⫽                                               │
│   → Loan Service ⫽                                                │
│   → Repayment Service ⫽                                          │
│   → User Service ⫽                                               │
│   → Org Service ⫽                                                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

多租户架构依赖：
```
服务层 → 租户拦截器 → 租户上下文 → 数据库tenant_id隔离
   ↓
API Gateway → 租户识别 → 租户头部传递 → 服务间调用
   ↓
前端应用 → 子域名/Token → 租户切换 → 多租户体验
```

---

## 📋 详细开发 TODO List

### Phase 1: 基础框架搭建 (P0 Framework)

#### 1.1 项目结构搭建
- [ ] **TODO-FRAMEWORK-001**: 创建父POM项目结构
  - [ ] financial-reimbursement-saas/ (根目录)
  - [ ] common/ (公共模块)
  - [ ] services/ (微服务)
  - [ ] gateway/ (API网关)
  - [ ] infrastructure/ (基础设施配置)
  - [ ] deployment/ (部署配置)
  
- [ ] **TODO-FRAMEWORK-002**: 创建公共模块 (common模块)
  - [ ] common-core (核心工具类、异常处理、统一返回)
  - [ ] common-web (Web通用配置、拦截器、过滤器)
  - [ ] common-security (JWT工具、安全配置)
  - [ ] common-tenant (多租户支持、拦截器、上下文)
  - [ ] common-plugin (插件化支持、动态加载)
  - [ ] common-workflow (工作流通用配置)
  - [ ] common-mq (消息队列配置)
  - [ ] common-feign (Feign客户端配置)

#### 1.2 数据库设计搭建
- [ ] **TODO-DATABASE-001**: 设计并创建PostgreSQL数据库
  - [ ] 创建financial_saas数据库
  - [ ] 执行所有表结构SQL
  - [ ] 创建索引和约束
  - [ ] 初始化基础数据

- [ ] **TODO-DATABASE-002**: 创建数据库迁移脚本
  - [ ] Flyway集成
  - [ ] V1.0.0__initial_schema.sql
  - [ ] V1.0.1__initial_data.sql

#### 1.3 基础设施配置
- [ ] **TODO-INFRA-001**: 本地开发环境配置
  - [ ] PostgreSQL数据库配置 (使用本机已安装的PG)
  - [ ] Redis配置
  - [ ] RabbitMQ配置 (Docker)
  - [ ] MinIO配置 (Docker)
  - [ ] Nacos配置 (Docker)

- [ ] **TODO-INFRA-002**: 监控配置
  - [ ] Prometheus集成 (使用本机已安装的)
  - [ ] Grafana仪表盘 (使用本机已安装的)
  - [ ] Spring Boot Actuator配置
  - [ ] 自定义监控指标

---

### Phase 2: P0核心服务开发 (按依赖顺序)

#### 2.1 Tenant Service (租户管理服务) - 8761

- [ ] **TODO-TENANT-001**: 项目搭建
  - [ ] 创建tenant-service模块
  - [ ] 配置application.yml
  - [ ] 集成MyBatis Plus
  - [ ] 配置多租户拦截器

- [ ] **TODO-TENANT-002**: 数据层实现
  - [ ] 创建Tenant实体类
  - [ ] 创建TenantMapper
  - [ ] 实现tenant表CRUD

- [ ] **TODO-TENANT-003**: 业务层实现
  - [ ] TenantService实现
  - [ ] 租户注册逻辑
  - [ ] 租户初始化数据
  - [ ] 租户状态管理

- [ ] **TODO-TENANT-004**: 控制器层实现
  - [ ] TenantController
  - [ ] 租户注册API
  - [ ] 租户查询API
  - [ ] 租户状态管理API

- [ ] **TODO-TENANT-005**: 集成测试
  - [ ] 单元测试
  - [ ] 集成测试
  - [ ] 接口测试

#### 2.2 User Service (用户管理服务) - 8762

- [ ] **TODO-USER-001**: 项目搭建
  - [ ] 创建user-service模块
  - [ ] 配置Spring Security
  - [ ] JWT认证配置
  - [ ] Redis缓存配置

- [ ] **TODO-USER-002**: 数据层实现
  - [ ] 创建User、Role、UserRole实体类
  - [ ] 创建对应的Mapper
  - [ ] 实现RBAC表CRUD

- [ ] **TODO-USER-003**: 认证实现
  - [ ] UserDetails实现
  - [ ] JwtTokenProvider
  - [ ] 登录/登出逻辑
  - [ ] 密码加密/验证

- [ ] **TODO-USER-004**: 业务层实现
  - [ ] UserService实现
  - [ ] 用户注册逻辑
  - [ ] 权限查询逻辑
  - [ ] 钉钉集成逻辑

- [ ] **TODO-USER-005**: 控制器层实现
  - [ ] AuthenticationController
  - [ ] UserController
  - [ ] 登录API
  - [ ] 用户管理API

- [ ] **TODO-USER-006**: 集成测试
  - [ ] 单元测试
  - [ ] 认证测试
  - [ ] 权限测试

#### 2.3 Org Service (组织管理服务) - 8763

- [ ] **TODO-ORG-001**: 项目搭建
  - [ ] 创建org-service模块
  - [ ] MyBatis Plus配置
  - [ ] 多租户配置

- [ ] **TODO-ORG-002**: 数据层实现
  - [ ] 创建Org实体类
  - [ ] 创建OrgMapper
  - [ ] 树形结构查询实现

- [ ] **TODO-ORG-003**: 业务层实现
  - [ ] OrgService实现
  - [ ] 组织树构建逻辑
  - [ ] 层级关系验证
  - [ ] 负责人管理

- [ ] **TODO-ORG-004**: 控制器层实现
  - [ ] OrgController
  - [ ] 组织管理API
  - [ ] 组织树API
  - [ ] 负责人设置API

- [ ] **TODO-ORG-005**: 集成测试
  - [ ] 单元测试
  - [ ] 树形结构测试

#### 2.4 Approval Service (审批服务) - 8767 ⭐必须先实现

- [ ] **TODO-APPROVAL-001**: 项目搭建
  - [ ] 创建approval-service模块
  - [ ] Camunda 8集成
  - [ ] Camunda配置

- [ ] **TODO-APPROVAL-002**: 流程定义
  - [ ] 报销审批流程BPMN设计
  - [ ] 借款审批流程BPMN设计
  - [ ] 还款审批流程BPMN设计
  - [ ] 部署流程定义

- [ ] **TODO-APPROVAL-003**: 业务层实现
  - [ ] ApprovalService实现
  - [ ] 流程启动逻辑
  - [ ] 任务查询逻辑
  - [ ] 任务处理逻辑
  - [ ] 流程历史查询

- [ ] **TODO-APPROVAL-004**: 任务监听器
  - [ ] ProjectManagerTaskListener
  - [ ] DeptManagerTaskListener
  - [ ] GeneralManagerTaskListener
  - [ ] FinanceReviewTaskListener

- [ ] **TODO-APPROVAL-005**: 控制器层实现
  - [ ] ApprovalController
  - [ ] 流程启动API
  - [ ] 任务查询API
  - [ ] 任务处理API

- [ ] **TODO-APPROVAL-006**: 集成测试
  - [ ] 流程测试
  - [ ] 任务测试
  - [ ] 监听器测试

#### 2.5 Trans Service (报销服务) - 8764 ⭐核心业务

- [ ] **TODO-TRANS-001**: 项目搭建
  - [ ] 创建trans-service模块
  - [ ] 插件化框架集成
  - [ ] Feign客户端配置

- [ ] **TODO-TRANS-002**: 数据层实现
  - [ ] 创建Trans、TransItem、ChargeItem、TransAttach实体类
  - [ ] 创建对应Mapper
  - [ ] 关联查询实现

- [ ] **TODO-TRANS-003**: 插件化实现
  - [ ] TransTypePluginManager
  - [ ] 插件加载逻辑
  - [ ] 动态表单配置
  - [ ] 6种报销类型插件

- [ ] **TODO-TRANS-004**: 业务层实现
  - [ ] TransService实现
  - [ ] 报销单创建逻辑
  - [ ] 报销单提交流程
  - [ ] 报销单结算逻辑
  - [ ] 审批流程集成

- [ ] **TODO-TRANS-005**: 控制器层实现
  - [ ] TransController
  - [ ] 报销单CRUD API
  - [ ] 报销单提交API
  - [ ] 插件配置API

- [ ] **TODO-TRANS-006**: 集成测试
  - [ ] 单元测试
  - [ ] 插件化测试
  - [ ] 审批集成测试

#### 2.6 Loan Service (借款服务) - 8765

- [ ] **TODO-LOAN-001**: 项目搭建
  - [ ] 创建loan-service模块
  - [ ] Feign客户端配置
  - [ ] 审批集成准备

- [ ] **TODO-LOAN-002**: 数据层实现
  - [ ] 创建Loan、LoanAttach实体类
  - [ ] 创建对应Mapper
  - [ ] 借款统计查询

- [ ] **TODO-LOAN-003**: 业务层实现
  - [ ] LoanService实现
  - [ ] 借款单创建逻辑
  - [ ] 借款发放逻辑
  - [ ] 还款跟踪逻辑
  - [ ] 审批流程集成

- [ ] **TODO-LOAN-004**: 控制器层实现
  - [ ] LoanController
  - [ ] 借款单CRUD API
  - [ ] 借款发放API
  - [ ] 还款跟踪API

- [ ] **TODO-LOAN-005**: 集成测试
  - [ ] 单元测试
  - [ ] 审批集成测试

#### 2.7 Repayment Service (还款服务) - 8766

- [ ] **TODO-REPAYMENT-001**: 项目搭建
  - [ ] 创建repayment-service模块
  - [ ] Feign客户端配置

- [ ] **TODO-REPAYMENT-002**: 数据层实现
  - [ ] 创建Repayment、RepaymentSett、RepaymentAttach实体类
  - [ ] 创建对应Mapper
  - [ ] 冲销关系查询

- [ ] **TODO-REPAYMENT-003**: 业务层实现
  - [ ] RepaymentService实现
  - [ ] 还款单创建逻辑
  - [ ] 还款冲销逻辑
  - [ ] 审批流程集成

- [ ] **TODO-REPAYMENT-004**: 控制器层实现
  - [ ] RepaymentController
  - [ ] 还款单CRUD API
  - [ ] 还款冲销API

- [ ] **TODO-REPAYMENT-005**: 集成测试
  - [ ] 单元测试
  - [ ] 冲销逻辑测试

---

### Phase 3: API Gateway (网关层)

#### 3.1 Gateway Service - 8080

- [ ] **TODO-GATEWAY-001**: 项目搭建
  - [ ] 创建gateway模块
  - [ ] Spring Cloud Gateway配置
  - [ ] Nacos集成

- [ ] **TODO-GATEWAY-002**: 租户识别
  - [ ] 子域名识别过滤器
  - [ ] Token租户提取
  - [ ] 租户头部传递

- [ ] **TODO-GATEWAY-003**: 路由配置
  - [ ] 微服务路由规则
  - [ ] 负载均衡
  - [ ] 限流配置

- [ ] **TODO-GATEWAY-004**: 安全配置
  - [ ] JWT验证过滤器
  - [ ] 权限验证
  - [ ] 跨域处理

- [ ] **TODO-GATEWAY-005**: 集成测试
  - [ ] 路由测试
  - [ ] 租户识别测试
  - [ ] 安全测试

---

### Phase 4: P1辅助服务 (后续实现)

#### 4.1 Notification Service - 8768
- [ ] **TODO-NOTIFICATION-001**: RabbitMQ消息处理
- [ ] **TODO-NOTIFICATION-002**: 邮件发送集成
- [ ] **TODO-NOTIFICATION-003**: 钉钉消息集成
- [ ] **TODO-NOTIFICATION-004**: WebSocket推送

#### 4.2 Report Service - 8769
- [ ] **TODO-REPORT-001**: Elasticsearch集成
- [ ] **TODO-REPORT-002**: 报表统计逻辑
- [ ] **TODO-REPORT-003**: 数据导出功能

#### 4.3 File Service - 8770
- [ ] **TODO-FILE-001**: MinIO集成
- [ ] **TODO-FILE-002**: 文件上传下载
- [ ] **TODO-FILE-003**: 文件预览功能

---

### Phase 5: 集成测试与部署

#### 5.1 集成测试
- [ ] **TODO-TEST-001**: 端到端测试
- [ ] **TODO-TEST-002**: 多租户隔离测试
- [ ] **TODO-TEST-003**: 性能测试

#### 5.2 部署配置
- [ ] **TODO-DEPLOY-001**: Docker镜像构建
- [ ] **TODO-DEPLOY-002**: Kubernetes配置
- [ ] **TODO-DEPLOY-003**: 监控配置
- [ ] **TODO-DEPLOY-004**: CI/CD流水线

---

## 🚀 开发优先级与时间规划

### Week 1-2: Phase 1 - 基础框架
```
Day 1-2: 项目结构搭建 + 父POM配置
Day 3-4: 公共模块开发
Day 5-6: 数据库设计与迁移脚本
Day 7: 基础设施搭建 + 监控配置
```

### Week 3-4: Phase 2.1 - Tenant Service
```
Day 8-10: Tenant Service开发
Day 11-12: 集成测试
Day 13-14: 优化与完善
```

### Week 5: Phase 2.2 - User Service
```
Day 15-18: User Service开发
Day 19-20: 认证集成测试
Day 21: 权限测试
```

### Week 6: Phase 2.3 - Org Service
```
Day 22-24: Org Service开发
Day 25-26: 树形结构测试
Day 27: 与User Service集成测试
```

### Week 7-8: Phase 2.4 - Approval Service ⭐关键
```
Day 28-30: Camunda集成 + 流程设计
Day 31-33: Approval Service开发
Day 34-35: 流程测试
Day 36-38: 与其他服务集成测试
```

### Week 9-10: Phase 2.5 - Trans Service ⭐核心
```
Day 39-42: Trans Service开发
Day 43-45: 插件化实现
Day 46-47: 审批集成
Day 48-50: 完整流程测试
```

### Week 11: Phase 2.6 - Loan Service
```
Day 51-53: Loan Service开发
Day 54-55: 与Approval Service集成
Day 56: 集成测试
```

### Week 12: Phase 2.7 - Repayment Service
```
Day 57-59: Repayment Service开发
Day 60-61: 冲销逻辑实现
Day 62: 完整借款-还款流程测试
```

### Week 13: Phase 3 - API Gateway
```
Day 63-65: Gateway Service开发
Day 66-67: 租户识别与路由
Day 68-70: 完整系统集成测试
```

---

## 📋 开发完成标准

### 每个服务完成标准
- [ ] ✅ 代码编译通过
- [ ] ✅ 单元测试覆盖率 > 80%
- [ ] ✅ 集成测试通过
- [ ] ✅ API接口文档完整
- [ ] ✅ 监控指标配置完成
- [ ] ✅ Docker镜像构建成功

### 系统整体完成标准
- [ ] ✅ 所有P0服务正常运行
- [ ] ✅ 多租户隔离功能正常
- [ ] ✅ 完整的报销-审批流程跑通
- [ ] ✅ 完整的借款-审批-还款流程跑通
- [ ] ✅ API Gateway路由正常
- [ ] ✅ 监控系统正常运行

---

## 🎯 验收测试清单

### 功能验收
- [ ] **基础功能**
  - [ ] 租户注册成功
  - [ ] 用户注册/登录成功
  - [ ] 组织树管理正常
  - [ ] 权限控制生效

- [ ] **核心业务功能**
  - [ ] 报销单创建 → 审批 → 结算 全流程
  - [ ] 借款单创建 → 审批 → 发放 全流程
  - [ ] 还款单创建 → 审批 → 冲销 全流程
  - [ ] 6种报销类型插件正常工作

### 技术验收
- [ ] **多租户**
  - [ ] 租户间数据完全隔离
  - [ ] 子域名访问正常
  - [ ] 租户配置生效

- [ ] **性能**
  - [ ] 接口响应时间 < 200ms
  - [ ] 并发支持 > 1000 QPS
  - [ ] 数据库查询优化

- [ ] **监控**
  - [ ] Prometheus指标正常
  - [ ] Grafana仪表盘完整
  - [ ] 告警规则生效

---

**创建时间**: 2026-01-25  
**作者**: Sisyphus Development Team  
**计划完成时间**: 2026-02-25 (13周)
