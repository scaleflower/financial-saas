# è´¢åŠ¡æŠ¥é”€ç³»ç»Ÿ - åŠŸèƒ½æ¨¡å—ä¸æ•°æ®åº“è®¾è®¡

## ğŸ“‹ è®¾è®¡æ¦‚è§ˆ

### è®¾è®¡åŸåˆ™

1. **å¤šç§Ÿæˆ·ä¼˜å…ˆ**ï¼šæ‰€æœ‰ä¸šåŠ¡è¡¨åŒ…å« tenant_id
2. **å¤–é”®åŒ…å«ç§Ÿæˆ·**ï¼šæ‰€æœ‰å¤–é”®çº¦æŸå¿…é¡»åŒ…å« tenant_id
3. **å¤åˆç´¢å¼•ä¼˜åŒ–**ï¼šç´¢å¼•ä»¥ tenant_id ä¸ºç¬¬ä¸€åˆ—
4. **è½¯åˆ é™¤æ”¯æŒ**ï¼šå…³é”®ä¸šåŠ¡è¡¨æ”¯æŒ deleted æ ‡è®°
5. **å®¡è®¡è¿½è¸ª**ï¼šåˆ›å»ºäººã€åˆ›å»ºæ—¶é—´ã€æ›´æ–°äººã€æ›´æ–°æ—¶é—´
6. **çŠ¶æ€ç®¡ç†**ï¼šæ‰€æœ‰ä¸šåŠ¡å®ä½“åŒ…å« state çŠ¶æ€å­—æ®µ

### æ•°æ®åº“ç±»å‹æ˜ å°„

| Java ç±»å‹ | PostgreSQL ç±»å‹ | è¯´æ˜ |
|----------|---------------|------|
| Long | BIGINT | ä¸»é”®ã€å¤–é”® |
| String | VARCHAR(n) | å˜é•¿å­—ç¬¦ä¸²ï¼ŒæŒ‡å®šé•¿åº¦ |
| String (text) | TEXT | é•¿æ–‡æœ¬ |
| BigDecimal | NUMERIC(12,2) | é‡‘é¢ï¼ˆç²¾åº¦12ï¼Œå°æ•°2ä½ï¼‰ |
| BigDecimal (rate) | NUMERIC(12,6) | æ±‡ç‡ï¼ˆç²¾åº¦12ï¼Œå°æ•°6ä½ï¼‰ |
| Integer | INTEGER | æ•´æ•° |
| LocalDate | DATE | æ—¥æœŸ |
| LocalDateTime | TIMESTAMP | æ—¥æœŸæ—¶é—´ |
| Boolean | SMALLINT | å¸ƒå°”å€¼ï¼ˆ0/1ï¼‰ |

---

## æ¨¡å—1ï¼šç§Ÿæˆ·ç®¡ç†

### åŠŸèƒ½è§„æ ¼

**æ¨¡å—åç§°**: tenant

**åŠŸèƒ½æè¿°**: å¤šç§Ÿæˆ·ç®¡ç†ï¼Œæ”¯æŒå¤šä¸ªå…¬å¸/ç»„ç»‡ç‹¬ç«‹ä½¿ç”¨ç³»ç»Ÿ

**æ ¸å¿ƒåŠŸèƒ½**:
- ç§Ÿæˆ·æ³¨å†Œ
- ç§Ÿæˆ·ä¿¡æ¯ç®¡ç†
- ç§Ÿæˆ·çŠ¶æ€ç®¡ç†ï¼ˆæ­£å¸¸/åœç”¨/è¿‡æœŸï¼‰
- ç§Ÿæˆ·é…ç½®ç®¡ç†ï¼ˆJSONæ ¼å¼å­˜å‚¨ä¸ªæ€§åŒ–é…ç½®ï¼‰

**ä¸šåŠ¡è§„åˆ™**:
- ç§Ÿæˆ·ä»£ç å…¨å±€å”¯ä¸€
- ç§Ÿæˆ·åç§°åœ¨åŒä¸€å±‚çº§ä¸é‡å¤
- ç§Ÿæˆ·åœç”¨åï¼Œè¯¥ç§Ÿæˆ·ä¸‹æ‰€æœ‰æ•°æ®ä¸å¯è®¿é—®

### æ•°æ®åº“è¡¨è®¾è®¡

#### 1.1 tenant (ç§Ÿæˆ·è¡¨)

```sql
COMMENT ON TABLE tenant IS 'ç§Ÿæˆ·è¡¨ï¼šå¤šç§Ÿæˆ·ç®¡ç†';

-- ç§Ÿæˆ·çŠ¶æ€æšä¸¾
CREATE TYPE tenant_status AS ENUM (
    'ACTIVE',          -- æ­£å¸¸
    'SUSPENDED',       -- åœç”¨
    'EXPIRED',         -- å·²è¿‡æœŸ
    'PENDING'          -- å¾…å®¡æ ¸
);

CREATE TABLE tenant (
    -- ä¸»é”®
    tenant_id BIGSERIAL PRIMARY KEY,
    
    -- åŸºæœ¬ä¿¡æ¯
    tenant_code VARCHAR(50) NOT NULL,              -- ç§Ÿæˆ·ä»£ç ï¼ˆå…¨å±€å”¯ä¸€ï¼‰
    tenant_name VARCHAR(200) NOT NULL,            -- ç§Ÿæˆ·åç§°
    tenant_type VARCHAR(50) NOT NULL,             -- ç§Ÿæˆ·ç±»å‹ï¼ˆCOMPANY/DEPARTMENTï¼‰
    contact_name VARCHAR(60),                    -- è”ç³»äººå§“å
    contact_phone VARCHAR(20),                   -- è”ç³»ç”µè¯
    contact_email VARCHAR(100),                  -- è”ç³»é‚®ç®±
    
    -- ç§Ÿæˆ·é…ç½®
    status tenant_status NOT NULL DEFAULT 'PENDING',
    config JSONB,                                -- ç§Ÿæˆ·é…ç½®ï¼ˆJSONæ ¼å¼ï¼‰
    
    -- è®¡è´¹ä¿¡æ¯
    max_users INTEGER DEFAULT 10,                 -- æœ€å¤§ç”¨æˆ·æ•°
    max_storage_mb INTEGER DEFAULT 1024,           -- æœ€å¤§å­˜å‚¨ç©ºé—´(MB)
    expire_date DATE,                            -- è¿‡æœŸæ—¥æœŸ
    
    -- å®¡è®¡å­—æ®µ
    created_by BIGINT,                           -- åˆ›å»ºäºº
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by BIGINT,                           -- æ›´æ–°äºº
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP,                         -- åˆ é™¤æ—¶é—´ï¼ˆè½¯åˆ é™¤ï¼‰
    
    -- å”¯ä¸€çº¦æŸ
    CONSTRAINT uk_tenant_code UNIQUE (tenant_code)
);

-- ç´¢å¼•
CREATE INDEX idx_tenant_status ON tenant(status);
CREATE INDEX idx_tenant_type ON tenant(tenant_type);
CREATE INDEX idx_tenant_expire_date ON tenant(expire_date);

-- è¯„è®º
COMMENT ON COLUMN tenant.tenant_id IS 'ç§Ÿæˆ·IDï¼ˆä¸»é”®ï¼‰';
COMMENT ON COLUMN tenant.tenant_code IS 'ç§Ÿæˆ·ä»£ç ï¼ˆå…¨å±€å”¯ä¸€ï¼‰';
COMMENT ON COLUMN tenant.tenant_name IS 'ç§Ÿæˆ·åç§°';
COMMENT ON COLUMN tenant.config IS 'ç§Ÿæˆ·é…ç½®ï¼ˆJSONæ ¼å¼ï¼Œå­˜å‚¨ä¸ªæ€§åŒ–é…ç½®ï¼‰';
COMMENT ON COLUMN tenant.max_users IS 'æœ€å¤§ç”¨æˆ·æ•°';
COMMENT ON COLUMN tenant.max_storage_mb IS 'æœ€å¤§å­˜å‚¨ç©ºé—´(MBï¼‰';
```

### è¡¨å…³ç³»

```
tenant (1) â”€â”€â”€â”€ (N) user
tenant (1) â”€â”€â”€â”€ (N) org
tenant (1) â”€â”€â”€â”€ (N) role
tenant (1) â”€â”€â”€â”€ (N) trans
tenant (1) â”€â”€â”€â”€ (N) loan
tenant (1) â”€â”€â”€â”€ (N) repayment
```

---

## æ¨¡å—2ï¼šç”¨æˆ·ç®¡ç†

### åŠŸèƒ½è§„æ ¼

**æ¨¡å—åç§°**: user

**åŠŸèƒ½æè¿°**: ç”¨æˆ·ç®¡ç†ï¼ŒåŒ…æ‹¬ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€æƒé™ç®¡ç†ç­‰

**æ ¸å¿ƒåŠŸèƒ½**:
- ç”¨æˆ·æ³¨å†Œï¼ˆç®¡ç†å‘˜åˆ›å»ºç”¨æˆ·ï¼‰
- ç”¨æˆ·ç™»å½•ï¼ˆç”¨æˆ·åå¯†ç ã€é’‰é’‰æ‰«ç ï¼‰
- ç”¨æˆ·ä¿¡æ¯ç®¡ç†
- ç”¨æˆ·çŠ¶æ€ç®¡ç†ï¼ˆæ­£å¸¸/é”å®š/åœç”¨ï¼‰
- å¯†ç é‡ç½®
- ç”¨æˆ·ç»„ç»‡å…³è”
- ç”¨æˆ·è§’è‰²å…³è”

**ä¸šåŠ¡è§„åˆ™**:
- ç”¨æˆ·ååœ¨åŒä¸€ç§Ÿæˆ·å†…å”¯ä¸€
- ç”¨æˆ·é‚®ç®±åœ¨åŒä¸€ç§Ÿæˆ·å†…å”¯ä¸€
- ç”¨æˆ·æ‰‹æœºå·åœ¨åŒä¸€ç§Ÿæˆ·å†…å”¯ä¸€
- ç”¨æˆ·å¿…é¡»å…³è”åˆ°ä¸€ä¸ªç»„ç»‡
- ç”¨æˆ·å¿…é¡»è‡³å°‘æœ‰ä¸€ä¸ªè§’è‰²

### æ•°æ®åº“è¡¨è®¾è®¡

#### 2.1 user (ç”¨æˆ·è¡¨)

```sql
COMMENT ON TABLE "user" IS 'ç”¨æˆ·è¡¨';

-- ç”¨æˆ·çŠ¶æ€æšä¸¾
CREATE TYPE user_status AS ENUM (
    'ACTIVE',          -- æ­£å¸¸
    'LOCKED',          -- é”å®š
    'DISABLED',       -- åœç”¨
    'PENDING'          -- å¾…æ¿€æ´»
);

CREATE TABLE "user" (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    user_id BIGSERIAL NOT NULL,
    
    -- åŸºæœ¬ä¿¡æ¯
    username VARCHAR(100) NOT NULL,             -- ç”¨æˆ·å
    password VARCHAR(100),                       -- å¯†ç ï¼ˆBCryptåŠ å¯†ï¼‰
    realname VARCHAR(60) NOT NULL,               -- çœŸå®å§“å
    nickname VARCHAR(60),                        -- æ˜µç§°
    avatar VARCHAR(255),                         -- å¤´åƒURL
    email VARCHAR(100),                          -- é‚®ç®±
    phone VARCHAR(20),                           -- æ‰‹æœºå·
    job_number VARCHAR(30),                      -- å·¥å·
    
    -- èº«ä»½è®¤è¯
    dingtalk_id VARCHAR(100),                     -- é’‰é’‰ç”¨æˆ·ID
    dingtalk_unionid VARCHAR(100),                -- é’‰é’‰unionid
    auth_type VARCHAR(20) DEFAULT 'PASSWORD',      -- è®¤è¯ç±»å‹ï¼ˆPASSWORD/DINGTALK/SMSï¼‰
    
    -- ç»„ç»‡å…³è”
    org_id BIGINT NOT NULL,                       -- æ‰€å±ç»„ç»‡ID
    
    -- ç”¨æˆ·çŠ¶æ€
    status user_status NOT NULL DEFAULT 'PENDING',
    deleted SMALLINT NOT NULL DEFAULT 0,           -- æ˜¯å¦åˆ é™¤ï¼ˆè½¯åˆ é™¤ï¼‰
    
    -- å¯†ç ç®¡ç†
    password_change_date DATE,                     -- å¯†ç ä¿®æ”¹æ—¥æœŸ
    login_fail_count INTEGER DEFAULT 0,             -- ç™»å½•å¤±è´¥æ¬¡æ•°
    locked_until TIMESTAMP,                        -- é”å®šæˆªæ­¢æ—¶é—´
    
    -- æœ€åç™»å½•ä¿¡æ¯
    last_login_ip VARCHAR(50),                    -- æœ€åç™»å½•IP
    last_login_time TIMESTAMP,                     -- æœ€åç™»å½•æ—¶é—´
    last_login_device VARCHAR(100),                -- æœ€åç™»å½•è®¾å¤‡
    
    -- å®¡è®¡å­—æ®µ
    created_by BIGINT,                            -- åˆ›å»ºäºº
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by BIGINT,                            -- æ›´æ–°äºº
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    remarks TEXT,                                  -- å¤‡æ³¨
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, user_id),
    
    -- å”¯ä¸€çº¦æŸ
    CONSTRAINT uk_user_tenant_username UNIQUE (tenant_id, username),
    CONSTRAINT uk_user_tenant_email UNIQUE (tenant_id, email),
    CONSTRAINT uk_user_tenant_phone UNIQUE (tenant_id, phone),
    CONSTRAINT uk_user_tenant_jobnumber UNIQUE (tenant_id, job_number),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_user_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    CONSTRAINT fk_user_org FOREIGN KEY (tenant_id, org_id) REFERENCES org(tenant_id, org_id)
);

-- ç´¢å¼•
CREATE INDEX idx_user_username ON "user"(username);
CREATE INDEX idx_user_email ON "user"(email);
CREATE INDEX idx_user_phone ON "user"(phone);
CREATE INDEX idx_user_dingtalk_id ON "user"(dingtalk_id);
CREATE INDEX idx_user_org ON "user"(tenant_id, org_id);
CREATE INDEX idx_user_status ON "user"(tenant_id, status);
CREATE INDEX idx_user_deleted ON "user"(deleted);

-- è¯„è®º
COMMENT ON COLUMN "user".tenant_id IS 'ç§Ÿæˆ·ID';
COMMENT ON COLUMN "user".user_id IS 'ç”¨æˆ·ID';
COMMENT ON COLUMN "user".username IS 'ç”¨æˆ·åï¼ˆç§Ÿæˆ·å†…å”¯ä¸€ï¼‰';
COMMENT ON COLUMN "user".password IS 'å¯†ç ï¼ˆBCryptåŠ å¯†ï¼‰';
COMMENT ON COLUMN "user".realname IS 'çœŸå®å§“å';
COMMENT ON COLUMN "user".org_id IS 'æ‰€å±ç»„ç»‡ID';
COMMENT ON COLUMN "user".dingtalk_id IS 'é’‰é’‰ç”¨æˆ·ID';
COMMENT ON COLUMN "user".auth_type IS 'è®¤è¯ç±»å‹';
COMMENT ON COLUMN "user".status IS 'ç”¨æˆ·çŠ¶æ€';
COMMENT ON COLUMN "user".deleted IS 'æ˜¯å¦åˆ é™¤ï¼ˆè½¯åˆ é™¤ï¼‰';
```

#### 2.2 user_role (ç”¨æˆ·è§’è‰²å…³è”è¡¨)

```sql
COMMENT ON TABLE user_role IS 'ç”¨æˆ·è§’è‰²å…³è”è¡¨';

CREATE TABLE user_role (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    user_role_id BIGSERIAL NOT NULL,
    
    -- å…³è”å…³ç³»
    user_id BIGINT NOT NULL,
    role_id BIGINT NOT NULL,
    
    -- å®¡è®¡å­—æ®µ
    created_by BIGINT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    expired_at TIMESTAMP,                            -- è¿‡æœŸæ—¶é—´ï¼ˆå¯é€‰ï¼Œç”¨äºä¸´æ—¶æƒé™ï¼‰
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, user_role_id),
    
    -- å”¯ä¸€çº¦æŸï¼ˆä¸€ä¸ªç”¨æˆ·åŒä¸€ç§Ÿæˆ·å†…ä¸èƒ½æœ‰é‡å¤çš„è§’è‰²ï¼‰
    CONSTRAINT uk_user_role UNIQUE (tenant_id, user_id, role_id, expired_at),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_user_role_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    CONSTRAINT fk_user_role_user FOREIGN KEY (tenant_id, user_id) REFERENCES "user"(tenant_id, user_id),
    CONSTRAINT fk_user_role_role FOREIGN KEY (tenant_id, role_id) REFERENCES role(tenant_id, role_id)
);

-- ç´¢å¼•
CREATE INDEX idx_user_role_user ON user_role(tenant_id, user_id);
CREATE INDEX idx_user_role_role ON user_role(tenant_id, role_id);

-- è¯„è®º
COMMENT ON COLUMN user_role.tenant_id IS 'ç§Ÿæˆ·ID';
COMMENT ON COLUMN user_role.user_id IS 'ç”¨æˆ·ID';
COMMENT ON COLUMN user_role.role_id IS 'è§’è‰²ID';
COMMENT ON COLUMN user_role.expired_at IS 'è¿‡æœŸæ—¶é—´';
```

### è¡¨å…³ç³»

```
org (1) â”€â”€â”€â”€ (N) user
user (N) â”€â”€â”€â”€ (M) role (é€šè¿‡user_roleè¡¨)
```

---

## æ¨¡å—3ï¼šç»„ç»‡ç®¡ç†

### åŠŸèƒ½è§„æ ¼

**æ¨¡å—åç§°**: org

**åŠŸèƒ½æè¿°**: ç»„ç»‡æ¶æ„ç®¡ç†ï¼Œæ”¯æŒæ ‘å½¢ç»“æ„

**æ ¸å¿ƒåŠŸèƒ½**:
- ç»„ç»‡æ ‘ç®¡ç†
- ç»„ç»‡ä¿¡æ¯ç®¡ç†
- ç»„ç»‡è´Ÿè´£äººè®¾ç½®
- ç»„ç»‡å±‚çº§ç®¡ç†

**ä¸šåŠ¡è§„åˆ™**:
- ç»„ç»‡ä»£ç åœ¨åŒä¸€ç§Ÿæˆ·å†…å”¯ä¸€
- ç»„ç»‡æ ‘ä¸èƒ½æœ‰å¾ªç¯å¼•ç”¨
- ç»„ç»‡è´Ÿè´£äººå¿…é¡»æ˜¯è¯¥ç»„ç»‡æˆ–å­ç»„ç»‡çš„ç”¨æˆ·
- åˆ é™¤ç»„ç»‡å‰éœ€æ£€æŸ¥æ˜¯å¦æœ‰ç”¨æˆ·æˆ–å­ç»„ç»‡

### æ•°æ®åº“è¡¨è®¾è®¡

#### 3.1 org (ç»„ç»‡è¡¨)

```sql
COMMENT ON TABLE org IS 'ç»„ç»‡è¡¨';

-- ç»„ç»‡çŠ¶æ€æšä¸¾
CREATE TYPE org_status AS ENUM (
    'ACTIVE',          -- æ­£å¸¸
    'DISABLED',       -- åœç”¨
    'DELETED'         -- å·²åˆ é™¤ï¼ˆè½¯åˆ é™¤ï¼‰
);

CREATE TABLE org (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    org_id BIGSERIAL NOT NULL,
    
    -- åŸºæœ¬ä¿¡æ¯
    org VARCHAR(50) NOT NULL,                   -- ç»„ç»‡ä»£ç ï¼ˆç§Ÿæˆ·å†…å”¯ä¸€ï¼‰
    org_name VARCHAR(200) NOT NULL,              -- ç»„ç»‡åç§°
    org_type VARCHAR(50) NOT NULL,               -- ç»„ç»‡ç±»å‹ï¼ˆCOMPANY/DEPARTMENT/TEAMï¼‰
    org_level INTEGER NOT NULL DEFAULT 1,        -- ç»„ç»‡å±‚çº§ï¼ˆ1=å…¬å¸ï¼Œ2=éƒ¨é—¨ï¼Œ3=å›¢é˜Ÿï¼‰
    
    -- ç»„ç»‡æ ‘ç»“æ„
    parent_org_id BIGINT,                         -- çˆ¶ç»„ç»‡ID
    parent_path VARCHAR(500),                      -- çˆ¶ç»„ç»‡è·¯å¾„ï¼ˆä¾¿äºæŸ¥è¯¢ï¼‰
    sort_order INTEGER DEFAULT 0,                 -- æ’åº
    
    -- ç»„ç»‡è´Ÿè´£äºº
    leader_id BIGINT,                              -- ç»„ç»‡è´Ÿè´£äººID
    leader_name VARCHAR(60),                       -- ç»„ç»‡è´Ÿè´£äººå§“å
    
    -- ç»„ç»‡çŠ¶æ€
    status org_status NOT NULL DEFAULT 'ACTIVE',
    
    -- è”ç³»ä¿¡æ¯
    contact_name VARCHAR(60),                       -- è”ç³»äººå§“å
    contact_phone VARCHAR(20),                      -- è”ç³»ç”µè¯
    contact_email VARCHAR(100),                     -- è”ç³»é‚®ç®±
    address VARCHAR(500),                          -- åœ°å€
    
    -- å®¡è®¡å­—æ®µ
    created_by BIGINT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by BIGINT,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP,
    remarks TEXT,
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, org_id),
    
    -- å”¯ä¸€çº¦æŸ
    CONSTRAINT uk_org_tenant_code UNIQUE (tenant_id, org),
    
    -- å¤–é”®çº¦æŸï¼ˆè‡ªå¼•ç”¨ï¼‰
    CONSTRAINT fk_org_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    CONSTRAINT fk_org_parent FOREIGN KEY (tenant_id, parent_org_id) REFERENCES org(tenant_id, org_id),
    CONSTRAINT fk_org_leader FOREIGN KEY (tenant_id, leader_id) REFERENCES "user"(tenant_id, user_id)
);

-- ç´¢å¼•
CREATE INDEX idx_org_parent ON org(tenant_id, parent_org_id);
CREATE INDEX idx_org_level ON org(tenant_id, org_level);
CREATE INDEX idx_org_status ON org(tenant_id, status);
CREATE INDEX idx_org_type ON org(tenant_id, org_type);

-- è¯„è®º
COMMENT ON COLUMN org.tenant_id IS 'ç§Ÿæˆ·ID';
COMMENT ON COLUMN org.org_id IS 'ç»„ç»‡ID';
COMMENT ON COLUMN org.org IS 'ç»„ç»‡ä»£ç ï¼ˆç§Ÿæˆ·å†…å”¯ä¸€ï¼‰';
COMMENT ON COLUMN org.org_name IS 'ç»„ç»‡åç§°';
COMMENT ON COLUMN org.org_type IS 'ç»„ç»‡ç±»å‹';
COMMENT ON COLUMN org.org_level IS 'ç»„ç»‡å±‚çº§';
COMMENT ON COLUMN org.parent_org_id IS 'çˆ¶ç»„ç»‡ID';
COMMENT ON COLUMN org.parent_path IS 'çˆ¶ç»„ç»‡è·¯å¾„';
COMMENT ON COLUMN org.leader_id IS 'ç»„ç»‡è´Ÿè´£äººID';
COMMENT ON COLUMN org.status IS 'ç»„ç»‡çŠ¶æ€';
```

### è¡¨å…³ç³»

```
org (1) â”€â”€â”€â”€ (N) user
org (1) â”€â”€â”€â”€ (N) org (çˆ¶å­å…³ç³»ï¼‰
```

---

## æ¨¡å—4ï¼šè§’è‰²æƒé™ç®¡ç†

### åŠŸèƒ½è§„æ ¼

**æ¨¡å—åç§°**: role_perm

**åŠŸèƒ½æè¿°**: RBACæƒé™ç®¡ç†ï¼Œè§’è‰²å’Œæƒé™çš„å…³è”

**æ ¸å¿ƒåŠŸèƒ½**:
- è§’è‰²ç®¡ç†
- æƒé™ç®¡ç†
- è§’è‰²æƒé™å…³è”
- æ•°æ®æƒé™ï¼ˆæ•°æ®èŒƒå›´æ§åˆ¶ï¼‰

**ä¸šåŠ¡è§„åˆ™**:
- è§’è‰²ä»£ç åœ¨åŒä¸€ç§Ÿæˆ·å†…å”¯ä¸€
- è§’è‰²å¯ä»¥å…³è”åˆ°ç»„ç»‡ï¼ˆç»„ç»‡çº§è§’è‰²ï¼‰
- æƒé™ä»£ç å…¨å±€å”¯ä¸€
- åˆ é™¤è§’è‰²å‰éœ€æ£€æŸ¥æ˜¯å¦æœ‰ç”¨æˆ·å…³è”

### æ•°æ®åº“è¡¨è®¾è®¡

#### 4.1 role (è§’è‰²è¡¨)

```sql
COMMENT ON TABLE role IS 'è§’è‰²è¡¨';

-- è§’è‰²çŠ¶æ€æšä¸¾
CREATE TYPE role_status AS ENUM (
    'ACTIVE',          -- æ­£å¸¸
    'DISABLED'        -- åœç”¨
);

CREATE TABLE role (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    role_id BIGSERIAL NOT NULL,
    
    -- åŸºæœ¬ä¿¡æ¯
    role VARCHAR(50) NOT NULL,                -- è§’è‰²ä»£ç ï¼ˆç§Ÿæˆ·å†…å”¯ä¸€ï¼‰
    role_name VARCHAR(100) NOT NULL,            -- è§’è‰²åç§°
    role_desc VARCHAR(500),                    -- è§’è‰²æè¿°
    role_type VARCHAR(50) NOT NULL,             -- è§’è‰²ç±»å‹ï¼ˆSYSTEM/BIZ/ORGï¼‰
    
    -- ç»„ç»‡å…³è”ï¼ˆç»„ç»‡çº§è§’è‰²ï¼‰
    org_id BIGINT,                              -- æ‰€å±ç»„ç»‡IDï¼ˆNULLè¡¨ç¤ºå…¨å±€è§’è‰²ï¼‰
    
    -- æ•°æ®æƒé™
    data_scope VARCHAR(50) DEFAULT 'ALL',       -- æ•°æ®èŒƒå›´ï¼ˆALL/DEPT/DEPT_AND_SUB/SELFï¼‰
    data_scope_dept_ids TEXT,                    -- æ•°æ®èŒƒå›´éƒ¨é—¨IDåˆ—è¡¨ï¼ˆJSONæ•°ç»„ï¼‰
    
    -- è§’è‰²çŠ¶æ€
    status role_status NOT NULL DEFAULT 'ACTIVE',
    sort_order INTEGER DEFAULT 0,                -- æ’åº
    
    -- å®¡è®¡å­—æ®µ
    created_by BIGINT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by BIGINT,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    remarks TEXT,
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, role_id),
    
    -- å”¯ä¸€çº¦æŸ
    CONSTRAINT uk_role_tenant_code UNIQUE (tenant_id, role),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_role_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    CONSTRAINT fk_role_org FOREIGN KEY (tenant_id, org_id) REFERENCES org(tenant_id, org_id)
);

-- ç´¢å¼•
CREATE INDEX idx_role_org ON role(tenant_id, org_id);
CREATE INDEX idx_role_type ON role(tenant_id, role_type);
CREATE INDEX idx_role_status ON role(tenant_id, status);

-- è¯„è®º
COMMENT ON COLUMN role.tenant_id IS 'ç§Ÿæˆ·ID';
COMMENT ON COLUMN role.role_id IS 'è§’è‰²ID';
COMMENT ON COLUMN role.role IS 'è§’è‰²ä»£ç ï¼ˆç§Ÿæˆ·å†…å”¯ä¸€ï¼‰';
COMMENT ON COLUMN role.role_name IS 'è§’è‰²åç§°';
COMMENT ON COLUMN role.role_type IS 'è§’è‰²ç±»å‹';
COMMENT ON COLUMN role.org_id IS 'æ‰€å±ç»„ç»‡IDï¼ˆNULLè¡¨ç¤ºå…¨å±€è§’è‰²ï¼‰';
COMMENT ON COLUMN role.data_scope IS 'æ•°æ®èŒƒå›´';
COMMENT ON COLUMN role.data_scope_dept_ids IS 'æ•°æ®èŒƒå›´éƒ¨é—¨IDåˆ—è¡¨ï¼ˆJSONæ•°ç»„ï¼‰';
```

#### 4.2 perm (æƒé™è¡¨)

```sql
COMMENT ON TABLE perm IS 'æƒé™è¡¨';

CREATE TABLE perm (
    -- ä¸»é”®
    perm_id BIGSERIAL PRIMARY KEY,
    
    -- åŸºæœ¬ä¿¡æ¯
    perm VARCHAR(100) NOT NULL,               -- æƒé™ä»£ç ï¼ˆå…¨å±€å”¯ä¸€ï¼‰
    perm_name VARCHAR(200) NOT NULL,           -- æƒé™åç§°
    perm_desc VARCHAR(500),                    -- æƒé™æè¿°
    
    -- æƒé™åˆ†ç±»
    perm_type VARCHAR(50) NOT NULL,            -- æƒé™ç±»å‹ï¼ˆMENU/BUTTON/APIï¼‰
    perm_group VARCHAR(50) NOT NULL,           -- æƒé™åˆ†ç»„ï¼ˆUSER/TRANS/LOAN/SYSTEMç­‰ï¼‰
    
    -- æƒé™è·¯å¾„
    perm_path VARCHAR(500),                     -- æƒé™è·¯å¾„ï¼ˆèœå•è·¯å¾„æˆ–APIè·¯å¾„ï¼‰
    perm_method VARCHAR(10),                    -- HTTPæ–¹æ³•ï¼ˆGET/POST/PUT/DELETEï¼‰
    
    -- å±‚çº§ç»“æ„
    parent_perm_id BIGINT,                       -- çˆ¶æƒé™ID
    sort_order INTEGER DEFAULT 0,                -- æ’åº
    icon VARCHAR(100),                          -- å›¾æ ‡
    is_leaf SMALLINT DEFAULT 1,                 -- æ˜¯å¦å¶å­èŠ‚ç‚¹
    
    -- æƒé™çŠ¶æ€
    status SMALLINT NOT NULL DEFAULT 1,           -- çŠ¶æ€ï¼ˆ0=ç¦ç”¨ï¼Œ1=å¯ç”¨ï¼‰
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    remarks TEXT,
    
    -- å”¯ä¸€çº¦æŸ
    CONSTRAINT uk_perm_perm UNIQUE (perm),
    CONSTRAINT uk_perm_group_type UNIQUE (perm_group, perm_type, perm),
    
    -- å¤–é”®çº¦æŸï¼ˆè‡ªå¼•ç”¨ï¼‰
    CONSTRAINT fk_perm_parent FOREIGN KEY (parent_perm_id) REFERENCES perm(perm_id)
);

-- ç´¢å¼•
CREATE INDEX idx_perm_parent ON perm(parent_perm_id);
CREATE INDEX idx_perm_group ON perm(perm_group);
CREATE INDEX idx_perm_type ON perm(perm_type);
CREATE INDEX idx_perm_status ON perm(status);

-- è¯„è®º
COMMENT ON COLUMN perm.perm_id IS 'æƒé™IDï¼ˆä¸»é”®ï¼‰';
COMMENT ON COLUMN perm.perm IS 'æƒé™ä»£ç ï¼ˆå…¨å±€å”¯ä¸€ï¼‰';
COMMENT ON COLUMN perm.perm_name IS 'æƒé™åç§°';
COMMENT ON COLUMN perm.perm_type IS 'æƒé™ç±»å‹';
COMMENT ON COLUMN perm.perm_group IS 'æƒé™åˆ†ç»„';
COMMENT ON COLUMN perm.perm_path IS 'æƒé™è·¯å¾„';
COMMENT ON COLUMN perm.perm_method IS 'HTTPæ–¹æ³•';
COMMENT ON COLUMN perm.parent_perm_id IS 'çˆ¶æƒé™ID';
```

#### 4.3 role_perm (è§’è‰²æƒé™å…³è”è¡¨)

```sql
COMMENT ON TABLE role_perm IS 'è§’è‰²æƒé™å…³è”è¡¨';

CREATE TABLE role_perm (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    role_perm_id BIGSERIAL NOT NULL,
    
    -- å…³è”å…³ç³»
    role_id BIGINT NOT NULL,
    perm_id BIGINT NOT NULL,
    
    -- å®¡è®¡å­—æ®µ
    created_by BIGINT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, role_perm_id),
    
    -- å”¯ä¸€çº¦æŸ
    CONSTRAINT uk_role_perm UNIQUE (tenant_id, role_id, perm_id),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_role_perm_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    CONSTRAINT fk_role_perm_role FOREIGN KEY (tenant_id, role_id) REFERENCES role(tenant_id, role_id),
    CONSTRAINT fk_role_perm_perm FOREIGN KEY (perm_id) REFERENCES perm(perm_id)
);

-- ç´¢å¼•
CREATE INDEX idx_role_perm_role ON role_perm(tenant_id, role_id);
CREATE INDEX idx_role_perm_perm ON role_perm(tenant_id, perm_id);

-- è¯„è®º
COMMENT ON COLUMN role_perm.tenant_id IS 'ç§Ÿæˆ·ID';
COMMENT ON COLUMN role_perm.role_id IS 'è§’è‰²ID';
COMMENT ON COLUMN role_perm.perm_id IS 'æƒé™ID';
```

### è¡¨å…³ç³»

```
role (1) â”€â”€â”€â”€ (N) user_role
role (N) â”€â”€â”€â”€ (M) perm (é€šè¿‡role_permè¡¨)
user (N) â”€â”€â”€â”€ (M) role (é€šè¿‡user_roleè¡¨)
perm (1) â”€â”€â”€â”€ (N) perm (çˆ¶å­å…³ç³»ï¼‰
```

---

## æ¨¡å—5ï¼šé¡¹ç›®ç®¡ç†

### åŠŸèƒ½è§„æ ¼

**æ¨¡å—åç§°**: project

**åŠŸèƒ½æè¿°**: é¡¹ç›®ç®¡ç†ï¼ŒæŠ¥é”€å•æ®å…³è”é¡¹ç›®

**æ ¸å¿ƒåŠŸèƒ½**:
- é¡¹ç›®åˆ›å»º
- é¡¹ç›®ä¿¡æ¯ç®¡ç†
- é¡¹ç›®çŠ¶æ€ç®¡ç†
- é¡¹ç›®æˆå‘˜ç®¡ç†

**ä¸šåŠ¡è§„åˆ™**:
- é¡¹ç›®ä»£ç åœ¨åŒä¸€ç§Ÿæˆ·å†…å”¯ä¸€
- é¡¹ç›®å¿…é¡»æœ‰è´Ÿè´£äºº
- é¡¹ç›®å¯ä»¥æœ‰å¤šä¸ªæˆå‘˜

### æ•°æ®åº“è¡¨è®¾è®¡

#### 5.1 project (é¡¹ç›®è¡¨)

```sql
COMMENT ON TABLE project IS 'é¡¹ç›®è¡¨';

-- é¡¹ç›®çŠ¶æ€æšä¸¾
CREATE TYPE project_status AS ENUM (
    'PLANNING',       -- è§„åˆ’ä¸­
    'ACTIVE',          -- è¿›è¡Œä¸­
    'COMPLETED',       -- å·²å®Œæˆ
    'CANCELLED',       -- å·²å–æ¶ˆ
    'SUSPENDED'        -- æš‚åœ
);

CREATE TABLE project (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    project_id BIGSERIAL NOT NULL,
    
    -- åŸºæœ¬ä¿¡æ¯
    project_code VARCHAR(50) NOT NULL,         -- é¡¹ç›®ä»£ç ï¼ˆç§Ÿæˆ·å†…å”¯ä¸€ï¼‰
    project_name VARCHAR(200) NOT NULL,        -- é¡¹ç›®åç§°
    project_type VARCHAR(50),                  -- é¡¹ç›®ç±»å‹
    project_desc TEXT,                         -- é¡¹ç›®æè¿°
    
    -- é¡¹ç›®è´Ÿè´£äºº
    manager_id BIGINT,                          -- é¡¹ç›®è´Ÿè´£äººID
    manager_name VARCHAR(60),                   -- é¡¹ç›®è´Ÿè´£äººå§“å
    
    -- é¡¹ç›®æ—¶é—´
    start_date DATE,                            -- å¼€å§‹æ—¥æœŸ
    end_date DATE,                              -- ç»“æŸæ—¥æœŸ
    
    -- é¡¹ç›®é¢„ç®—
    budget NUMERIC(12,2),                       -- é¢„ç®—é‡‘é¢
    currency_id INTEGER DEFAULT 1,               -- å¸ç§ID
    
    -- é¡¹ç›®çŠ¶æ€
    status project_status NOT NULL DEFAULT 'PLANNING',
    progress NUMERIC(5,2) DEFAULT 0,             -- å®Œæˆè¿›åº¦ï¼ˆ0-100ï¼‰
    
    -- é¡¹ç›®å…³è”
    org_id BIGINT,                              -- æ‰€å±ç»„ç»‡ID
    
    -- å®¡è®¡å­—æ®µ
    created_by BIGINT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by BIGINT,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP,
    remarks TEXT,
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, project_id),
    
    -- å”¯ä¸€çº¦æŸ
    CONSTRAINT uk_project_tenant_code UNIQUE (tenant_id, project_code),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_project_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    CONSTRAINT fk_project_org FOREIGN KEY (tenant_id, org_id) REFERENCES org(tenant_id, org_id),
    CONSTRAINT fk_project_manager FOREIGN KEY (tenant_id, manager_id) REFERENCES "user"(tenant_id, user_id),
    CONSTRAINT fk_project_currency FOREIGN KEY (currency_id) REFERENCES currency(currency_id)
);

-- ç´¢å¼•
CREATE INDEX idx_project_org ON project(tenant_id, org_id);
CREATE INDEX idx_project_status ON project(tenant_id, status);
CREATE INDEX idx_project_manager ON project(tenant_id, manager_id);

-- è¯„è®º
COMMENT ON COLUMN project.tenant_id IS 'ç§Ÿæˆ·ID';
COMMENT ON COLUMN project.project_id IS 'é¡¹ç›®ID';
COMMENT ON COLUMN project.project_code IS 'é¡¹ç›®ä»£ç ï¼ˆç§Ÿæˆ·å†…å”¯ä¸€ï¼‰';
COMMENT ON COLUMN project.project_name IS 'é¡¹ç›®åç§°';
COMMENT ON COLUMN project.manager_id IS 'é¡¹ç›®è´Ÿè´£äººID';
COMMENT ON COLUMN project.status IS 'é¡¹ç›®çŠ¶æ€';
COMMENT ON COLUMN project.progress IS 'å®Œæˆè¿›åº¦ï¼ˆ0-100ï¼‰';
```

---

## æ¨¡å—6ï¼šæŠ¥é”€ç®¡ç†

### åŠŸèƒ½è§„æ ¼

**æ¨¡å—åç§°**: trans

**åŠŸèƒ½æè¿°**: æŠ¥é”€å•ç®¡ç†ï¼ŒåŒ…æ‹¬æŠ¥é”€å•ã€æŠ¥é”€æ˜ç»†ã€è´¹ç”¨æ˜ç»†

**æ ¸å¿ƒåŠŸèƒ½**:
- æŠ¥é”€å•åˆ›å»ºï¼ˆè‰ç¨¿ã€æäº¤ï¼‰
- æŠ¥é”€å•å®¡æ‰¹
- æŠ¥é”€å•ç»“ç®—
- æŠ¥é”€å•æŸ¥è¯¢
- æŠ¥é”€å•å¯¼å‡º
- è‰ç¨¿ä¿å­˜

**ä¸šåŠ¡è§„åˆ™**:
- æŠ¥é”€å•å·åœ¨åŒä¸€ç§Ÿæˆ·å†…å”¯ä¸€
- æŠ¥é”€å•å¿…é¡»æœ‰é¡¹ç›®
- æŠ¥é”€å•å¿…é¡»æœ‰æŠ¥é”€ç±»å‹
- æŠ¥é”€é‡‘é¢å¿…é¡»å¤§äº0
- æŠ¥é”€å•å¿…é¡»é€šè¿‡å®¡æ‰¹æ‰èƒ½ç»“ç®—
- æ˜ç»†é‡‘é¢æ€»å’Œå¿…é¡»ç­‰äºæŠ¥é”€å•é‡‘é¢

### æ•°æ®åº“è¡¨è®¾è®¡

#### 6.1 trans (æŠ¥é”€å•è¡¨)

```sql
COMMENT ON TABLE trans IS 'æŠ¥é”€å•è¡¨';

-- æŠ¥é”€çŠ¶æ€æšä¸¾
CREATE TYPE trans_state AS ENUM (
    'DRAFT',           -- è‰ç¨¿
    'SUBMITTED',        -- å·²æäº¤
    'IN_APPROVAL',      -- å®¡æ‰¹ä¸­
    'APPROVED',         -- å·²é€šè¿‡
    'REJECTED',         -- å·²é©³å›
    'COMPLETED',        -- å·²å®Œæˆ
    'CANCELLED'         -- å·²å–æ¶ˆ
);

CREATE TABLE trans (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    trans_id BIGSERIAL NOT NULL,
    
    -- åŸºæœ¬ä¿¡æ¯
    trans_code VARCHAR(60) NOT NULL,             -- æŠ¥é”€å•å·ï¼ˆç§Ÿæˆ·å†…å”¯ä¸€ï¼‰
    trans_type_id BIGINT NOT NULL,               -- æŠ¥é”€ç±»å‹ID
    trans_type_name VARCHAR(100) NOT NULL,        -- æŠ¥é”€ç±»å‹åç§°
    trans_type_code VARCHAR(50),                 -- æŠ¥é”€ç±»å‹ä»£ç 
    
    -- é¡¹ç›®å…³è”
    project_id BIGINT NOT NULL,                   -- é¡¹ç›®ID
    project_code VARCHAR(50) NOT NULL,            -- é¡¹ç›®ä»£ç 
    project_name VARCHAR(200) NOT NULL,           -- é¡¹ç›®åç§°
    
    -- æŠ¥é”€é‡‘é¢
    trans_charge NUMERIC(12,2),                 -- æŠ¥é”€é‡‘é¢ï¼ˆåŸå§‹å¸ç§ï¼‰
    lc_charge NUMERIC(12,2),                    -- æœ¬å¸é‡‘é¢
    trans_sett_charge NUMERIC(12,2),             -- ç»“ç®—é‡‘é¢ï¼ˆåŸå§‹å¸ç§ï¼‰
    lc_sett_charge NUMERIC(12,2),               -- æœ¬å¸ç»“ç®—é‡‘é¢
    
    -- è”ç³»ä¿¡æ¯
    link_tel VARCHAR(20),                         -- è”ç³»ç”µè¯
    link_address VARCHAR(500),                    -- è”ç³»åœ°å€
    
    -- é™„ä»¶ä¿¡æ¯
    pages INTEGER,                               -- é™„ä»¶é¡µæ•°
    sheets INTEGER,                               -- é™„ä»¶å¼ æ•°
    
    -- æŠ¥é”€è¯´æ˜
    trans_desc TEXT,                             -- æŠ¥é”€è¯´æ˜
    trans_sett_desc TEXT,                        -- ç»“ç®—è¯´æ˜
    
    -- å®¡æ‰¹æµç¨‹
    processinstance_id VARCHAR(60),                -- æµç¨‹å®ä¾‹ID
    state trans_state NOT NULL DEFAULT 'DRAFT',   -- æŠ¥é”€çŠ¶æ€
    state_date TIMESTAMP,                         -- çŠ¶æ€å˜æ›´æ—¥æœŸ
    
    -- å¸ç§å’Œæ±‡ç‡
    currency_id INTEGER DEFAULT 1,                -- å¸ç§ID
    exchange_rate NUMERIC(12,6),                 -- æ±‡ç‡
    
    -- åˆ›å»ºäººä¿¡æ¯
    created_user_id BIGINT NOT NULL,              -- åˆ›å»ºäººID
    created_user_name VARCHAR(60) NOT NULL,       -- åˆ›å»ºäººå§“å
    created_job_number VARCHAR(30),               -- åˆ›å»ºäººå·¥å·
    
    -- ç»“ç®—äººä¿¡æ¯
    sett_user_id BIGINT,                          -- ç»“ç®—äººID
    sett_user_name VARCHAR(60),                   -- ç»“ç®—äººå§“å
    sett_job_number VARCHAR(30),                  -- ç»“ç®—äººå·¥å·
    sett_date TIMESTAMP,                          -- ç»“ç®—æ—¥æœŸ
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP,
    remarks TEXT,
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, trans_id),
    
    -- å”¯ä¸€çº¦æŸ
    CONSTRAINT uk_trans_tenant_code UNIQUE (tenant_id, trans_code),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_trans_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    CONSTRAINT fk_trans_trans_type FOREIGN KEY (tenant_id, trans_type_id) REFERENCES trans_type(tenant_id, trans_type_id),
    CONSTRAINT fk_trans_project FOREIGN KEY (tenant_id, project_id) REFERENCES project(tenant_id, project_id),
    CONSTRAINT fk_trans_created_user FOREIGN KEY (tenant_id, created_user_id) REFERENCES "user"(tenant_id, user_id),
    CONSTRAINT fk_trans_sett_user FOREIGN KEY (tenant_id, sett_user_id) REFERENCES "user"(tenant_id, user_id),
    CONSTRAINT fk_trans_currency FOREIGN KEY (currency_id) REFERENCES currency(currency_id)
);

-- ç´¢å¼•
CREATE INDEX idx_trans_tenant_user ON trans(tenant_id, created_user_id);
CREATE INDEX idx_trans_project ON trans(tenant_id, project_id);
CREATE INDEX idx_trans_type ON trans(tenant_id, trans_type_id);
CREATE INDEX idx_trans_state ON trans(tenant_id, state);
CREATE INDEX idx_trans_date ON trans(tenant_id, created_at);
CREATE INDEX idx_trans_sett_user ON trans(tenant_id, sett_user_id);
CREATE INDEX idx_trans_process ON trans(processinstance_id);

-- è¯„è®º
COMMENT ON COLUMN trans.tenant_id IS 'ç§Ÿæˆ·ID';
COMMENT ON COLUMN trans.trans_id IS 'æŠ¥é”€å•ID';
COMMENT ON COLUMN trans.trans_code IS 'æŠ¥é”€å•å·ï¼ˆç§Ÿæˆ·å†…å”¯ä¸€ï¼‰';
COMMENT ON COLUMN trans.trans_type_id IS 'æŠ¥é”€ç±»å‹ID';
COMMENT ON COLUMN trans.trans_charge IS 'æŠ¥é”€é‡‘é¢ï¼ˆåŸå§‹å¸ç§ï¼‰';
COMMENT ON COLUMN trans.lc_charge IS 'æœ¬å¸é‡‘é¢';
COMMENT ON COLUMN trans.trans_sett_charge IS 'ç»“ç®—é‡‘é¢ï¼ˆåŸå§‹å¸ç§ï¼‰';
COMMENT ON COLUMN trans.state IS 'æŠ¥é”€çŠ¶æ€';
COMMENT ON COLUMN trans.processinstance_id IS 'æµç¨‹å®ä¾‹ID';
```

#### 6.2 trans_item (æŠ¥é”€æ˜ç»†è¡¨)

```sql
COMMENT ON TABLE trans_item IS 'æŠ¥é”€æ˜ç»†è¡¨';

CREATE TABLE trans_item (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    trans_item_id BIGSERIAL NOT NULL,
    
    -- å…³è”æŠ¥é”€å•
    trans_id BIGINT NOT NULL,
    
    -- æŠ¥é”€ç±»å‹
    trans_type_id BIGINT,
    trans_type_name VARCHAR(100),
    trans_type_code VARCHAR(50),
    
    -- é¡¹ç›®å…³è”
    project_id BIGINT,
    project_code VARCHAR(50),
    project_name VARCHAR(200),
    
    -- æ˜ç»†ä¿¡æ¯
    trans_item_name VARCHAR(200) NOT NULL,         -- æ˜ç»†åç§°
    trans_item_desc TEXT,                          -- æ˜ç»†è¯´æ˜
    
    -- æ˜ç»†çŠ¶æ€
    state VARCHAR(20) DEFAULT 'DRAFT',             -- çŠ¶æ€
    state_date TIMESTAMP,                           -- çŠ¶æ€å˜æ›´æ—¥æœŸ
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, trans_item_id),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_trans_item_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    CONSTRAINT fk_trans_item_trans FOREIGN KEY (tenant_id, trans_id) REFERENCES trans(tenant_id, trans_id),
    CONSTRAINT fk_trans_item_trans_type FOREIGN KEY (tenant_id, trans_type_id) REFERENCES trans_type(tenant_id, trans_type_id),
    CONSTRAINT fk_trans_item_project FOREIGN KEY (tenant_id, project_id) REFERENCES project(tenant_id, project_id)
);

-- ç´¢å¼•
CREATE INDEX idx_trans_item_trans ON trans_item(tenant_id, trans_id);
CREATE INDEX idx_trans_item_type ON trans_item(tenant_id, trans_type_id);
CREATE INDEX idx_trans_item_project ON trans_item(tenant_id, project_id);
CREATE INDEX idx_trans_item_state ON trans_item(tenant_id, state);

-- è¯„è®º
COMMENT ON COLUMN trans_item.tenant_id IS 'ç§Ÿæˆ·ID';
COMMENT ON COLUMN trans_item.trans_item_id IS 'æŠ¥é”€æ˜ç»†ID';
COMMENT ON COLUMN trans_item.trans_id IS 'æŠ¥é”€å•ID';
COMMENT ON COLUMN trans_item.trans_item_name IS 'æ˜ç»†åç§°';
```

#### 6.3 charge_item (è´¹ç”¨æ˜ç»†è¡¨)

```sql
COMMENT ON TABLE charge_item IS 'è´¹ç”¨æ˜ç»†è¡¨';

CREATE TABLE charge_item (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    charge_id BIGSERIAL NOT NULL,
    
    -- å…³è”æŠ¥é”€æ˜ç»†
    trans_item_id BIGINT NOT NULL,
    
    -- è´¹ç”¨ç±»å‹
    expense_item_type_id BIGINT NOT NULL,
    expense_item_type_name VARCHAR(100) NOT NULL,
    
    -- è´¹ç”¨ä¿¡æ¯
    charge_amount NUMERIC(12,2) NOT NULL,        -- è´¹ç”¨é‡‘é¢ï¼ˆåŸå§‹å¸ç§ï¼‰
    lc_charge NUMERIC(12,2),                    -- æœ¬å¸é‡‘é¢
    charge_desc TEXT,                            -- è´¹ç”¨è¯´æ˜
    charge_date DATE,                             -- è´¹ç”¨æ—¥æœŸ
    
    -- å¸ç§å’Œæ±‡ç‡
    exchange_rate NUMERIC(12,6),                 -- æ±‡ç‡
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, charge_id),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_charge_item_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    CONSTRAINT fk_charge_item_trans_item FOREIGN KEY (tenant_id, trans_item_id) REFERENCES trans_item(tenant_id, trans_item_id),
    CONSTRAINT fk_charge_item_expense_type FOREIGN KEY (tenant_id, expense_item_type_id) REFERENCES expense_item_type(tenant_id, expense_item_type_id)
);

-- ç´¢å¼•
CREATE INDEX idx_charge_item_trans_item ON charge_item(tenant_id, trans_item_id);
CREATE INDEX idx_charge_item_expense_type ON charge_item(tenant_id, expense_item_type_id);
CREATE INDEX idx_charge_item_date ON charge_item(tenant_id, charge_date);

-- è¯„è®º
COMMENT ON COLUMN charge_item.tenant_id IS 'ç§Ÿæˆ·ID';
COMMENT ON COLUMN charge_item.charge_id IS 'è´¹ç”¨æ˜ç»†ID';
COMMENT ON COLUMN charge_item.trans_item_id IS 'æŠ¥é”€æ˜ç»†ID';
COMMENT ON COLUMN charge_item.expense_item_type_id IS 'è´¹ç”¨ç±»å‹ID';
COMMENT ON COLUMN charge_item.charge_amount IS 'è´¹ç”¨é‡‘é¢ï¼ˆåŸå§‹å¸ç§ï¼‰';
COMMENT ON COLUMN charge_item.lc_charge IS 'æœ¬å¸é‡‘é¢';
```

#### 6.4 trans_attach (æŠ¥é”€é™„ä»¶è¡¨)

```sql
COMMENT ON TABLE trans_attach IS 'æŠ¥é”€é™„ä»¶è¡¨';

CREATE TABLE trans_attach (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    attach_id BIGSERIAL NOT NULL,
    
    -- å…³è”æŠ¥é”€å•
    trans_id BIGINT NOT NULL,
    
    -- é™„ä»¶ä¿¡æ¯
    attach_name VARCHAR(255) NOT NULL,            -- é™„ä»¶åç§°
    attach_path VARCHAR(500),                     -- é™„ä»¶è·¯å¾„
    attach_size BIGINT,                           -- é™„ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
    attach_type VARCHAR(100),                    -- é™„ä»¶ç±»å‹
    attach_ext VARCHAR(10),                       -- é™„ä»¶æ‰©å±•å
    
    -- MinIOå­˜å‚¨ä¿¡æ¯
    bucket_name VARCHAR(100),                     -- å­˜å‚¨æ¡¶åç§°
    object_key VARCHAR(500) NOT NULL,              -- å¯¹è±¡é”®
    object_url VARCHAR(500),                      -- å¯¹è±¡URL
    
    -- ä¸Šä¼ äººä¿¡æ¯
    upload_user_id BIGINT NOT NULL,               -- ä¸Šä¼ äººID
    upload_user_name VARCHAR(60) NOT NULL,        -- ä¸Šä¼ äººå§“å
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, attach_id),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_trans_attach_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    CONSTRAINT fk_trans_attach_trans FOREIGN KEY (tenant_id, trans_id) REFERENCES trans(tenant_id, trans_id),
    CONSTRAINT fk_trans_attach_user FOREIGN KEY (tenant_id, upload_user_id) REFERENCES "user"(tenant_id, user_id)
);

-- ç´¢å¼•
CREATE INDEX idx_trans_attach_trans ON trans_attach(tenant_id, trans_id);
CREATE INDEX idx_trans_attach_user ON trans_attach(tenant_id, upload_user_id);

-- è¯„è®º
COMMENT ON COLUMN trans_attach.tenant_id IS 'ç§Ÿæˆ·ID';
COMMENT ON COLUMN trans_attach.attach_id IS 'é™„ä»¶ID';
COMMENT ON COLUMN trans_attach.trans_id IS 'æŠ¥é”€å•ID';
COMMENT ON COLUMN trans_attach.attach_name IS 'é™„ä»¶åç§°';
COMMENT ON COLUMN trans_attach.object_key IS 'MinIOå¯¹è±¡é”®';
COMMENT ON COLUMN trans_attach.object_url IS 'MinIOå¯¹è±¡URL';
```

### è¡¨å…³ç³»

```
trans (1) â”€â”€â”€â”€ (N) trans_item
trans_item (1) â”€â”€â”€â”€ (N) charge_item
trans (1) â”€â”€â”€â”€ (N) trans_attach
trans (N) â”€â”€â”€â”€ (1) trans_type
trans (N) â”€â”€â”€â”€ (1) project
trans (N) â”€â”€â”€â”€ (1) "user" (created_user)
trans (N) â”€â”€â”€â”€ (1) "user" (sett_user)
```

---

## æ¨¡å—7ï¼šå€Ÿæ¬¾ç®¡ç†

### åŠŸèƒ½è§„æ ¼

**æ¨¡å—åç§°**: loan

**åŠŸèƒ½æè¿°**: å€Ÿæ¬¾å•ç®¡ç†ï¼Œå‘˜å·¥å‘å…¬å¸å€Ÿæ¬¾

**æ ¸å¿ƒåŠŸèƒ½**:
- å€Ÿæ¬¾ç”³è¯·åˆ›å»º
- å€Ÿæ¬¾å®¡æ‰¹
- å€Ÿæ¬¾å‘æ”¾
- å€Ÿæ¬¾æŸ¥è¯¢
- å€Ÿæ¬¾è¿˜æ¬¾è·Ÿè¸ª

**ä¸šåŠ¡è§„åˆ™**:
- å€Ÿæ¬¾å•å·åœ¨åŒä¸€ç§Ÿæˆ·å†…å”¯ä¸€
- å€Ÿæ¬¾å¿…é¡»æœ‰é¡¹ç›®
- å€Ÿæ¬¾å¿…é¡»æœ‰å€Ÿæ¬¾ç±»å‹
- å€Ÿæ¬¾é‡‘é¢å¿…é¡»å¤§äº0
- å€Ÿæ¬¾å¿…é¡»é€šè¿‡å®¡æ‰¹æ‰èƒ½å‘æ”¾
- å€Ÿæ¬¾é‡‘é¢ä¸èƒ½è¶…è¿‡å‰©ä½™é¢åº¦

### æ•°æ®åº“è¡¨è®¾è®¡

#### 7.1 loan (å€Ÿæ¬¾è¡¨)

```sql
COMMENT ON TABLE loan IS 'å€Ÿæ¬¾è¡¨';

-- å€Ÿæ¬¾çŠ¶æ€æšä¸¾
CREATE TYPE loan_state AS ENUM (
    'DRAFT',           -- è‰ç¨¿
    'SUBMITTED',        -- å·²æäº¤
    'IN_APPROVAL',      -- å®¡æ‰¹ä¸­
    'APPROVED',         -- å·²é€šè¿‡
    'REJECTED',         -- å·²é©³å›
    'RELEASED',         -- å·²å‘æ”¾
    'COMPLETED',        -- å·²å®Œæˆ
    'CANCELLED'         -- å·²å–æ¶ˆ
);

CREATE TABLE loan (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    loan_id BIGSERIAL NOT NULL,
    
    -- åŸºæœ¬ä¿¡æ¯
    loan_code VARCHAR(60) NOT NULL,              -- å€Ÿæ¬¾å•å·ï¼ˆç§Ÿæˆ·å†…å”¯ä¸€ï¼‰
    loan_type VARCHAR(50),                       -- å€Ÿæ¬¾ç±»å‹
    
    -- å€Ÿæ¬¾äººä¿¡æ¯
    user_id BIGINT NOT NULL,                      -- å€Ÿæ¬¾äººID
    user_name VARCHAR(60) NOT NULL,               -- å€Ÿæ¬¾äººå§“å
    user_job_number VARCHAR(30),                  -- å€Ÿæ¬¾äººå·¥å·
    user_org_id BIGINT,                           -- å€Ÿæ¬¾äººç»„ç»‡ID
    
    -- å€Ÿæ¬¾é¡¹ç›®
    project_id BIGINT NOT NULL,                   -- é¡¹ç›®ID
    project_code VARCHAR(50) NOT NULL,             -- é¡¹ç›®ä»£ç 
    project_name VARCHAR(200) NOT NULL,            -- é¡¹ç›®åç§°
    
    -- å€Ÿæ¬¾é‡‘é¢
    loan_amount NUMERIC(12,2) NOT NULL,           -- å€Ÿæ¬¾é‡‘é¢ï¼ˆåŸå§‹å¸ç§ï¼‰
    loan_lc_amount NUMERIC(12,2),                -- æœ¬å¸é‡‘é¢
    loan_sett_charge NUMERIC(12,2),             -- ç»“ç®—é‡‘é¢ï¼ˆåŸå§‹å¸ç§ï¼‰
    amount_repaid NUMERIC(12,2) DEFAULT 0,       -- å·²è¿˜é‡‘é¢
    amount_outstanding NUMERIC(12,2),             -- æœªè¿˜é‡‘é¢
    
    -- å€Ÿæ¬¾æ—¥æœŸ
    loan_date DATE NOT NULL,                      -- å€Ÿæ¬¾æ—¥æœŸ
    due_date DATE,                                -- åˆ°æœŸæ—¥æœŸ
    sett_date DATE,                                -- ç»“ç®—æ—¥æœŸ
    
    -- å€Ÿæ¬¾è¯´æ˜
    description TEXT,                              -- å€Ÿæ¬¾è¯´æ˜
    loan_sett_desc TEXT,                         -- ç»“ç®—è¯´æ˜
    
    -- è”ç³»ä¿¡æ¯
    link_tel VARCHAR(20),                         -- è”ç³»ç”µè¯
    
    -- å®¡æ‰¹æµç¨‹
    processinstance_id VARCHAR(60),                -- æµç¨‹å®ä¾‹ID
    state loan_state NOT NULL DEFAULT 'DRAFT',    -- å€Ÿæ¬¾çŠ¶æ€
    state_date TIMESTAMP,                          -- çŠ¶æ€å˜æ›´æ—¥æœŸ
    
    -- å¸ç§å’Œæ±‡ç‡
    currency_id INTEGER DEFAULT 1,                -- å¸ç§ID
    exchange_rate NUMERIC(12,6),                 -- æ±‡ç‡
    
    -- ç»“ç®—äººä¿¡æ¯
    sett_user_id BIGINT,                          -- ç»“ç®—äººID
    sett_user_name VARCHAR(60),                   -- ç»“ç®—äººå§“å
    sett_job_number VARCHAR(30),                  -- ç»“ç®—äººå·¥å·
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP,
    remarks TEXT,
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, loan_id),
    
    -- å”¯ä¸€çº¦æŸ
    CONSTRAINT uk_loan_tenant_code UNIQUE (tenant_id, loan_code),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_loan_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    CONSTRAINT fk_loan_user FOREIGN KEY (tenant_id, user_id) REFERENCES "user"(tenant_id, user_id),
    CONSTRAINT fk_loan_project FOREIGN KEY (tenant_id, project_id) REFERENCES project(tenant_id, project_id),
    CONSTRAINT fk_loan_sett_user FOREIGN KEY (tenant_id, sett_user_id) REFERENCES "user"(tenant_id, user_id),
    CONSTRAINT fk_loan_currency FOREIGN KEY (currency_id) REFERENCES currency(currency_id)
);

-- ç´¢å¼•
CREATE INDEX idx_loan_user ON loan(tenant_id, user_id);
CREATE INDEX idx_loan_project ON loan(tenant_id, project_id);
CREATE INDEX idx_loan_state ON loan(tenant_id, state);
CREATE INDEX idx_loan_date ON loan(tenant_id, loan_date);
CREATE INDEX idx_loan_process ON loan(processinstance_id);

-- è¯„è®º
COMMENT ON COLUMN loan.tenant_id IS 'ç§Ÿæˆ·ID';
COMMENT ON COLUMN loan.loan_id IS 'å€Ÿæ¬¾ID';
COMMENT ON COLUMN loan.loan_code IS 'å€Ÿæ¬¾å•å·ï¼ˆç§Ÿæˆ·å†…å”¯ä¸€ï¼‰';
COMMENT ON COLUMN loan.user_id IS 'å€Ÿæ¬¾äººID';
COMMENT ON COLUMN loan.loan_amount IS 'å€Ÿæ¬¾é‡‘é¢ï¼ˆåŸå§‹å¸ç§ï¼‰';
COMMENT ON COLUMN loan.loan_lc_amount IS 'æœ¬å¸é‡‘é¢';
COMMENT ON COLUMN loan.amount_repaid IS 'å·²è¿˜é‡‘é¢';
COMMENT ON COLUMN loan.amount_outstanding IS 'æœªè¿˜é‡‘é¢';
COMMENT ON COLUMN loan.state IS 'å€Ÿæ¬¾çŠ¶æ€';
COMMENT ON COLUMN loan.processinstance_id IS 'æµç¨‹å®ä¾‹ID';
```

#### 7.2 loan_attach (å€Ÿæ¬¾é™„ä»¶è¡¨)

```sql
COMMENT ON TABLE loan_attach IS 'å€Ÿæ¬¾é™„ä»¶è¡¨';

CREATE TABLE loan_attach (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    attach_id BIGSERIAL NOT NULL,
    
    -- å…³è”å€Ÿæ¬¾å•
    loan_id BIGINT NOT NULL,
    
    -- é™„ä»¶ä¿¡æ¯
    attach_name VARCHAR(255) NOT NULL,
    attach_path VARCHAR(500),
    attach_size BIGINT,
    attach_type VARCHAR(100),
    attach_ext VARCHAR(10),
    
    -- MinIOå­˜å‚¨ä¿¡æ¯
    bucket_name VARCHAR(100),
    object_key VARCHAR(500) NOT NULL,
    object_url VARCHAR(500),
    
    -- ä¸Šä¼ äººä¿¡æ¯
    upload_user_id BIGINT NOT NULL,
    upload_user_name VARCHAR(60) NOT NULL,
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, attach_id),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_loan_attach_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    CONSTRAINT fk_loan_attach_loan FOREIGN KEY (tenant_id, loan_id) REFERENCES loan(tenant_id, loan_id),
    CONSTRAINT fk_loan_attach_user FOREIGN KEY (tenant_id, upload_user_id) REFERENCES "user"(tenant_id, user_id)
);

-- ç´¢å¼•
CREATE INDEX idx_loan_attach_loan ON loan_attach(tenant_id, loan_id);

-- è¯„è®º
COMMENT ON COLUMN loan_attach.tenant_id IS 'ç§Ÿæˆ·ID';
COMMENT ON COLUMN loan_attach.attach_id IS 'é™„ä»¶ID';
COMMENT ON COLUMN loan_attach.loan_id IS 'å€Ÿæ¬¾ID';
COMMENT ON COLUMN loan_attach.object_key IS 'MinIOå¯¹è±¡é”®';
```

### è¡¨å…³ç³»

```
loan (1) â”€â”€â”€â”€ (N) loan_attach
loan (N) â”€â”€â”€â”€ (1) project
loan (N) â”€â”€â”€â”€ (1) "user" (borrower)
loan (N) â”€â”€â”€â”€ (1) "user" (settler)
```

---

## æ¨¡å—8ï¼šè¿˜æ¬¾ç®¡ç†

### åŠŸèƒ½è§„æ ¼

**æ¨¡å—åç§°**: repayment

**åŠŸèƒ½æè¿°**: è¿˜æ¬¾ç®¡ç†ï¼Œå‘˜å·¥å½’è¿˜å€Ÿæ¬¾

**æ ¸å¿ƒåŠŸèƒ½**:
- è¿˜æ¬¾ç”³è¯·åˆ›å»º
- è¿˜æ¬¾å®¡æ‰¹
- è¿˜æ¬¾ç»“ç®—
- è¿˜æ¬¾å†²é”€å€Ÿæ¬¾
- è¿˜æ¬¾æŸ¥è¯¢

**ä¸šåŠ¡è§„åˆ™**:
- è¿˜æ¬¾å•å·åœ¨åŒä¸€ç§Ÿæˆ·å†…å”¯ä¸€
- è¿˜æ¬¾å¿…é¡»å…³è”åˆ°å€Ÿæ¬¾
- è¿˜æ¬¾é‡‘é¢å¿…é¡»å¤§äº0
- è¿˜æ¬¾é‡‘é¢ä¸èƒ½è¶…è¿‡å€Ÿæ¬¾æœªè¿˜é‡‘é¢
- è¿˜æ¬¾å¿…é¡»é€šè¿‡å®¡æ‰¹æ‰èƒ½ç»“ç®—

### æ•°æ®åº“è¡¨è®¾è®¡

#### 8.1 repayment (è¿˜æ¬¾è¡¨)

```sql
COMMENT ON TABLE repayment IS 'è¿˜æ¬¾è¡¨';

-- è¿˜æ¬¾çŠ¶æ€æšä¸¾
CREATE TYPE repayment_state AS ENUM (
    'DRAFT',           -- è‰ç¨¿
    'SUBMITTED',        -- å·²æäº¤
    'IN_APPROVAL',      -- å®¡æ‰¹ä¸­
    'APPROVED',         -- å·²é€šè¿‡
    'REJECTED',         -- å·²é©³å›
    'COMPLETED',        -- å·²å®Œæˆ
    'CANCELLED'         -- å·²å–æ¶ˆ
);

CREATE TABLE repayment (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    repayment_id BIGSERIAL NOT NULL,
    
    -- åŸºæœ¬ä¿¡æ¯
    repayment_code VARCHAR(60) NOT NULL,           -- è¿˜æ¬¾å•å·ï¼ˆç§Ÿæˆ·å†…å”¯ä¸€ï¼‰
    
    -- è¿˜æ¬¾äººä¿¡æ¯
    user_id BIGINT NOT NULL,                      -- è¿˜æ¬¾äººID
    user_name VARCHAR(60) NOT NULL,               -- è¿˜æ¬¾äººå§“å
    user_job_number VARCHAR(30),                  -- è¿˜æ¬¾äººå·¥å·
    
    -- è¿˜æ¬¾é¡¹ç›®
    project_id BIGINT NOT NULL,                   -- é¡¹ç›®ID
    project_code VARCHAR(50) NOT NULL,             -- é¡¹ç›®ä»£ç 
    project_name VARCHAR(200) NOT NULL,            -- é¡¹ç›®åç§°
    
    -- è¿˜æ¬¾é‡‘é¢
    repayment_amount NUMERIC(12,2) NOT NULL,     -- è¿˜æ¬¾é‡‘é¢ï¼ˆåŸå§‹å¸ç§ï¼‰
    lc_repayment_amount NUMERIC(12,2),            -- æœ¬å¸é‡‘é¢
    
    -- è¿˜æ¬¾æ—¥æœŸ
    repayment_date DATE NOT NULL,                  -- è¿˜æ¬¾æ—¥æœŸ
    sett_date DATE,                                -- ç»“ç®—æ—¥æœŸ
    
    -- è¿˜æ¬¾è¯´æ˜
    description TEXT,                              -- è¿˜æ¬¾è¯´æ˜
    
    -- è”ç³»ä¿¡æ¯
    link_tel VARCHAR(20),                         -- è”ç³»ç”µè¯
    
    -- å®¡æ‰¹æµç¨‹
    processinstance_id VARCHAR(60),                -- æµç¨‹å®ä¾‹ID
    state repayment_state NOT NULL DEFAULT 'DRAFT', -- è¿˜æ¬¾çŠ¶æ€
    state_date TIMESTAMP,                          -- çŠ¶æ€å˜æ›´æ—¥æœŸ
    
    -- å¸ç§å’Œæ±‡ç‡
    currency_id INTEGER DEFAULT 1,                -- å¸ç§ID
    exchange_rate NUMERIC(12,6),                 -- æ±‡ç‡
    
    -- ç»“ç®—äººä¿¡æ¯
    sett_user_id BIGINT,                          -- ç»“ç®—äººID
    sett_user_name VARCHAR(60),                   -- ç»“ç®—äººå§“å
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP,
    remarks TEXT,
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, repayment_id),
    
    -- å”¯ä¸€çº¦æŸ
    CONSTRAINT uk_repayment_tenant_code UNIQUE (tenant_id, repayment_code),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_repayment_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    CONSTRAINT fk_repayment_user FOREIGN KEY (tenant_id, user_id) REFERENCES "user"(tenant_id, user_id),
    CONSTRAINT fk_repayment_project FOREIGN KEY (tenant_id, project_id) REFERENCES project(tenant_id, project_id),
    CONSTRAINT fk_repayment_sett_user FOREIGN KEY (tenant_id, sett_user_id) REFERENCES "user"(tenant_id, user_id),
    CONSTRAINT fk_repayment_currency FOREIGN KEY (currency_id) REFERENCES currency(currency_id)
);

-- ç´¢å¼•
CREATE INDEX idx_repayment_user ON repayment(tenant_id, user_id);
CREATE INDEX idx_repayment_project ON repayment(tenant_id, project_id);
CREATE INDEX idx_repayment_state ON repayment(tenant_id, state);
CREATE INDEX idx_repayment_date ON repayment(tenant_id, repayment_date);
CREATE INDEX idx_repayment_process ON repayment(processinstance_id);

-- è¯„è®º
COMMENT ON COLUMN repayment.tenant_id IS 'ç§Ÿæˆ·ID';
COMMENT ON COLUMN repayment.repayment_id IS 'è¿˜æ¬¾ID';
COMMENT ON COLUMN repayment.repayment_code IS 'è¿˜æ¬¾å•å·ï¼ˆç§Ÿæˆ·å†…å”¯ä¸€ï¼‰';
COMMENT ON COLUMN repayment.user_id IS 'è¿˜æ¬¾äººID';
COMMENT ON COLUMN repayment.repayment_amount IS 'è¿˜æ¬¾é‡‘é¢ï¼ˆåŸå§‹å¸ç§ï¼‰';
COMMENT ON COLUMN repayment.lc_repayment_amount IS 'æœ¬å¸é‡‘é¢';
COMMENT ON COLUMN repayment.state IS 'è¿˜æ¬¾çŠ¶æ€';
COMMENT ON COLUMN repayment.processinstance_id IS 'æµç¨‹å®ä¾‹ID';
```

#### 8.2 repayment_sett (è¿˜æ¬¾å†²é”€è¡¨)

```sql
COMMENT ON TABLE repayment_sett IS 'è¿˜æ¬¾å†²é”€è¡¨';

CREATE TABLE repayment_sett (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    sett_id BIGSERIAL NOT NULL,
    
    -- å…³è”å…³ç³»
    repayment_id BIGINT NOT NULL,                -- è¿˜æ¬¾ID
    loan_id BIGINT NOT NULL,                     -- å€Ÿæ¬¾ID
    
    -- å†²é”€ä¿¡æ¯
    sett_amount NUMERIC(12,2) NOT NULL,          -- å†²é”€é‡‘é¢
    sett_date DATE NOT NULL,                      -- å†²é”€æ—¥æœŸ
    sett_desc TEXT,                               -- å†²é”€è¯´æ˜
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, sett_id),
    
    -- å”¯ä¸€çº¦æŸ
    CONSTRAINT uk_repayment_sett UNIQUE (tenant_id, repayment_id, loan_id),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_repayment_sett_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    CONSTRAINT fk_repayment_sett_repayment FOREIGN KEY (tenant_id, repayment_id) REFERENCES repayment(tenant_id, repayment_id),
    CONSTRAINT fk_repayment_sett_loan FOREIGN KEY (tenant_id, loan_id) REFERENCES loan(tenant_id, loan_id)
);

-- ç´¢å¼•
CREATE INDEX idx_repayment_sett_repayment ON repayment_sett(tenant_id, repayment_id);
CREATE INDEX idx_repayment_sett_loan ON repayment_sett(tenant_id, loan_id);

-- è¯„è®º
COMMENT ON COLUMN repayment_sett.tenant_id IS 'ç§Ÿæˆ·ID';
COMMENT ON COLUMN repayment_sett.sett_id IS 'å†²é”€ID';
COMMENT ON COLUMN repayment_sett.repayment_id IS 'è¿˜æ¬¾ID';
COMMENT ON COLUMN repayment_sett.loan_id IS 'å€Ÿæ¬¾ID';
COMMENT ON COLUMN repayment_sett.sett_amount IS 'å†²é”€é‡‘é¢';
```

#### 8.3 repayment_attach (è¿˜æ¬¾é™„ä»¶è¡¨)

```sql
COMMENT ON TABLE repayment_attach IS 'è¿˜æ¬¾é™„ä»¶è¡¨';

CREATE TABLE repayment_attach (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    attach_id BIGSERIAL NOT NULL,
    
    -- å…³è”è¿˜æ¬¾å•
    repayment_id BIGINT NOT NULL,
    
    -- é™„ä»¶ä¿¡æ¯
    attach_name VARCHAR(255) NOT NULL,
    attach_path VARCHAR(500),
    attach_size BIGINT,
    attach_type VARCHAR(100),
    attach_ext VARCHAR(10),
    
    -- MinIOå­˜å‚¨ä¿¡æ¯
    bucket_name VARCHAR(100),
    object_key VARCHAR(500) NOT NULL,
    object_url VARCHAR(500),
    
    -- ä¸Šä¼ äººä¿¡æ¯
    upload_user_id BIGINT NOT NULL,
    upload_user_name VARCHAR(60) NOT NULL,
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, attach_id),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_repayment_attach_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    CONSTRAINT fk_repayment_attach_repayment FOREIGN KEY (tenant_id, repayment_id) REFERENCES repayment(tenant_id, repayment_id),
    CONSTRAINT fk_repayment_attach_user FOREIGN KEY (tenant_id, upload_user_id) REFERENCES "user"(tenant_id, user_id)
);

-- ç´¢å¼•
CREATE INDEX idx_repayment_attach_repayment ON repayment_attach(tenant_id, repayment_id);

-- è¯„è®º
COMMENT ON COLUMN repayment_attach.tenant_id IS 'ç§Ÿæˆ·ID';
COMMENT ON COLUMN repayment_attach.attach_id IS 'é™„ä»¶ID';
COMMENT ON COLUMN repayment_attach.repayment_id IS 'è¿˜æ¬¾ID';
COMMENT ON COLUMN repayment_attach.object_key IS 'MinIOå¯¹è±¡é”®';
```

### è¡¨å…³ç³»

```
repayment (1) â”€â”€â”€â”€ (N) repayment_sett
repayment (1) â”€â”€â”€â”€ (N) repayment_attach
repayment (N) â”€â”€â”€â”€ (1) project
repayment (N) â”€â”€â”€â”€ (1) "user" (repayer)
repayment (N) â”€â”€â”€â”€ (1) "user" (settler)
repayment_sett (N) â”€â”€â”€â”€ (1) loan
```

---

## æ¨¡å—9ï¼šåŸºç¡€æ•°æ®ç®¡ç†

### åŠŸèƒ½è§„æ ¼

**æ¨¡å—åç§°**: base_data

**åŠŸèƒ½æè¿°**: åŸºç¡€æ•°æ®ç®¡ç†ï¼ŒåŒ…æ‹¬å¸ç§ã€æ±‡ç‡ã€è´¹ç”¨ç±»å‹ç­‰

**æ ¸å¿ƒåŠŸèƒ½**:
- å¸ç§ç®¡ç†
- æ±‡ç‡ç®¡ç†
- æŠ¥é”€ç±»å‹ç®¡ç†
- è´¹ç”¨ç±»å‹ç®¡ç†
- é¡¹ç›®ç±»å‹ç®¡ç†
- åŸå¸‚ç®¡ç†ï¼ˆè¡¥è´´æ ‡å‡†ï¼‰

### æ•°æ®åº“è¡¨è®¾è®¡

#### 9.1 currency (å¸ç§è¡¨)

```sql
COMMENT ON TABLE currency IS 'å¸ç§è¡¨';

CREATE TABLE currency (
    -- ä¸»é”®
    currency_id SERIAL PRIMARY KEY,
    
    -- åŸºæœ¬ä¿¡æ¯
    currency_code VARCHAR(10) NOT NULL,         -- å¸ç§ä»£ç ï¼ˆå¦‚ï¼šCNY, USD, EURï¼‰
    currency_name VARCHAR(50) NOT NULL,         -- å¸ç§åç§°ï¼ˆå¦‚ï¼šäººæ°‘å¸, ç¾å…ƒ, æ¬§å…ƒï¼‰
    currency_symbol VARCHAR(10) NOT NULL,        -- å¸ç§ç¬¦å·ï¼ˆå¦‚ï¼šÂ¥, $, â‚¬ï¼‰
    
    -- æ’åº
    sort_order INTEGER DEFAULT 0,
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- å”¯ä¸€çº¦æŸ
    CONSTRAINT uk_currency_code UNIQUE (currency_code)
);

-- ç´¢å¼•
CREATE INDEX idx_currency_sort ON currency(sort_order);

-- è¯„è®º
COMMENT ON COLUMN currency.currency_id IS 'å¸ç§IDï¼ˆä¸»é”®ï¼‰';
COMMENT ON COLUMN currency.currency_code IS 'å¸ç§ä»£ç ï¼ˆå¦‚ï¼šCNY, USD, EURï¼‰';
COMMENT ON COLUMN currency.currency_name IS 'å¸ç§åç§°ï¼ˆå¦‚ï¼šäººæ°‘å¸, ç¾å…ƒ, æ¬§å…ƒï¼‰';
COMMENT ON COLUMN currency.currency_symbol IS 'å¸ç§ç¬¦å·ï¼ˆå¦‚ï¼šÂ¥, $, â‚¬ï¼‰';
```

#### 9.2 exchange_rate (æ±‡ç‡è¡¨)

```sql
COMMENT ON TABLE exchange_rate IS 'æ±‡ç‡è¡¨';

CREATE TABLE exchange_rate (
    -- ä¸»é”®
    rate_id BIGSERIAL PRIMARY KEY,
    
    -- æ±‡ç‡ä¿¡æ¯
    src_currency_id INTEGER NOT NULL,             -- æºå¸ç§ID
    obj_currency_id INTEGER NOT NULL,             -- ç›®æ ‡å¸ç§ID
    exchange_rate NUMERIC(12,6) NOT NULL,       -- æ±‡ç‡
    
    -- ç”Ÿæ•ˆæ—¥æœŸ
    effect_date DATE NOT NULL,                   -- ç”Ÿæ•ˆæ—¥æœŸ
    expiry_date DATE,                            -- å¤±æ•ˆæ—¥æœŸ
    
    -- å®¡è®¡å­—æ®µ
    created_by BIGINT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- å”¯ä¸€çº¦æŸ
    CONSTRAINT uk_exchange_rate UNIQUE (src_currency_id, obj_currency_id, effect_date),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_exchange_rate_src FOREIGN KEY (src_currency_id) REFERENCES currency(currency_id),
    CONSTRAINT fk_exchange_rate_obj FOREIGN KEY (obj_currency_id) REFERENCES currency(currency_id)
);

-- ç´¢å¼•
CREATE INDEX idx_exchange_rate_src ON exchange_rate(src_currency_id);
CREATE INDEX idx_exchange_rate_obj ON exchange_rate(obj_currency_id);
CREATE INDEX idx_exchange_rate_effect_date ON exchange_rate(effect_date);

-- è¯„è®º
COMMENT ON COLUMN exchange_rate.src_currency_id IS 'æºå¸ç§ID';
COMMENT ON COLUMN exchange_rate.obj_currency_id IS 'ç›®æ ‡å¸ç§ID';
COMMENT ON COLUMN exchange_rate.exchange_rate IS 'æ±‡ç‡';
COMMENT ON COLUMN exchange_rate.effect_date IS 'ç”Ÿæ•ˆæ—¥æœŸ';
```

#### 9.3 trans_type (æŠ¥é”€ç±»å‹è¡¨)

```sql
COMMENT ON TABLE trans_type IS 'æŠ¥é”€ç±»å‹è¡¨';

CREATE TABLE trans_type (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    trans_type_id BIGSERIAL NOT NULL,
    
    -- åŸºæœ¬ä¿¡æ¯
    trans_type VARCHAR(50) NOT NULL,           -- æŠ¥é”€ç±»å‹ä»£ç 
    trans_type_name VARCHAR(100) NOT NULL,       -- æŠ¥é”€ç±»å‹åç§°
    trans_type_desc VARCHAR(500),              -- æŠ¥é”€ç±»å‹æè¿°
    
    -- æ’åº
    sort_order INTEGER DEFAULT 0,
    
    -- å®¡è®¡å­—æ®µ
    created_by BIGINT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by BIGINT,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, trans_type_id),
    
    -- å”¯ä¸€çº¦æŸ
    CONSTRAINT uk_trans_type_code UNIQUE (tenant_id, trans_type),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_trans_type_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id)
);

-- ç´¢å¼•
CREATE INDEX idx_trans_type_sort ON trans_type(tenant_id, sort_order);

-- è¯„è®º
COMMENT ON COLUMN trans_type.tenant_id IS 'ç§Ÿæˆ·ID';
COMMENT ON COLUMN trans_type.trans_type_id IS 'æŠ¥é”€ç±»å‹ID';
COMMENT ON COLUMN trans_type.trans_type IS 'æŠ¥é”€ç±»å‹ä»£ç ï¼ˆç§Ÿæˆ·å†…å”¯ä¸€ï¼‰';
COMMENT ON COLUMN trans_type.trans_type_name IS 'æŠ¥é”€ç±»å‹åç§°';
```

#### 9.4 expense_item_type (è´¹ç”¨ç±»å‹è¡¨)

```sql
COMMENT ON TABLE expense_item_type IS 'è´¹ç”¨ç±»å‹è¡¨';

CREATE TABLE expense_item_type (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    expense_item_type_id BIGSERIAL NOT NULL,
    
    -- åŸºæœ¬ä¿¡æ¯
    expense_item_type VARCHAR(50) NOT NULL,  -- è´¹ç”¨ç±»å‹ä»£ç 
    expense_item_type_name VARCHAR(100) NOT NULL, -- è´¹ç”¨ç±»å‹åç§°
    expense_item_type_desc VARCHAR(500),          -- è´¹ç”¨ç±»å‹æè¿°
    
    -- è´¹ç”¨åˆ†ç±»
    expense_category VARCHAR(50),                -- è´¹ç”¨åˆ†ç±»ï¼ˆå¦‚ï¼šäº¤é€šè´¹ã€ä½å®¿è´¹ã€é¤é¥®è´¹ï¼‰
    
    -- é¢„ç®—æ§åˆ¶
    is_budget_controlled SMALLINT DEFAULT 0,      -- æ˜¯å¦é¢„ç®—æ§åˆ¶
    
    -- æ’åº
    sort_order INTEGER DEFAULT 0,
    
    -- å®¡è®¡å­—æ®µ
    created_by BIGINT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by BIGINT,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, expense_item_type_id),
    
    -- å”¯ä¸€çº¦æŸ
    CONSTRAINT uk_expense_item_type_code UNIQUE (tenant_id, expense_item_type),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_expense_item_type_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id)
);

-- ç´¢å¼•
CREATE INDEX idx_expense_item_type_category ON expense_item_type(tenant_id, expense_category);
CREATE INDEX idx_expense_item_type_sort ON expense_item_type(tenant_id, sort_order);

-- è¯„è®º
COMMENT ON COLUMN expense_item_type.tenant_id IS 'ç§Ÿæˆ·ID';
COMMENT ON COLUMN expense_item_type.expense_item_type_id IS 'è´¹ç”¨ç±»å‹ID';
COMMENT ON COLUMN expense_item_type.expense_item_type IS 'è´¹ç”¨ç±»å‹ä»£ç ï¼ˆç§Ÿæˆ·å†…å”¯ä¸€ï¼‰';
COMMENT ON COLUMN expense_item_type.expense_item_type_name IS 'è´¹ç”¨ç±»å‹åç§°';
```

### è¡¨å…³ç³»

```
currency (1) â”€â”€â”€â”€ (N) exchange_rate (src_currency_id)
currency (1) â”€â”€â”€â”€ (N) exchange_rate (obj_currency_id)
currency (1) â”€â”€â”€â”€ (N) trans
currency (1) â”€â”€â”€â”€ (N) loan
currency (1) â”€â”€â”€â”€ (N) repayment
exchange_rate (1) â”€â”€â”€â”€ (N) exchange_rate (è‡ªå¼•ç”¨ï¼‰
trans_type (1) â”€â”€â”€â”€ (N) trans
expense_item_type (1) â”€â”€â”€â”€ (N) charge_item
```

---

## æ¨¡å—10ï¼šå·¥ä½œæµç®¡ç†

### åŠŸèƒ½è§„æ ¼

**æ¨¡å—åç§°**: workflow

**åŠŸèƒ½æè¿°**: å·¥ä½œæµç®¡ç†ï¼Œä½¿ç”¨Flowableå¼•æ“

**æ ¸å¿ƒåŠŸèƒ½**:
- æµç¨‹å®šä¹‰ç®¡ç†
- æµç¨‹å®ä¾‹ç®¡ç†
- ä»»åŠ¡ç®¡ç†
- æµç¨‹å†å²ç®¡ç†

**ä¸šåŠ¡è§„åˆ™**:
- æµç¨‹å®šä¹‰åœ¨åŒä¸€ç§Ÿæˆ·å†…å”¯ä¸€
- æµç¨‹å®ä¾‹å¿…é¡»å…³è”åˆ°ä¸šåŠ¡å•æ®
- ä»»åŠ¡å¿…é¡»åˆ†é…ç»™å…·ä½“ç”¨æˆ·æˆ–ç”¨æˆ·ç»„

### æ•°æ®åº“è¡¨è®¾è®¡

**è¯´æ˜**: Flowableå¼•æ“ä¼šè‡ªåŠ¨åˆ›å»º25å¼ è¡¨ï¼ˆact_*ï¼‰ï¼Œè¿™é‡Œåªè®¾è®¡ä¸šåŠ¡å…³è”è¡¨ã€‚

#### 10.1 workflow_instance (æµç¨‹å®ä¾‹å…³è”è¡¨)

```sql
COMMENT ON TABLE workflow_instance IS 'æµç¨‹å®ä¾‹å…³è”è¡¨';

CREATE TABLE workflow_instance (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    instance_id BIGSERIAL NOT NULL,
    
    -- æµç¨‹ä¿¡æ¯
    processinstance_id VARCHAR(60) NOT NULL,       -- Flowableæµç¨‹å®ä¾‹ID
    process_def_key VARCHAR(100) NOT NULL,        -- æµç¨‹å®šä¹‰key
    process_def_name VARCHAR(200) NOT NULL,        -- æµç¨‹å®šä¹‰åç§°
    process_def_version INTEGER NOT NULL,          -- æµç¨‹å®šä¹‰ç‰ˆæœ¬
    
    -- ä¸šåŠ¡å…³è”
    business_type VARCHAR(50) NOT NULL,             -- ä¸šåŠ¡ç±»å‹ï¼ˆTRANS/LOAN/REPAYMENTï¼‰
    business_id BIGINT NOT NULL,                    -- ä¸šåŠ¡ID
    
    -- æµç¨‹çŠ¶æ€
    state VARCHAR(20) NOT NULL,                   -- æµç¨‹çŠ¶æ€
    start_time TIMESTAMP NOT NULL,                 -- å¼€å§‹æ—¶é—´
    end_time TIMESTAMP,                           -- ç»“æŸæ—¶é—´
    duration_seconds BIGINT,                       -- æŒç»­æ—¶é—´ï¼ˆç§’ï¼‰
    
    -- æµç¨‹å˜é‡
    variables JSONB,                                -- æµç¨‹å˜é‡
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, instance_id),
    
    -- å”¯ä¸€çº¦æŸ
    CONSTRAINT uk_workflow_instance_process UNIQUE (tenant_id, processinstance_id),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_workflow_instance_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id)
);

-- ç´¢å¼•
CREATE INDEX idx_workflow_instance_business ON workflow_instance(tenant_id, business_type, business_id);
CREATE INDEX idx_workflow_instance_state ON workflow_instance(tenant_id, state);
CREATE INDEX idx_workflow_instance_time ON workflow_instance(tenant_id, start_time);

-- è¯„è®º
COMMENT ON COLUMN workflow_instance.tenant_id IS 'ç§Ÿæˆ·ID';
COMMENT ON COLUMN workflow_instance.instance_id IS 'å®ä¾‹ID';
COMMENT ON COLUMN workflow_instance.processinstance_id IS 'Flowableæµç¨‹å®ä¾‹ID';
COMMENT ON COLUMN workflow_instance.business_type IS 'ä¸šåŠ¡ç±»å‹ï¼ˆTRANS/LOAN/REPAYMENTï¼‰';
COMMENT ON COLUMN workflow_instance.business_id IS 'ä¸šåŠ¡ID';
```

#### 10.2 workflow_task (æµç¨‹ä»»åŠ¡è¡¨)

```sql
COMMENT ON TABLE workflow_task IS 'æµç¨‹ä»»åŠ¡è¡¨';

CREATE TABLE workflow_task (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    task_id BIGSERIAL NOT NULL,
    
    -- æµç¨‹ä»»åŠ¡ä¿¡æ¯
    task_id_flowable VARCHAR(60) NOT NULL,         -- Flowableä»»åŠ¡ID
    task_name VARCHAR(200) NOT NULL,               -- ä»»åŠ¡åç§°
    task_def_key VARCHAR(100),                      -- ä»»åŠ¡å®šä¹‰key
    task_instance_id VARCHAR(60) NOT NULL,        -- ä»»åŠ¡å®ä¾‹ID
    processinstance_id VARCHAR(60) NOT NULL,       -- æµç¨‹å®ä¾‹ID
    
    -- ä¸šåŠ¡å…³è”
    business_type VARCHAR(50) NOT NULL,             -- ä¸šåŠ¡ç±»å‹
    business_id BIGINT NOT NULL,                    -- ä¸šåŠ¡ID
    
    -- ä»»åŠ¡åˆ†é…
    assignee_type VARCHAR(20) NOT NULL,             -- åˆ†é…ç±»å‹ï¼ˆUSER/GROUP/EXPRESSIONï¼‰
    assignee_value VARCHAR(200),                   -- åˆ†é…å€¼ï¼ˆç”¨æˆ·IDã€ç»„IDã€è¡¨è¾¾å¼ï¼‰
    assignee_id BIGINT,                            -- å®é™…åˆ†é…äººID
    assignee_name VARCHAR(60),                       -- å®é™…åˆ†é…äººå§“å
    
    -- ä»»åŠ¡æ—¶é—´
    create_time TIMESTAMP NOT NULL,                 -- åˆ›å»ºæ—¶é—´
    claim_time TIMESTAMP,                           -- è®¤é¢†æ—¶é—´
    complete_time TIMESTAMP,                         -- å®Œæˆæ—¶é—´
    
    -- ä»»åŠ¡çŠ¶æ€
    state VARCHAR(20) NOT NULL DEFAULT 'PENDING',  -- ä»»åŠ¡çŠ¶æ€ï¼ˆPENDING/CLAIMED/COMPLETED/CANCELLEDï¼‰
    
    -- ä»»åŠ¡å˜é‡
    variables JSONB,                                -- ä»»åŠ¡å˜é‡
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, task_id),
    
    -- å”¯ä¸€çº¦æŸ
    CONSTRAINT uk_workflow_task_flowable UNIQUE (tenant_id, task_id_flowable),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_workflow_task_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id)
);

-- ç´¢å¼•
CREATE INDEX idx_workflow_task_process ON workflow_task(tenant_id, processinstance_id);
CREATE INDEX idx_workflow_task_assignee ON workflow_task(tenant_id, assignee_id);
CREATE INDEX idx_workflow_task_state ON workflow_task(tenant_id, state);
CREATE INDEX idx_workflow_task_business ON workflow_task(tenant_id, business_type, business_id);

-- è¯„è®º
COMMENT ON COLUMN workflow_task.tenant_id IS 'ç§Ÿæˆ·ID';
COMMENT ON COLUMN workflow_task.task_id IS 'ä»»åŠ¡ID';
COMMENT ON COLUMN workflow_task.task_id_flowable IS 'Flowableä»»åŠ¡ID';
COMMENT ON COLUMN workflow_task.task_name IS 'ä»»åŠ¡åç§°';
COMMENT ON COLUMN workflow_task.processinstance_id IS 'æµç¨‹å®ä¾‹ID';
COMMENT ON COLUMN workflow_task.assignee_id IS 'å®é™…åˆ†é…äººID';
COMMENT ON COLUMN workflow_task.state IS 'ä»»åŠ¡çŠ¶æ€';
```

#### 10.3 workflow_approval (å®¡æ‰¹å†å²è¡¨)

```sql
COMMENT ON TABLE workflow_approval IS 'å®¡æ‰¹å†å²è¡¨';

CREATE TABLE workflow_approval (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    approval_id BIGSERIAL NOT NULL,
    
    -- æµç¨‹ä¿¡æ¯
    processinstance_id VARCHAR(60) NOT NULL,       -- æµç¨‹å®ä¾‹ID
    task_id_flowable VARCHAR(60) NOT NULL,         -- Flowableä»»åŠ¡ID
    task_name VARCHAR(200) NOT NULL,               -- ä»»åŠ¡åç§°
    
    -- ä¸šåŠ¡å…³è”
    business_type VARCHAR(50) NOT NULL,             -- ä¸šåŠ¡ç±»å‹
    business_id BIGINT NOT NULL,                    -- ä¸šåŠ¡ID
    
    -- å®¡æ‰¹äººä¿¡æ¯
    approver_id BIGINT NOT NULL,                   -- å®¡æ‰¹äººID
    approver_name VARCHAR(60) NOT NULL,              -- å®¡æ‰¹äººå§“å
    
    -- å®¡æ‰¹æ“ä½œ
    action VARCHAR(20) NOT NULL,                   -- å®¡æ‰¹æ“ä½œï¼ˆAPPROVE/REJECT/DELEGATE/TRANSFERï¼‰
    action_desc VARCHAR(500),                       -- å®¡æ‰¹æ„è§
    
    -- å®¡æ‰¹æ—¶é—´
    approval_time TIMESTAMP NOT NULL,               -- å®¡æ‰¹æ—¶é—´
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, approval_id),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_workflow_approval_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id)
);

-- ç´¢å¼•
CREATE INDEX idx_workflow_approval_process ON workflow_approval(tenant_id, processinstance_id);
CREATE INDEX idx_workflow_approval_approver ON workflow_approval(tenant_id, approver_id);
CREATE INDEX idx_workflow_approval_business ON workflow_approval(tenant_id, business_type, business_id);
CREATE INDEX idx_workflow_approval_time ON workflow_approval(tenant_id, approval_time);

-- è¯„è®º
COMMENT ON COLUMN workflow_approval.tenant_id IS 'ç§Ÿæˆ·ID';
COMMENT ON COLUMN workflow_approval.approval_id IS 'å®¡æ‰¹ID';
COMMENT ON COLUMN workflow_approval.processinstance_id IS 'æµç¨‹å®ä¾‹ID';
COMMENT ON COLUMN workflow_approval.approver_id IS 'å®¡æ‰¹äººID';
COMMENT ON COLUMN workflow_approval.action IS 'å®¡æ‰¹æ“ä½œï¼ˆAPPROVE/REJECT/DELEGATE/TRANSFERï¼‰';
```

### è¡¨å…³ç³»

```
workflow_instance (1) â”€â”€â”€â”€ (N) workflow_task
workflow_instance (N) â”€â”€â”€â”€ (1) trans/loan/repayment
workflow_task (1) â”€â”€â”€â”€ (N) workflow_approval
workflow_task (N) â”€â”€â”€â”€ (1) "user" (assignee)
workflow_approval (N) â”€â”€â”€â”€ (1) "user" (approver)
```

---

## æ¨¡å—11ï¼šé€šçŸ¥ç®¡ç†

### åŠŸèƒ½è§„æ ¼

**æ¨¡å—åç§°**: notification

**åŠŸèƒ½æè¿°**: é€šçŸ¥ç®¡ç†ï¼ŒåŒ…æ‹¬ç³»ç»Ÿé€šçŸ¥ã€å®¡æ‰¹é€šçŸ¥ç­‰

**æ ¸å¿ƒåŠŸèƒ½**:
- é€šçŸ¥å‘é€
- é€šçŸ¥æŸ¥è¯¢
- é€šçŸ¥å·²è¯»/æœªè¯»çŠ¶æ€
- é€šçŸ¥æ¨¡æ¿ç®¡ç†

**ä¸šåŠ¡è§„åˆ™**:
- é€šçŸ¥å¿…é¡»æœ‰æ¥æ”¶äºº
- é€šçŸ¥å¿…é¡»æœ‰é€šçŸ¥ç±»å‹
- é€šçŸ¥å¯ä»¥æ‰¹é‡å‘é€

### æ•°æ®åº“è¡¨è®¾è®¡

#### 11.1 notification (é€šçŸ¥è¡¨)

```sql
COMMENT ON TABLE notification IS 'é€šçŸ¥è¡¨';

-- é€šçŸ¥ç±»å‹æšä¸¾
CREATE TYPE notification_type AS ENUM (
    'SYSTEM',          -- ç³»ç»Ÿé€šçŸ¥
    'APPROVAL',        -- å®¡æ‰¹é€šçŸ¥
    'REMIND',          -- æé†’é€šçŸ¥
    'MESSAGE'           -- æ¶ˆæ¯é€šçŸ¥
);

-- é€šçŸ¥çŠ¶æ€æšä¸¾
CREATE TYPE notification_status AS ENUM (
    'UNREAD',          -- æœªè¯»
    'READ',            -- å·²è¯»
    'DELETED'          -- å·²åˆ é™¤
);

CREATE TABLE notification (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    notification_id BIGSERIAL NOT NULL,
    
    -- é€šçŸ¥ä¿¡æ¯
    notification_type notification_type NOT NULL, -- é€šçŸ¥ç±»å‹
    title VARCHAR(200) NOT NULL,                 -- é€šçŸ¥æ ‡é¢˜
    content TEXT NOT NULL,                        -- é€šçŸ¥å†…å®¹
    link_url VARCHAR(500),                        -- é“¾æ¥URL
    
    -- é€šçŸ¥æ¥æ”¶äºº
    receiver_id BIGINT NOT NULL,                 -- æ¥æ”¶äººID
    receiver_name VARCHAR(60) NOT NULL,            -- æ¥æ”¶äººå§“å
    receiver_org_id BIGINT,                        -- æ¥æ”¶äººç»„ç»‡ID
    
    -- é€šçŸ¥çŠ¶æ€
    status notification_status NOT NULL DEFAULT 'UNREAD', -- é€šçŸ¥çŠ¶æ€
    read_time TIMESTAMP,                            -- é˜…è¯»æ—¶é—´
    
    -- ä¸šåŠ¡å…³è”
    business_type VARCHAR(50),                     -- ä¸šåŠ¡ç±»å‹
    business_id BIGINT,                            -- ä¸šåŠ¡ID
    business_key VARCHAR(100),                      -- ä¸šåŠ¡keyï¼ˆå¦‚æµç¨‹å®ä¾‹IDï¼‰
    
    -- å‘é€æ¸ é“
    channel VARCHAR(50) DEFAULT 'SYSTEM',         -- å‘é€æ¸ é“ï¼ˆSYSTEM/DINGTALK/EMAIL/SMSï¼‰
    channel_status VARCHAR(50),                     -- æ¸ é“çŠ¶æ€
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, notification_id),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_notification_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    CONSTRAINT fk_notification_receiver FOREIGN KEY (tenant_id, receiver_id) REFERENCES "user"(tenant_id, user_id)
);

-- ç´¢å¼•
CREATE INDEX idx_notification_receiver ON notification(tenant_id, receiver_id);
CREATE INDEX idx_notification_type ON notification(tenant_id, notification_type);
CREATE INDEX idx_notification_status ON notification(tenant_id, status);
CREATE INDEX idx_notification_business ON notification(tenant_id, business_type, business_id);
CREATE INDEX idx_notification_time ON notification(tenant_id, created_at);

-- è¯„è®º
COMMENT ON COLUMN notification.tenant_id IS 'ç§Ÿæˆ·ID';
COMMENT ON COLUMN notification.notification_id IS 'é€šçŸ¥ID';
COMMENT ON COLUMN notification.notification_type IS 'é€šçŸ¥ç±»å‹';
COMMENT ON COLUMN notification.receiver_id IS 'æ¥æ”¶äººID';
COMMENT ON COLUMN notification.status IS 'é€šçŸ¥çŠ¶æ€';
COMMENT ON COLUMN notification.business_type IS 'ä¸šåŠ¡ç±»å‹';
COMMENT ON COLUMN notification.business_id IS 'ä¸šåŠ¡ID';
```

### è¡¨å…³ç³»

```
notification (N) â”€â”€â”€â”€ (1) "user" (receiver)
notification (N) â”€â”€â”€â”€ (1) trans/loan/repayment
```

---

## æ¨¡å—12ï¼šå®¡è®¡æ—¥å¿—

### åŠŸèƒ½è§„æ ¼

**æ¨¡å—åç§°**: audit_log

**åŠŸèƒ½æè¿°**: å®¡è®¡æ—¥å¿—ï¼Œè®°å½•æ‰€æœ‰æ“ä½œå†å²

**æ ¸å¿ƒåŠŸèƒ½**:
- æ“ä½œæ—¥å¿—è®°å½•
- æ“ä½œæ—¥å¿—æŸ¥è¯¢
- æ“ä½œæ—¥å¿—å¯¼å‡º

**ä¸šåŠ¡è§„åˆ™**:
- è®°å½•æ‰€æœ‰å†™æ“ä½œ
- è®°å½•æ“ä½œäººã€æ“ä½œæ—¶é—´ã€æ“ä½œå†…å®¹

### æ•°æ®åº“è¡¨è®¾è®¡

#### 12.1 audit_log (å®¡è®¡æ—¥å¿—è¡¨)

```sql
COMMENT ON TABLE audit_log IS 'å®¡è®¡æ—¥å¿—è¡¨';

CREATE TABLE audit_log (
    -- ä¸»é”®
    log_id BIGSERIAL PRIMARY KEY,
    
    -- ç§Ÿæˆ·ä¿¡æ¯
    tenant_id BIGINT NOT NULL,
    
    -- æ“ä½œäººä¿¡æ¯
    operator_id BIGINT NOT NULL,                 -- æ“ä½œäººID
    operator_name VARCHAR(60) NOT NULL,            -- æ“ä½œäººå§“å
    
    -- æ“ä½œä¿¡æ¯
    operation_type VARCHAR(50) NOT NULL,          -- æ“ä½œç±»å‹ï¼ˆCREATE/UPDATE/DELETE/APPROVE/REJECTï¼‰
    operation_module VARCHAR(50) NOT NULL,         -- æ“ä½œæ¨¡å—ï¼ˆTRANS/LOAN/REPAYMENT/USER/ROLEç­‰ï¼‰
    operation_desc VARCHAR(500),                  -- æ“ä½œæè¿°
    
    -- ä¸šåŠ¡å…³è”
    business_type VARCHAR(50),                     -- ä¸šåŠ¡ç±»å‹
    business_id BIGINT,                            -- ä¸šåŠ¡ID
    
    -- å˜æ›´å‰æ•°æ®
    old_value JSONB,                              -- å˜æ›´å‰æ•°æ®
    
    -- å˜æ›´åæ•°æ®
    new_value JSONB,                              -- å˜æ›´åæ•°æ®
    
    -- è¯·æ±‚ä¿¡æ¯
    request_method VARCHAR(10),                    -- è¯·æ±‚æ–¹æ³•ï¼ˆGET/POST/PUT/DELETEï¼‰
    request_url VARCHAR(500),                       -- è¯·æ±‚URL
    request_params JSONB,                          -- è¯·æ±‚å‚æ•°
    
    -- IPå’Œæ—¶é—´
    client_ip VARCHAR(50),                         -- å®¢æˆ·ç«¯IP
    user_agent VARCHAR(500),                        -- User-Agent
    operate_time TIMESTAMP NOT NULL,              -- æ“ä½œæ—¶é—´
    
    -- æ“ä½œç»“æœ
    result VARCHAR(20) NOT NULL,                  -- æ“ä½œç»“æœï¼ˆSUCCESS/FAILUREï¼‰
    error_msg VARCHAR(500),                         -- é”™è¯¯ä¿¡æ¯
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_audit_log_tenant ON audit_log(tenant_id);
CREATE INDEX idx_audit_log_operator ON audit_log(tenant_id, operator_id);
CREATE INDEX idx_audit_log_module ON audit_log(tenant_id, operation_module);
CREATE INDEX idx_audit_log_business ON audit_log(tenant_id, business_type, business_id);
CREATE INDEX idx_audit_log_time ON audit_log(operate_time);
CREATE INDEX idx_audit_log_result ON audit_log(result);

-- è¯„è®º
COMMENT ON COLUMN audit_log.log_id IS 'æ—¥å¿—IDï¼ˆä¸»é”®ï¼‰';
COMMENT ON COLUMN audit_log.tenant_id IS 'ç§Ÿæˆ·ID';
COMMENT ON COLUMN audit_log.operator_id IS 'æ“ä½œäººID';
COMMENT ON COLUMN audit_log.operation_type IS 'æ“ä½œç±»å‹ï¼ˆCREATE/UPDATE/DELETE/APPROVE/REJECTï¼‰';
COMMENT ON COLUMN audit_log.operation_module IS 'æ“ä½œæ¨¡å—ï¼ˆTRANS/LOAN/REPAYMENT/USER/ROLEç­‰ï¼‰';
COMMENT ON COLUMN audit_log.business_type IS 'ä¸šåŠ¡ç±»å‹';
COMMENT ON COLUMN audit_log.business_id IS 'ä¸šåŠ¡ID';
COMMENT ON COLUMN audit_log.old_value IS 'å˜æ›´å‰æ•°æ®';
COMMENT ON COLUMN audit_log.new_value IS 'å˜æ›´åæ•°æ®';
COMMENT ON COLUMN audit_log.result IS 'æ“ä½œç»“æœï¼ˆSUCCESS/FAILUREï¼‰';
```

### è¡¨å…³ç³»

```
audit_log (N) â”€â”€â”€â”€ (1) tenant
audit_log (N) â”€â”€â”€â”€ (1) "user" (operator)
audit_log (N) â”€â”€â”€â”€ (1) trans/loan/repayment (businesså…³è”ï¼‰
```

---

## æ•°æ®åº“è¡¨æ±‡æ€»

### è¡¨æ•°é‡ç»Ÿè®¡

| ç±»åˆ« | è¡¨æ•°é‡ | è¡¨å |
|------|--------|------|
| ç§Ÿæˆ·ç®¡ç† | 1 | tenant |
| ç”¨æˆ·ç®¡ç† | 2 | user, user_role |
| ç»„ç»‡ç®¡ç† | 1 | org |
| è§’è‰²æƒé™ç®¡ç† | 3 | role, perm, role_perm |
| é¡¹ç›®ç®¡ç† | 1 | project |
| æŠ¥é”€ç®¡ç† | 4 | trans, trans_item, charge_item, trans_attach |
| å€Ÿæ¬¾ç®¡ç† | 2 | loan, loan_attach |
| è¿˜æ¬¾ç®¡ç† | 3 | repayment, repayment_sett, repayment_attach |
| åŸºç¡€æ•°æ® | 4 | currency, exchange_rate, trans_type, expense_item_type |
| å·¥ä½œæµç®¡ç† | 3 | workflow_instance, workflow_task, workflow_approval |
| é€šçŸ¥ç®¡ç† | 1 | notification |
| å®¡è®¡æ—¥å¿— | 1 | audit_log |
| **åˆè®¡** | **27** | - |

### Flowableå¼•æ“è¡¨ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰

Flowableå¼•æ“ä¼šè‡ªåŠ¨åˆ›å»º25å¼ è¡¨ï¼ˆact_*ï¼‰ï¼ŒåŒ…æ‹¬ï¼š
- æµç¨‹å®šä¹‰è¡¨ï¼šact_re_procdef, act_re_deployment
- æµç¨‹å®ä¾‹è¡¨ï¼šact_ru_execution, act_ru_variable
- ä»»åŠ¡è¡¨ï¼šact_ru_task, act_ru_identitylink
- å†å²è¡¨ï¼šact_hi_procinst, act_hi_taskinst, act_hi_varinst
- ç­‰ç­‰...

---

## ERå›¾æ±‡æ€»

### æ ¸å¿ƒä¸šåŠ¡æµç¨‹

```
ç§Ÿæˆ·ç®¡ç†
â”œâ”€ tenant
   â”œâ”€ user (N)
   â”‚  â”œâ”€ user_role (N) â”€â”€ role (M)
   â”‚  â”‚                    â””â”€ role_perm (N) â”€â”€ perm (M)
   â”‚  â””â”€ org (1)
   â”‚     â”œâ”€ user (N)
   â”‚     â””â”€ org (N) (çˆ¶å­å…³ç³»ï¼‰
   â”œâ”€ role (N)
   â”‚  â””â”€ role_perm (N) â”€â”€ perm (M)
   â”œâ”€ project (N)
   â”œâ”€ trans (N)
   â”‚  â”œâ”€ trans_item (N)
   â”‚  â”‚  â””â”€ charge_item (N)
   â”‚  â”œâ”€ trans_attach (N)
   â”‚  â””â”€ workflow_instance (1) â”€â”€ workflow_task (N) â”€â”€ workflow_approval (N)
   â”œâ”€ loan (N)
   â”‚  â”œâ”€ loan_attach (N)
   â”‚  â””â”€ workflow_instance (1)
   â”œâ”€ repayment (N)
   â”‚  â”œâ”€ repayment_sett (N) â”€â”€ loan (1)
   â”‚  â”œâ”€ repayment_attach (N)
   â”‚  â””â”€ workflow_instance (1)
   â””â”€ notification (N)

åŸºç¡€æ•°æ®
â”œâ”€ currency (1)
â”‚  â”œâ”€ exchange_rate (N) (src_currency_id)
â”‚  â””â”€ exchange_rate (N) (obj_currency_id)
â”œâ”€ trans_type (1) â”€â”€ trans (N)
â”œâ”€ expense_item_type (1) â”€â”€ charge_item (N)

å®¡è®¡
â””â”€ audit_log (N)
   â”œâ”€ tenant (1)
   â””â”€ "user" (N)
```

---

## ä¸‹ä¸€æ­¥å·¥ä½œ

### éœ€è¦è¡¥å……çš„æ¨¡å—

1. **è¡¨å•ç®¡ç†æ¨¡å—**
   - è¡¨å•é…ç½®è¡¨ï¼ˆJSONæ ¼å¼ï¼‰
   - è¡¨å•å­—æ®µé…ç½®è¡¨
   - è¡¨å•éªŒè¯è§„åˆ™è¡¨

2. **æ’ä»¶ç®¡ç†æ¨¡å—**
   - æ’ä»¶æ³¨å†Œè¡¨
   - æ’ä»¶é…ç½®è¡¨
   - æ’ä»¶ä¾èµ–è¡¨

3. **é…ç½®ç®¡ç†æ¨¡å—**
   - ç³»ç»Ÿé…ç½®è¡¨
   - ç§Ÿæˆ·é…ç½®è¡¨
   - é…ç½®ç‰ˆæœ¬ç®¡ç†

4. **APIç®¡ç†æ¨¡å—**
   - APIæ³¨å†Œè¡¨
   - APIæƒé™è¡¨
   - APIè°ƒç”¨æ—¥å¿—è¡¨

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2026-01-24  
**è¡¨æ•°é‡**: 27å¼ ä¸šåŠ¡è¡¨ + 25å¼ Flowableè¡¨  
**çŠ¶æ€**: è®¾è®¡é˜¶æ®µï¼Œå¾…å®¡é˜…
