# å·¥ä½œæµå®¡æ‰¹æµç¨‹è®¾è®¡

## ğŸ“‹ è®¾è®¡èƒŒæ™¯

æ ¹æ®ä¸šåŠ¡éœ€æ±‚ï¼ŒæŠ¥é”€ç®¡ç†çš„å®¡æ‰¹æµç¨‹å¦‚ä¸‹ï¼š

```
å‘˜å·¥æäº¤ 
  â†’ é¡¹ç›®ç»ç†å®¡æ‰¹
  â†’ éƒ¨é—¨ç»ç†å®¡æ‰¹
  â†’ [æ¡ä»¶åˆ†æ”¯] æ€»ç»ç†å®¡æ‰¹ï¼ˆæ ¹æ®é‡‘é¢é…ç½®å†³å®šï¼‰
  â†’ è´¢åŠ¡å®¡æ ¸
  â†’ å‡ºçº³ä»˜æ¬¾
  â†’ å…³é—­æµç¨‹ï¼Œç”Ÿæˆå‡­è¯
```

---

## ğŸ¯ å®¡æ‰¹æµç¨‹è¯¦ç»†è®¾è®¡

### æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æŠ¥é”€å®¡æ‰¹æµç¨‹                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                           å¼€å§‹
                            â”‚
                            â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   å‘˜å·¥æäº¤    â”‚
                    â”‚  (START)      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  é¡¹ç›®ç»ç†å®¡æ‰¹ â”‚ â—„â”€â”€ å®¡æ‰¹äººï¼šé¡¹ç›®è´Ÿè´£äºº
                    â”‚   (APPROVE)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚               â”‚
                 é€šè¿‡              é©³å›
                    â”‚               â”‚
                    â–¼               â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ éƒ¨é—¨ç»ç†å®¡æ‰¹   â”‚   â”‚  å‘˜å·¥ä¿®æ”¹    â”‚
            â”‚   (APPROVE)   â”‚   â”‚ (UPDATE)      â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                   â”‚
                    â–¼                   â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”           â”‚
            â”‚               â”‚           â”‚
         é€šè¿‡              é©³å›          â”‚
            â”‚               â”‚           â”‚
            â–¼               â–¼           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ é‡‘é¢åˆ¤æ–­ç½‘å…³   â”‚   â”‚  å‘˜å·¥ä¿®æ”¹    â”‚
    â”‚   (GATEWAY)   â”‚   â”‚ (UPDATE)      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
    â”‚               â”‚
  â‰¥é˜ˆå€¼           <é˜ˆå€¼
    â”‚               â”‚
    â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ€»ç»ç†å®¡æ‰¹     â”‚ â”‚  è´¢åŠ¡å®¡æ ¸    â”‚
â”‚   (APPROVE)   â”‚ â”‚  (APPROVE)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                 â”‚
        â”‚             â”Œâ”€â”€â”€â”´â”€â”€â”€â”
        â”‚             â”‚       â”‚
     é€šè¿‡           é€šè¿‡    é©³å›
        â”‚             â”‚       â”‚
        â”‚             â–¼       â–¼
        â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚     â”‚  è´¢åŠ¡å®¡æ ¸    â”‚
        â”‚     â”‚   (APPROVE)   â”‚
        â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚             â”‚
        â”‚             â”‚
        â”‚         â”Œâ”€â”€â”€â”´â”€â”€â”€â”
        â”‚         â”‚       â”‚
        â”‚       é€šè¿‡     é©³å›
        â”‚         â”‚       â”‚
        â”‚         â–¼       â–¼
        â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   â”‚  å‡ºçº³ä»˜æ¬¾    â”‚
        â”‚   â”‚ (PAYMENT)    â”‚
        â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚           â”‚
        â”‚       â”Œâ”€â”€â”€â”´â”€â”€â”€â”
        â”‚       â”‚       â”‚
        â”‚      ä»˜æ¬¾    é€€å›
        â”‚       â”‚       â”‚
        â”‚       â–¼       â–¼
        â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â””â”€â”€â”€â–º  ç”Ÿæˆå‡­è¯ï¼Œå…³é—­æµç¨‹      â”‚
            â”‚     (END)               â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”‘ æµç¨‹å…³é”®èŠ‚ç‚¹å®šä¹‰

### 1. å‘˜å·¥æäº¤ (START)
- **èŠ‚ç‚¹ç±»å‹**: å¼€å§‹äº‹ä»¶
- **æ‰§è¡Œè€…**: ç”³è¯·å‘˜å·¥
- **åŠŸèƒ½**: 
  - å¡«å†™æŠ¥é”€å•
  - ä¸Šä¼ é™„ä»¶
  - æäº¤å®¡æ‰¹
  - æµç¨‹å˜é‡è®¾ç½®:
    - `applicant_id`: ç”³è¯·äººID
    - `project_id`: é¡¹ç›®ID
    - `charge`: æŠ¥é”€é‡‘é¢
    - `dept_id`: éƒ¨é—¨ID

### 2. é¡¹ç›®ç»ç†å®¡æ‰¹ (APPROVE)
- **èŠ‚ç‚¹ç±»å‹**: ç”¨æˆ·ä»»åŠ¡
- **å®¡æ‰¹äºº**: é¡¹ç›®çš„è´Ÿè´£äººï¼ˆä»projectè¡¨è·å–leader_idï¼‰
- **æ“ä½œç±»å‹**: 
  - âœ… é€šè¿‡ â†’ æµè½¬åˆ°éƒ¨é—¨ç»ç†å®¡æ‰¹
  - âŒ é©³å› â†’ æµè½¬åˆ°å‘˜å·¥ä¿®æ”¹
- **å®¡æ‰¹æ—¶é™**: 24å°æ—¶
- **è¶…æ—¶å¤„ç†**: 
  - å‘é€æé†’é€šçŸ¥
  - è¶…è¿‡48å°æ—¶è‡ªåŠ¨è½¬åŠç»™å¤‡é€‰å®¡æ‰¹äºº

### 3. éƒ¨é—¨ç»ç†å®¡æ‰¹ (APPROVE)
- **èŠ‚ç‚¹ç±»å‹**: ç”¨æˆ·ä»»åŠ¡
- **å®¡æ‰¹äºº**: ç”³è¯·äººæ‰€å±éƒ¨é—¨çš„è´Ÿè´£äººï¼ˆä»orgè¡¨è·å–leader_idï¼‰
- **æ“ä½œç±»å‹**:
  - âœ… é€šè¿‡ â†’ æµè½¬åˆ°é‡‘é¢åˆ¤æ–­ç½‘å…³
  - âŒ é©³å› â†’ æµè½¬åˆ°å‘˜å·¥ä¿®æ”¹
- **å®¡æ‰¹æ—¶é™**: 24å°æ—¶
- **è¶…æ—¶å¤„ç†**: åŒé¡¹ç›®ç»ç†å®¡æ‰¹

### 4. é‡‘é¢åˆ¤æ–­ç½‘å…³ (GATEWAY)
- **èŠ‚ç‚¹ç±»å‹**: æ’ä»–ç½‘å…³
- **åˆ¤æ–­æ¡ä»¶**: æŠ¥é”€é‡‘é¢æ˜¯å¦è¶…è¿‡é…ç½®çš„é˜ˆå€¼
- **æµç¨‹å˜é‡**: `charge` (æŠ¥é”€é‡‘é¢)
- **é…ç½®æ¥æº**: ç§Ÿæˆ·çº§åˆ«çš„æŠ¥é”€é‡‘é¢å®¡æ‰¹é˜ˆå€¼é…ç½®
- **åˆ¤æ–­é€»è¾‘**:
  ```java
  if (charge >= tenantConfig.getLoanApprovalThreshold()) {
      // æµå‘æ€»ç»ç†å®¡æ‰¹
      return "æ€»ç»ç†å®¡æ‰¹";
  } else {
      // æµå‘è´¢åŠ¡å®¡æ ¸
      return "è´¢åŠ¡å®¡æ ¸";
  }
  ```
- **é˜ˆå€¼é…ç½®ç¤ºä¾‹**:
  ```json
  {
    "tenant_id": 1,
    "trans_approval_thresholds": {
      "general": 5000,      // ä¸€èˆ¬è´¹ç”¨ â‰¥5000å…ƒéœ€æ€»ç»ç†å®¡æ‰¹
      "travel": 10000,      // å·®æ—…æŠ¥é”€ â‰¥10000å…ƒéœ€æ€»ç»ç†å®¡æ‰¹
      "team_building": 8000 // å›¢å»ºè´¹ç”¨ â‰¥8000å…ƒéœ€æ€»ç»ç†å®¡æ‰¹
    }
  }
  ```

### 5. æ€»ç»ç†å®¡æ‰¹ (APPROVE)
- **èŠ‚ç‚¹ç±»å‹**: ç”¨æˆ·ä»»åŠ¡
- **å®¡æ‰¹äºº**: ç§Ÿæˆ·çº§åˆ«çš„æ€»ç»ç†ï¼ˆä»tenant_configè·å–ï¼‰
- **æ“ä½œç±»å‹**:
  - âœ… é€šè¿‡ â†’ æµå‘è´¢åŠ¡å®¡æ ¸
  - âŒ é©³å› â†’ æµè½¬åˆ°å‘˜å·¥ä¿®æ”¹
- **å®¡æ‰¹æ—¶é™**: 48å°æ—¶
- **è¶…æ—¶å¤„ç†**: 
  - å‘é€ç´§æ€¥é€šçŸ¥ç»™æ€»ç»ç†
  - å‘é€æé†’ç»™ç”³è¯·äºº

### 6. è´¢åŠ¡å®¡æ ¸ (APPROVE)
- **èŠ‚ç‚¹ç±»å‹**: ç”¨æˆ·ä»»åŠ¡
- **å®¡æ‰¹äºº**: è´¢åŠ¡éƒ¨é—¨äººå‘˜ï¼ˆè§’è‰²ï¼šFINANCEï¼‰
- **æ“ä½œç±»å‹**:
  - âœ… é€šè¿‡ â†’ æµå‘å‡ºçº³ä»˜æ¬¾
  - âŒ é©³å› â†’ æµè½¬åˆ°å‘˜å·¥ä¿®æ”¹
- **å®¡æ ¸å†…å®¹**:
  - å‘ç¥¨çœŸå®æ€§
  - é‡‘é¢å‡†ç¡®æ€§
  - è´¹ç”¨åˆè§„æ€§
- **å®¡æ‰¹æ—¶é™**: 48å°æ—¶
- **è¶…æ—¶å¤„ç†**: å‘é€æé†’ç»™è´¢åŠ¡æ€»ç›‘

### 7. å‡ºçº³ä»˜æ¬¾ (PAYMENT)
- **èŠ‚ç‚¹ç±»å‹**: ç”¨æˆ·ä»»åŠ¡
- **æ‰§è¡Œäºº**: å‡ºçº³äººå‘˜ï¼ˆè§’è‰²ï¼šCASHIERï¼‰
- **æ“ä½œç±»å‹**:
  - âœ… ç¡®è®¤ä»˜æ¬¾ â†’ ç”Ÿæˆå‡­è¯ï¼Œå…³é—­æµç¨‹
  - âŒ é€€å› â†’ æµå‘å‘˜å·¥ä¿®æ”¹
- **ä»˜æ¬¾å†…å®¹**:
  - å®ä»˜é‡‘é¢: `payable_amount = lc_charge - loan_offset_amount`
  - ä»˜æ¬¾æ–¹å¼: é“¶è¡Œè½¬è´¦/ç°é‡‘
  - ä»˜æ¬¾è´¦æˆ·: å‘˜å·¥å·¥èµ„è´¦æˆ·
- **ä»˜æ¬¾æ—¶é™**: 24å°æ—¶
- **è¶…æ—¶å¤„ç†**: å‘é€ç´§æ€¥é€šçŸ¥ç»™è´¢åŠ¡ç»ç†

### 8. å‘˜å·¥ä¿®æ”¹ (UPDATE)
- **èŠ‚ç‚¹ç±»å‹**: ç”¨æˆ·ä»»åŠ¡
- **æ‰§è¡Œè€…**: ç”³è¯·å‘˜å·¥
- **æ“ä½œç±»å‹**: 
  - âœ… é‡æ–°æäº¤ â†’ æµè½¬åˆ°é¡¹ç›®ç»ç†å®¡æ‰¹
  - âŒ æ’¤é”€ç”³è¯· â†’ ç»“æŸæµç¨‹
- **ä¿®æ”¹æƒé™**: 
  - å¯ä»¥ä¿®æ”¹æŠ¥é”€å•å†…å®¹ï¼ˆè‰ç¨¿çŠ¶æ€ï¼‰
  - å¯ä»¥ä¿®æ”¹é™„ä»¶
  - å¯ä»¥è°ƒæ•´é‡‘é¢
- **ä¿®æ”¹é™åˆ¶**: 
  - å®¡æ‰¹é€šè¿‡åçš„èŠ‚ç‚¹ä¸å¯ä¿®æ”¹
  - åªèƒ½å›åˆ°é©³å›èŠ‚ç‚¹é‡æ–°æäº¤

### 9. ç”Ÿæˆå‡­è¯ï¼Œå…³é—­æµç¨‹ (END)
- **èŠ‚ç‚¹ç±»å‹**: ç»“æŸäº‹ä»¶
- **æ‰§è¡ŒåŠŸèƒ½**:
  - ç”Ÿæˆè´¢åŠ¡å‡­è¯
  - æ›´æ–°æŠ¥é”€å•çŠ¶æ€ä¸ºå·²ç»“ç®—ï¼ˆSETTLEDï¼‰
  - è®°å½•ç»“ç®—æ—¥æœŸ
  - è®°å½•ç»“ç®—äºº
  - ç”Ÿæˆç»“ç®—å•å·
  - å‘é€å®Œæˆé€šçŸ¥ç»™ç”³è¯·äºº
- **å‡­è¯å†…å®¹**:
  ```json
  {
    "voucher_no": "PZ202501240001",
    "trans_no": "BX202501240001",
    "voucher_date": "2025-01-24",
    "voucher_type": "æŠ¥é”€ä»˜æ¬¾",
    "amount": 5000.00,
    "account_code": "6601.01",  // ç®¡ç†è´¹ç”¨-å·®æ—…è´¹
    "applicant_id": 1001,
    "project_id": 2001
  }
  ```

---

## ğŸ“Š æµç¨‹å˜é‡å®šä¹‰

### å…¨å±€æµç¨‹å˜é‡

| å˜é‡å | ç±»å‹ | è¯´æ˜ | ä½œç”¨åŸŸ |
|--------|------|------|--------|
| transId | Long | æŠ¥é”€å•ID | å…¨å±€ |
| transNo | String | æŠ¥é”€å•å· | å…¨å±€ |
| tenantId | Long | ç§Ÿæˆ·ID | å…¨å±€ |
| applicantId | Long | ç”³è¯·äººID | å…¨å±€ |
| projectId | Long | é¡¹ç›®ID | å…¨å±€ |
| deptId | Long | éƒ¨é—¨ID | å…¨å±€ |
| charge | BigDecimal | æŠ¥é”€é‡‘é¢ | å…¨å±€ |
| lcCharge | BigDecimal | æœ¬å¸é‡‘é¢ | å…¨å±€ |
| loanOffsetAmount | BigDecimal | å€Ÿæ¬¾æŠµæ‰£é‡‘é¢ | å…¨å±€ |
| payableAmount | BigDecimal | å®ä»˜é‡‘é¢ | å…¨å±€ |
| currency | String | å¸ç§ | å…¨å±€ |
| exchangeRate | BigDecimal | æ±‡ç‡ | å…¨å±€ |
| transType | String | æŠ¥é”€ç±»å‹ | å…¨å±€ |
| transReason | String | æŠ¥é”€åŸå›  | å…¨å±€ |
| submitTime | LocalDateTime | æäº¤æ—¶é—´ | å…¨å±€ |
| approvalThreshold | BigDecimal | å®¡æ‰¹é˜ˆå€¼ | å…¨å±€ |
| currentApprover | String | å½“å‰å®¡æ‰¹äºº | å±€éƒ¨ |
| lastApprovalAction | String | ä¸Šä¸€æ¬¡å®¡æ‰¹æ“ä½œ | å…¨å±€ |
| lastApprovalComment | String | ä¸Šä¸€æ¬¡å®¡æ‰¹æ„è§ | å…¨å±€ |
| modificationCount | Integer | ä¿®æ”¹æ¬¡æ•° | å…¨å±€ |
| rejectCount | Integer | é©³å›æ¬¡æ•° | å…¨å±€ |

### èŠ‚ç‚¹å±€éƒ¨å˜é‡

#### é¡¹ç›®ç»ç†å®¡æ‰¹èŠ‚ç‚¹
- `approvalResult`: å®¡æ‰¹ç»“æœï¼ˆAPPROVE/REJECTï¼‰
- `approvalComment`: å®¡æ‰¹æ„è§
- `approvalTime`: å®¡æ‰¹æ—¶é—´

#### éƒ¨é—¨ç»ç†å®¡æ‰¹èŠ‚ç‚¹
- åŒé¡¹ç›®ç»ç†

#### æ€»ç»ç†å®¡æ‰¹èŠ‚ç‚¹
- åŒé¡¹ç›®ç»ç†

#### è´¢åŠ¡å®¡æ ¸èŠ‚ç‚¹
- `approvalResult`: å®¡æ‰¹ç»“æœï¼ˆAPPROVE/REJECTï¼‰
- `approvalComment`: å®¡æ‰¹æ„è§
- `auditRemarks`: å®¡æ ¸å¤‡æ³¨
- `attachments`: å®¡æ ¸é™„ä»¶

#### å‡ºçº³ä»˜æ¬¾èŠ‚ç‚¹
- `paymentResult`: ä»˜æ¬¾ç»“æœï¼ˆPAID/RETURNï¼‰
- `paymentMethod`: ä»˜æ¬¾æ–¹å¼ï¼ˆBANK/CASHï¼‰
- `paymentAccount`: ä»˜æ¬¾è´¦æˆ·
- `paymentVoucherNo`: ä»˜æ¬¾å‡­è¯å·
- `paymentTime`: ä»˜æ¬¾æ—¶é—´

---

## ğŸ¨ BPMNæµç¨‹å®šä¹‰æ–‡ä»¶

```xml
<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
             xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC"
             xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI"
             xmlns:flowable="http://flowable.org/bpmn"
             targetNamespace="http://www.flowable.org/processdef">
    
    <process id="reimbursementApprovalProcess" name="æŠ¥é”€å®¡æ‰¹æµç¨‹" isExecutable="true">
        
        <!-- å¼€å§‹äº‹ä»¶ -->
        <startEvent id="start" name="å‘˜å·¥æäº¤"/>
        
        <!-- é¡¹ç›®ç»ç†å®¡æ‰¹ -->
        <userTask id="projectManagerApproval" name="é¡¹ç›®ç»ç†å®¡æ‰¹">
            <extensionElements>
                <flowable:taskListener event="create" class="com.fs.workflow.listener.ProjectManagerTaskListener"/>
                <flowable:candidateUsers>${projectManagerId}</flowable:candidateUsers>
            </extensionElements>
        </userTask>
        
        <!-- éƒ¨é—¨ç»ç†å®¡æ‰¹ -->
        <userTask id="deptManagerApproval" name="éƒ¨é—¨ç»ç†å®¡æ‰¹">
            <extensionElements>
                <flowable:taskListener event="create" class="com.fs.workflow.listener.DeptManagerTaskListener"/>
                <flowable:candidateUsers>${deptManagerId}</flowable:candidateUsers>
            </extensionElements>
        </userTask>
        
        <!-- é‡‘é¢åˆ¤æ–­ç½‘å…³ -->
        <exclusiveGateway id="amountGateway" name="é‡‘é¢åˆ¤æ–­"/>
        
        <!-- æ€»ç»ç†å®¡æ‰¹ -->
        <userTask id="gmApproval" name="æ€»ç»ç†å®¡æ‰¹">
            <extensionElements>
                <flowable:taskListener event="create" class="com.fs.workflow.listener.GMTaskListener"/>
                <flowable:candidateUsers>${generalManagerId}</flowable:candidateUsers>
            </extensionElements>
        </userTask>
        
        <!-- è´¢åŠ¡å®¡æ ¸ -->
        <userTask id="financeAudit" name="è´¢åŠ¡å®¡æ ¸">
            <extensionElements>
                <flowable:taskListener event="create" class="com.fs.workflow.listener.FinanceTaskListener"/>
                <flowable:candidateGroups>FINANCE</flowable:candidateGroups>
            </extensionElements>
        </userTask>
        
        <!-- å‡ºçº³ä»˜æ¬¾ -->
        <userTask id="cashierPayment" name="å‡ºçº³ä»˜æ¬¾">
            <extensionElements>
                <flowable:taskListener event="create" class="com.fs.workflow.listener.CashierTaskListener"/>
                <flowable:candidateGroups>CASHIER</flowable:candidateGroups>
            </extensionElements>
        </userTask>
        
        <!-- å‘˜å·¥ä¿®æ”¹ -->
        <userTask id="employeeUpdate" name="å‘˜å·¥ä¿®æ”¹">
            <extensionElements>
                <flowable:taskListener event="create" class="com.fs.workflow.listener.EmployeeUpdateTaskListener"/>
                <flowable:assignee>${applicantId}</flowable:assignee>
            </extensionElements>
        </userTask>
        
        <!-- ç»“æŸäº‹ä»¶ -->
        <endEvent id="end" name="ç”Ÿæˆå‡­è¯ï¼Œå…³é—­æµç¨‹">
            <extensionElements>
                <flowable:executionListener event="end" class="com.fs.workflow.listener.VoucherGenerationListener"/>
            </extensionElements>
        </endEvent>
        
        <!-- æµç¨‹è¿çº¿ -->
        <sequenceFlow id="flow1" sourceRef="start" targetRef="projectManagerApproval"/>
        
        <sequenceFlow id="flow2" sourceRef="projectManagerApproval" targetRef="deptManagerApproval">
            <conditionExpression xsi:type="tFormalExpression">
                ${approvalResult == 'APPROVE'}
            </conditionExpression>
        </sequenceFlow>
        
        <sequenceFlow id="flow3" sourceRef="projectManagerApproval" targetRef="employeeUpdate">
            <conditionExpression xsi:type="tFormalExpression">
                ${approvalResult == 'REJECT'}
            </conditionExpression>
        </sequenceFlow>
        
        <sequenceFlow id="flow4" sourceRef="deptManagerApproval" targetRef="amountGateway">
            <conditionExpression xsi:type="tFormalExpression">
                ${approvalResult == 'APPROVE'}
            </conditionExpression>
        </sequenceFlow>
        
        <sequenceFlow id="flow5" sourceRef="deptManagerApproval" targetRef="employeeUpdate">
            <conditionExpression xsi:type="tFormalExpression">
                ${approvalResult == 'REJECT'}
            </conditionExpression>
        </sequenceFlow>
        
        <sequenceFlow id="flow6" sourceRef="amountGateway" targetRef="gmApproval">
            <conditionExpression xsi:type="tFormalExpression">
                ${charge >= approvalThreshold}
            </conditionExpression>
        </sequenceFlow>
        
        <sequenceFlow id="flow7" sourceRef="amountGateway" targetRef="financeAudit">
            <conditionExpression xsi:type="tFormalExpression">
                ${charge < approvalThreshold}
            </conditionExpression>
        </sequenceFlow>
        
        <sequenceFlow id="flow8" sourceRef="gmApproval" targetRef="financeAudit">
            <conditionExpression xsi:type="tFormalExpression">
                ${approvalResult == 'APPROVE'}
            </conditionExpression>
        </sequenceFlow>
        
        <sequenceFlow id="flow9" sourceRef="gmApproval" targetRef="employeeUpdate">
            <conditionExpression xsi:type="tFormalExpression">
                ${approvalResult == 'REJECT'}
            </conditionExpression>
        </sequenceFlow>
        
        <sequenceFlow id="flow10" sourceRef="financeAudit" targetRef="cashierPayment">
            <conditionExpression xsi:type="tFormalExpression">
                ${approvalResult == 'APPROVE'}
            </conditionExpression>
        </sequenceFlow>
        
        <sequenceFlow id="flow11" sourceRef="financeAudit" targetRef="employeeUpdate">
            <conditionExpression xsi:type="tFormalExpression">
                ${approvalResult == 'REJECT'}
            </conditionExpression>
        </sequenceFlow>
        
        <sequenceFlow id="flow12" sourceRef="cashierPayment" targetRef="end">
            <conditionExpression xsi:type="tFormalExpression">
                ${paymentResult == 'PAID'}
            </conditionExpression>
        </sequenceFlow>
        
        <sequenceFlow id="flow13" sourceRef="cashierPayment" targetRef="employeeUpdate">
            <conditionExpression xsi:type="tFormalExpression">
                ${paymentResult == 'RETURN'}
            </conditionExpression>
        </sequenceFlow>
        
        <sequenceFlow id="flow14" sourceRef="employeeUpdate" targetRef="projectManagerApproval">
            <conditionExpression xsi:type="tFormalExpression">
                ${submitAction == 'RESUBMIT'}
            </conditionExpression>
        </sequenceFlow>
        
    </process>
</definitions>
```

---

## ğŸ”§ ä»»åŠ¡ç›‘å¬å™¨å®ç°

### 1. é¡¹ç›®ç»ç†ä»»åŠ¡ç›‘å¬å™¨

```java
@Component
public class ProjectManagerTaskListener implements TaskListener {
    
    @Autowired
    private ProjectService projectService;
    
    @Autowired
    private NotificationService notificationService;
    
    @Override
    public void notify(DelegateTask delegateTask) {
        Long transId = (Long) delegateTask.getVariable("transId");
        Long projectId = (Long) delegateTask.getVariable("projectId");
        
        // æŸ¥è¯¢é¡¹ç›®è´Ÿè´£äºº
        Project project = projectService.getById(projectId);
        Long managerId = project.getLeaderId();
        
        // è®¾ç½®å®¡æ‰¹äºº
        delegateTask.setVariable("projectManagerId", managerId);
        delegateTask.setAssignee(managerId.toString());
        
        // å‘é€å®¡æ‰¹é€šçŸ¥
        notificationService.sendApprovalNotification(
            managerId, 
            "å¾…å®¡æ‰¹æŠ¥é”€å•", 
            "æ‚¨æœ‰ä¸€ç¬”æŠ¥é”€å•éœ€è¦å®¡æ‰¹ï¼Œé‡‘é¢: " + delegateTask.getVariable("charge")
        );
        
        // è®¾ç½®ä»»åŠ¡è¶…æ—¶æ—¶é—´ï¼ˆ24å°æ—¶ï¼‰
        delegateTask.setDueDate(DateUtils.addHours(new Date(), 24));
    }
}
```

### 2. éƒ¨é—¨ç»ç†ä»»åŠ¡ç›‘å¬å™¨

```java
@Component
public class DeptManagerTaskListener implements TaskListener {
    
    @Autowired
    private OrgService orgService;
    
    @Autowired
    private NotificationService notificationService;
    
    @Override
    public void notify(DelegateTask delegateTask) {
        Long transId = (Long) delegateTask.getVariable("transId");
        Long deptId = (Long) delegateTask.getVariable("deptId");
        
        // æŸ¥è¯¢éƒ¨é—¨è´Ÿè´£äºº
        Org dept = orgService.getById(deptId);
        Long managerId = dept.getLeaderId();
        
        // è®¾ç½®å®¡æ‰¹äºº
        delegateTask.setVariable("deptManagerId", managerId);
        delegateTask.setAssignee(managerId.toString());
        
        // å‘é€å®¡æ‰¹é€šçŸ¥
        notificationService.sendApprovalNotification(
            managerId, 
            "å¾…å®¡æ‰¹æŠ¥é”€å•", 
            "æ‚¨æœ‰ä¸€ç¬”æŠ¥é”€å•éœ€è¦å®¡æ‰¹ï¼Œé‡‘é¢: " + delegateTask.getVariable("charge")
        );
        
        // è®¾ç½®ä»»åŠ¡è¶…æ—¶æ—¶é—´ï¼ˆ24å°æ—¶ï¼‰
        delegateTask.setDueDate(DateUtils.addHours(new Date(), 24));
    }
}
```

### 3. é‡‘é¢åˆ¤æ–­ç½‘å…³ç›‘å¬å™¨

```java
@Component
public class AmountGatewayListener implements ExecutionListener {
    
    @Autowired
    private TenantConfigService tenantConfigService;
    
    @Override
    public void notify(DelegateExecution execution) {
        Long tenantId = execution.getVariable("tenantId", Long.class);
        BigDecimal charge = execution.getVariable("charge", BigDecimal.class);
        String transType = execution.getVariable("transType", String.class);
        
        // æŸ¥è¯¢ç§Ÿæˆ·é…ç½®çš„å®¡æ‰¹é˜ˆå€¼
        TenantConfig config = tenantConfigService.getByTenantId(tenantId);
        BigDecimal threshold = config.getTransApprovalThreshold(transType);
        
        // è®¾ç½®æµç¨‹å˜é‡
        execution.setVariable("approvalThreshold", threshold);
    }
}
```

### 4. å‡­è¯ç”Ÿæˆç›‘å¬å™¨

```java
@Component
public class VoucherGenerationListener implements ExecutionListener {
    
    @Autowired
    private VoucherService voucherService;
    
    @Autowired
    private TransService transService;
    
    @Override
    public void notify(DelegateExecution execution) {
        Long transId = execution.getVariable("transId", Long.class);
        
        // ç”Ÿæˆè´¢åŠ¡å‡­è¯
        Voucher voucher = voucherService.generateVoucher(transId);
        
        // æ›´æ–°æŠ¥é”€å•çŠ¶æ€
        transService.updateStatus(transId, TransState.SETTLED);
        
        // è®°å½•å‡­è¯å·åˆ°æµç¨‹å˜é‡
        execution.setVariable("voucherNo", voucher.getVoucherNo());
    }
}
```

---

## ğŸ“‹ å®¡æ‰¹é˜ˆå€¼é…ç½®è¡¨

### ç§Ÿæˆ·å®¡æ‰¹é˜ˆå€¼é…ç½®è¡¨ (tenant_approval_config)

```sql
COMMENT ON TABLE tenant_approval_config IS 'ç§Ÿæˆ·å®¡æ‰¹é˜ˆå€¼é…ç½®è¡¨';

CREATE TABLE tenant_approval_config (
    -- ä¸»é”®å’Œç§Ÿæˆ·ID
    tenant_id BIGINT NOT NULL,
    config_id BIGSERIAL NOT NULL,
    
    -- æŠ¥é”€ç±»å‹é˜ˆå€¼
    general_threshold NUMERIC(12,2) DEFAULT 5000,         -- ä¸€èˆ¬è´¹ç”¨é˜ˆå€¼
    travel_threshold NUMERIC(12,2) DEFAULT 10000,          -- å·®æ—…æŠ¥é”€é˜ˆå€¼
    team_building_threshold NUMERIC(12,2) DEFAULT 8000,   -- å›¢å»ºè´¹ç”¨é˜ˆå€¼
    domestic_transport_threshold NUMERIC(12,2) DEFAULT 3000, -- å¸‚å†…äº¤é€šé˜ˆå€¼
    personal_comm_threshold NUMERIC(12,2) DEFAULT 2000,   -- ä¸ªäººé€šè®¯é˜ˆå€¼
    business_activity_threshold NUMERIC(12,2) DEFAULT 5000,-- ä¸šåŠ¡æ´»åŠ¨é˜ˆå€¼
    
    -- å€Ÿæ¬¾ç±»å‹é˜ˆå€¼
    loan_general_threshold NUMERIC(12,2) DEFAULT 10000,   -- ä¸€èˆ¬å€Ÿæ¬¾é˜ˆå€¼
    loan_travel_threshold NUMERIC(12,2) DEFAULT 20000,    -- å·®æ—…å€Ÿæ¬¾é˜ˆå€¼
    
    -- æ€»ç»ç†ID
    general_manager_id BIGINT,                             -- æ€»ç»ç†ID
    
    -- å®¡è®¡å­—æ®µ
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    -- ä¸»é”®çº¦æŸ
    PRIMARY KEY (tenant_id, config_id),
    
    -- å¤–é”®çº¦æŸ
    CONSTRAINT fk_tenant_approval_tenant FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    CONSTRAINT fk_tenant_approval_gm FOREIGN KEY (tenant_id, general_manager_id) 
        REFERENCES "user"(tenant_id, user_id)
);

-- ç´¢å¼•
CREATE INDEX idx_tenant_approval_tenant ON tenant_approval_config(tenant_id);

-- æ³¨é‡Š
COMMENT ON COLUMN tenant_approval_config.tenant_id IS 'ç§Ÿæˆ·ID';
COMMENT ON COLUMN tenant_approval_config.config_id IS 'é…ç½®ID';
COMMENT ON COLUMN tenant_approval_config.general_threshold IS 'ä¸€èˆ¬è´¹ç”¨é˜ˆå€¼';
COMMENT ON COLUMN tenant_approval_config.travel_threshold IS 'å·®æ—…æŠ¥é”€é˜ˆå€¼';
COMMENT ON COLUMN tenant_approval_config.general_manager_id IS 'æ€»ç»ç†ID';
```

---

## ğŸš€ ä¸‹ä¸€æ­¥è®¾è®¡

åŸºäºè¿™ä¸ªå®¡æ‰¹æµç¨‹ï¼Œæ¥ä¸‹æ¥éœ€è¦è®¾è®¡ï¼š

1. **æ¨¡å—10ï¼šå·¥ä½œæµç®¡ç†** - æä¾›æµç¨‹å®šä¹‰ã€æµç¨‹å®ä¾‹ã€ä»»åŠ¡ç®¡ç†ç­‰åŠŸèƒ½
2. **æ¨¡å—8ï¼šå€Ÿæ¬¾ç®¡ç†** - å€Ÿæ¬¾å®¡æ‰¹æµç¨‹ï¼ˆç±»ä¼¼ä½†æ›´ç®€å•ï¼‰
3. **æ¨¡å—9ï¼šè¿˜æ¬¾ç®¡ç†** - è¿˜æ¬¾å®¡æ‰¹æµç¨‹ï¼ˆæœ€ç®€å•ï¼‰

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-01-24  
**çŠ¶æ€**: âœ… å·²å®Œæˆ
