# å·¥ä½œæµå®¡æ‰¹æµç¨‹è®¾è®¡ï¼ˆä¼˜åŒ–ç‰ˆï¼‰

## ğŸ“‹ è®¾è®¡èƒŒæ™¯

æ ¹æ®ä¸šåŠ¡éœ€æ±‚ï¼ŒæŠ¥é”€ç®¡ç†çš„å®¡æ‰¹æµç¨‹å¦‚ä¸‹ï¼š

```
å‘˜å·¥æäº¤ 
  â†’ é¡¹ç›®ç»ç†å®¡æ‰¹
  â†’ [æ™ºèƒ½åˆ¤æ–­] éƒ¨é—¨ç»ç†å®¡æ‰¹ï¼ˆå¦‚æœé¡¹ç›®ç»ç†â‰ éƒ¨é—¨ç»ç†ï¼‰
  â†’ [æ¡ä»¶åˆ†æ”¯] æ€»ç»ç†å®¡æ‰¹ï¼ˆæ ¹æ®é‡‘é¢é…ç½®å†³å®šï¼‰
  â†’ è´¢åŠ¡å®¡æ ¸
  â†’ å‡ºçº³ä»˜æ¬¾
  â†’ å…³é—­æµç¨‹ï¼Œç”Ÿæˆå‡­è¯
```

---

## ğŸ¯ æ ¸å¿ƒä¼˜åŒ–è§„åˆ™

### ä¼˜åŒ–è§„åˆ™1ï¼šé¡¹ç›®ç»ç†å’Œéƒ¨é—¨ç»ç†ä¸ºåŒä¸€äººæ—¶åªå®¡æ‰¹ä¸€æ¬¡

**ä¸šåŠ¡åœºæ™¯**ï¼š
- é¡¹ç›®ç»ç†åŒæ—¶ä¹Ÿæ˜¯éƒ¨é—¨è´Ÿè´£äºº
- é¿å…åŒä¸€äººé‡å¤å®¡æ‰¹
- æé«˜å®¡æ‰¹æ•ˆç‡

**å®ç°æ–¹å¼**ï¼š
- åœ¨é¡¹ç›®ç»ç†å®¡æ‰¹å®Œæˆçš„ç›‘å¬å™¨ä¸­åˆ¤æ–­
- å¦‚æœé¡¹ç›®ç»ç†ID = éƒ¨é—¨ç»ç†IDï¼Œåˆ™è‡ªåŠ¨å®Œæˆéƒ¨é—¨ç»ç†å®¡æ‰¹ä»»åŠ¡
- è‡ªåŠ¨è®¾ç½®ç›¸åŒçš„å®¡æ‰¹æ„è§å’Œå®¡æ‰¹æ—¶é—´

**åˆ¤æ–­é€»è¾‘**ï¼š
```java
// é¡¹ç›®ç»ç†å®¡æ‰¹å®Œæˆåçš„åˆ¤æ–­
Long projectManagerId = project.getLeaderId();
Long deptManagerId = dept.getLeaderId();

if (projectManagerId.equals(deptManagerId)) {
    // è‡ªåŠ¨å®Œæˆéƒ¨é—¨ç»ç†å®¡æ‰¹ä»»åŠ¡
    autoCompleteDeptManagerTask(taskId, approvalResult, approvalComment);
    // ç›´æ¥è·³è½¬åˆ°é‡‘é¢åˆ¤æ–­ç½‘å…³
}
```

**å®¡æ‰¹æµç¨‹ä¼˜åŒ–å**ï¼š

```
é¡¹ç›®ç»ç†å®¡æ‰¹
    â”‚
    â”œâ”€â”€â”€ é¡¹ç›®ç»ç† â‰  éƒ¨é—¨ç»ç† â”€â”€â†’ éƒ¨é—¨ç»ç†å®¡æ‰¹ â”€â”€â†’ é‡‘é¢åˆ¤æ–­ç½‘å…³
    â”‚
    â””â”€â”€â”€ é¡¹ç›®ç»ç† = éƒ¨é—¨ç»ç† â”€â”€â†’ é‡‘é¢åˆ¤æ–­ç½‘å…³ï¼ˆè‡ªåŠ¨è·³è¿‡éƒ¨é—¨ç»ç†å®¡æ‰¹ï¼‰
```

---

## ğŸ¯ ä¼˜åŒ–åçš„æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æŠ¥é”€å®¡æ‰¹æµç¨‹ï¼ˆä¼˜åŒ–ç‰ˆï¼‰                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                           å¼€å§‹
                            â”‚
                            â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   å‘˜å·¥æäº¤    â”‚
                    â”‚  (START)      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  é¡¹ç›®ç»ç†å®¡æ‰¹ â”‚ â—„â”€â”€ å®¡æ‰¹äººï¼šé¡¹ç›®è´Ÿè´£äºº
                    â”‚   (APPROVE)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚               â”‚
                 é€šè¿‡              é©³å›
                    â”‚               â”‚
                    â–¼               â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚æ™ºèƒ½åˆ¤æ–­ï¼š     â”‚   â”‚  å‘˜å·¥ä¿®æ”¹    â”‚
            â”‚é¡¹ç›®ç»ç†=éƒ¨é—¨ç»ç†?â”‚   â”‚ (UPDATE)      â”‚
            â”‚ (DECISION)    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
            â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
                    â”‚                   â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”           â”‚
            â”‚               â”‚           â”‚
          æ˜¯(=)          å¦(â‰ )         â”‚
            â”‚               â”‚           â”‚
            â–¼               â–¼           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ é‡‘é¢åˆ¤æ–­ç½‘å…³   â”‚ â”‚ éƒ¨é—¨ç»ç†å®¡æ‰¹   â”‚
    â”‚   (GATEWAY)   â”‚ â”‚   (APPROVE)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                   â”‚
            â”‚             â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
            â”‚             â”‚           â”‚
            â”‚           é€šè¿‡         é©³å›
            â”‚             â”‚           â”‚
            â”‚             â–¼           â–¼
            â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚     â”‚  é‡‘é¢åˆ¤æ–­ç½‘å…³   â”‚
            â”‚     â”‚   (GATEWAY)   â”‚
            â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚             â”‚
            â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
            â”‚     â”‚               â”‚
            â”‚   â‰¥é˜ˆå€¼           <é˜ˆå€¼
            â”‚     â”‚               â”‚
            â”‚     â–¼               â–¼
            â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ â”‚ æ€»ç»ç†å®¡æ‰¹     â”‚ â”‚  è´¢åŠ¡å®¡æ ¸    â”‚
            â”‚ â”‚   (APPROVE)   â”‚ â”‚  (APPROVE)   â”‚
            â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚         â”‚                 â”‚
            â”‚         â”‚             â”Œâ”€â”€â”€â”´â”€â”€â”€â”
            â”‚         â”‚             â”‚       â”‚
            â”‚       é€šè¿‡           é€šè¿‡    é©³å›
            â”‚         â”‚             â”‚       â”‚
            â”‚         â–¼             â–¼       â–¼
            â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   â”‚  è´¢åŠ¡å®¡æ ¸    â”‚
            â”‚   â”‚   (APPROVE)   â”‚
            â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚           â”‚
            â”‚       â”Œâ”€â”€â”€â”´â”€â”€â”€â”
            â”‚       â”‚       â”‚
            â”‚     é€šè¿‡     é©³å›
            â”‚       â”‚       â”‚
            â”‚       â–¼       â–¼
            â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   â”‚  å‡ºçº³ä»˜æ¬¾    â”‚
            â”‚   â”‚ (PAYMENT)    â”‚
            â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚           â”‚
            â”‚       â”Œâ”€â”€â”€â”´â”€â”€â”€â”
            â”‚       â”‚       â”‚
            â”‚      ä»˜æ¬¾    é€€å›
            â”‚       â”‚       â”‚
            â”‚       â–¼       â–¼
            â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â””â”€â”€â”€â–º  ç”Ÿæˆå‡­è¯ï¼Œå…³é—­æµç¨‹      â”‚
                â”‚     (END)               â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”‘ ä¼˜åŒ–åçš„æµç¨‹å…³é”®èŠ‚ç‚¹å®šä¹‰

### 1. å‘˜å·¥æäº¤ (START)
- **èŠ‚ç‚¹ç±»å‹**: å¼€å§‹äº‹ä»¶
- **æ‰§è¡Œè€…**: ç”³è¯·å‘˜å·¥
- **åŠŸèƒ½**: 
  - å¡«å†™æŠ¥é”€å•
  - ä¸Šä¼ é™„ä»¶
  - æäº¤å®¡æ‰¹
  - æµç¨‹å˜é‡è®¾ç½®

### 2. é¡¹ç›®ç»ç†å®¡æ‰¹ (APPROVE) - ä¼˜åŒ–èŠ‚ç‚¹
- **èŠ‚ç‚¹ç±»å‹**: ç”¨æˆ·ä»»åŠ¡
- **å®¡æ‰¹äºº**: é¡¹ç›®çš„è´Ÿè´£äººï¼ˆä»projectè¡¨è·å–leader_idï¼‰
- **æ“ä½œç±»å‹**: 
  - âœ… é€šè¿‡ â†’ æµè½¬åˆ°æ™ºèƒ½åˆ¤æ–­èŠ‚ç‚¹
  - âŒ é©³å› â†’ æµè½¬åˆ°å‘˜å·¥ä¿®æ”¹
- **å®¡æ‰¹æ—¶é™**: 24å°æ—¶
- **è¶…æ—¶å¤„ç†**: 
  - å‘é€æé†’é€šçŸ¥
  - è¶…è¿‡48å°æ—¶è‡ªåŠ¨è½¬åŠç»™å¤‡é€‰å®¡æ‰¹äºº
- **ä¼˜åŒ–é€»è¾‘**:
  ```java
  // å®¡æ‰¹å®Œæˆåï¼Œåˆ¤æ–­é¡¹ç›®ç»ç†å’Œéƒ¨é—¨ç»ç†æ˜¯å¦ä¸ºåŒä¸€äºº
  @Override
  public void notify(DelegateTask delegateTask) {
      String eventName = delegateTask.getEventName();
      
      if ("complete".equals(eventName)) {
          // è·å–å®¡æ‰¹ç»“æœ
          String approvalResult = delegateTask.getVariable("approvalResult", String.class);
          String approvalComment = delegateTask.getVariable("approvalComment", String.class);
          
          if ("APPROVE".equals(approvalResult)) {
              Long projectId = delegateTask.getVariable("projectId", Long.class);
              Long deptId = delegateTask.getVariable("deptId", Long.class);
              
              // æŸ¥è¯¢é¡¹ç›®ç»ç†å’Œéƒ¨é—¨ç»ç†
              Project project = projectService.getById(projectId);
              Org dept = orgService.getById(deptId);
              
              Long projectManagerId = project.getLeaderId();
              Long deptManagerId = dept.getLeaderId();
              
              // è®¾ç½®æµç¨‹å˜é‡
              delegateTask.setVariable("projectManagerId", projectManagerId);
              delegateTask.setVariable("deptManagerId", deptManagerId);
              delegateTask.setVariable("isSameManager", projectManagerId.equals(deptManagerId));
              
              // å¦‚æœé¡¹ç›®ç»ç†å’Œéƒ¨é—¨ç»ç†æ˜¯åŒä¸€äººï¼Œè‡ªåŠ¨å®Œæˆéƒ¨é—¨ç»ç†å®¡æ‰¹ä»»åŠ¡
              if (projectManagerId.equals(deptManagerId)) {
                  autoCompleteDeptManagerTask(
                      delegateTask.getProcessInstanceId(),
                      approvalResult,
                      approvalComment
                  );
                  
                  // å‘é€è‡ªåŠ¨å®¡æ‰¹é€šçŸ¥
                  notificationService.sendAutoApprovalNotification(
                      projectManagerId,
                      "éƒ¨é—¨ç»ç†å®¡æ‰¹å·²è‡ªåŠ¨å®Œæˆ",
                      "ç”±äºæ‚¨åŒæ—¶æ‹…ä»»é¡¹ç›®ç»ç†å’Œéƒ¨é—¨ç»ç†ï¼Œéƒ¨é—¨ç»ç†å®¡æ‰¹å·²è‡ªåŠ¨å®Œæˆ"
                  );
              }
          }
      }
  }
  
  private void autoCompleteDeptManagerTask(String processInstanceId, 
                                             String approvalResult, 
                                             String approvalComment) {
      // æŸ¥æ‰¾éƒ¨é—¨ç»ç†å®¡æ‰¹ä»»åŠ¡
      Task task = taskService.createTaskQuery()
          .processInstanceId(processInstanceId)
          .taskDefinitionKey("deptManagerApproval")
          .singleResult();
      
      if (task != null) {
          // è‡ªåŠ¨å®Œæˆä»»åŠ¡
          taskService.complete(task.getId(), Map.of(
              "approvalResult", approvalResult,
              "approvalComment", "[è‡ªåŠ¨å®¡æ‰¹] " + approvalComment,
              "approvalTime", LocalDateTime.now(),
              "autoApproved", true
          ));
      }
  }
  ```

### 3. æ™ºèƒ½åˆ¤æ–­èŠ‚ç‚¹ (DECISION) - æ–°å¢èŠ‚ç‚¹
- **èŠ‚ç‚¹ç±»å‹**: æœåŠ¡ä»»åŠ¡ï¼ˆæˆ–æ’ä»–ç½‘å…³ï¼‰
- **åŠŸèƒ½**: åˆ¤æ–­é¡¹ç›®ç»ç†å’Œéƒ¨é—¨ç»ç†æ˜¯å¦ä¸ºåŒä¸€äºº
- **åˆ¤æ–­å˜é‡**: `isSameManager` (boolean)
- **æµç¨‹åˆ†æ”¯**:
  - `isSameManager = true` â†’ æµè½¬åˆ°é‡‘é¢åˆ¤æ–­ç½‘å…³
  - `isSameManager = false` â†’ æµè½¬åˆ°éƒ¨é—¨ç»ç†å®¡æ‰¹

**å®ç°æ–¹å¼1ï¼šæœåŠ¡ä»»åŠ¡**
```java
@Component
public class ManagerDecisionTask implements JavaDelegate {
    
    @Override
    public void execute(DelegateExecution execution) {
        Boolean isSameManager = execution.getVariable("isSameManager", Boolean.class);
        
        if (Boolean.TRUE.equals(isSameManager)) {
            // ç›´æ¥æµè½¬åˆ°é‡‘é¢åˆ¤æ–­ç½‘å…³
            // Flowableä¼šè‡ªåŠ¨å¤„ç†æµç¨‹æµè½¬
        }
    }
}
```

**å®ç°æ–¹å¼2ï¼šæ’ä»–ç½‘å…³ï¼ˆæ¨èï¼‰**
```xml
<exclusiveGateway id="managerGateway" name="æ™ºèƒ½åˆ¤æ–­"/>

<sequenceFlow id="flowSame" sourceRef="managerGateway" targetRef="amountGateway">
    <conditionExpression xsi:type="tFormalExpression">
        ${isSameManager == true}
    </conditionExpression>
</sequenceFlow>

<sequenceFlow id="flowDifferent" sourceRef="managerGateway" targetRef="deptManagerApproval">
    <conditionExpression xsi:type="tFormalExpression">
        ${isSameManager == false}
    </conditionExpression>
</sequenceFlow>
```

### 4. éƒ¨é—¨ç»ç†å®¡æ‰¹ (APPROVE) - æ¡ä»¶èŠ‚ç‚¹
- **èŠ‚ç‚¹ç±»å‹**: ç”¨æˆ·ä»»åŠ¡
- **å®¡æ‰¹äºº**: ç”³è¯·äººæ‰€å±éƒ¨é—¨çš„è´Ÿè´£äººï¼ˆä»orgè¡¨è·å–leader_idï¼‰
- **æ“ä½œç±»å‹**:
  - âœ… é€šè¿‡ â†’ æµè½¬åˆ°é‡‘é¢åˆ¤æ–­ç½‘å…³
  - âŒ é©³å› â†’ æµè½¬åˆ°å‘˜å·¥ä¿®æ”¹
- **å®¡æ‰¹æ—¶é™**: 24å°æ—¶
- **è¶…æ—¶å¤„ç†**: åŒé¡¹ç›®ç»ç†å®¡æ‰¹
- **ä¼˜åŒ–è¯´æ˜**: åªæœ‰é¡¹ç›®ç»ç†å’Œéƒ¨é—¨ç»ç†ä¸æ˜¯åŒä¸€äººæ—¶ï¼Œæ‰ä¼šæ‰§è¡Œæ­¤èŠ‚ç‚¹

### 5. é‡‘é¢åˆ¤æ–­ç½‘å…³ (GATEWAY)
- **èŠ‚ç‚¹ç±»å‹**: æ’ä»–ç½‘å…³
- **åˆ¤æ–­æ¡ä»¶**: æŠ¥é”€é‡‘é¢æ˜¯å¦è¶…è¿‡é…ç½®çš„é˜ˆå€¼
- **æµç¨‹å˜é‡**: `charge` (æŠ¥é”€é‡‘é¢)
- **é…ç½®æ¥æº**: ç§Ÿæˆ·çº§åˆ«çš„æŠ¥é”€é‡‘é¢å®¡æ‰¹é˜ˆå€¼é…ç½®

### 6-9. å…¶ä»–èŠ‚ç‚¹ï¼ˆä¿æŒä¸å˜ï¼‰
- æ€»ç»ç†å®¡æ‰¹
- è´¢åŠ¡å®¡æ ¸
- å‡ºçº³ä»˜æ¬¾
- å‘˜å·¥ä¿®æ”¹
- ç”Ÿæˆå‡­è¯ï¼Œå…³é—­æµç¨‹

---

## ğŸ“Š ä¼˜åŒ–åçš„æµç¨‹å˜é‡

### æ–°å¢æµç¨‹å˜é‡

| å˜é‡å | ç±»å‹ | è¯´æ˜ | ä½œç”¨åŸŸ |
|--------|------|------|--------|
| projectManagerId | Long | é¡¹ç›®ç»ç†ID | å…¨å±€ |
| deptManagerId | Long | éƒ¨é—¨ç»ç†ID | å…¨å±€ |
| isSameManager | Boolean | é¡¹ç›®ç»ç†å’Œéƒ¨é—¨ç»ç†æ˜¯å¦ä¸ºåŒä¸€äºº | å…¨å±€ |
| autoApproved | Boolean | æ˜¯å¦è‡ªåŠ¨å®¡æ‰¹ | å…¨å±€ |

### ä¿ç•™åŸæœ‰æµç¨‹å˜é‡
- transId, transNo, tenantId, applicantId, projectId, deptId
- charge, lcCharge, loanOffsetAmount, payableAmount
- currency, exchangeRate, transType, transReason
- submitTime, approvalThreshold
- currentApprover, lastApprovalAction, lastApprovalComment
- modificationCount, rejectCount

---

## ğŸ¨ ä¼˜åŒ–åçš„BPMNæµç¨‹å®šä¹‰

```xml
<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
             xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC"
             xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI"
             xmlns:flowable="http://flowable.org/bpmn"
             targetNamespace="http://www.flowable.org/processdef">
    
    <process id="reimbursementApprovalProcess" name="æŠ¥é”€å®¡æ‰¹æµç¨‹ï¼ˆä¼˜åŒ–ç‰ˆï¼‰" isExecutable="true">
        
        <!-- å¼€å§‹äº‹ä»¶ -->
        <startEvent id="start" name="å‘˜å·¥æäº¤"/>
        
        <!-- é¡¹ç›®ç»ç†å®¡æ‰¹ -->
        <userTask id="projectManagerApproval" name="é¡¹ç›®ç»ç†å®¡æ‰¹">
            <extensionElements>
                <flowable:taskListener event="complete" class="com.fs.workflow.listener.ProjectManagerCompleteListener"/>
                <flowable:taskListener event="create" class="com.fs.workflow.listener.ProjectManagerTaskListener"/>
            </extensionElements>
        </userTask>
        
        <!-- æ™ºèƒ½åˆ¤æ–­ç½‘å…³ï¼šé¡¹ç›®ç»ç†å’Œéƒ¨é—¨ç»ç†æ˜¯å¦ä¸ºåŒä¸€äºº -->
        <exclusiveGateway id="managerGateway" name="æ™ºèƒ½åˆ¤æ–­"/>
        
        <!-- éƒ¨é—¨ç»ç†å®¡æ‰¹ -->
        <userTask id="deptManagerApproval" name="éƒ¨é—¨ç»ç†å®¡æ‰¹">
            <extensionElements>
                <flowable:taskListener event="create" class="com.fs.workflow.listener.DeptManagerTaskListener"/>
                <flowable:candidateUsers>${deptManagerId}</flowable:candidateUsers>
            </extensionElements>
        </userTask>
        
        <!-- é‡‘é¢åˆ¤æ–­ç½‘å…³ -->
        <exclusiveGateway id="amountGateway" name="é‡‘é¢åˆ¤æ–­"/>
        
        <!-- æ€»ç»ç†å®¡æ‰¹ -->
        <userTask id="gmApproval" name="æ€»ç»ç†å®¡æ‰¹">
            <extensionElements>
                <flowable:taskListener event="create" class="com.fs.workflow.listener.GMTaskListener"/>
                <flowable:candidateUsers>${generalManagerId}</flowable:candidateUsers>
            </extensionElements>
        </userTask>
        
        <!-- è´¢åŠ¡å®¡æ ¸ -->
        <userTask id="financeAudit" name="è´¢åŠ¡å®¡æ ¸">
            <extensionElements>
                <flowable:taskListener event="create" class="com.fs.workflow.listener.FinanceTaskListener"/>
                <flowable:candidateGroups>FINANCE</flowable:candidateGroups>
            </extensionElements>
        </userTask>
        
        <!-- å‡ºçº³ä»˜æ¬¾ -->
        <userTask id="cashierPayment" name="å‡ºçº³ä»˜æ¬¾">
            <extensionElements>
                <flowable:taskListener event="create" class="com.fs.workflow.listener.CashierTaskListener"/>
                <flowable:candidateGroups>CASHIER</flowable:candidateGroups>
            </extensionElements>
        </userTask>
        
        <!-- å‘˜å·¥ä¿®æ”¹ -->
        <userTask id="employeeUpdate" name="å‘˜å·¥ä¿®æ”¹">
            <extensionElements>
                <flowable:taskListener event="create" class="com.fs.workflow.listener.EmployeeUpdateTaskListener"/>
                <flowable:assignee>${applicantId}</flowable:assignee>
            </extensionElements>
        </userTask>
        
        <!-- ç»“æŸäº‹ä»¶ -->
        <endEvent id="end" name="ç”Ÿæˆå‡­è¯ï¼Œå…³é—­æµç¨‹">
            <extensionElements>
                <flowable:executionListener event="end" class="com.fs.workflow.listener.VoucherGenerationListener"/>
            </extensionElements>
        </endEvent>
        
        <!-- æµç¨‹è¿çº¿ -->
        <sequenceFlow id="flow1" sourceRef="start" targetRef="projectManagerApproval"/>
        
        <!-- é¡¹ç›®ç»ç†å®¡æ‰¹å®Œæˆåçš„åˆ†æ”¯ -->
        <sequenceFlow id="flow2" sourceRef="projectManagerApproval" targetRef="managerGateway">
            <conditionExpression xsi:type="tFormalExpression">
                ${approvalResult == 'APPROVE'}
            </conditionExpression>
        </sequenceFlow>
        
        <sequenceFlow id="flow3" sourceRef="projectManagerApproval" targetRef="employeeUpdate">
            <conditionExpression xsi:type="tFormalExpression">
                ${approvalResult == 'REJECT'}
            </conditionExpression>
        </sequenceFlow>
        
        <!-- æ™ºèƒ½åˆ¤æ–­ç½‘å…³çš„åˆ†æ”¯ -->
        <sequenceFlow id="flow4" sourceRef="managerGateway" targetRef="amountGateway">
            <conditionExpression xsi:type="tFormalExpression">
                ${isSameManager == true}
            </conditionExpression>
        </sequenceFlow>
        
        <sequenceFlow id="flow5" sourceRef="managerGateway" targetRef="deptManagerApproval">
            <conditionExpression xsi:type="tFormalExpression">
                ${isSameManager == false}
            </conditionExpression>
        </sequenceFlow>
        
        <!-- éƒ¨é—¨ç»ç†å®¡æ‰¹å®Œæˆåçš„åˆ†æ”¯ -->
        <sequenceFlow id="flow6" sourceRef="deptManagerApproval" targetRef="amountGateway">
            <conditionExpression xsi:type="tFormalExpression">
                ${approvalResult == 'APPROVE'}
            </conditionExpression>
        </sequenceFlow>
        
        <sequenceFlow id="flow7" sourceRef="deptManagerApproval" targetRef="employeeUpdate">
            <conditionExpression xsi:type="tFormalExpression">
                ${approvalResult == 'REJECT'}
            </conditionExpression>
        </sequenceFlow>
        
        <!-- é‡‘é¢åˆ¤æ–­ç½‘å…³çš„åˆ†æ”¯ -->
        <sequenceFlow id="flow8" sourceRef="amountGateway" targetRef="gmApproval">
            <conditionExpression xsi:type="tFormalExpression">
                ${charge >= approvalThreshold}
            </conditionExpression>
        </sequenceFlow>
        
        <sequenceFlow id="flow9" sourceRef="amountGateway" targetRef="financeAudit">
            <conditionExpression xsi:type="tFormalExpression">
                ${charge < approvalThreshold}
            </conditionExpression>
        </sequenceFlow>
        
        <!-- æ€»ç»ç†å®¡æ‰¹å®Œæˆåçš„åˆ†æ”¯ -->
        <sequenceFlow id="flow10" sourceRef="gmApproval" targetRef="financeAudit">
            <conditionExpression xsi:type="tFormalExpression">
                ${approvalResult == 'APPROVE'}
            </conditionExpression>
        </sequenceFlow>
        
        <sequenceFlow id="flow11" sourceRef="gmApproval" targetRef="employeeUpdate">
            <conditionExpression xsi:type="tFormalExpression">
                ${approvalResult == 'REJECT'}
            </conditionExpression>
        </sequenceFlow>
        
        <!-- è´¢åŠ¡å®¡æ ¸å®Œæˆåçš„åˆ†æ”¯ -->
        <sequenceFlow id="flow12" sourceRef="financeAudit" targetRef="cashierPayment">
            <conditionExpression xsi:type="tFormalExpression">
                ${approvalResult == 'APPROVE'}
            </conditionExpression>
        </sequenceFlow>
        
        <sequenceFlow id="flow13" sourceRef="financeAudit" targetRef="employeeUpdate">
            <conditionExpression xsi:type="tFormalExpression">
                ${approvalResult == 'REJECT'}
            </conditionExpression>
        </sequenceFlow>
        
        <!-- å‡ºçº³ä»˜æ¬¾å®Œæˆåçš„åˆ†æ”¯ -->
        <sequenceFlow id="flow14" sourceRef="cashierPayment" targetRef="end">
            <conditionExpression xsi:type="tFormalExpression">
                ${paymentResult == 'PAID'}
            </conditionExpression>
        </sequenceFlow>
        
        <sequenceFlow id="flow15" sourceRef="cashierPayment" targetRef="employeeUpdate">
            <conditionExpression xsi:type="tFormalExpression">
                ${paymentResult == 'RETURN'}
            </conditionExpression>
        </sequenceFlow>
        
        <!-- å‘˜å·¥ä¿®æ”¹é‡æ–°æäº¤ -->
        <sequenceFlow id="flow16" sourceRef="employeeUpdate" targetRef="projectManagerApproval">
            <conditionExpression xsi:type="tFormalExpression">
                ${submitAction == 'RESUBMIT'}
            </conditionExpression>
        </sequenceFlow>
        
    </process>
</definitions>
```

---

## ğŸ”§ é¡¹ç›®ç»ç†å®¡æ‰¹å®Œæˆç›‘å¬å™¨ï¼ˆå®Œæ•´å®ç°ï¼‰

```java
@Component
public class ProjectManagerCompleteListener implements TaskListener {
    
    @Autowired
    private ProjectService projectService;
    
    @Autowired
    private OrgService orgService;
    
    @Autowired
    private TaskService taskService;
    
    @Autowired
    private NotificationService notificationService;
    
    @Autowired
    private WorkflowApprovalService workflowApprovalService;
    
    @Override
    public void notify(DelegateTask delegateTask) {
        String eventName = delegateTask.getEventName();
        
        if ("complete".equals(eventName)) {
            Long processInstanceId = Long.parseLong(delegateTask.getProcessInstanceId());
            
            // è·å–å®¡æ‰¹ç»“æœ
            String approvalResult = delegateTask.getVariable("approvalResult", String.class);
            String approvalComment = delegateTask.getVariable("approvalComment", String.class);
            
            // è®¾ç½®å®¡æ‰¹æ—¶é—´
            delegateTask.setVariable("approvalTime", LocalDateTime.now());
            
            // è®¾ç½®å®¡æ‰¹äºº
            delegateTask.setVariable("projectManagerApprovalUser", delegateTask.getAssignee());
            
            if ("APPROVE".equals(approvalResult)) {
                Long projectId = delegateTask.getVariable("projectId", Long.class);
                Long deptId = delegateTask.getVariable("deptId", Long.class);
                
                // æŸ¥è¯¢é¡¹ç›®ç»ç†å’Œéƒ¨é—¨ç»ç†
                Project project = projectService.getById(projectId);
                Org dept = orgService.getById(deptId);
                
                Long projectManagerId = project.getLeaderId();
                Long deptManagerId = dept.getLeaderId();
                
                // è®¾ç½®æµç¨‹å˜é‡
                delegateTask.setVariable("projectManagerId", projectManagerId);
                delegateTask.setVariable("deptManagerId", deptManagerId);
                delegateTask.setVariable("isSameManager", projectManagerId.equals(deptManagerId));
                
                // åˆ¤æ–­é¡¹ç›®ç»ç†å’Œéƒ¨é—¨ç»ç†æ˜¯å¦ä¸ºåŒä¸€äºº
                if (projectManagerId.equals(deptManagerId)) {
                    // è‡ªåŠ¨å®Œæˆéƒ¨é—¨ç»ç†å®¡æ‰¹ä»»åŠ¡
                    autoCompleteDeptManagerTask(
                        processInstanceId,
                        approvalResult,
                        approvalComment
                    );
                    
                    // è®°å½•å®¡æ‰¹å†å²
                    workflowApprovalService.saveApprovalHistory(
                        processInstanceId,
                        "deptManagerApproval",
                        projectManagerId,
                        "APPROVE",
                        "[è‡ªåŠ¨å®¡æ‰¹] " + approvalComment,
                        true // æ ‡è®°ä¸ºè‡ªåŠ¨å®¡æ‰¹
                    );
                    
                    // å‘é€è‡ªåŠ¨å®¡æ‰¹é€šçŸ¥
                    notificationService.sendAutoApprovalNotification(
                        projectManagerId,
                        "éƒ¨é—¨ç»ç†å®¡æ‰¹å·²è‡ªåŠ¨å®Œæˆ",
                        "ç”±äºæ‚¨åŒæ—¶æ‹…ä»»é¡¹ç›®ç»ç†å’Œéƒ¨é—¨ç»ç†ï¼Œéƒ¨é—¨ç»ç†å®¡æ‰¹å·²è‡ªåŠ¨å®Œæˆ"
                    );
                    
                    log.info("é¡¹ç›®ç»ç†å’Œéƒ¨é—¨ç»ç†ä¸ºåŒä¸€äººï¼Œè‡ªåŠ¨å®Œæˆéƒ¨é—¨ç»ç†å®¡æ‰¹ã€‚é¡¹ç›®ç»ç†ID: {}", projectManagerId);
                } else {
                    log.info("é¡¹ç›®ç»ç†å’Œéƒ¨é—¨ç»ç†ä¸æ˜¯åŒä¸€äººï¼Œæµç¨‹æµè½¬åˆ°éƒ¨é—¨ç»ç†å®¡æ‰¹ã€‚é¡¹ç›®ç»ç†ID: {}, éƒ¨é—¨ç»ç†ID: {}", 
                        projectManagerId, deptManagerId);
                }
            }
        }
    }
    
    /**
     * è‡ªåŠ¨å®Œæˆéƒ¨é—¨ç»ç†å®¡æ‰¹ä»»åŠ¡
     */
    private void autoCompleteDeptManagerTask(String processInstanceId, 
                                             String approvalResult, 
                                             String approvalComment) {
        try {
            // æŸ¥æ‰¾éƒ¨é—¨ç»ç†å®¡æ‰¹ä»»åŠ¡
            Task task = taskService.createTaskQuery()
                .processInstanceId(processInstanceId)
                .taskDefinitionKey("deptManagerApproval")
                .singleResult();
            
            if (task != null) {
                // è‡ªåŠ¨å®Œæˆä»»åŠ¡
                taskService.complete(task.getId(), Map.of(
                    "approvalResult", approvalResult,
                    "approvalComment", "[è‡ªåŠ¨å®¡æ‰¹] " + approvalComment,
                    "approvalTime", LocalDateTime.now(),
                    "autoApproved", true,
                    "deptManagerApprovalUser", task.getAssignee()
                ));
                
                log.info("è‡ªåŠ¨å®Œæˆéƒ¨é—¨ç»ç†å®¡æ‰¹ä»»åŠ¡æˆåŠŸã€‚ä»»åŠ¡ID: {}", task.getId());
            } else {
                log.warn("æœªæ‰¾åˆ°éƒ¨é—¨ç»ç†å®¡æ‰¹ä»»åŠ¡ã€‚æµç¨‹å®ä¾‹ID: {}", processInstanceId);
            }
        } catch (Exception e) {
            log.error("è‡ªåŠ¨å®Œæˆéƒ¨é—¨ç»ç†å®¡æ‰¹ä»»åŠ¡å¤±è´¥", e);
            throw new RuntimeException("è‡ªåŠ¨å®Œæˆéƒ¨é—¨ç»ç†å®¡æ‰¹ä»»åŠ¡å¤±è´¥", e);
        }
    }
}
```

---

## ğŸ“‹ å®¡æ‰¹å†å²è®°å½•è¡¨ä¼˜åŒ–

### å®¡æ‰¹å†å²è¡¨ (workflow_approval)

éœ€è¦æ–°å¢å­—æ®µæ¥æ ‡è®°è‡ªåŠ¨å®¡æ‰¹ï¼š

```sql
ALTER TABLE workflow_approval ADD COLUMN IF NOT EXISTS auto_approved SMALLINT DEFAULT 0;
COMMENT ON COLUMN workflow_approval.auto_approved IS 'æ˜¯å¦è‡ªåŠ¨å®¡æ‰¹ï¼ˆ0=å¦ï¼Œ1=æ˜¯ï¼‰';
```

### å®¡æ‰¹å†å²è®°å½•ç¤ºä¾‹

| id | process_instance_id | task_def_key | approver_id | approval_result | approval_comment | approval_time | auto_approved |
|----|---------------------|--------------|-------------|------------------|------------------|---------------|---------------|
| 1 | proc_001 | projectManagerApproval | 1001 | APPROVE | åŒæ„ç”³è¯· | 2025-01-24 10:30 | 0 |
| 2 | proc_001 | deptManagerApproval | 1001 | APPROVE | [è‡ªåŠ¨å®¡æ‰¹] åŒæ„ç”³è¯· | 2025-01-24 10:30 | 1 |
| 3 | proc_001 | financeAudit | 2001 | APPROVE | å®¡æ ¸é€šè¿‡ | 2025-01-24 14:20 | 0 |

---

## ğŸ“Š å‰ç«¯å±•ç¤ºä¼˜åŒ–

### å®¡æ‰¹å†å²å±•ç¤ºä¼˜åŒ–

åœ¨å®¡æ‰¹å†å²é¡µé¢ï¼Œéœ€è¦åŒºåˆ†æ‰‹åŠ¨å®¡æ‰¹å’Œè‡ªåŠ¨å®¡æ‰¹ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¡æ‰¹å†å²                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  1. é¡¹ç›®ç»ç†å®¡æ‰¹                          â”‚
â”‚     å®¡æ‰¹äºº: å¼ ä¸‰                          â”‚
â”‚     å®¡æ‰¹ç»“æœ: âœ… é€šè¿‡                     â”‚
â”‚     å®¡æ‰¹æ„è§: åŒæ„ç”³è¯·                     â”‚
â”‚     å®¡æ‰¹æ—¶é—´: 2025-01-24 10:30           â”‚
â”‚                                         â”‚
â”‚  2. éƒ¨é—¨ç»ç†å®¡æ‰¹  ğŸ¤– (è‡ªåŠ¨å®¡æ‰¹)          â”‚
â”‚     å®¡æ‰¹äºº: å¼ ä¸‰                          â”‚
â”‚     å®¡æ‰¹ç»“æœ: âœ… é€šè¿‡                     â”‚
â”‚     å®¡æ‰¹æ„è§: [è‡ªåŠ¨å®¡æ‰¹] åŒæ„ç”³è¯·           â”‚
â”‚     å®¡æ‰¹æ—¶é—´: 2025-01-24 10:30           â”‚
â”‚     è¯´æ˜: é¡¹ç›®ç»ç†å’Œéƒ¨é—¨ç»ç†ä¸ºåŒä¸€äººï¼Œè‡ªåŠ¨å®Œæˆ â”‚
â”‚                                         â”‚
â”‚  3. è´¢åŠ¡å®¡æ ¸                              â”‚
â”‚     å®¡æ‰¹äºº: æå››                          â”‚
â”‚     å®¡æ‰¹ç»“æœ: âœ… é€šè¿‡                     â”‚
â”‚     å®¡æ‰¹æ„è§: å®¡æ ¸é€šè¿‡                     â”‚
â”‚     å®¡æ‰¹æ—¶é—´: 2025-01-24 14:20           â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ ä¸‹ä¸€æ­¥è®¾è®¡

åŸºäºä¼˜åŒ–åçš„å®¡æ‰¹æµç¨‹ï¼Œæ¥ä¸‹æ¥éœ€è¦è®¾è®¡ï¼š

1. **æ¨¡å—10ï¼šå·¥ä½œæµç®¡ç†** - æä¾›æµç¨‹å®šä¹‰ã€æµç¨‹å®ä¾‹ã€ä»»åŠ¡ç®¡ç†ç­‰åŠŸèƒ½
2. **æ¨¡å—8ï¼šå€Ÿæ¬¾ç®¡ç†** - å€Ÿæ¬¾å®¡æ‰¹æµç¨‹ï¼ˆåº”ç”¨åŒæ ·çš„ä¼˜åŒ–é€»è¾‘ï¼‰
3. **æ¨¡å—9ï¼šè¿˜æ¬¾ç®¡ç†** - è¿˜æ¬¾å®¡æ‰¹æµç¨‹

---

## ğŸ“Œ ä¼˜åŒ–æ€»ç»“

### ä¼˜åŒ–æ•ˆæœ
- âœ… æé«˜å®¡æ‰¹æ•ˆç‡ï¼šé¡¹ç›®ç»ç†å’Œéƒ¨é—¨ç»ç†ä¸ºåŒä¸€äººæ—¶ï¼Œå‡å°‘1ä¸ªå®¡æ‰¹èŠ‚ç‚¹
- âœ… ç”¨æˆ·ä½“éªŒä¼˜åŒ–ï¼šé¿å…åŒä¸€äººé‡å¤å®¡æ‰¹
- âœ… çµæ´»æ€§å¼ºï¼šä¸åŒæƒ…å†µä¸‹è‡ªåŠ¨é€‚é…å®¡æ‰¹æµç¨‹
- âœ… å¯è¿½æº¯æ€§å¼ºï¼šå®¡æ‰¹å†å²æ¸…æ™°æ ‡è®°è‡ªåŠ¨å®¡æ‰¹

### æŠ€æœ¯å®ç°è¦ç‚¹
1. **é¡¹ç›®ç»ç†å®¡æ‰¹å®Œæˆç›‘å¬å™¨**ï¼šåœ¨å®¡æ‰¹å®Œæˆååˆ¤æ–­æ˜¯å¦éœ€è¦è‡ªåŠ¨å®Œæˆéƒ¨é—¨ç»ç†å®¡æ‰¹
2. **æ™ºèƒ½åˆ¤æ–­ç½‘å…³**ï¼šä½¿ç”¨æ’ä»–ç½‘å…³æ ¹æ®å˜é‡è‡ªåŠ¨æµè½¬
3. **è‡ªåŠ¨å®¡æ‰¹é€»è¾‘**ï¼šè‡ªåŠ¨æŸ¥æ‰¾å¹¶å®Œæˆéƒ¨é—¨ç»ç†å®¡æ‰¹ä»»åŠ¡
4. **å®¡æ‰¹å†å²è®°å½•**ï¼šæ¸…æ™°æ ‡è®°è‡ªåŠ¨å®¡æ‰¹ï¼Œä¾¿äºè¿½æº¯

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0 (ä¼˜åŒ–ç‰ˆ)  
**åˆ›å»ºæ—¥æœŸ**: 2025-01-24  
**çŠ¶æ€**: âœ… å·²å®Œæˆ
